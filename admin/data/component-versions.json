{
  "ReportTable": {
    "active": "v30",
    "versions": [
      {
        "id": "v26",
        "timestamp": "2025-11-09T07:22:58.288Z",
        "note": "Modifica multipla 09/11/2025, 08:22:57",
        "code": "'use client';\n\nimport { useState, useEffect } from 'react';\nimport { ReportColumn, GroupedDataNode } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { ChevronDown, ChevronRight } from 'lucide-react';\n\nconst TEXTS = {\n  // ----------------------------------------------------------\n  // Bottoni / messaggi di sistema\n  // ----------------------------------------------------------\n  buttonShowOnlyPending: {\n    it: 'Mostra solo da consegnare',\n    en: 'Show only pending',\n    de: 'Nur ausstehende anzeigen',\n    fr: 'Afficher uniquement en attente',\n    es: 'Mostrar solo pendientes',\n    pt: 'Mostrar apenas pendentes',\n  },\n  buttonExcel: {\n    it: 'Excel',\n    en: 'Excel',\n    de: 'Excel',\n    fr: 'Excel',\n    es: 'Excel',\n    pt: 'Excel',\n  },\n  buttonPDF: {\n    it: 'PDF',\n    en: 'PDF',\n    de: 'PDF',\n    fr: 'PDF',\n    es: 'PDF',\n    pt: 'PDF',\n  },\n  messageNoDocuments: {\n    it: 'Nessun documento trovato',\n    en: 'No documents found',\n    de: 'Keine Dokumente gefunden',\n    fr: 'Aucun document trouvé',\n    es: 'No se encontraron documentos',\n    pt: 'Nenhum documento encontrado',\n  },\n  labelTotal: {\n    it: 'TOTALE',\n    en: 'TOTAL',\n    de: 'GESAMT',\n    fr: 'TOTAL',\n    es: 'TOTAL',\n    pt: 'TOTAL',\n  },\n\n  // ----------------------------------------------------------\n  // Stato righe\n  // ----------------------------------------------------------\n  statusDelivered: {\n    it: 'CONSEGNATO',\n    en: 'DELIVERED',\n    de: 'GELIEFERT',\n    fr: 'LIVRÉ',\n    es: 'ENTREGADO',\n    pt: 'ENTREGUE',\n  },\n  statusInOrder: {\n    it: 'IN ORDINE',\n    en: 'IN ORDER',\n    de: 'IN AUFTRAG',\n    fr: 'EN COMMANDE',\n    es: 'EN PEDIDO',\n    pt: 'EM PEDIDO',\n  },\n\n  // ----------------------------------------------------------\n  // Raggruppamenti\n  // ----------------------------------------------------------\n  labelOrder: {\n    it: 'Ordine',\n    en: 'Order',\n    de: 'Bestellung',\n    fr: 'Commande',\n    es: 'Pedido',\n    pt: 'Pedido',\n  },\n  labelDelivered: {\n    it: 'consegnato',\n    en: 'delivered',\n    de: 'geliefert',\n    fr: 'livré',\n    es: 'entregado',\n    pt: 'entregue',\n  },\n  labelFulfilled: {\n    it: 'Evasi',\n    en: 'Fulfilled',\n    de: 'Erfüllt',\n    fr: 'Traités',\n    es: 'Cumplidos',\n    pt: 'Cumpridos',\n  },\n\n  // ----------------------------------------------------------\n  // COLONNE DINAMICHE\n  // Ogni colonna usa: column_<nomeField>\n  // ----------------------------------------------------------\n  columns: {\n    column_data: {\n      it: 'Data',\n      en: 'Date',\n      de: 'Datum',\n      fr: 'Date',\n      es: 'Fecha',\n      pt: 'Data',\n    },\n    column_tipo_documento: {\n      it: 'Tipo Documento',\n      en: 'Document type',\n      de: 'Belegart',\n      fr: 'Type de document',\n      es: 'Tipo de documento',\n      pt: 'Tipo de documento',\n    },\n    column_tipo: {\n      it: 'Tipo',\n      en: 'Type',\n      de: 'Typ',\n      fr: 'Type',\n      es: 'Tipo',\n      pt: 'Tipo',\n    },\n    column_numero: {\n      it: 'Numero',\n      en: 'Number',\n      de: 'Nummer',\n      fr: 'Numéro',\n      es: 'Número',\n      pt: 'Número',\n    },\n    column_descrizione: {\n      it: 'Descrizione',\n      en: 'Description',\n      de: 'Beschreibung',\n      fr: 'Description',\n      es: 'Descripción',\n      pt: 'Descrição',\n    },\n    column_stato: {\n      it: 'Stato',\n      en: 'Status',\n      de: 'Status',\n      fr: 'Statut',\n      es: 'Estado',\n      pt: 'Estado',\n    },\n    column_totale: {\n      it: 'Importo',\n      en: 'Amount',\n      de: 'Betrag',\n      fr: 'Montant',\n      es: 'Importe',\n      pt: 'Valor',\n    },\n    column_valuta: {\n      it: 'Valuta',\n      en: 'Currency',\n      de: 'Währung',\n      fr: 'Devise',\n      es: 'Moneda',\n      pt: 'Moeda',\n    },\n    column_anno: {\n      it: 'Anno',\n      en: 'Year',\n      de: 'Jahr',\n      fr: 'Année',\n      es: 'Año',\n      pt: 'Ano',\n    },\n    column_ngl_doc_ord: {\n      it: 'Numero Ordine',\n      en: 'Order number',\n      de: 'Bestellnummer',\n      fr: 'Numéro de commande',\n      es: 'Número de pedido',\n      pt: 'Número do pedido',\n    },\n    column_dtt_ord: {\n      it: 'Data Ordine',\n      en: 'Order date',\n      de: 'Bestelldatum',\n      fr: 'Date de commande',\n      es: 'Fecha de pedido',\n      pt: 'Data do pedido',\n    },\n    column_cds_caum: {\n      it: 'Causale',\n      en: 'Reason',\n      de: 'Grund',\n      fr: 'Motif',\n      es: 'Causal',\n      pt: 'Causa',\n    },\n    column_cky_cnt_clfr: {\n      it: 'Codice cliente',\n      en: 'Customer code',\n      de: 'Kundencode',\n      fr: 'Code client',\n      es: 'Código cliente',\n      pt: 'Código do cliente',\n    },\n    column_cds_cnt_ragsoc: {\n      it: 'Ragione Sociale',\n      en: 'Company name',\n      de: 'Firmenname',\n      fr: 'Raison sociale',\n      es: 'Razón social',\n      pt: 'Razão social',\n    },\n    column_nome_agente: {\n      it: 'Agente',\n      en: 'Agent',\n      de: 'Vertreter',\n      fr: 'Agent',\n      es: 'Agente',\n      pt: 'Agente',\n    },\n    column_cky_art: {\n      it: 'Codice Articolo',\n      en: 'Item code',\n      de: 'Artikelcode',\n      fr: \"Code de l'article\",\n      es: 'Código artículo',\n      pt: 'Código do artigo',\n    },\n    column_descrizione_art: {\n      it: 'Articolo',\n      en: 'Item',\n      de: 'Artikel',\n      fr: 'Article',\n      es: 'Artículo',\n      pt: 'Artigo',\n    },\n    column_quantita: {\n      it: 'Quantità',\n      en: 'Quantity',\n      de: 'Menge',\n      fr: 'Quantité',\n      es: 'Cantidad',\n      pt: 'Quantidade',\n    },\n    column_valore: {\n      it: 'Valore',\n      en: 'Value',\n      de: 'Wert',\n      fr: 'Valeur',\n      es: 'Valor',\n      pt: 'Valor',\n    },\n    column_sigla_trasf: {\n      it: 'Sigla Doc Magazzino',\n      en: 'Warehouse doc code',\n      de: 'Lagerbeleg-Kürzel',\n      fr: 'Code doc magasin',\n      es: 'Sigla doc almacén',\n      pt: 'Sigla doc armazém',\n    },\n    column_numero_trasf: {\n      it: 'Numero Doc Magazzino',\n      en: 'Warehouse doc number',\n      de: 'Lagerbelegnummer',\n      fr: 'Numéro doc magasin',\n      es: 'Número doc almacén',\n      pt: 'Número doc armazém',\n    },\n    column_data_trasf: {\n      it: 'Data trasf',\n      en: 'Transfer date',\n      de: 'Transferdatum',\n      fr: 'Date transfert',\n      es: 'Fecha transf',\n      pt: 'Data transf',\n    },\n    column_origne: {\n      it: 'Evaso o In Ordine',\n      en: 'Fulfilled or On order',\n      de: 'Erledigt oder in Bestellung',\n      fr: 'Livré ou en commande',\n      es: 'Servido o en pedido',\n      pt: 'Atendido ou em pedido',\n    },\n    column_sco_1: {\n      it: 'Sco 1',\n      en: 'Disc 1',\n      de: 'Rabatt 1',\n      fr: 'Rem 1',\n      es: 'Dto 1',\n      pt: 'Desc 1',\n    },\n    column_sco_2: {\n      it: 'Sco 2',\n      en: 'Disc 2',\n      de: 'Rabatt 2',\n      fr: 'Rem 2',\n      es: 'Dto 2',\n      pt: 'Desc 2',\n    },\n    column_sco_3: {\n      it: 'Sco 3',\n      en: 'Disc 3',\n      de: 'Rabatt 3',\n      fr: 'Rem 3',\n      es: 'Dto 3',\n      pt: 'Desc 3',\n    },\n    column_npz_unit: {\n      it: 'Prezzo Unitario',\n      en: 'Unit price',\n      de: 'Einzelpreis',\n      fr: 'Prix unitaire',\n      es: 'Precio unitario',\n      pt: 'Preço unitário',\n    },\n  },\n};\n\nfunction getColumnLabelFromField(field: string | undefined, language: string): string {\n  if (!field) return '';\n  const key = `column_${field.replace(/`/g, '').replace(/\\s+/g, '_').toLowerCase()}`;\n  const colObj = (TEXTS.columns as any)[key];\n  if (colObj) {\n    return colObj[language] || colObj.it;\n  }\n  return field;\n}\n\ninterface ReportTableProps {\n  data: any[] | GroupedDataNode[];\n  columns: ReportColumn[];\n  aggregates?: Record<string, any>;\n  language?: string;\n  isGrouped?: boolean;\n  groupingConfig?: any[];\n}\n\nexport default function ReportTable({\n  data,\n  columns,\n  aggregates,\n  language = 'it',\n  isGrouped = false,\n  groupingConfig = [],\n}: ReportTableProps) {\n  // inizializzazione gruppi\n  const getInitialExpandedGroups = () => {\n    const shouldExpandAll =\n      groupingConfig.length > 0 && groupingConfig[0].collapsed === false;\n\n    if (shouldExpandAll && isGrouped && data.length > 0) {\n      const all = new Set<string>();\n      const collect = (nodes: any[]) => {\n        nodes.forEach((n) => {\n          if ('groupKey' in n) {\n            all.add(n.groupKey);\n            if (n.children?.length) collect(n.children);\n          }\n        });\n      };\n      collect(data as GroupedDataNode[]);\n      return all;\n    }\n    return new Set<string>();\n  };\n\n  const [expandedGroups, setExpandedGroups] = useState<Set<string>>(\n    getInitialExpandedGroups()\n  );\n  const [showOnlyPending, setShowOnlyPending] = useState(false);\n  const [columnWidths, setColumnWidths] = useState<Record<string, number>>({});\n\n  const visibleColumns = columns.filter((c) => c.visible);\n\n  const statusColumn = columns.find((c) =>\n    (c.field || '').toLowerCase().includes('stato')\n  );\n\n  useEffect(() => {\n    setExpandedGroups(getInitialExpandedGroups());\n  }, [data, groupingConfig]);\n\n  // calcolo larghezze basato su label tradotta\n  useEffect(() => {\n    const widths: Record<string, number> = {};\n    const sampleRows: any[] = Array.isArray(data)\n      ? data.filter((r) => !('groupKey' in r)).slice(0, 10)\n      : [];\n\n    visibleColumns.forEach((col) => {\n      const label = getColumnLabelFromField(col.field, language);\n      let maxLen = (label || col.field || '').length;\n\n      sampleRows.forEach((row) => {\n        const val = row[col.field];\n        const str = val == null ? '' : String(val);\n        if (str.length > maxLen) maxLen = str.length;\n      });\n\n      let px = maxLen * 8 + 28;\n      const isTexty =\n        label.toLowerCase().includes('descr') ||\n        label.toLowerCase().includes('articolo');\n      const min = isTexty ? 160 : 90;\n      const max = isTexty ? 360 : 180;\n      if (px < min) px = min;\n      if (px > max) px = max;\n\n      widths[col.field] = px;\n    });\n\n    setColumnWidths(widths);\n  }, [data, columns, language, visibleColumns]);\n\n  const toggleGroup = (groupKey: string) => {\n    const next = new Set(expandedGroups);\n    if (next.has(groupKey)) next.delete(groupKey);\n    else next.add(groupKey);\n    setExpandedGroups(next);\n  };\n\n  const getGroupDeliveryInfo = (node: GroupedDataNode) => {\n    let total = 0;\n    let delivered = 0;\n\n    const scan = (items: any[]) => {\n      items.forEach((it) => {\n        if ('groupKey' in it) {\n          if (it.children?.length) scan(it.children);\n        } else {\n          total++;\n          if (statusColumn) {\n            const raw = (it[statusColumn.field] || '').toString().trim().toUpperCase();\n            if (raw === 'EVASO' || raw === 'CONSEGNATO') delivered++;\n          }\n        }\n      });\n    };\n\n    if (node.children?.length) scan(node.children);\n\n    const perc = total > 0 ? Math.round((delivered / total) * 100) : 0;\n    return { total, delivered, perc };\n  };\n\n  // filtro \"mostra solo da consegnare\"\n  const filteredData = (() => {\n    if (!showOnlyPending) return data;\n    if (isGrouped && Array.isArray(data) && data.length > 0 && 'groupKey' in data[0]) {\n      return (data as GroupedDataNode[]).filter((node) => {\n        const { perc } = getGroupDeliveryInfo(node);\n        return perc < 100;\n      });\n    }\n    if (Array.isArray(data)) {\n      return data.filter((row: any) => {\n        if (!statusColumn) return true;\n        const raw = (row[statusColumn.field] || '').toString().trim().toUpperCase();\n        return !(raw === 'EVASO' || raw === 'CONSEGNATO');\n      });\n    }\n    return data;\n  })();\n\n  const renderStatusBadge = (raw: any) => {\n    const txt = (raw || '').toString().trim().toUpperCase();\n    const delivered = txt === 'EVASO' || txt === 'CONSEGNATO';\n    return (\n      <span\n        className={`inline-flex items-center px-2 py-[2px] rounded-full text-[11px] font-semibold ${\n          delivered\n            ? 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200'\n            : 'bg-sky-100 text-sky-700 ring-1 ring-sky-200'\n        }`}\n      >\n        {delivered\n          ? TEXTS.statusDelivered[language as keyof typeof TEXTS.statusDelivered]\n          : TEXTS.statusInOrder[language as keyof typeof TEXTS.statusInOrder]}\n      </span>\n    );\n  };\n\n  const renderDataRow = (row: any, idx: number) => {\n    return (\n      <div\n        key={idx}\n        className=\"flex border-b border-slate-100 hover:bg-slate-50/80 transition-colors duration-150\"\n      >\n        {visibleColumns.map((col) => {\n          const width = columnWidths[col.field] || 120;\n          if (statusColumn && col.field === statusColumn.field) {\n            return (\n              <div\n                key={col.field}\n                className=\"px-3 py-2 flex items-center\"\n                style={{ width, minWidth: width }}\n              >\n                {renderStatusBadge(row[col.field])}\n              </div>\n            );\n          }\n          return (\n            <div\n              key={col.field}\n              className={`px-3 py-2 text-xs text-slate-800 ${\n                col.align === 'right' ? 'text-right' : 'text-left'\n              } overflow-hidden text-ellipsis whitespace-nowrap`}\n              style={{ width, minWidth: width }}\n              title={row[col.field] != null ? String(row[col.field]) : ''}\n            >\n              {ReportEngine.formatValue(row[col.field], col, language)}\n            </div>\n          );\n        })}\n      </div>\n    );\n  };\n\n  const renderGroupedRow = (node: GroupedDataNode, index: number) => {\n    const isExpanded = expandedGroups.has(node.groupKey);\n    const hasChildren = node.children.length > 0;\n    const { total, delivered, perc } = getGroupDeliveryInfo(node);\n\n    let badgeClass = 'bg-orange-100 text-orange-800';\n    let barClass = 'bg-orange-500';\n    if (perc >= 75) {\n      badgeClass = 'bg-emerald-100 text-emerald-700';\n      barClass = 'bg-emerald-500';\n    } else if (perc >= 26) {\n      badgeClass = 'bg-amber-100 text-amber-800';\n      barClass = 'bg-amber-400';\n    }\n\n    return (\n      <div key={`${node.groupKey}-${index}`} className=\"bg-white\">\n        <div\n          className=\"flex items-center justify-between border-b border-sky-200 bg-gradient-to-r from-sky-100 to-sky-50 hover:from-sky-200/80 hover:to-sky-100/80 cursor-pointer px-4 py-2.5\"\n          onClick={() => hasChildren && toggleGroup(node.groupKey)}\n        >\n          <div className=\"flex items-center gap-2\">\n            {hasChildren && (\n              <span className=\"rounded-full bg-white/90 p-1 shadow-sm\">\n                {isExpanded ? (\n                  <ChevronDown className=\"w-4 h-4 text-sky-700\" />\n                ) : (\n                  <ChevronRight className=\"w-4 h-4 text-sky-700\" />\n                )}\n              </span>\n            )}\n            <span className=\"text-sm font-bold text-sky-950\">\n              {TEXTS.labelOrder[language as keyof typeof TEXTS.labelOrder]}:{' '}\n              {node.groupLabel}\n            </span>\n            <span\n              className={`text-[11px] font-semibold px-2 py-[1px] rounded-full ${badgeClass}`}\n            >\n              {perc}%{' '}\n              {TEXTS.labelDelivered[language as keyof typeof TEXTS.labelDelivered]}\n            </span>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <span className=\"text-xs font-bold text-sky-900\">\n              {TEXTS.labelFulfilled[language as keyof typeof TEXTS.labelFulfilled]}{' '}\n              {delivered}/{total}\n            </span>\n            <div className=\"w-28 h-2.5 bg-slate-200 rounded-full overflow-hidden shadow-inner\">\n              <div\n                className={`h-2.5 transition-all ${barClass}`}\n                style={{ width: `${perc}%` }}\n              />\n            </div>\n          </div>\n        </div>\n\n        {isExpanded && hasChildren && (\n          <div className=\"border-l border-slate-100\">\n            {node.children.map((child: any, i: number) =>\n              'groupKey' in child ? renderGroupedRow(child, i) : renderDataRow(child, i)\n            )}\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"bg-white/50 backdrop-blur-sm rounded-2xl shadow-md border border-slate-100 overflow-hidden flex flex-col max-h-[72vh]\">\n      {/* header tabella */}\n      <div className=\"flex items-center justify-between px-4 py-3 bg-white/80 border-b border-slate-100\">\n        <button\n          type=\"button\"\n          onClick={() => setShowOnlyPending((p) => !p)}\n          className={`inline-flex items-center gap-2 text-sm font-semibold rounded-full px-4 py-1.5 transition ${\n            showOnlyPending\n              ? 'bg-sky-600 text-white shadow-sm'\n              : 'bg-slate-200 text-slate-700 hover:bg-slate-300'\n          }`}\n        >\n          <span className=\"text-xs\">●</span>\n          {TEXTS.buttonShowOnlyPending[\n            language as keyof typeof TEXTS.buttonShowOnlyPending\n          ]}\n        </button>\n\n        <div className=\"flex items-center gap-2\">\n          <button\n            type=\"button\"\n            className=\"px-3 py-1.5 rounded-md bg-slate-100 text-slate-700 text-xs hover:bg-slate-200 shadow-sm\"\n          >\n            {TEXTS.buttonExcel[language as keyof typeof TEXTS.buttonExcel]}\n          </button>\n          <button\n            type=\"button\"\n            className=\"px-3 py-1.5 rounded-md bg-slate-100 text-slate-700 text-xs hover:bg-slate-200 shadow-sm\"\n          >\n            {TEXTS.buttonPDF[language as keyof typeof TEXTS.buttonPDF]}\n          </button>\n        </div>\n      </div>\n\n      {/* intestazione colonne */}\n      <div className=\"flex border-b border-slate-200 bg-slate-100/90 sticky top-0 z-10\">\n        {visibleColumns.map((col) => {\n          const width = columnWidths[col.field] || 120;\n          return (\n            <div\n              key={col.field}\n              className={`px-3 py-2 text-[11px] font-semibold text-slate-700 uppercase tracking-wide ${\n                col.align === 'right' ? 'text-right' : 'text-left'\n              } overflow-hidden text-ellipsis whitespace-nowrap`}\n              style={{ width, minWidth: width }}\n            >\n              {getColumnLabelFromField(col.field, language)}\n            </div>\n          );\n        })}\n      </div>\n\n      {/* corpo tabella */}\n      <div className=\"flex-1 overflow-auto\">\n        {filteredData.length === 0 ? (\n          <div className=\"px-6 py-12 text-center text-slate-400 text-sm\">\n            {\n              TEXTS.messageNoDocuments[\n                language as keyof typeof TEXTS.messageNoDocuments\n              ]\n            }\n          </div>\n        ) : isGrouped && 'groupKey' in filteredData[0] ? (\n          (filteredData as GroupedDataNode[]).map((node, idx) =>\n            renderGroupedRow(node, idx)\n          )\n        ) : (\n          (filteredData as any[]).map((row, idx) => renderDataRow(row, idx))\n        )}\n      </div>\n\n      {/* footer totali */}\n      {aggregates && Object.keys(aggregates).length > 0 && (\n        <div className=\"flex border-t border-slate-200 bg-blue-50/80\">\n          {visibleColumns.map((col, idx) => {\n            const width = columnWidths[col.field] || 120;\n            return (\n              <div\n                key={col.field}\n                className={`px-3 py-2 text-xs ${\n                  col.align === 'right' ? 'text-right' : 'text-left'\n                } overflow-hidden text-ellipsis whitespace-nowrap`}\n                style={{ width, minWidth: width }}\n              >\n                {idx === 0 ? (\n                  <span className=\"font-bold text-slate-900\">\n                    {TEXTS.labelTotal[language as keyof typeof TEXTS.labelTotal]}\n                  </span>\n                ) : col.aggregate && aggregates[col.field] !== undefined ? (\n                  <span className=\"font-bold text-slate-900\">\n                    {ReportEngine.formatValue(aggregates[col.field], col, language)}\n                  </span>\n                ) : null}\n              </div>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v27",
        "timestamp": "2025-11-09T07:28:02.758Z",
        "note": "Modifica multipla 09/11/2025, 08:28:02",
        "code": "'use client';\n\nimport { useState, useEffect } from 'react';\nimport { ReportColumn, GroupedDataNode } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { ChevronDown, ChevronRight } from 'lucide-react';\n\nconst TEXTS = {\n  // ----------------------------------------------------------\n  // Bottoni / messaggi di sistema\n  // ----------------------------------------------------------\n  buttonShowOnlyPending: {\n    it: 'Mostra solo da consegnare',\n    en: 'Show only pending',\n    de: 'Nur ausstehende anzeigen',\n    fr: 'Afficher uniquement en attente',\n    es: 'Mostrar solo pendientes',\n    pt: 'Mostrar apenas pendentes',\n  },\n  buttonExcel: {\n    it: 'Excel',\n    en: 'Excel',\n    de: 'Excel',\n    fr: 'Excel',\n    es: 'Excel',\n    pt: 'Excel',\n  },\n  buttonPDF: {\n    it: 'PDF',\n    en: 'PDF',\n    de: 'PDF',\n    fr: 'PDF',\n    es: 'PDF',\n    pt: 'PDF',\n  },\n  messageNoDocuments: {\n    it: 'Nessun documento trovato',\n    en: 'No documents found',\n    de: 'Keine Dokumente gefunden',\n    fr: 'Aucun document trouvé',\n    es: 'No se encontraron documentos',\n    pt: 'Nenhum documento encontrado',\n  },\n  labelTotal: {\n    it: 'TOTALE',\n    en: 'TOTAL',\n    de: 'GESAMT',\n    fr: 'TOTAL',\n    es: 'TOTAL',\n    pt: 'TOTAL',\n  },\n\n  // ----------------------------------------------------------\n  // Stato righe\n  // ----------------------------------------------------------\n  statusDelivered: {\n    it: 'CONSEGNATO',\n    en: 'DELIVERED',\n    de: 'GELIEFERT',\n    fr: 'LIVRÉ',\n    es: 'ENTREGADO',\n    pt: 'ENTREGUE',\n  },\n  statusInOrder: {\n    it: 'IN ORDINE',\n    en: 'IN ORDER',\n    de: 'IN AUFTRAG',\n    fr: 'EN COMMANDE',\n    es: 'EN PEDIDO',\n    pt: 'EM PEDIDO',\n  },\n\n  // ----------------------------------------------------------\n  // Raggruppamenti\n  // ----------------------------------------------------------\n  labelOrder: {\n    it: 'Ordine',\n    en: 'Order',\n    de: 'Bestellung',\n    fr: 'Commande',\n    es: 'Pedido',\n    pt: 'Pedido',\n  },\n  labelDelivered: {\n    it: 'consegnato',\n    en: 'delivered',\n    de: 'geliefert',\n    fr: 'livré',\n    es: 'entregado',\n    pt: 'entregue',\n  },\n  labelFulfilled: {\n    it: 'Evasi',\n    en: 'Fulfilled',\n    de: 'Erfüllt',\n    fr: 'Traités',\n    es: 'Cumplidos',\n    pt: 'Cumpridos',\n  },\n\n  // ----------------------------------------------------------\n  // COLONNE DINAMICHE\n  // ----------------------------------------------------------\n  columns: {\n    column_data: {\n      it: 'Data',\n      en: 'Date',\n      de: 'Datum',\n      fr: 'Date',\n      es: 'Fecha',\n      pt: 'Data',\n    },\n    column_tipo_documento: {\n      it: 'Tipo Documento',\n      en: 'Document type',\n      de: 'Belegart',\n      fr: 'Type de document',\n      es: 'Tipo de documento',\n      pt: 'Tipo de documento',\n    },\n    column_tipo: {\n      it: 'Tipo',\n      en: 'Type',\n      de: 'Typ',\n      fr: 'Type',\n      es: 'Tipo',\n      pt: 'Tipo',\n    },\n    column_numero: {\n      it: 'Numero',\n      en: 'Number',\n      de: 'Nummer',\n      fr: 'Numéro',\n      es: 'Número',\n      pt: 'Número',\n    },\n    column_descrizione: {\n      it: 'Descrizione',\n      en: 'Description',\n      de: 'Beschreibung',\n      fr: 'Description',\n      es: 'Descripción',\n      pt: 'Descrição',\n    },\n    column_stato: {\n      it: 'Stato',\n      en: 'Status',\n      de: 'Status',\n      fr: 'Statut',\n      es: 'Estado',\n      pt: 'Estado',\n    },\n    column_totale: {\n      it: 'Importo',\n      en: 'Amount',\n      de: 'Betrag',\n      fr: 'Montant',\n      es: 'Importe',\n      pt: 'Valor',\n    },\n    column_valuta: {\n      it: 'Valuta',\n      en: 'Currency',\n      de: 'Währung',\n      fr: 'Devise',\n      es: 'Moneda',\n      pt: 'Moeda',\n    },\n    column_anno: {\n      it: 'Anno',\n      en: 'Year',\n      de: 'Jahr',\n      fr: 'Année',\n      es: 'Año',\n      pt: 'Ano',\n    },\n    column_ngl_doc_ord: {\n      it: 'Numero Ordine',\n      en: 'Order number',\n      de: 'Bestellnummer',\n      fr: 'Numéro de commande',\n      es: 'Número de pedido',\n      pt: 'Número do pedido',\n    },\n    column_dtt_ord: {\n      it: 'Data Ordine',\n      en: 'Order date',\n      de: 'Bestelldatum',\n      fr: 'Date de commande',\n      es: 'Fecha de pedido',\n      pt: 'Data do pedido',\n    },\n    column_cds_caum: {\n      it: 'Causale',\n      en: 'Reason',\n      de: 'Grund',\n      fr: 'Motif',\n      es: 'Causal',\n      pt: 'Causa',\n    },\n    column_cky_cnt_clfr: {\n      it: 'Codice cliente',\n      en: 'Customer code',\n      de: 'Kundencode',\n      fr: 'Code client',\n      es: 'Código cliente',\n      pt: 'Código do cliente',\n    },\n    column_cds_cnt_ragsoc: {\n      it: 'Ragione Sociale',\n      en: 'Company name',\n      de: 'Firmenname',\n      fr: 'Raison sociale',\n      es: 'Razón social',\n      pt: 'Razão social',\n    },\n    column_nome_agente: {\n      it: 'Agente',\n      en: 'Agent',\n      de: 'Vertreter',\n      fr: 'Agent',\n      es: 'Agente',\n      pt: 'Agente',\n    },\n    column_cky_art: {\n      it: 'Codice Articolo',\n      en: 'Item code',\n      de: 'Artikelcode',\n      fr: \"Code de l'article\",\n      es: 'Código artículo',\n      pt: 'Código do artigo',\n    },\n    column_descrizione_art: {\n      it: 'Articolo',\n      en: 'Item',\n      de: 'Artikel',\n      fr: 'Article',\n      es: 'Artículo',\n      pt: 'Artigo',\n    },\n    column_quantita: {\n      it: 'Quantità',\n      en: 'Quantity',\n      de: 'Menge',\n      fr: 'Quantité',\n      es: 'Cantidad',\n      pt: 'Quantidade',\n    },\n    column_valore: {\n      it: 'Valore',\n      en: 'Value',\n      de: 'Wert',\n      fr: 'Valeur',\n      es: 'Valor',\n      pt: 'Valor',\n    },\n    column_sigla_trasf: {\n      it: 'Sigla Doc Magazzino',\n      en: 'Warehouse doc code',\n      de: 'Lagerbeleg-Kürzel',\n      fr: 'Code doc magasin',\n      es: 'Sigla doc almacén',\n      pt: 'Sigla doc armazém',\n    },\n    column_numero_trasf: {\n      it: 'Numero Doc Magazzino',\n      en: 'Warehouse doc number',\n      de: 'Lagerbelegnummer',\n      fr: 'Numéro doc magasin',\n      es: 'Número doc almacén',\n      pt: 'Número doc armazém',\n    },\n    column_data_trasf: {\n      it: 'Data trasf',\n      en: 'Transfer date',\n      de: 'Transferdatum',\n      fr: 'Date transfert',\n      es: 'Fecha transf',\n      pt: 'Data transf',\n    },\n    column_origne: {\n      it: 'Evaso o In Ordine',\n      en: 'Fulfilled or On order',\n      de: 'Erledigt oder in Bestellung',\n      fr: 'Livré ou en commande',\n      es: 'Servido o en pedido',\n      pt: 'Atendido ou em pedido',\n    },\n    column_sco_1: {\n      it: 'Sco 1',\n      en: 'Disc 1',\n      de: 'Rabatt 1',\n      fr: 'Rem 1',\n      es: 'Dto 1',\n      pt: 'Desc 1',\n    },\n    column_sco_2: {\n      it: 'Sco 2',\n      en: 'Disc 2',\n      de: 'Rabatt 2',\n      fr: 'Rem 2',\n      es: 'Dto 2',\n      pt: 'Desc 2',\n    },\n    column_sco_3: {\n      it: 'Sco 3',\n      en: 'Disc 3',\n      de: 'Rabatt 3',\n      fr: 'Rem 3',\n      es: 'Dto 3',\n      pt: 'Desc 3',\n    },\n    column_npz_unit: {\n      it: 'Prezzo Unitario',\n      en: 'Unit price',\n      de: 'Einzelpreis',\n      fr: 'Prix unitaire',\n      es: 'Precio unitario',\n      pt: 'Preço unitário',\n    },\n  },\n};\n\nfunction getColumnLabelFromField(field: string | undefined, language: string): string {\n  if (!field) return '';\n  const key = `column_${field.replace(/`/g, '').replace(/\\s+/g, '_').toLowerCase()}`;\n  const colObj = (TEXTS.columns as any)[key];\n  if (colObj) {\n    return colObj[language] || colObj.it;\n  }\n  return field;\n}\n\ninterface ReportTableProps {\n  data: any[] | GroupedDataNode[];\n  columns: ReportColumn[];\n  aggregates?: Record<string, any>;\n  language?: string;\n  isGrouped?: boolean;\n  groupingConfig?: any[];\n}\n\nexport default function ReportTable({\n  data,\n  columns,\n  aggregates,\n  language = 'it',\n  isGrouped = false,\n  groupingConfig = [],\n}: ReportTableProps) {\n  const getInitialExpandedGroups = () => {\n    const shouldExpandAll =\n      groupingConfig.length > 0 && groupingConfig[0].collapsed === false;\n\n    if (shouldExpandAll && isGrouped && data.length > 0) {\n      const all = new Set<string>();\n      const collect = (nodes: any[]) => {\n        nodes.forEach((n) => {\n          if ('groupKey' in n) {\n            all.add(n.groupKey);\n            if (n.children?.length) collect(n.children);\n          }\n        });\n      };\n      collect(data as GroupedDataNode[]);\n      return all;\n    }\n    return new Set<string>();\n  };\n\n  const [expandedGroups, setExpandedGroups] = useState<Set<string>>(getInitialExpandedGroups());\n  const [showOnlyPending, setShowOnlyPending] = useState(false);\n  const [columnWidths, setColumnWidths] = useState<Record<string, number>>({});\n\n  const visibleColumns = columns.filter((c) => c.visible);\n\n  const statusColumn = columns.find((c) => (c.field || '').toLowerCase().includes('stato'));\n\n  useEffect(() => {\n    setExpandedGroups(getInitialExpandedGroups());\n  }, [data, groupingConfig]);\n\n  useEffect(() => {\n    const widths: Record<string, number> = {};\n    const sampleRows: any[] = Array.isArray(data)\n      ? data.filter((r) => !('groupKey' in r)).slice(0, 10)\n      : [];\n\n    visibleColumns.forEach((col) => {\n      const label = getColumnLabelFromField(col.field, language);\n      let maxLen = (label || col.field || '').length;\n\n      sampleRows.forEach((row) => {\n        const val = row[col.field];\n        const str = val == null ? '' : String(val);\n        if (str.length > maxLen) maxLen = str.length;\n      });\n\n      let px = maxLen * 8 + 28;\n      const isTexty =\n        label.toLowerCase().includes('descr') || label.toLowerCase().includes('articolo');\n      const min = isTexty ? 160 : 90;\n      const max = isTexty ? 360 : 180;\n      if (px < min) px = min;\n      if (px > max) px = max;\n\n      widths[col.field] = px;\n    });\n\n    setColumnWidths(widths);\n  }, [data, columns, language, visibleColumns]);\n\n  const toggleGroup = (groupKey: string) => {\n    const next = new Set(expandedGroups);\n    if (next.has(groupKey)) next.delete(groupKey);\n    else next.add(groupKey);\n    setExpandedGroups(next);\n  };\n\n  const getGroupDeliveryInfo = (node: GroupedDataNode) => {\n    let total = 0;\n    let delivered = 0;\n\n    const scan = (items: any[]) => {\n      items.forEach((it) => {\n        if ('groupKey' in it) {\n          if (it.children?.length) scan(it.children);\n        } else {\n          total++;\n          if (statusColumn) {\n            const raw = (it[statusColumn.field] || '').toString().trim().toUpperCase();\n            if (raw === 'EVASO' || raw === 'CONSEGNATO') delivered++;\n          }\n        }\n      });\n    };\n\n    if (node.children?.length) scan(node.children);\n\n    const perc = total > 0 ? Math.round((delivered / total) * 100) : 0;\n    return { total, delivered, perc };\n  };\n\n  const filteredData = (() => {\n    if (!showOnlyPending) return data;\n    if (isGrouped && Array.isArray(data) && data.length > 0 && 'groupKey' in data[0]) {\n      return (data as GroupedDataNode[]).filter((node) => {\n        const { perc } = getGroupDeliveryInfo(node);\n        return perc < 100;\n      });\n    }\n    if (Array.isArray(data)) {\n      return data.filter((row: any) => {\n        if (!statusColumn) return true;\n        const raw = (row[statusColumn.field] || '').toString().trim().toUpperCase();\n        return !(raw === 'EVASO' || raw === 'CONSEGNATO');\n      });\n    }\n    return data;\n  })();\n\n  const renderStatusBadge = (raw: any) => {\n    const txt = (raw || '').toString().trim().toUpperCase();\n    const delivered = txt === 'EVASO' || txt === 'CONSEGNATO';\n    return (\n      <span\n        className={`inline-flex items-center px-2 py-[2px] rounded-full text-[11px] font-semibold ${\n          delivered\n            ? 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200'\n            : 'bg-sky-100 text-sky-700 ring-1 ring-sky-200'\n        }`}\n      >\n        {delivered\n          ? TEXTS.statusDelivered[language as keyof typeof TEXTS.statusDelivered]\n          : TEXTS.statusInOrder[language as keyof typeof TEXTS.statusInOrder]}\n      </span>\n    );\n  };\n\n  const renderDataRow = (row: any, idx: number) => {\n    return (\n      <div\n        key={idx}\n        className=\"flex border-b border-slate-100 hover:bg-slate-50/80 transition-colors duration-150\"\n      >\n        {visibleColumns.map((col) => {\n          const width = columnWidths[col.field] || 120;\n          if (statusColumn && col.field === statusColumn.field) {\n            return (\n              <div key={col.field} className=\"px-3 py-2 flex items-center\" style={{ width, minWidth: width }}>\n                {renderStatusBadge(row[col.field])}\n              </div>\n            );\n          }\n          return (\n            <div\n              key={col.field}\n              className={`px-3 py-2 text-xs text-slate-800 ${\n                col.align === 'right' ? 'text-right' : 'text-left'\n              } overflow-hidden text-ellipsis whitespace-nowrap`}\n              style={{ width, minWidth: width }}\n              title={row[col.field] != null ? String(row[col.field]) : ''}\n            >\n              {ReportEngine.formatValue(row[col.field], col, language)}\n            </div>\n          );\n        })}\n      </div>\n    );\n  };\n\n  const renderGroupedRow = (node: GroupedDataNode, index: number) => {\n    const isExpanded = expandedGroups.has(node.groupKey);\n    const hasChildren = node.children.length > 0;\n    const { total, delivered, perc } = getGroupDeliveryInfo(node);\n\n    let badgeClass = 'bg-orange-100 text-orange-800';\n    let barClass = 'bg-orange-500';\n    if (perc >= 75) {\n      badgeClass = 'bg-emerald-100 text-emerald-700';\n      barClass = 'bg-emerald-500';\n    } else if (perc >= 26) {\n      badgeClass = 'bg-amber-100 text-amber-800';\n      barClass = 'bg-amber-400';\n    }\n\n    return (\n      <div key={`${node.groupKey}-${index}`} className=\"bg-white\">\n        <div\n          className=\"flex items-center justify-between border-b border-sky-200 bg-gradient-to-r from-sky-100 to-sky-50 hover:from-sky-200/80 hover:to-sky-100/80 cursor-pointer px-4 py-2.5\"\n          onClick={() => hasChildren && toggleGroup(node.groupKey)}\n        >\n          <div className=\"flex items-center gap-2\">\n            {hasChildren && (\n              <span className=\"rounded-full bg-white/90 p-1 shadow-sm\">\n                {isExpanded ? (\n                  <ChevronDown className=\"w-4 h-4 text-sky-700\" />\n                ) : (\n                  <ChevronRight className=\"w-4 h-4 text-sky-700\" />\n                )}\n              </span>\n            )}\n            <span className=\"text-sm font-bold text-sky-950\">\n              {TEXTS.labelOrder[language as keyof typeof TEXTS.labelOrder]}: {node.groupLabel}\n            </span>\n            <span className={`text-[11px] font-semibold px-2 py-[1px] rounded-full ${badgeClass}`}>\n              {perc}% {TEXTS.labelDelivered[language as keyof typeof TEXTS.labelDelivered]}\n            </span>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <span className=\"text-xs font-bold text-sky-900\">\n              {TEXTS.labelFulfilled[language as keyof typeof TEXTS.labelFulfilled]} {delivered}/{total}\n            </span>\n            <div className=\"w-28 h-2.5 bg-slate-200 rounded-full overflow-hidden shadow-inner\">\n              <div className={`h-2.5 transition-all ${barClass}`} style={{ width: `${perc}%` }} />\n            </div>\n          </div>\n        </div>\n\n        {isExpanded && hasChildren && (\n          <div className=\"border-l border-slate-100\">\n            {node.children.map((child: any, i: number) =>\n              'groupKey' in child ? renderGroupedRow(child, i) : renderDataRow(child, i)\n            )}\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"bg-white/50 backdrop-blur-sm rounded-2xl shadow-md border border-slate-100 overflow-hidden flex flex-col max-h-[72vh]\">\n      {/* header tabella */}\n      <div className=\"flex items-center justify-between px-4 py-3 bg-white/80 border-b border-slate-100\">\n        <button\n          type=\"button\"\n          onClick={() => setShowOnlyPending((p) => !p)}\n          className={`inline-flex items-center gap-2 text-sm font-semibold rounded-full px-4 py-1.5 transition ${\n            showOnlyPending\n              ? 'bg-sky-600 text-white shadow-sm'\n              : 'bg-slate-200 text-slate-700 hover:bg-slate-300'\n          }`}\n        >\n          <span className=\"text-xs\">●</span>\n          {TEXTS.buttonShowOnlyPending[language as keyof typeof TEXTS.buttonShowOnlyPending]}\n        </button>\n\n        <div className=\"flex items-center gap-2\">\n          <button\n            type=\"button\"\n            className=\"px-3 py-1.5 rounded-md bg-slate-100 text-slate-700 text-xs hover:bg-slate-200 shadow-sm\"\n          >\n            {TEXTS.buttonExcel[language as keyof typeof TEXTS.buttonExcel]}\n          </button>\n          <button\n            type=\"button\"\n            className=\"px-3 py-1.5 rounded-md bg-slate-100 text-slate-700 text-xs hover:bg-slate-200 shadow-sm\"\n          >\n            {TEXTS.buttonPDF[language as keyof typeof TEXTS.buttonPDF]}\n          </button>\n        </div>\n      </div>\n\n      {/* intestazione colonne */}\n      <div className=\"flex border-b border-slate-200 bg-slate-100/90 sticky top-0 z-10\">\n        {visibleColumns.map((col) => {\n          const width = columnWidths[col.field] || 120;\n          return (\n            <div\n              key={col.field}\n              className={`px-3 py-2 text-[11px] font-semibold text-slate-700 uppercase tracking-wide ${\n                col.align === 'right' ? 'text-right' : 'text-left'\n              } overflow-hidden text-ellipsis whitespace-nowrap`}\n              style={{ width, minWidth: width }}\n            >\n              {getColumnLabelFromField(col.field, language)}\n            </div>\n          );\n        })}\n      </div>\n\n      {/* corpo tabella */}\n      <div className=\"flex-1 overflow-auto\">\n        {filteredData.length === 0 ? (\n          <div className=\"px-6 py-12 text-center text-slate-400 text-sm\">\n            {TEXTS.messageNoDocuments[language as keyof typeof TEXTS.messageNoDocuments]}\n          </div>\n        ) : isGrouped && 'groupKey' in filteredData[0] ? (\n          (filteredData as GroupedDataNode[]).map((node, idx) => renderGroupedRow(node, idx))\n        ) : (\n          (filteredData as any[]).map((row, idx) => renderDataRow(row, idx))\n        )}\n      </div>\n\n      {/* footer totali */}\n      {aggregates && Object.keys(aggregates).length > 0 && (\n        <div className=\"flex border-t border-slate-200 bg-blue-50/80\">\n          {visibleColumns.map((col, idx) => {\n            const width = columnWidths[col.field] || 120;\n            return (\n              <div\n                key={col.field}\n                className={`px-3 py-2 text-xs ${\n                  col.align === 'right' ? 'text-right' : 'text-left'\n                } overflow-hidden text-ellipsis whitespace-nowrap`}\n                style={{ width, minWidth: width }}\n              >\n                {idx === 0 ? (\n                  <span className=\"font-bold text-slate-900\">\n                    {TEXTS.labelTotal[language as keyof typeof TEXTS.labelTotal]}\n                  </span>\n                ) : col.aggregate && aggregates[col.field] !== undefined ? (\n                  <span className=\"font-bold text-slate-900\">\n                    {ReportEngine.formatValue(aggregates[col.field], col, language)}\n                  </span>\n                ) : null}\n              </div>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v28",
        "timestamp": "2025-11-09T07:49:10.014Z",
        "note": "Modifica 09/11/2025, 08:49:09",
        "code": "// ============================================================\n// COMPONENTE: ReportTable\n// FILE: components/reports/ReportTable.tsx\n// ============================================================\n\n'use client';\n\nimport { useState, useEffect, useMemo } from 'react';\nimport { ReportColumn, GroupedDataNode } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { ChevronDown, ChevronRight } from 'lucide-react';\n\nconst TEXTS = {\n  // ----------------------------------------------------------\n  // Bottoni / messaggi di sistema\n  // ----------------------------------------------------------\n  buttonShowOnlyPending: {\n    it: 'Mostra solo da consegnare',\n    en: 'Show only pending',\n    de: 'Nur ausstehende anzeigen',\n    fr: 'Afficher uniquement en attente',\n    es: 'Mostrar solo pendientes',\n    pt: 'Mostrar apenas pendentes',\n  },\n  buttonExcel: {\n    it: 'Excel',\n    en: 'Excel',\n    de: 'Excel',\n    fr: 'Excel',\n    es: 'Excel',\n    pt: 'Excel',\n  },\n  buttonPDF: {\n    it: 'PDF',\n    en: 'PDF',\n    de: 'PDF',\n    fr: 'PDF',\n    es: 'PDF',\n    pt: 'PDF',\n  },\n  messageNoDocuments: {\n    it: 'Nessun documento trovato',\n    en: 'No documents found',\n    de: 'Keine Dokumente gefunden',\n    fr: 'Aucun document trouvé',\n    es: 'No se encontraron documentos',\n    pt: 'Nenhum documento encontrado',\n  },\n  labelTotal: {\n    it: 'TOTALE',\n    en: 'TOTAL',\n    de: 'GESAMT',\n    fr: 'TOTAL',\n    es: 'TOTAL',\n    pt: 'TOTAL',\n  },\n\n  // ----------------------------------------------------------\n  // Stato righe\n  // ----------------------------------------------------------\n  statusDelivered: {\n    it: 'CONSEGNATO',\n    en: 'DELIVERED',\n    de: 'GELIEFERT',\n    fr: 'LIVRÉ',\n    es: 'ENTREGADO',\n    pt: 'ENTREGUE',\n  },\n  statusInOrder: {\n    it: 'IN ORDINE',\n    en: 'IN ORDER',\n    de: 'IN AUFTRAG',\n    fr: 'EN COMMANDE',\n    es: 'EN PEDIDO',\n    pt: 'EM PEDIDO',\n  },\n\n  // ----------------------------------------------------------\n  // Raggruppamenti\n  // ----------------------------------------------------------\n  labelOrder: {\n    it: 'Ordine',\n    en: 'Order',\n    de: 'Bestellung',\n    fr: 'Commande',\n    es: 'Pedido',\n    pt: 'Pedido',\n  },\n  labelDelivered: {\n    it: 'consegnato',\n    en: 'delivered',\n    de: 'geliefert',\n    fr: 'livré',\n    es: 'entregado',\n    pt: 'entregue',\n  },\n  labelFulfilled: {\n    it: 'Evasi',\n    en: 'Fulfilled',\n    de: 'Erfüllt',\n    fr: 'Traités',\n    es: 'Cumplidos',\n    pt: 'Cumpridos',\n  },\n\n  // ----------------------------------------------------------\n  // COLONNE DINAMICHE\n  // ----------------------------------------------------------\n  columns: {\n    column_data: {\n      it: 'Data',\n      en: 'Date',\n      de: 'Datum',\n      fr: 'Date',\n      es: 'Fecha',\n      pt: 'Data',\n    },\n    column_tipo_documento: {\n      it: 'Tipo Documento',\n      en: 'Document type',\n      de: 'Belegart',\n      fr: 'Type de document',\n      es: 'Tipo de documento',\n      pt: 'Tipo de documento',\n    },\n    column_tipo: {\n      it: 'Tipo',\n      en: 'Type',\n      de: 'Typ',\n      fr: 'Type',\n      es: 'Tipo',\n      pt: 'Tipo',\n    },\n    column_numero: {\n      it: 'Numero',\n      en: 'Number',\n      de: 'Nummer',\n      fr: 'Numéro',\n      es: 'Número',\n      pt: 'Número',\n    },\n    column_descrizione: {\n      it: 'Descrizione',\n      en: 'Description',\n      de: 'Beschreibung',\n      fr: 'Description',\n      es: 'Descripción',\n      pt: 'Descrição',\n    },\n    column_stato: {\n      it: 'Stato',\n      en: 'Status',\n      de: 'Status',\n      fr: 'Statut',\n      es: 'Estado',\n      pt: 'Estado',\n    },\n    column_totale: {\n      it: 'Importo',\n      en: 'Amount',\n      de: 'Betrag',\n      fr: 'Montant',\n      es: 'Importe',\n      pt: 'Valor',\n    },\n    column_valuta: {\n      it: 'Valuta',\n      en: 'Currency',\n      de: 'Währung',\n      fr: 'Devise',\n      es: 'Moneda',\n      pt: 'Moeda',\n    },\n    column_anno: {\n      it: 'Anno',\n      en: 'Year',\n      de: 'Jahr',\n      fr: 'Année',\n      es: 'Año',\n      pt: 'Ano',\n    },\n    column_ngl_doc_ord: {\n      it: 'Numero Ordine',\n      en: 'Order number',\n      de: 'Bestellnummer',\n      fr: 'Numéro de commande',\n      es: 'Número de pedido',\n      pt: 'Número do pedido',\n    },\n    column_dtt_ord: {\n      it: 'Data Ordine',\n      en: 'Order date',\n      de: 'Bestelldatum',\n      fr: 'Date de commande',\n      es: 'Fecha de pedido',\n      pt: 'Data do pedido',\n    },\n    column_cds_caum: {\n      it: 'Causale',\n      en: 'Reason',\n      de: 'Grund',\n      fr: 'Motif',\n      es: 'Causal',\n      pt: 'Causa',\n    },\n    column_cky_cnt_clfr: {\n      it: 'Codice cliente',\n      en: 'Customer code',\n      de: 'Kundencode',\n      fr: 'Code client',\n      es: 'Código cliente',\n      pt: 'Código do cliente',\n    },\n    column_cds_cnt_ragsoc: {\n      it: 'Ragione Sociale',\n      en: 'Company name',\n      de: 'Firmenname',\n      fr: 'Raison sociale',\n      es: 'Razón social',\n      pt: 'Razão social',\n    },\n    column_nome_agente: {\n      it: 'Agente',\n      en: 'Agent',\n      de: 'Vertreter',\n      fr: 'Agent',\n      es: 'Agente',\n      pt: 'Agente',\n    },\n    column_cky_art: {\n      it: 'Codice Articolo',\n      en: 'Item code',\n      de: 'Artikelcode',\n      fr: \"Code de l'article\",\n      es: 'Código artículo',\n      pt: 'Código do artigo',\n    },\n    column_descrizione_art: {\n      it: 'Articolo',\n      en: 'Item',\n      de: 'Artikel',\n      fr: 'Article',\n      es: 'Artículo',\n      pt: 'Artigo',\n    },\n    column_quantita: {\n      it: 'Quantità',\n      en: 'Quantity',\n      de: 'Menge',\n      fr: 'Quantité',\n      es: 'Cantidad',\n      pt: 'Quantidade',\n    },\n    column_valore: {\n      it: 'Valore',\n      en: 'Value',\n      de: 'Wert',\n      fr: 'Valeur',\n      es: 'Valor',\n      pt: 'Valor',\n    },\n    column_sigla_trasf: {\n      it: 'Sigla Doc Magazzino',\n      en: 'Warehouse doc code',\n      de: 'Lagerbeleg-Kürzel',\n      fr: 'Code doc magasin',\n      es: 'Sigla doc almacén',\n      pt: 'Sigla doc armazém',\n    },\n    column_numero_trasf: {\n      it: 'Numero Doc Magazzino',\n      en: 'Warehouse doc number',\n      de: 'Lagerbelegnummer',\n      fr: 'Numéro doc magasin',\n      es: 'Número doc almacén',\n      pt: 'Número doc armazém',\n    },\n    column_data_trasf: {\n      it: 'Data trasf',\n      en: 'Transfer date',\n      de: 'Transferdatum',\n      fr: 'Date transfert',\n      es: 'Fecha transf',\n      pt: 'Data transf',\n    },\n    column_origne: {\n      it: 'Evaso o In Ordine',\n      en: 'Fulfilled or On order',\n      de: 'Erledigt oder in Bestellung',\n      fr: 'Livré ou en commande',\n      es: 'Servido o en pedido',\n      pt: 'Atendido ou em pedido',\n    },\n    column_sco_1: {\n      it: 'Sco 1',\n      en: 'Disc 1',\n      de: 'Rabatt 1',\n      fr: 'Rem 1',\n      es: 'Dto 1',\n      pt: 'Desc 1',\n    },\n    column_sco_2: {\n      it: 'Sco 2',\n      en: 'Disc 2',\n      de: 'Rabatt 2',\n      fr: 'Rem 2',\n      es: 'Dto 2',\n      pt: 'Desc 2',\n    },\n    column_sco_3: {\n      it: 'Sco 3',\n      en: 'Disc 3',\n      de: 'Rabatt 3',\n      fr: 'Rem 3',\n      es: 'Dto 3',\n      pt: 'Desc 3',\n    },\n    column_npz_unit: {\n      it: 'Prezzo Unitario',\n      en: 'Unit price',\n      de: 'Einzelpreis',\n      fr: 'Prix unitaire',\n      es: 'Precio unitario',\n      pt: 'Preço unitário',\n    },\n  },\n};\n\nfunction getColumnLabelFromField(field: string | undefined, language: string): string {\n  if (!field) return '';\n  const key = `column_${field.replace(/`/g, '').replace(/\\s+/g, '_').toLowerCase()}`;\n  const colObj = (TEXTS.columns as any)[key];\n  if (colObj) {\n    return colObj[language] || colObj.it;\n  }\n  return field;\n}\n\ninterface ReportTableProps {\n  data: any[] | GroupedDataNode[];\n  columns: ReportColumn[];\n  aggregates?: Record<string, any>;\n  language?: string;\n  isGrouped?: boolean;\n  groupingConfig?: any[];\n}\n\nexport default function ReportTable({\n  data,\n  columns,\n  aggregates,\n  language = 'it',\n  isGrouped = false,\n  groupingConfig = [],\n}: ReportTableProps) {\n  const getInitialExpandedGroups = () => {\n    const shouldExpandAll =\n      groupingConfig.length > 0 && groupingConfig[0].collapsed === false;\n\n    if (shouldExpandAll && isGrouped && data.length > 0) {\n      const all = new Set<string>();\n      const collect = (nodes: any[]) => {\n        nodes.forEach((n) => {\n          if ('groupKey' in n) {\n            all.add(n.groupKey);\n            if (n.children?.length) collect(n.children);\n          }\n        });\n      };\n      collect(data as GroupedDataNode[]);\n      return all;\n    }\n    return new Set<string>();\n  };\n\n  const [expandedGroups, setExpandedGroups] = useState<Set<string>>(getInitialExpandedGroups());\n  const [showOnlyPending, setShowOnlyPending] = useState(false);\n  const [columnWidths, setColumnWidths] = useState<Record<string, number>>({});\n\n  const visibleColumns = useMemo(() => columns.filter((c) => c.visible), [columns]);\n\n  const statusColumn = columns.find((c) => (c.field || '').toLowerCase().includes('stato'));\n\n  useEffect(() => {\n    setExpandedGroups(getInitialExpandedGroups());\n  }, [data, groupingConfig]);\n\n  useEffect(() => {\n    const widths: Record<string, number> = {};\n    const sampleRows: any[] = Array.isArray(data)\n      ? data.filter((r) => !('groupKey' in r)).slice(0, 10)\n      : [];\n\n    visibleColumns.forEach((col) => {\n      const label = getColumnLabelFromField(col.field, language);\n      let maxLen = (label || col.field || '').length;\n\n      sampleRows.forEach((row) => {\n        const val = row[col.field];\n        const str = val == null ? '' : String(val);\n        if (str.length > maxLen) maxLen = str.length;\n      });\n\n      let px = maxLen * 8 + 28;\n      const isTexty =\n        label.toLowerCase().includes('descr') || label.toLowerCase().includes('articolo');\n      const min = isTexty ? 160 : 90;\n      const max = isTexty ? 360 : 180;\n      if (px < min) px = min;\n      if (px > max) px = max;\n\n      widths[col.field] = px;\n    });\n\n    setColumnWidths(widths);\n  }, [data, columns, language, visibleColumns]);\n\n  const toggleGroup = (groupKey: string) => {\n    const next = new Set(expandedGroups);\n    if (next.has(groupKey)) next.delete(groupKey);\n    else next.add(groupKey);\n    setExpandedGroups(next);\n  };\n\n  const getGroupDeliveryInfo = (node: GroupedDataNode) => {\n    let total = 0;\n    let delivered = 0;\n\n    const scan = (items: any[]) => {\n      items.forEach((it) => {\n        if ('groupKey' in it) {\n          if (it.children?.length) scan(it.children);\n        } else {\n          total++;\n          if (statusColumn) {\n            const raw = (it[statusColumn.field] || '').toString().trim().toUpperCase();\n            if (raw === 'EVASO' || raw === 'CONSEGNATO') delivered++;\n          }\n        }\n      });\n    };\n\n    if (node.children?.length) scan(node.children);\n\n    const perc = total > 0 ? Math.round((delivered / total) * 100) : 0;\n    return { total, delivered, perc };\n  };\n\n  const filteredData = (() => {\n    if (!showOnlyPending) return data;\n    if (isGrouped && Array.isArray(data) && data.length > 0 && 'groupKey' in data[0]) {\n      return (data as GroupedDataNode[]).filter((node) => {\n        const { perc } = getGroupDeliveryInfo(node);\n        return perc < 100;\n      });\n    }\n    if (Array.isArray(data)) {\n      return data.filter((row: any) => {\n        if (!statusColumn) return true;\n        const raw = (row[statusColumn.field] || '').toString().trim().toUpperCase();\n        return !(raw === 'EVASO' || raw === 'CONSEGNATO');\n      });\n    }\n    return data;\n  })();\n\n  const renderStatusBadge = (raw: any) => {\n    const txt = (raw || '').toString().trim().toUpperCase();\n    const delivered = txt === 'EVASO' || txt === 'CONSEGNATO';\n    return (\n      <span\n        className={`inline-flex items-center px-2 py-[2px] rounded-full text-[11px] font-semibold ${\n          delivered\n            ? 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200'\n            : 'bg-sky-100 text-sky-700 ring-1 ring-sky-200'\n        }`}\n      >\n        {delivered\n          ? TEXTS.statusDelivered[language as keyof typeof TEXTS.statusDelivered]\n          : TEXTS.statusInOrder[language as keyof typeof TEXTS.statusInOrder]}\n      </span>\n    );\n  };\n\n  const renderDataRow = (row: any, idx: number) => {\n    return (\n      <div\n        key={idx}\n        className=\"flex border-b border-slate-100 hover:bg-slate-50/80 transition-colors duration-150\"\n      >\n        {visibleColumns.map((col) => {\n          const width = columnWidths[col.field] || 120;\n          if (statusColumn && col.field === statusColumn.field) {\n            return (\n              <div key={col.field} className=\"px-3 py-2 flex items-center\" style={{ width, minWidth: width }}>\n                {renderStatusBadge(row[col.field])}\n              </div>\n            );\n          }\n          return (\n            <div\n              key={col.field}\n              className={`px-3 py-2 text-xs text-slate-800 ${\n                col.align === 'right' ? 'text-right' : 'text-left'\n              } overflow-hidden text-ellipsis whitespace-nowrap`}\n              style={{ width, minWidth: width }}\n              title={row[col.field] != null ? String(row[col.field]) : ''}\n            >\n              {ReportEngine.formatValue(row[col.field], col, language)}\n            </div>\n          );\n        })}\n      </div>\n    );\n  };\n\n  const renderGroupedRow = (node: GroupedDataNode, index: number) => {\n    const isExpanded = expandedGroups.has(node.groupKey);\n    const hasChildren = node.children.length > 0;\n    const { total, delivered, perc } = getGroupDeliveryInfo(node);\n\n    let badgeClass = 'bg-orange-100 text-orange-800';\n    let barClass = 'bg-orange-500';\n    if (perc >= 75) {\n      badgeClass = 'bg-emerald-100 text-emerald-700';\n      barClass = 'bg-emerald-500';\n    } else if (perc >= 26) {\n      badgeClass = 'bg-amber-100 text-amber-800';\n      barClass = 'bg-amber-400';\n    }\n\n    return (\n      <div key={`${node.groupKey}-${index}`} className=\"bg-white\">\n        <div\n          className=\"flex items-center justify-between border-b border-sky-200 bg-gradient-to-r from-sky-100 to-sky-50 hover:from-sky-200/80 hover:to-sky-100/80 cursor-pointer px-4 py-2.5\"\n          onClick={() => hasChildren && toggleGroup(node.groupKey)}\n        >\n          <div className=\"flex items-center gap-2\">\n            {hasChildren && (\n              <span className=\"rounded-full bg-white/90 p-1 shadow-sm\">\n                {isExpanded ? (\n                  <ChevronDown className=\"w-4 h-4 text-sky-700\" />\n                ) : (\n                  <ChevronRight className=\"w-4 h-4 text-sky-700\" />\n                )}\n              </span>\n            )}\n            <span className=\"text-sm font-bold text-sky-950\">\n              {TEXTS.labelOrder[language as keyof typeof TEXTS.labelOrder]}: {node.groupLabel}\n            </span>\n            <span className={`text-[11px] font-semibold px-2 py-[1px] rounded-full ${badgeClass}`}>\n              {perc}% {TEXTS.labelDelivered[language as keyof typeof TEXTS.labelDelivered]}\n            </span>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <span className=\"text-xs font-bold text-sky-900\">\n              {TEXTS.labelFulfilled[language as keyof typeof TEXTS.labelFulfilled]} {delivered}/{total}\n            </span>\n            <div className=\"w-28 h-2.5 bg-slate-200 rounded-full overflow-hidden shadow-inner\">\n              <div className={`h-2.5 transition-all ${barClass}`} style={{ width: `${perc}%` }} />\n            </div>\n          </div>\n        </div>\n\n        {isExpanded && hasChildren && (\n          <div className=\"border-l border-slate-100\">\n            {node.children.map((child: any, i: number) =>\n              'groupKey' in child ? renderGroupedRow(child, i) : renderDataRow(child, i)\n            )}\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"bg-white/50 backdrop-blur-sm rounded-2xl shadow-md border border-slate-100 overflow-hidden flex flex-col max-h-[72vh]\">\n      {/* header tabella */}\n      <div className=\"flex items-center justify-between px-4 py-3 bg-white/80 border-b border-slate-100\">\n        <button\n          type=\"button\"\n          onClick={() => setShowOnlyPending((p) => !p)}\n          className={`inline-flex items-center gap-2 text-sm font-semibold rounded-full px-4 py-1.5 transition ${\n            showOnlyPending\n              ? 'bg-sky-600 text-white shadow-sm'\n              : 'bg-slate-200 text-slate-700 hover:bg-slate-300'\n          }`}\n        >\n          <span className=\"text-xs\">●</span>\n          {TEXTS.buttonShowOnlyPending[language as keyof typeof TEXTS.buttonShowOnlyPending]}\n        </button>\n\n        <div className=\"flex items-center gap-2\">\n          <button\n            type=\"button\"\n            className=\"px-3 py-1.5 rounded-md bg-slate-100 text-slate-700 text-xs hover:bg-slate-200 shadow-sm\"\n          >\n            {TEXTS.buttonExcel[language as keyof typeof TEXTS.buttonExcel]}\n          </button>\n          <button\n            type=\"button\"\n            className=\"px-3 py-1.5 rounded-md bg-slate-100 text-slate-700 text-xs hover:bg-slate-200 shadow-sm\"\n          >\n            {TEXTS.buttonPDF[language as keyof typeof TEXTS.buttonPDF]}\n          </button>\n        </div>\n      </div>\n\n      {/* intestazione colonne */}\n      <div className=\"flex border-b border-slate-200 bg-slate-100/90 sticky top-0 z-10\">\n        {visibleColumns.map((col) => {\n          const width = columnWidths[col.field] || 120;\n          return (\n            <div\n              key={col.field}\n              className={`px-3 py-2 text-[11px] font-semibold text-slate-700 uppercase tracking-wide ${\n                col.align === 'right' ? 'text-right' : 'text-left'\n              } overflow-hidden text-ellipsis whitespace-nowrap`}\n              style={{ width, minWidth: width }}\n            >\n              {getColumnLabelFromField(col.field, language)}\n            </div>\n          );\n        })}\n      </div>\n\n      {/* corpo tabella */}\n      <div className=\"flex-1 overflow-auto\">\n        {filteredData.length === 0 ? (\n          <div className=\"px-6 py-12 text-center text-slate-400 text-sm\">\n            {TEXTS.messageNoDocuments[language as keyof typeof TEXTS.messageNoDocuments]}\n          </div>\n        ) : isGrouped && 'groupKey' in filteredData[0] ? (\n          (filteredData as GroupedDataNode[]).map((node, idx) => renderGroupedRow(node, idx))\n        ) : (\n          (filteredData as any[]).map((row, idx) => renderDataRow(row, idx))\n        )}\n      </div>\n\n      {/* footer totali */}\n      {aggregates && Object.keys(aggregates).length > 0 && (\n        <div className=\"flex border-t border-slate-200 bg-blue-50/80\">\n          {visibleColumns.map((col, idx) => {\n            const width = columnWidths[col.field] || 120;\n            return (\n              <div\n                key={col.field}\n                className={`px-3 py-2 text-xs ${\n                  col.align === 'right' ? 'text-right' : 'text-left'\n                } overflow-hidden text-ellipsis whitespace-nowrap`}\n                style={{ width, minWidth: width }}\n              >\n                {idx === 0 ? (\n                  <span className=\"font-bold text-slate-900\">\n                    {TEXTS.labelTotal[language as keyof typeof TEXTS.labelTotal]}\n                  </span>\n                ) : col.aggregate && aggregates[col.field] !== undefined ? (\n                  <span className=\"font-bold text-slate-900\">\n                    {ReportEngine.formatValue(aggregates[col.field], col, language)}\n                  </span>\n                ) : null}\n              </div>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n\n// ============================================================\n// COMPONENTE: ReportFilters\n// FILE: components/reports/ReportFilters.tsx\n// ============================================================\n\n'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { ReportFilter } from '@/types/report';\nimport { Filter, X } from 'lucide-react';\n\nconst TEXTS_FILTERS = {\n  filters: {\n    it: 'Filtri',\n    en: 'Filters',\n    de: 'Filter',\n    fr: 'Filtres',\n    es: 'Filtros',\n    pt: 'Filtros',\n  },\n  show: {\n    it: 'Mostra',\n    en: 'Show',\n    de: 'Anzeigen',\n    fr: 'Afficher',\n    es: 'Mostrar',\n    pt: 'Mostrar',\n  },\n  hide: {\n    it: 'Nascondi',\n    en: 'Hide',\n    de: 'Verbergen',\n    fr: 'Masquer',\n    es: 'Ocultar',\n    pt: 'Ocultar',\n  },\n  applyFilters: {\n    it: 'Applica filtri',\n    en: 'Apply filters',\n    de: 'Filter anwenden',\n    fr: 'Appliquer les filtres',\n    es: 'Aplicar filtros',\n    pt: 'Aplicar filtros',\n  },\n  reset: {\n    it: 'Reset',\n    en: 'Reset',\n    de: 'Zurücksetzen',\n    fr: 'Réinitialiser',\n    es: 'Restablecer',\n    pt: 'Redefinir',\n  },\n  all: {\n    it: 'Tutti',\n    en: 'All',\n    de: 'Alle',\n    fr: 'Tous',\n    es: 'Todos',\n    pt: 'Todos',\n  },\n  search: {\n    it: 'Cerca...',\n    en: 'Search...',\n    de: 'Suchen...',\n    fr: 'Rechercher...',\n    es: 'Buscar...',\n    pt: 'Pesquisar...',\n  },\n  selected: {\n    it: 'selezionati',\n    en: 'selected',\n    de: 'ausgewählt',\n    fr: 'sélectionnés',\n    es: 'seleccionados',\n    pt: 'selecionados',\n  },\n  noOptionsFound: {\n    it: 'Nessuna opzione trovata',\n    en: 'No options found',\n    de: 'Keine Optionen gefunden',\n    fr: 'Aucune option trouvée',\n    es: 'No se encontraron opciones',\n    pt: 'Nenhuma opção encontrada',\n  },\n  selectAll: {\n    it: 'Seleziona tutti',\n    en: 'Select all',\n    de: 'Alle auswählen',\n    fr: 'Tout sélectionner',\n    es: 'Seleccionar todo',\n    pt: 'Selecionar tudo',\n  },\n  from: {\n    it: 'Da',\n    en: 'From',\n    de: 'Von',\n    fr: 'De',\n    es: 'Desde',\n    pt: 'De',\n  },\n  to: {\n    it: 'A',\n    en: 'To',\n    de: 'Bis',\n    fr: 'À',\n    es: 'Hasta',\n    pt: 'Até',\n  },\n};\n\n// mappa delle label dei filtri per campo\nconst TEXTS_FILTER_FIELDS: Record<\n  string,\n  { it: string; en: string; de: string; fr: string; es: string; pt: string }\n> = {\n  dateRange: {\n    it: 'Periodo',\n    en: 'Period',\n    de: 'Zeitraum',\n    fr: 'Période',\n    es: 'Período',\n    pt: 'Período',\n  },\n  tipo_documento: {\n    it: 'Tipo Documento',\n    en: 'Document type',\n    de: 'Belegart',\n    fr: 'Type de document',\n    es: 'Tipo de documento',\n    pt: 'Tipo de documento',\n  },\n  stato: {\n    it: 'Stato',\n    en: 'Status',\n    de: 'Status',\n    fr: 'Statut',\n    es: 'Estado',\n    pt: 'Estado',\n  },\n  DTT_ORD: {\n    it: 'Data Ordine',\n    en: 'Order date',\n    de: 'Bestelldatum',\n    fr: 'Date de commande',\n    es: 'Fecha de pedido',\n    pt: 'Data do pedido',\n  },\n  Numero_trasf: {\n    it: 'Numero documento di magazzino',\n    en: 'Warehouse document number',\n    de: 'Lagertbelegnummer',\n    fr: 'Numéro document magasin',\n    es: 'Número documento almacén',\n    pt: 'Número documento armazém',\n  },\n  CKY_ART: {\n    it: 'Codice Articolo',\n    en: 'Item code',\n    de: 'Artikelcode',\n    fr: \"Code de l'article\",\n    es: 'Código artículo',\n    pt: 'Código do artigo',\n  },\n  anno: {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n};\n\n// traduzioni per le opzioni fisse di alcuni filtri (stato)\nconst TEXTS_FILTER_OPTIONS: Record<\n  string,\n  { it: string; en: string; de: string; fr: string; es: string; pt: string }\n> = {\n  Tutti: {\n    it: 'Tutti',\n    en: 'All',\n    de: 'Alle',\n    fr: 'Tous',\n    es: 'Todos',\n    pt: 'Todos',\n  },\n  Pagato: {\n    it: 'Pagato',\n    en: 'Paid',\n    de: 'Bezahlt',\n    fr: 'Payé',\n    es: 'Pagado',\n    pt: 'Pago',\n  },\n  'Da Pagare': {\n    it: 'Da Pagare',\n    en: 'To pay',\n    de: 'Zu zahlen',\n    fr: 'À payer',\n    es: 'Por pagar',\n    pt: 'A pagar',\n  },\n  Annullato: {\n    it: 'Annullato',\n    en: 'Cancelled',\n    de: 'Storniert',\n    fr: 'Annulé',\n    es: 'Anulado',\n    pt: 'Anulado',\n  },\n};\n\nfunction getFilterLabelFromField(filter: ReportFilter, language: string): string {\n  const field = filter.field;\n  if (TEXTS_FILTER_FIELDS[field]) {\n    return TEXTS_FILTER_FIELDS[field][language as keyof (typeof TEXTS_FILTER_FIELDS)[string]] ||\n      TEXTS_FILTER_FIELDS[field].it;\n  }\n  // fallback all'etichetta arrivata dal DB, ma non direttamente in JSX altrove\n  return filter.label || field;\n}\n\nfunction translateFilterOption(option: string, language: string): string {\n  const map = TEXTS_FILTER_OPTIONS[option];\n  if (map) {\n    return map[language as keyof typeof map] || map.it;\n  }\n  return option;\n}\n\ninterface ReportFiltersProps {\n  filters: ReportFilter[];\n  values: Record<string, any>;\n  onChange: (values: Record<string, any>) => void;\n  onApply: () => void;\n  autoOptions?: Record<string, string[]>;\n  rawData?: any[];\n  language?: string;\n}\n\nexport default function ReportFilters({\n  filters,\n  values,\n  onChange,\n  onApply,\n  autoOptions = {},\n  rawData = [],\n  language = 'it',\n}: ReportFiltersProps) {\n  const currentLang = language || 'it';\n\n  const [showFilters, setShowFilters] = useState(false);\n  const [localValues, setLocalValues] = useState(values);\n  const [autocompleteOpen, setAutocompleteOpen] = useState<string | null>(null);\n  const autocompleteRef = useRef<HTMLDivElement>(null);\n\n  const [multiselectSearch, setMultiselectSearch] = useState<Record<string, string>>({});\n  const [multiselectOpen, setMultiselectOpen] = useState<Record<string, boolean>>({});\n\n  useEffect(() => {\n    setLocalValues(values);\n  }, [values]);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (\n        autocompleteRef.current &&\n        !autocompleteRef.current.contains(event.target as Node)\n      ) {\n        setAutocompleteOpen(null);\n        setMultiselectOpen({});\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  const handleChange = (field: string, value: any) => {\n    setLocalValues({ ...localValues, [field]: value });\n  };\n\n  const getUniqueValues = (field: string): string[] => {\n    if (!rawData || rawData.length === 0) return [];\n\n    const uniqueValues = new Set<string>();\n    rawData.forEach((row) => {\n      const value = row[field];\n      if (value != null && value !== '') {\n        uniqueValues.add(String(value));\n      }\n    });\n\n    return Array.from(uniqueValues).sort();\n  };\n\n  const getSuggestions = (field: string, inputValue: string): string[] => {\n    if (!inputValue) return getUniqueValues(field).slice(0, 10);\n\n    const uniqueValues = getUniqueValues(field);\n    return uniqueValues\n      .filter((val) => val.toLowerCase().includes(inputValue.toLowerCase()))\n      .slice(0, 10);\n  };\n\n  const handleApply = () => {\n    onChange(localValues);\n    onApply();\n    setShowFilters(false);\n  };\n\n  const handleReset = () => {\n    const resetValues: Record<string, any> = {};\n    filters.forEach((filter) => {\n      resetValues[filter.field] = filter.default || null;\n    });\n    setLocalValues(resetValues);\n    onChange(resetValues);\n    onApply();\n  };\n\n  const getDateRangeDefault = (defaultValue: string) => {\n    const today = new Date();\n    const currentYear = today.getFullYear();\n\n    switch (defaultValue) {\n      case 'current_year':\n        return {\n          from: `${currentYear}-01-01`,\n          to: `${currentYear}-12-31`,\n        };\n      case 'last_year':\n        return {\n          from: `${currentYear - 1}-01-01`,\n          to: `${currentYear - 1}-12-31`,\n        };\n      case 'last_6_months': {\n        const sixMonthsAgo = new Date(today);\n        sixMonthsAgo.setMonth(today.getMonth() - 6);\n        return {\n          from: sixMonthsAgo.toISOString().split('T')[0],\n          to: today.toISOString().split('T')[0],\n        };\n      }\n      default:\n        return { from: '', to: '' };\n    }\n  };\n\n  const renderFilter = (filter: ReportFilter) => {\n    const value = localValues[filter.field];\n    const label = getFilterLabelFromField(filter, currentLang);\n\n    switch (filter.type) {\n      case 'text': {\n        const suggestions = getSuggestions(filter.field, value || '');\n        const showAutocomplete =\n          autocompleteOpen === filter.field && suggestions.length > 0;\n\n        return (\n          <div\n            className=\"relative\"\n            ref={autocompleteOpen === filter.field ? autocompleteRef : null}\n          >\n            <input\n              type=\"text\"\n              value={value || ''}\n              onChange={(e) => handleChange(filter.field, e.target.value)}\n              onFocus={() => setAutocompleteOpen(filter.field)}\n              className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              placeholder={label}\n            />\n            {showAutocomplete && (\n              <div className=\"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                {suggestions.map((suggestion, idx) => (\n                  <button\n                    key={idx}\n                    type=\"button\"\n                    onClick={() => {\n                      handleChange(filter.field, suggestion);\n                      setAutocompleteOpen(null);\n                    }}\n                    className=\"w-full text-left px-3 py-2 hover:bg-sky-50 text-sm text-gray-700 hover:text-sky-900 border-b last:border-b-0\"\n                  >\n                    {suggestion}\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n        );\n      }\n\n      case 'select': {\n        const selectOptions =\n          filter.options === 'auto'\n            ? autoOptions[filter.field] || []\n            : filter.options || [];\n\n        return (\n          <select\n            value={value || ''}\n            onChange={(e) => handleChange(filter.field, e.target.value)}\n            className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 bg-white shadow-sm\"\n          >\n            <option value=\"\">{TEXTS_FILTERS.all[currentLang]}</option>\n            {selectOptions.map((option) => (\n              <option key={option} value={option}>\n                {translateFilterOption(option, currentLang)}\n              </option>\n            ))}\n          </select>\n        );\n      }\n\n      case 'multiselect': {\n        const multiOptions =\n          filter.options === 'auto'\n            ? autoOptions[filter.field] || []\n            : filter.options || [];\n\n        const selectedValues = value || [];\n        const searchTerm = multiselectSearch[filter.field] || '';\n        const isOpen = multiselectOpen[filter.field] || false;\n\n        const filteredOptions = multiOptions.filter((option) =>\n          option.toLowerCase().includes(searchTerm.toLowerCase())\n        );\n\n        return (\n          <div className=\"relative\" ref={isOpen ? autocompleteRef : null}>\n            {selectedValues.length > 0 && (\n              <div className=\"flex flex-wrap gap-1 mb-2\">\n                {selectedValues.map((val: string) => (\n                  <span\n                    key={val}\n                    className=\"inline-flex items-center gap-1 bg-sky-100 text-sky-800 text-xs px-2 py-1 rounded-full\"\n                  >\n                    {translateFilterOption(val, currentLang)}\n                    <button\n                      type=\"button\"\n                      onClick={() => {\n                        const newValues = selectedValues.filter(\n                          (v: string) => v !== val\n                        );\n                        handleChange(filter.field, newValues);\n                      }}\n                      className=\"text-sky-600 hover:text-sky-800\"\n                    >\n                      ×\n                    </button>\n                  </span>\n                ))}\n              </div>\n            )}\n\n            <div className=\"relative\">\n              <input\n                type=\"text\"\n                value={searchTerm}\n                onChange={(e) =>\n                  setMultiselectSearch({\n                    ...multiselectSearch,\n                    [filter.field]: e.target.value,\n                  })\n                }\n                onFocus={() =>\n                  setMultiselectOpen({\n                    ...multiselectOpen,\n                    [filter.field]: true,\n                  })\n                }\n                placeholder={`${TEXTS_FILTERS.search[currentLang]} (${\n                  selectedValues.length\n                } ${TEXTS_FILTERS.selected[currentLang]})`}\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n\n              {isOpen && (\n                <div className=\"absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                  {filteredOptions.length === 0 ? (\n                    <div className=\"px-3 py-2 text-sm text-gray-500\">\n                      {TEXTS_FILTERS.noOptionsFound[currentLang]}\n                    </div>\n                  ) : (\n                    <>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          handleChange(filter.field, filteredOptions);\n                          setMultiselectOpen({\n                            ...multiselectOpen,\n                            [filter.field]: false,\n                          });\n                        }}\n                        className=\"w-full text-left px-3 py-2 text-xs text-sky-600 hover:bg-sky-50 border-b\"\n                      >\n                        ✓ {TEXTS_FILTERS.selectAll[currentLang]} (\n                        {filteredOptions.length})\n                      </button>\n                      {filteredOptions.map((option) => (\n                        <label\n                          key={option}\n                          className=\"flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer border-b last:border-b-0\"\n                        >\n                          <input\n                            type=\"checkbox\"\n                            checked={selectedValues.includes(option)}\n                            onChange={(e) => {\n                              const newValues = e.target.checked\n                                ? [...selectedValues, option]\n                                : selectedValues.filter(\n                                    (v: string) => v !== option\n                                  );\n                              handleChange(filter.field, newValues);\n                            }}\n                            className=\"rounded\"\n                          />\n                          <span className=\"text-sm\">\n                            {translateFilterOption(option, currentLang)}\n                          </span>\n                        </label>\n                      ))}\n                    </>\n                  )}\n                </div>\n              )}\n            </div>\n\n            <button\n              type=\"button\"\n              onClick={() =>\n                setMultiselectOpen({\n                  ...multiselectOpen,\n                  [filter.field]: !isOpen,\n                })\n              }\n              className=\"absolute right-2 top-2 text-gray-400 hover:text-gray-600\"\n            >\n              {isOpen ? '▲' : '▼'}\n            </button>\n          </div>\n        );\n      }\n\n      case 'daterange': {\n        const dateRange = value || getDateRangeDefault(filter.default as string);\n\n        return (\n          <div className=\"flex gap-2\">\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.from[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.from || ''}\n                onChange={(e) =>\n                  handleChange(filter.field, { ...dateRange, from: e.target.value })\n                }\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.to[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.to || ''}\n                onChange={(e) =>\n                  handleChange(filter.field, { ...dateRange, to: e.target.value })\n                }\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n          </div>\n        );\n      }\n\n      default:\n        return null;\n    }\n  };\n\n  const activeFiltersCount = Object.values(localValues).filter(\n    (v) =>\n      v !== null &&\n      v !== undefined &&\n      v !== '' &&\n      !(typeof v === 'object' && Object.keys(v).length === 0)\n  ).length;\n\n  return (\n    <div className=\"bg-white/80 backdrop-blur-sm rounded-xl shadow-sm border border-gray-100 p-4 mb-4\">\n      <div className=\"flex items-center justify-between mb-3\">\n        <div className=\"flex items-center gap-2\">\n          <span className=\"inline-flex items-center justify-center w-8 h-8 rounded-full bg-sky-100 text-sky-700 shadow-sm\">\n            <Filter className=\"w-4 h-4\" />\n          </span>\n          <h3 className=\"text-base font-semibold text-gray-900\">\n            {TEXTS_FILTERS.filters[currentLang]}\n          </h3>\n          {activeFiltersCount > 0 && (\n            <span className=\"px-2 py-1 bg-sky-100 text-sky-800 text-xs font-medium rounded-full\">\n              {activeFiltersCount}\n            </span>\n          )}\n        </div>\n        <button\n          onClick={() => setShowFilters(!showFilters)}\n          className=\"text-sky-600 hover:text-sky-700 text-sm font-medium\"\n        >\n          {showFilters\n            ? TEXTS_FILTERS.hide[currentLang]\n            : TEXTS_FILTERS.show[currentLang]}\n        </button>\n      </div>\n\n      {showFilters && (\n        <>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4\">\n            {filters.map((filter) => {\n              const label = getFilterLabelFromField(filter, currentLang);\n              return (\n                <div key={filter.field}>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    {label}\n                  </label>\n                  {renderFilter(filter)}\n                </div>\n              );\n            })}\n          </div>\n\n          <div className=\"flex gap-2 pt-4 border-t border-dashed border-slate-200\">\n            <button\n              onClick={handleApply}\n              className=\"px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 font-medium shadow-sm transition\"\n            >\n              {TEXTS_FILTERS.applyFilters[currentLang]}\n            </button>\n            <button\n              onClick={handleReset}\n              className=\"px-4 py-2 border border-gray-200 text-gray-700 bg-white rounded-md hover:bg-gray-50 font-medium flex items-center gap-2\"\n            >\n              <X className=\"w-4 h-4\" />\n              {TEXTS_FILTERS.reset[currentLang]}\n            </button>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}\n\n// ============================================================\n// COMPONENTE: ReportExport\n// FILE: components/reports/ReportExport.tsx\n// ============================================================\n\n'use client';\n\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { FileText, Table, File } from 'lucide-react';\n\n// collezione colonne (copiata per avere le traduzioni anche qui)\nconst TEXTS_COLUMNS_EXPORT = {\n  column_data: {\n    it: 'Data',\n    en: 'Date',\n    de: 'Datum',\n    fr: 'Date',\n    es: 'Fecha',\n    pt: 'Data',\n  },\n  column_tipo_documento: {\n    it: 'Tipo Documento',\n    en: 'Document type',\n    de: 'Belegart',\n    fr: 'Type de document',\n    es: 'Tipo de documento',\n    pt: 'Tipo de documento',\n  },\n  column_tipo: {\n    it: 'Tipo',\n    en: 'Type',\n    de: 'Typ',\n    fr: 'Type',\n    es: 'Tipo',\n    pt: 'Tipo',\n  },\n  column_numero: {\n    it: 'Numero',\n    en: 'Number',\n    de: 'Nummer',\n    fr: 'Numéro',\n    es: 'Número',\n    pt: 'Número',\n  },\n  column_descrizione: {\n    it: 'Descrizione',\n    en: 'Description',\n    de: 'Beschreibung',\n    fr: 'Description',\n    es: 'Descripción',\n    pt: 'Descrição',\n  },\n  column_stato: {\n    it: 'Stato',\n    en: 'Status',\n    de: 'Status',\n    fr: 'Statut',\n    es: 'Estado',\n    pt: 'Estado',\n  },\n  column_totale: {\n    it: 'Importo',\n    en: 'Amount',\n    de: 'Betrag',\n    fr: 'Montant',\n    es: 'Importe',\n    pt: 'Valor',\n  },\n  column_valuta: {\n    it: 'Valuta',\n    en: 'Currency',\n    de: 'Währung',\n    fr: 'Devise',\n    es: 'Moneda',\n    pt: 'Moeda',\n  },\n  column_anno: {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  column_ngl_doc_ord: {\n    it: 'Numero Ordine',\n    en: 'Order number',\n    de: 'Bestellnummer',\n    fr: 'Numéro de commande',\n    es: 'Número de pedido',\n    pt: 'Número do pedido',\n  },\n  column_dtt_ord: {\n    it: 'Data Ordine',\n    en: 'Order date',\n    de: 'Bestelldatum',\n    fr: 'Date de commande',\n    es: 'Fecha de pedido',\n    pt: 'Data do pedido',\n  },\n  column_cds_caum: {\n    it: 'Causale',\n    en: 'Reason',\n    de: 'Grund',\n    fr: 'Motif',\n    es: 'Causal',\n    pt: 'Causa',\n  },\n  column_cky_cnt_clfr: {\n    it: 'Codice cliente',\n    en: 'Customer code',\n    de: 'Kundencode',\n    fr: 'Code client',\n    es: 'Código cliente',\n    pt: 'Código do cliente',\n  },\n  column_cds_cnt_ragsoc: {\n    it: 'Ragione Sociale',\n    en: 'Company name',\n    de: 'Firmenname',\n    fr: 'Raison sociale',\n    es: 'Razón social',\n    pt: 'Razão social',\n  },\n  column_nome_agente: {\n    it: 'Agente',\n    en: 'Agent',\n    de: 'Vertreter',\n    fr: 'Agent',\n    es: 'Agente',\n    pt: 'Agente',\n  },\n  column_cky_art: {\n    it: 'Codice Articolo',\n    en: 'Item code',\n    de: 'Artikelcode',\n    fr: \"Code de l'article\",\n    es: 'Código artículo',\n    pt: 'Código do artigo',\n  },\n  column_descrizione_art: {\n    it: 'Articolo',\n    en: 'Item',\n    de: 'Artikel',\n    fr: 'Article',\n    es: 'Artículo',\n    pt: 'Artigo',\n  },\n  column_quantita: {\n    it: 'Quantità',\n    en: 'Quantity',\n    de: 'Menge',\n    fr: 'Quantité',\n    es: 'Cantidad',\n    pt: 'Quantidade',\n  },\n  column_valore: {\n    it: 'Valore',\n    en: 'Value',\n    de: 'Wert',\n    fr: 'Valeur',\n    es: 'Valor',\n    pt: 'Valor',\n  },\n  column_sigla_trasf: {\n    it: 'Sigla Doc Magazzino',\n    en: 'Warehouse doc code',\n    de: 'Lagerbeleg-Kürzel',\n    fr: 'Code doc magasin',\n    es: 'Sigla doc almacén',\n    pt: 'Sigla doc armazém',\n  },\n  column_numero_trasf: {\n    it: 'Numero Doc Magazzino',\n    en: 'Warehouse doc number',\n    de: 'Lagerbelegnummer',\n    fr: 'Numéro doc magasin',\n    es: 'Número doc almacén',\n    pt: 'Número doc armazém',\n  },\n  column_data_trasf: {\n    it: 'Data trasf',\n    en: 'Transfer date',\n    de: 'Transferdatum',\n    fr: 'Date transfert',\n    es: 'Fecha transf',\n    pt: 'Data transf',\n  },\n  column_origne: {\n    it: 'Evaso o In Ordine',\n    en: 'Fulfilled or On order',\n    de: 'Erledigt oder in Bestellung',\n    fr: 'Livré ou en commande',\n    es: 'Servido o en pedido',\n    pt: 'Atendido ou em pedido',\n  },\n  column_sco_1: {\n    it: 'Sco 1',\n    en: 'Disc 1',\n    de: 'Rabatt 1',\n    fr: 'Rem 1',\n    es: 'Dto 1',\n    pt: 'Desc 1',\n  },\n  column_sco_2: {\n    it: 'Sco 2',\n    en: 'Disc 2',\n    de: 'Rabatt 2',\n    fr: 'Rem 2',\n    es: 'Dto 2',\n    pt: 'Desc 2',\n  },\n  column_sco_3: {\n    it: 'Sco 3',\n    en: 'Disc 3',\n    de: 'Rabatt 3',\n    fr: 'Rem 3',\n    es: 'Dto 3',\n    pt: 'Desc 3',\n  },\n  column_npz_unit: {\n    it: 'Prezzo Unitario',\n    en: 'Unit price',\n    de: 'Einzelpreis',\n    fr: 'Prix unitaire',\n    es: 'Precio unitario',\n    pt: 'Preço unitário',\n  },\n};\n\nconst TEXTS_EXPORT = {\n  exportPdfTitle: {\n    it: 'Esporta come PDF',\n    en: 'Export as PDF',\n    de: 'Als PDF exportieren',\n    fr: 'Exporter en PDF',\n    es: 'Exportar como PDF',\n    pt: 'Exportar como PDF',\n  },\n  exportExcelTitle: {\n    it: 'Esporta come Excel',\n    en: 'Export as Excel',\n    de: 'Als Excel exportieren',\n    fr: 'Exporter en Excel',\n    es: 'Exportar como Excel',\n    pt: 'Exportar como Excel',\n  },\n  exportCsvTitle: {\n    it: 'Esporta come CSV',\n    en: 'Export as CSV',\n    de: 'Als CSV exportieren',\n    fr: 'Exporter en CSV',\n    es: 'Exportar como CSV',\n    pt: 'Exportar como CSV',\n  },\n  errorCsvExport: {\n    it: \"Errore durante l'export CSV\",\n    en: 'Error during CSV export',\n    de: 'Fehler beim CSV-Export',\n    fr: \"Erreur lors de l'export CSV\",\n    es: 'Error durante la exportación CSV',\n    pt: 'Erro durante a exportação CSV',\n  },\n  errorExcelExport: {\n    it: \"Errore durante l'export Excel\",\n    en: 'Error during Excel export',\n    de: 'Fehler beim Excel-Export',\n    fr: \"Erreur lors de l'export Excel\",\n    es: 'Error durante la exportación Excel',\n    pt: 'Erro durante a exportação Excel',\n  },\n  noExportFormats: {\n    it: 'Nessun formato di export disponibile',\n    en: 'No export formats available',\n    de: 'Keine Exportformate verfügbar',\n    fr: \"Aucun format d'export disponible\",\n    es: 'No hay formatos de exportación disponibles',\n    pt: 'Nenhum formato de exportação disponível',\n  },\n  buttonPdf: {\n    it: 'PDF',\n    en: 'PDF',\n    de: 'PDF',\n    fr: 'PDF',\n    es: 'PDF',\n    pt: 'PDF',\n  },\n  buttonExcel: {\n    it: 'Excel',\n    en: 'Excel',\n    de: 'Excel',\n    fr: 'Excel',\n    es: 'Excel',\n    pt: 'Excel',\n  },\n  buttonCsv: {\n    it: 'CSV',\n    en: 'CSV',\n    de: 'CSV',\n    fr: 'CSV',\n    es: 'CSV',\n    pt: 'CSV',\n  },\n};\n\nfunction getExportColumnLabel(field: string, language: string): string {\n  const key = `column_${field.replace(/`/g, '').replace(/\\s+/g, '_').toLowerCase()}`;\n  const colObj = (TEXTS_COLUMNS_EXPORT as any)[key];\n  if (colObj) {\n    return colObj[language] || colObj.it;\n  }\n  return field;\n}\n\ninterface ReportExportProps {\n  data: any[];\n  config: ReportConfig;\n  reportTitle: string;\n  language?: string;\n}\n\nexport default function ReportExport({ data, config, reportTitle, language = 'it' }: ReportExportProps) {\n  const flattenGroupedData = (items: any[]): any[] => {\n    const result: any[] = [];\n\n    items.forEach((item) => {\n      if ('groupKey' in item) {\n        result.push(...flattenGroupedData(item.children));\n      } else {\n        result.push(item);\n      }\n    });\n\n    return result;\n  };\n\n  const exportToCSV = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      const headers = visibleColumns\n        .map((col) => getExportColumnLabel(col.field, language))\n        .join(',');\n\n      const rows = flatData.map((row) =>\n        visibleColumns\n          .map((col) => {\n            const value = ReportEngine.formatValue(row[col.field], col, language);\n            return `\"${String(value).replace(/\"/g, '\"\"')}\"`;\n          })\n          .join(',')\n      );\n\n      const csv = [headers, ...rows].join('\\n');\n\n      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle.replace(/\\s+/g, '_').trim()}_${\n        new Date().toISOString().split('T')[0]\n      }.csv`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting CSV:', error);\n      alert(TEXTS_EXPORT.errorCsvExport[language as keyof typeof TEXTS_EXPORT.errorCsvExport]);\n    }\n  };\n\n  const exportToExcel = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      let html = '<table border=\"1\"><thead><tr>';\n\n      visibleColumns.forEach((col) => {\n        html += `<th>${getExportColumnLabel(col.field, language)}</th>`;\n      });\n      html += '</tr></thead><tbody>';\n\n      flatData.forEach((row) => {\n        html += '<tr>';\n        visibleColumns.forEach((col) => {\n          const value = ReportEngine.formatValue(row[col.field], col, language);\n          html += `<td>${value}</td>`;\n        });\n        html += '</tr>';\n      });\n\n      html += '</tbody></table>';\n\n      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle.replace(/\\s+/g, '_').trim()}_${\n        new Date().toISOString().split('T')[0]\n      }.xls`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting Excel:', error);\n      alert(TEXTS_EXPORT.errorExcelExport[language as keyof typeof TEXTS_EXPORT.errorExcelExport]);\n    }\n  };\n\n  const exportToPDF = () => {\n    window.print();\n  };\n\n  return (\n    <div className=\"flex flex-wrap gap-2 mt-4\">\n      {config.export?.pdf && (\n        <button\n          onClick={exportToPDF}\n          className=\"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={TEXTS_EXPORT.exportPdfTitle[language as keyof typeof TEXTS_EXPORT.exportPdfTitle]}\n        >\n          <FileText className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonPdf[language as keyof typeof TEXTS_EXPORT.buttonPdf]}\n        </button>\n      )}\n\n      {config.export?.excel && (\n        <button\n          onClick={exportToExcel}\n          className=\"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportExcelTitle[language as keyof typeof TEXTS_EXPORT.exportExcelTitle]\n          }\n        >\n          <Table className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonExcel[language as keyof typeof TEXTS_EXPORT.buttonExcel]}\n        </button>\n      )}\n\n      {config.export?.csv && (\n        <button\n          onClick={exportToCSV}\n          className=\"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={TEXTS_EXPORT.exportCsvTitle[language as keyof typeof TEXTS_EXPORT.exportCsvTitle]}\n        >\n          <File className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonCsv[language as keyof typeof TEXTS_EXPORT.buttonCsv]}\n        </button>\n      )}\n\n      {!config.export?.pdf && !config.export?.excel && !config.export?.csv && (\n        <p className=\"text-sm text-gray-500\">\n          {TEXTS_EXPORT.noExportFormats[language as keyof typeof TEXTS_EXPORT.noExportFormats]}\n        </p>\n      )}\n    </div>\n  );\n}\n\n// ============================================================\n// COMPONENTE: ReportBuilder\n// FILE: components/reports/ReportBuilder.tsx\n// ============================================================\n\n'use client';\n\nimport { useState, useEffect } from 'react';\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport {\n  executeQuery,\n  getDocumentTypes,\n  getDocumentYears,\n} from '@/lib/mysql-query';\nimport ReportTable from './ReportTable';\nimport { ReportFilters as ReportFiltersComponent } from './ReportFilters';\nimport { ReportExport as ReportExportComponent } from './ReportExport';\nimport { Loader2 } from 'lucide-react';\n\nconst TEXTS_BUILDER = {\n  errorTitle: {\n    it: 'Errore',\n    en: 'Error',\n    de: 'Fehler',\n    fr: 'Erreur',\n    es: 'Error',\n    pt: 'Erro',\n  },\n  loadingData: {\n    it: 'Caricamento dati...',\n    en: 'Loading data...',\n    de: 'Daten werden geladen...',\n    fr: 'Chargement des données...',\n    es: 'Cargando datos...',\n    pt: 'Carregando dados...',\n  },\n  noDataTitle: {\n    it: 'Nessun dato disponibile',\n    en: 'No data available',\n    de: 'Keine Daten verfügbar',\n    fr: 'Aucune donnée disponible',\n    es: 'No hay datos disponibles',\n    pt: 'Nenhum dado disponível',\n  },\n  noDataDescription: {\n    it: 'Non ci sono dati per il cliente selezionato con i filtri applicati.',\n    en: 'There is no data for the selected customer with the applied filters.',\n    de: 'Es sind keine Daten für den ausgewählten Kunden mit den angewendeten Filtern vorhanden.',\n    fr: \"Aucune donnée pour le client sélectionné avec les filtres appliqués.\",\n    es: 'No hay datos para el cliente seleccionado con los filtros aplicados.',\n    pt: 'Não há dados para o cliente selecionado com os filtros aplicados.',\n  },\n  languageLabel: {\n    it: 'Lingua',\n    en: 'Language',\n    de: 'Sprache',\n    fr: 'Langue',\n    es: 'Idioma',\n    pt: 'Idioma',\n  },\n  debugTitle: {\n    it: 'Debug: Query SQL eseguita',\n    en: 'Debug: Executed SQL query',\n    de: 'Debug: Ausgeführte SQL-Abfrage',\n    fr: 'Debug : Requête SQL exécutée',\n    es: 'Debug: Consulta SQL ejecutada',\n    pt: 'Debug: Consulta SQL executada',\n  },\n  debugQuery: {\n    it: 'Query SQL:',\n    en: 'SQL query:',\n    de: 'SQL-Abfrage:',\n    fr: 'Requête SQL :',\n    es: 'Consulta SQL:',\n    pt: 'Consulta SQL:',\n  },\n  debugParams: {\n    it: 'Parametri:',\n    en: 'Parameters:',\n    de: 'Parameter:',\n    fr: 'Paramètres :',\n    es: 'Parámetros:',\n    pt: 'Parâmetros:',\n  },\n  debugBindTypes: {\n    it: 'Bind Types:',\n    en: 'Bind Types:',\n    de: 'Bind-Typen:',\n    fr: 'Types de liaison :',\n    es: 'Tipos de enlace:',\n    pt: 'Tipos de binding:',\n  },\n  activeFilters: {\n    it: 'Filtri attivi:',\n    en: 'Active filters:',\n    de: 'Aktive Filter:',\n    fr: 'Filtres actifs :',\n    es: 'Filtros activos:',\n    pt: 'Filtros ativos:',\n  },\n  removeAll: {\n    it: 'Rimuovi tutti',\n    en: 'Remove all',\n    de: 'Alle entfernen',\n    fr: 'Tout supprimer',\n    es: 'Quitar todo',\n    pt: 'Remover todos',\n  },\n};\n\nfunction getReportTitleFromSlug(\n  slug: string,\n  language: string,\n  fallback: string\n): string {\n  const rep = (REPORT_TEXTS as any)[slug];\n  if (rep && rep.title) {\n    return rep.title[language] || rep.title.it || fallback;\n  }\n  return fallback;\n}\n\nfunction getReportDescriptionFromSlug(\n  slug: string,\n  language: string,\n  fallback: string | undefined\n): string | undefined {\n  const rep = (REPORT_TEXTS as any)[slug];\n  if (rep && rep.description) {\n    return rep.description[language] || rep.description.it || fallback;\n  }\n  return fallback;\n}\n\nfunction getFilterLabelFromConfig(\n  field: string,\n  language: string,\n  config: ReportConfig | null\n): string {\n  if (!config || !config.filters) return field;\n  const f = config.filters.find((fl) => fl.field === field);\n  if (!f) return field;\n  // qui possiamo riusare la stessa mappa di ReportFilters\n  if (TEXTS_FILTER_FIELDS[field]) {\n    return TEXTS_FILTER_FIELDS[field][language as keyof (typeof TEXTS_FILTER_FIELDS)[string]] ||\n      TEXTS_FILTER_FIELDS[field].it;\n  }\n  return f.label || field;\n}\n\ninterface ReportBuilderProps {\n  reportSlug: string;\n  clientCode: string;\n  language?: string;\n}\n\nexport default function ReportBuilder({\n  reportSlug,\n  clientCode,\n  language: initialLanguage = 'it',\n}: ReportBuilderProps) {\n  const [config, setConfig] = useState<ReportConfig | null>(null);\n  const [rawData, setRawData] = useState<any[]>([]);\n  const [processedData, setProcessedData] = useState<any[]>([]);\n  const [aggregates, setAggregates] = useState<Record<string, any>>({});\n  const [filters, setFilters] = useState<Record<string, any>>({});\n  const [autoOptions, setAutoOptions] = useState<Record<string, string[]>>({});\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [debugInfo, setDebugInfo] = useState<any>(null);\n  const [currentLanguage, setCurrentLanguage] = useState(initialLanguage);\n\n  useEffect(() => {\n    async function loadConfig() {\n      try {\n        const response = await fetch(`/api/reports/config?slug=${reportSlug}`);\n\n        if (!response.ok) {\n          throw new Error(`Report configuration not found: ${reportSlug}`);\n        }\n\n        const data = await response.json();\n        setConfig(data.config);\n      } catch (err: any) {\n        console.error('Error loading report config:', err);\n        setError(err.message || 'Failed to load report configuration');\n      }\n    }\n\n    loadConfig();\n  }, [reportSlug]);\n\n  useEffect(() => {\n    if (!config || !clientCode) return;\n\n    async function loadData(reportConfig: ReportConfig) {\n      try {\n        setLoading(true);\n        setError(null);\n\n        const queryParams: Record<string, any> = {};\n        queryParams.clientCode = clientCode;\n\n        const result = await executeQuery(reportConfig.query, queryParams);\n\n        setRawData(result.data || []);\n\n        if (result.debug) {\n          setDebugInfo(result.debug);\n        }\n\n        const options: Record<string, string[]> = {};\n\n        for (const filter of reportConfig.filters || []) {\n          if (filter.options === 'auto') {\n            if (filter.field === 'tipo_documento') {\n              options[filter.field] = await getDocumentTypes(clientCode);\n            } else if (filter.field === 'anno') {\n              const years = await getDocumentYears(clientCode);\n              options[filter.field] = years.map(String);\n            } else {\n              const uniqueValues = new Set<string>();\n              result.data.forEach((row: any) => {\n                const value = row[filter.field];\n                if (value != null && value !== '') {\n                  uniqueValues.add(String(value));\n                }\n              });\n              options[filter.field] = Array.from(uniqueValues).sort();\n            }\n          }\n        }\n\n        setAutoOptions(options);\n      } catch (err: any) {\n        console.error('Error loading data:', err);\n        setError(err.message || 'Failed to load data');\n      } finally {\n        setLoading(false);\n      }\n    }\n\n    loadData(config);\n  }, [config, clientCode]);\n\n  useEffect(() => {\n    if (!config || rawData.length === 0) {\n      setProcessedData([]);\n      setAggregates({});\n      return;\n    }\n\n    const result = ReportEngine.processReport(rawData, config, filters);\n    setProcessedData(result.data);\n    setAggregates(result.aggregates);\n  }, [rawData, config, filters]);\n\n  const handleFiltersChange = (newFilters: Record<string, any>) => {\n    setFilters(newFilters);\n  };\n\n  const handleApplyFilters = () => {};\n\n  if (loading && !config) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-sky-600\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n        <p className=\"text-red-800 font-medium\">\n          {TEXTS_BUILDER.errorTitle[currentLanguage as keyof typeof TEXTS_BUILDER.errorTitle]}\n        </p>\n        <p className=\"text-red-600 text-sm mt-1\">{error}</p>\n      </div>\n    );\n  }\n\n  if (!config) {\n    return null;\n  }\n\n  const isGrouped = config.grouping && config.grouping.length > 0;\n\n  const translatedTitle = getReportTitleFromSlug(\n    reportSlug,\n    currentLanguage,\n    config.title\n  );\n  const translatedDescription = getReportDescriptionFromSlug(\n    reportSlug,\n    currentLanguage,\n    config.description\n  );\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-start justify-between bg-gradient-to-r from-white to-slate-50 rounded-xl p-3 md:p-4\">\n        <div className=\"flex-1\">\n          <h1 className=\"text-3xl font-bold text-gray-900 tracking-tight\">\n            {translatedTitle}\n          </h1>\n          {translatedDescription && (\n            <p className=\"text-gray-600 mt-2\">{translatedDescription}</p>\n          )}\n        </div>\n\n        <div className=\"ml-4\">\n          <label className=\"block text-xs font-medium text-gray-600 mb-1\">\n            {TEXTS_BUILDER.languageLabel[currentLanguage as keyof typeof TEXTS_BUILDER.languageLabel]}\n          </label>\n          <select\n            value={currentLanguage}\n            onChange={(e) => setCurrentLanguage(e.target.value)}\n            className=\"block w-40 px-3 py-2 bg-white border border-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400 text-sm\"\n          >\n            <option value=\"it\">🇮🇹 Italiano</option>\n            <option value=\"en\">🇬🇧 English</option>\n            <option value=\"de\">🇩🇪 Deutsch</option>\n            <option value=\"fr\">🇫🇷 Français</option>\n            <option value=\"es\">🇪🇸 Español</option>\n            <option value=\"pt\">🇵🇹 Português</option>\n          </select>\n        </div>\n      </div>\n\n      {config && config.filters && config.filters.length > 0 && (\n        <ReportFiltersComponent\n          filters={config.filters}\n          values={filters}\n          onChange={handleFiltersChange}\n          onApply={handleApplyFilters}\n          autoOptions={autoOptions}\n          rawData={rawData}\n          language={currentLanguage}\n        />\n      )}\n\n      {debugInfo && (\n        <details className=\"bg-gray-50 border border-gray-200 rounded-lg p-4\">\n          <summary className=\"cursor-pointer font-medium text-gray-700 hover:text-gray-900\">\n            {TEXTS_BUILDER.debugTitle[currentLanguage as keyof typeof TEXTS_BUILDER.debugTitle]}\n          </summary>\n          <div className=\"mt-4 space-y-3\">\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugQuery[currentLanguage as keyof typeof TEXTS_BUILDER.debugQuery]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {debugInfo.sql}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugParams[currentLanguage as keyof typeof TEXTS_BUILDER.debugParams]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {JSON.stringify(debugInfo.params, null, 2)}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugBindTypes[currentLanguage as keyof typeof TEXTS_BUILDER.debugBindTypes]}\n              </p>\n              <code className=\"bg-white px-2 py-1 rounded border text-xs\">\n                {debugInfo.bindTypes}\n              </code>\n            </div>\n          </div>\n        </details>\n      )}\n\n      {!loading &&\n        Object.keys(filters)\n          .filter((key) => filters[key])\n          .length > 0 && (\n          <div className=\"bg-sky-50 border border-sky-100 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <h3 className=\"text-sm font-semibold text-sky-900\">\n                {TEXTS_BUILDER.activeFilters[\n                  currentLanguage as keyof typeof TEXTS_BUILDER.activeFilters\n                ]}\n              </h3>\n              <button\n                onClick={() => setFilters({})}\n                className=\"text-xs text-sky-600 hover:text-sky-800 underline\"\n              >\n                {TEXTS_BUILDER.removeAll[\n                  currentLanguage as keyof typeof TEXTS_BUILDER.removeAll\n                ]}\n              </button>\n            </div>\n            <div className=\"flex flex-wrap gap-2\">\n              {Object.entries(filters).map(([field, value]) => {\n                if (!value) return null;\n\n                const label = getFilterLabelFromConfig(field, currentLanguage, config);\n\n                let displayValue = value;\n                if (typeof value === 'object' && (value as any).from && (value as any).to) {\n                  displayValue = `${(value as any).from} - ${(value as any).to}`;\n                } else if (Array.isArray(value)) {\n                  displayValue = (value as string[]).join(', ');\n                }\n\n                return (\n                  <div\n                    key={field}\n                    className=\"inline-flex items-center gap-2 bg-white border border-sky-200 rounded-full px-3 py-1 text-sm shadow-sm\"\n                  >\n                    <span className=\"font-medium text-sky-900\">{label}:</span>\n                    <span className=\"text-sky-700\">{displayValue as string}</span>\n                    <button\n                      onClick={() => {\n                        const newFilters = { ...filters };\n                        delete newFilters[field];\n                        setFilters(newFilters);\n                      }}\n                      className=\"text-sky-400 hover:text-sky-600\"\n                    >\n                      ×\n                    </button>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        )}\n\n      {loading && (\n        <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"w-6 h-6 animate-spin text-sky-600 mr-2\" />\n          <span className=\"text-gray-600\">\n            {TEXTS_BUILDER.loadingData[currentLanguage as keyof typeof TEXTS_BUILDER.loadingData]}\n          </span>\n        </div>\n      )}\n\n      {!loading && processedData.length === 0 && (\n        <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center\">\n          <p className=\"text-yellow-800 font-medium\">\n            {TEXTS_BUILDER.noDataTitle[currentLanguage as keyof typeof TEXTS_BUILDER.noDataTitle]}\n          </p>\n          <p className=\"text-yellow-600 text-sm mt-1\">\n            {TEXTS_BUILDER.noDataDescription[\n              currentLanguage as keyof typeof TEXTS_BUILDER.noDataDescription\n            ]}\n          </p>\n        </div>\n      )}\n\n      {!loading && processedData.length > 0 && config && (\n        <ReportTable\n          data={processedData}\n          columns={config.columns}\n          aggregates={aggregates}\n          language={currentLanguage}\n          isGrouped={isGrouped}\n          groupingConfig={config.grouping}\n        />\n      )}\n\n      {!loading && processedData.length > 0 && config && (\n        <ReportExportComponent\n          data={processedData}\n          config={config}\n          reportTitle={translatedTitle}\n          language={currentLanguage}\n        />\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v29",
        "timestamp": "2025-11-09T08:09:14.249Z",
        "note": "Modifica 09/11/2025, 09:09:13",
        "code": "// ============================================================\n// COMPONENTE: ReportTable\n// FILE: components/reports/ReportTable.tsx\n// ============================================================\n\n'use client';\n\nimport { useState, useEffect, useMemo } from 'react';\nimport { ReportColumn, GroupedDataNode } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { ChevronDown, ChevronRight } from 'lucide-react';\n\nconst TEXTS = {\n  // ----------------------------------------------------------\n  // Bottoni / messaggi di sistema\n  // ----------------------------------------------------------\n  buttonShowOnlyPending: {\n    it: 'Mostra solo da consegnare',\n    en: 'Show only pending',\n    de: 'Nur ausstehende anzeigen',\n    fr: 'Afficher uniquement en attente',\n    es: 'Mostrar solo pendientes',\n    pt: 'Mostrar apenas pendentes',\n  },\n  buttonExcel: {\n    it: 'Excel',\n    en: 'Excel',\n    de: 'Excel',\n    fr: 'Excel',\n    es: 'Excel',\n    pt: 'Excel',\n  },\n  buttonPDF: {\n    it: 'PDF',\n    en: 'PDF',\n    de: 'PDF',\n    fr: 'PDF',\n    es: 'PDF',\n    pt: 'PDF',\n  },\n  messageNoDocuments: {\n    it: 'Nessun documento trovato',\n    en: 'No documents found',\n    de: 'Keine Dokumente gefunden',\n    fr: 'Aucun document trouvé',\n    es: 'No se encontraron documentos',\n    pt: 'Nenhum documento encontrado',\n  },\n  labelTotal: {\n    it: 'TOTALE',\n    en: 'TOTAL',\n    de: 'GESAMT',\n    fr: 'TOTAL',\n    es: 'TOTAL',\n    pt: 'TOTAL',\n  },\n\n  // ----------------------------------------------------------\n  // Stato righe\n  // ----------------------------------------------------------\n  statusDelivered: {\n    it: 'CONSEGNATO',\n    en: 'DELIVERED',\n    de: 'GELIEFERT',\n    fr: 'LIVRÉ',\n    es: 'ENTREGADO',\n    pt: 'ENTREGUE',\n  },\n  statusInOrder: {\n    it: 'IN ORDINE',\n    en: 'IN ORDER',\n    de: 'IN AUFTRAG',\n    fr: 'EN COMMANDE',\n    es: 'EN PEDIDO',\n    pt: 'EM PEDIDO',\n  },\n\n  // ----------------------------------------------------------\n  // Raggruppamenti\n  // ----------------------------------------------------------\n  labelOrder: {\n    it: 'Ordine',\n    en: 'Order',\n    de: 'Bestellung',\n    fr: 'Commande',\n    es: 'Pedido',\n    pt: 'Pedido',\n  },\n  labelDelivered: {\n    it: 'consegnato',\n    en: 'delivered',\n    de: 'geliefert',\n    fr: 'livré',\n    es: 'entregado',\n    pt: 'entregue',\n  },\n  labelFulfilled: {\n    it: 'Evasi',\n    en: 'Fulfilled',\n    de: 'Erfüllt',\n    fr: 'Traités',\n    es: 'Cumplidos',\n    pt: 'Cumpridos',\n  },\n\n  // ----------------------------------------------------------\n  // COLONNE DINAMICHE\n  // ----------------------------------------------------------\n  columns: {\n    column_data: {\n      it: 'Data',\n      en: 'Date',\n      de: 'Datum',\n      fr: 'Date',\n      es: 'Fecha',\n      pt: 'Data',\n    },\n    column_tipo_documento: {\n      it: 'Tipo Documento',\n      en: 'Document type',\n      de: 'Belegart',\n      fr: 'Type de document',\n      es: 'Tipo de documento',\n      pt: 'Tipo de documento',\n    },\n    column_tipo: {\n      it: 'Tipo',\n      en: 'Type',\n      de: 'Typ',\n      fr: 'Type',\n      es: 'Tipo',\n      pt: 'Tipo',\n    },\n    column_numero: {\n      it: 'Numero',\n      en: 'Number',\n      de: 'Nummer',\n      fr: 'Numéro',\n      es: 'Número',\n      pt: 'Número',\n    },\n    column_descrizione: {\n      it: 'Descrizione',\n      en: 'Description',\n      de: 'Beschreibung',\n      fr: 'Description',\n      es: 'Descripción',\n      pt: 'Descrição',\n    },\n    column_stato: {\n      it: 'Stato',\n      en: 'Status',\n      de: 'Status',\n      fr: 'Statut',\n      es: 'Estado',\n      pt: 'Estado',\n    },\n    column_totale: {\n      it: 'Importo',\n      en: 'Amount',\n      de: 'Betrag',\n      fr: 'Montant',\n      es: 'Importe',\n      pt: 'Valor',\n    },\n    column_valuta: {\n      it: 'Valuta',\n      en: 'Currency',\n      de: 'Währung',\n      fr: 'Devise',\n      es: 'Moneda',\n      pt: 'Moeda',\n    },\n    column_anno: {\n      it: 'Anno',\n      en: 'Year',\n      de: 'Jahr',\n      fr: 'Année',\n      es: 'Año',\n      pt: 'Ano',\n    },\n    column_ngl_doc_ord: {\n      it: 'Numero Ordine',\n      en: 'Order number',\n      de: 'Bestellnummer',\n      fr: 'Numéro de commande',\n      es: 'Número de pedido',\n      pt: 'Número do pedido',\n    },\n    column_dtt_ord: {\n      it: 'Data Ordine',\n      en: 'Order date',\n      de: 'Bestelldatum',\n      fr: 'Date de commande',\n      es: 'Fecha de pedido',\n      pt: 'Data do pedido',\n    },\n    column_cds_caum: {\n      it: 'Causale',\n      en: 'Reason',\n      de: 'Grund',\n      fr: 'Motif',\n      es: 'Causal',\n      pt: 'Causa',\n    },\n    column_cky_cnt_clfr: {\n      it: 'Codice cliente',\n      en: 'Customer code',\n      de: 'Kundencode',\n      fr: 'Code client',\n      es: 'Código cliente',\n      pt: 'Código do cliente',\n    },\n    column_cds_cnt_ragsoc: {\n      it: 'Ragione Sociale',\n      en: 'Company name',\n      de: 'Firmenname',\n      fr: 'Raison sociale',\n      es: 'Razón social',\n      pt: 'Razão social',\n    },\n    column_nome_agente: {\n      it: 'Agente',\n      en: 'Agent',\n      de: 'Vertreter',\n      fr: 'Agent',\n      es: 'Agente',\n      pt: 'Agente',\n    },\n    column_cky_art: {\n      it: 'Codice Articolo',\n      en: 'Item code',\n      de: 'Artikelcode',\n      fr: \"Code de l'article\",\n      es: 'Código artículo',\n      pt: 'Código do artigo',\n    },\n    column_descrizione_art: {\n      it: 'Articolo',\n      en: 'Item',\n      de: 'Artikel',\n      fr: 'Article',\n      es: 'Artículo',\n      pt: 'Artigo',\n    },\n    column_quantita: {\n      it: 'Quantità',\n      en: 'Quantity',\n      de: 'Menge',\n      fr: 'Quantité',\n      es: 'Cantidad',\n      pt: 'Quantidade',\n    },\n    column_valore: {\n      it: 'Valore',\n      en: 'Value',\n      de: 'Wert',\n      fr: 'Valeur',\n      es: 'Valor',\n      pt: 'Valor',\n    },\n    column_sigla_trasf: {\n      it: 'Sigla Doc Magazzino',\n      en: 'Warehouse doc code',\n      de: 'Lagerbeleg-Kürzel',\n      fr: 'Code doc magasin',\n      es: 'Sigla doc almacén',\n      pt: 'Sigla doc armazém',\n    },\n    column_numero_trasf: {\n      it: 'Numero Doc Magazzino',\n      en: 'Warehouse doc number',\n      de: 'Lagerbelegnummer',\n      fr: 'Numéro doc magasin',\n      es: 'Número doc almacén',\n      pt: 'Número doc armazém',\n    },\n    column_data_trasf: {\n      it: 'Data trasf',\n      en: 'Transfer date',\n      de: 'Transferdatum',\n      fr: 'Date transfert',\n      es: 'Fecha transf',\n      pt: 'Data transf',\n    },\n    column_origne: {\n      it: 'Evaso o In Ordine',\n      en: 'Fulfilled or On order',\n      de: 'Erledigt oder in Bestellung',\n      fr: 'Livré ou en commande',\n      es: 'Servido o en pedido',\n      pt: 'Atendido ou em pedido',\n    },\n    column_sco_1: {\n      it: 'Sco 1',\n      en: 'Disc 1',\n      de: 'Rabatt 1',\n      fr: 'Rem 1',\n      es: 'Dto 1',\n      pt: 'Desc 1',\n    },\n    column_sco_2: {\n      it: 'Sco 2',\n      en: 'Disc 2',\n      de: 'Rabatt 2',\n      fr: 'Rem 2',\n      es: 'Dto 2',\n      pt: 'Desc 2',\n    },\n    column_sco_3: {\n      it: 'Sco 3',\n      en: 'Disc 3',\n      de: 'Rabatt 3',\n      fr: 'Rem 3',\n      es: 'Dto 3',\n      pt: 'Desc 3',\n    },\n    column_npz_unit: {\n      it: 'Prezzo Unitario',\n      en: 'Unit price',\n      de: 'Einzelpreis',\n      fr: 'Prix unitaire',\n      es: 'Precio unitario',\n      pt: 'Preço unitário',\n    },\n  },\n};\n\nfunction getColumnLabelFromField(field: string | undefined, language: string): string {\n  if (!field) return '';\n  const key = `column_${field.replace(/`/g, '').replace(/\\s+/g, '_').toLowerCase()}`;\n  const colObj = (TEXTS.columns as any)[key];\n  if (colObj) {\n    return colObj[language] || colObj.it;\n  }\n  return field;\n}\n\ninterface ReportTableProps {\n  data: any[] | GroupedDataNode[];\n  columns: ReportColumn[];\n  aggregates?: Record<string, any>;\n  language?: string;\n  isGrouped?: boolean;\n  groupingConfig?: any[];\n}\n\nexport default function ReportTable({\n  data,\n  columns,\n  aggregates,\n  language = 'it',\n  isGrouped = false,\n  groupingConfig = [],\n}: ReportTableProps) {\n  const getInitialExpandedGroups = () => {\n    const shouldExpandAll = groupingConfig.length > 0 && groupingConfig[0].collapsed === false;\n\n    if (shouldExpandAll && isGrouped && data.length > 0) {\n      const all = new Set<string>();\n      const collect = (nodes: any[]) => {\n        nodes.forEach((n) => {\n          if ('groupKey' in n) {\n            all.add(n.groupKey);\n            if (n.children?.length) collect(n.children);\n          }\n        });\n      };\n      collect(data as GroupedDataNode[]);\n      return all;\n    }\n    return new Set<string>();\n  };\n\n  const [expandedGroups, setExpandedGroups] = useState<Set<string>>(getInitialExpandedGroups());\n  const [showOnlyPending, setShowOnlyPending] = useState(false);\n  const [columnWidths, setColumnWidths] = useState<Record<string, number>>({});\n\n  const visibleColumns = useMemo(() => columns.filter((c) => c.visible), [columns]);\n\n  const statusColumn = columns.find((c) => (c.field || '').toLowerCase().includes('stato'));\n\n  useEffect(() => {\n    setExpandedGroups(getInitialExpandedGroups());\n  }, [data, groupingConfig]);\n\n  useEffect(() => {\n    const widths: Record<string, number> = {};\n    const sampleRows: any[] = Array.isArray(data)\n      ? data.filter((r) => !('groupKey' in r)).slice(0, 10)\n      : [];\n\n    visibleColumns.forEach((col) => {\n      const label = getColumnLabelFromField(col.field, language);\n      let maxLen = (label || col.field || '').length;\n\n      sampleRows.forEach((row) => {\n        const val = row[col.field];\n        const str = val == null ? '' : String(val);\n        if (str.length > maxLen) maxLen = str.length;\n      });\n\n      let px = maxLen * 8 + 28;\n      const isTexty =\n        label.toLowerCase().includes('descr') || label.toLowerCase().includes('articolo');\n      const min = isTexty ? 160 : 90;\n      const max = isTexty ? 360 : 180;\n      if (px < min) px = min;\n      if (px > max) px = max;\n\n      widths[col.field] = px;\n    });\n\n    setColumnWidths(widths);\n  }, [data, columns, language, visibleColumns]);\n\n  const toggleGroup = (groupKey: string) => {\n    const next = new Set(expandedGroups);\n    if (next.has(groupKey)) next.delete(groupKey);\n    else next.add(groupKey);\n    setExpandedGroups(next);\n  };\n\n  const getGroupDeliveryInfo = (node: GroupedDataNode) => {\n    let total = 0;\n    let delivered = 0;\n\n    const scan = (items: any[]) => {\n      items.forEach((it) => {\n        if ('groupKey' in it) {\n          if (it.children?.length) scan(it.children);\n        } else {\n          total++;\n          if (statusColumn) {\n            const raw = (it[statusColumn.field] || '').toString().trim().toUpperCase();\n            if (raw === 'EVASO' || raw === 'CONSEGNATO') delivered++;\n          }\n        }\n      });\n    };\n\n    if (node.children?.length) scan(node.children);\n\n    const perc = total > 0 ? Math.round((delivered / total) * 100) : 0;\n    return { total, delivered, perc };\n  };\n\n  const filteredData = (() => {\n    if (!showOnlyPending) return data;\n    if (isGrouped && Array.isArray(data) && data.length > 0 && 'groupKey' in data[0]) {\n      return (data as GroupedDataNode[]).filter((node) => {\n        const { perc } = getGroupDeliveryInfo(node);\n        return perc < 100;\n      });\n    }\n    if (Array.isArray(data)) {\n      return data.filter((row: any) => {\n        if (!statusColumn) return true;\n        const raw = (row[statusColumn.field] || '').toString().trim().toUpperCase();\n        return !(raw === 'EVASO' || raw === 'CONSEGNATO');\n      });\n    }\n    return data;\n  })();\n\n  const renderStatusBadge = (raw: any) => {\n    const txt = (raw || '').toString().trim().toUpperCase();\n    const delivered = txt === 'EVASO' || txt === 'CONSEGNATO';\n    return (\n      <span\n        className={`inline-flex items-center px-2 py-[2px] rounded-full text-[11px] font-semibold ${\n          delivered\n            ? 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200'\n            : 'bg-sky-100 text-sky-700 ring-1 ring-sky-200'\n        }`}\n      >\n        {delivered\n          ? TEXTS.statusDelivered[language as keyof typeof TEXTS.statusDelivered]\n          : TEXTS.statusInOrder[language as keyof typeof TEXTS.statusInOrder]}\n      </span>\n    );\n  };\n\n  const renderDataRow = (row: any, idx: number) => {\n    return (\n      <div\n        key={idx}\n        className=\"flex border-b border-slate-100 hover:bg-slate-50/80 transition-colors duration-150\"\n      >\n        {visibleColumns.map((col) => {\n          const width = columnWidths[col.field] || 120;\n          if (statusColumn && col.field === statusColumn.field) {\n            return (\n              <div key={col.field} className=\"px-3 py-2 flex items-center\" style={{ width, minWidth: width }}>\n                {renderStatusBadge(row[col.field])}\n              </div>\n            );\n          }\n          return (\n            <div\n              key={col.field}\n              className={`px-3 py-2 text-xs text-slate-800 ${\n                col.align === 'right' ? 'text-right' : 'text-left'\n              } overflow-hidden text-ellipsis whitespace-nowrap`}\n              style={{ width, minWidth: width }}\n              title={row[col.field] != null ? String(row[col.field]) : ''}\n            >\n              {ReportEngine.formatValue(row[col.field], col, language)}\n            </div>\n          );\n        })}\n      </div>\n    );\n  };\n\n  const renderGroupedRow = (node: GroupedDataNode, index: number) => {\n    const isExpanded = expandedGroups.has(node.groupKey);\n    const hasChildren = node.children.length > 0;\n    const { total, delivered, perc } = getGroupDeliveryInfo(node);\n\n    let badgeClass = 'bg-orange-100 text-orange-800';\n    let barClass = 'bg-orange-500';\n    if (perc >= 75) {\n      badgeClass = 'bg-emerald-100 text-emerald-700';\n      barClass = 'bg-emerald-500';\n    } else if (perc >= 26) {\n      badgeClass = 'bg-amber-100 text-amber-800';\n      barClass = 'bg-amber-400';\n    }\n\n    return (\n      <div key={`${node.groupKey}-${index}`} className=\"bg-white\">\n        <div\n          className=\"flex items-center justify-between border-b border-sky-200 bg-gradient-to-r from-sky-100 to-sky-50 hover:from-sky-200/80 hover:to-sky-100/80 cursor-pointer px-4 py-2.5\"\n          onClick={() => hasChildren && toggleGroup(node.groupKey)}\n        >\n          <div className=\"flex items-center gap-2\">\n            {hasChildren && (\n              <span className=\"rounded-full bg-white/90 p-1 shadow-sm\">\n                {isExpanded ? (\n                  <ChevronDown className=\"w-4 h-4 text-sky-700\" />\n                ) : (\n                  <ChevronRight className=\"w-4 h-4 text-sky-700\" />\n                )}\n              </span>\n            )}\n            <span className=\"text-sm font-bold text-sky-950\">\n              {TEXTS.labelOrder[language as keyof typeof TEXTS.labelOrder]}: {node.groupLabel}\n            </span>\n            <span className={`text-[11px] font-semibold px-2 py-[1px] rounded-full ${badgeClass}`}>\n              {perc}% {TEXTS.labelDelivered[language as keyof typeof TEXTS.labelDelivered]}\n            </span>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <span className=\"text-xs font-bold text-sky-900\">\n              {TEXTS.labelFulfilled[language as keyof typeof TEXTS.labelFulfilled]} {delivered}/{total}\n            </span>\n            <div className=\"w-28 h-2.5 bg-slate-200 rounded-full overflow-hidden shadow-inner\">\n              <div className={`h-2.5 transition-all ${barClass}`} style={{ width: `${perc}%` }} />\n            </div>\n          </div>\n        </div>\n\n        {isExpanded && hasChildren && (\n          <div className=\"border-l border-slate-100\">\n            {node.children.map((child: any, i: number) =>\n              'groupKey' in child ? renderGroupedRow(child, i) : renderDataRow(child, i)\n            )}\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"bg-white/50 backdrop-blur-sm rounded-2xl shadow-md border border-slate-100 overflow-hidden flex flex-col max-h-[72vh]\">\n      {/* header tabella */}\n      <div className=\"flex items-center justify-between px-4 py-3 bg-white/80 border-b border-slate-100\">\n        <button\n          type=\"button\"\n          onClick={() => setShowOnlyPending((p) => !p)}\n          className={`inline-flex items-center gap-2 text-sm font-semibold rounded-full px-4 py-1.5 transition ${\n            showOnlyPending\n              ? 'bg-sky-600 text-white shadow-sm'\n              : 'bg-slate-200 text-slate-700 hover:bg-slate-300'\n          }`}\n        >\n          <span className=\"text-xs\">●</span>\n          {TEXTS.buttonShowOnlyPending[language as keyof typeof TEXTS.buttonShowOnlyPending]}\n        </button>\n\n        <div className=\"flex items-center gap-2\">\n          <button\n            type=\"button\"\n            className=\"px-3 py-1.5 rounded-md bg-slate-100 text-slate-700 text-xs hover:bg-slate-200 shadow-sm\"\n          >\n            {TEXTS.buttonExcel[language as keyof typeof TEXTS.buttonExcel]}\n          </button>\n          <button\n            type=\"button\"\n            className=\"px-3 py-1.5 rounded-md bg-slate-100 text-slate-700 text-xs hover:bg-slate-200 shadow-sm\"\n          >\n            {TEXTS.buttonPDF[language as keyof typeof TEXTS.buttonPDF]}\n          </button>\n        </div>\n      </div>\n\n      {/* intestazione colonne */}\n      <div className=\"flex border-b border-slate-200 bg-slate-100/90 sticky top-0 z-10\">\n        {visibleColumns.map((col) => {\n          const width = columnWidths[col.field] || 120;\n          return (\n            <div\n              key={col.field}\n              className={`px-3 py-2 text-[11px] font-semibold text-slate-700 uppercase tracking-wide ${\n                col.align === 'right' ? 'text-right' : 'text-left'\n              } overflow-hidden text-ellipsis whitespace-nowrap`}\n              style={{ width, minWidth: width }}\n            >\n              {getColumnLabelFromField(col.field, language)}\n            </div>\n          );\n        })}\n      </div>\n\n      {/* corpo tabella */}\n      <div className=\"flex-1 overflow-auto\">\n        {filteredData.length === 0 ? (\n          <div className=\"px-6 py-12 text-center text-slate-400 text-sm\">\n            {TEXTS.messageNoDocuments[language as keyof typeof TEXTS.messageNoDocuments]}\n          </div>\n        ) : isGrouped && 'groupKey' in filteredData[0] ? (\n          (filteredData as GroupedDataNode[]).map((node, idx) => renderGroupedRow(node, idx))\n        ) : (\n          (filteredData as any[]).map((row, idx) => renderDataRow(row, idx))\n        )}\n      </div>\n\n      {/* footer totali */}\n      {aggregates && Object.keys(aggregates).length > 0 && (\n        <div className=\"flex border-t border-slate-200 bg-blue-50/80\">\n          {visibleColumns.map((col, idx) => {\n            const width = columnWidths[col.field] || 120;\n            return (\n              <div\n                key={col.field}\n                className={`px-3 py-2 text-xs ${\n                  col.align === 'right' ? 'text-right' : 'text-left'\n                } overflow-hidden text-ellipsis whitespace-nowrap`}\n                style={{ width, minWidth: width }}\n              >\n                {idx === 0 ? (\n                  <span className=\"font-bold text-slate-900\">\n                    {TEXTS.labelTotal[language as keyof typeof TEXTS.labelTotal]}\n                  </span>\n                ) : col.aggregate && aggregates[col.field] !== undefined ? (\n                  <span className=\"font-bold text-slate-900\">\n                    {ReportEngine.formatValue(aggregates[col.field], col, language)}\n                  </span>\n                ) : null}\n              </div>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n\n// ============================================================\n// COMPONENTE: ReportFilters\n// FILE: components/reports/ReportFilters.tsx\n// ============================================================\n\n'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { ReportFilter } from '@/types/report';\nimport { Filter, X } from 'lucide-react';\n\nconst TEXTS_FILTERS = {\n  filters: {\n    it: 'Filtri',\n    en: 'Filters',\n    de: 'Filter',\n    fr: 'Filtres',\n    es: 'Filtros',\n    pt: 'Filtros',\n  },\n  show: {\n    it: 'Mostra',\n    en: 'Show',\n    de: 'Anzeigen',\n    fr: 'Afficher',\n    es: 'Mostrar',\n    pt: 'Mostrar',\n  },\n  hide: {\n    it: 'Nascondi',\n    en: 'Hide',\n    de: 'Verbergen',\n    fr: 'Masquer',\n    es: 'Ocultar',\n    pt: 'Ocultar',\n  },\n  applyFilters: {\n    it: 'Applica filtri',\n    en: 'Apply filters',\n    de: 'Filter anwenden',\n    fr: 'Appliquer les filtres',\n    es: 'Aplicar filtros',\n    pt: 'Aplicar filtros',\n  },\n  reset: {\n    it: 'Reset',\n    en: 'Reset',\n    de: 'Zurücksetzen',\n    fr: 'Réinitialiser',\n    es: 'Restablecer',\n    pt: 'Redefinir',\n  },\n  all: {\n    it: 'Tutti',\n    en: 'All',\n    de: 'Alle',\n    fr: 'Tous',\n    es: 'Todos',\n    pt: 'Todos',\n  },\n  search: {\n    it: 'Cerca...',\n    en: 'Search...',\n    de: 'Suchen...',\n    fr: 'Rechercher...',\n    es: 'Buscar...',\n    pt: 'Pesquisar...',\n  },\n  selected: {\n    it: 'selezionati',\n    en: 'selected',\n    de: 'ausgewählt',\n    fr: 'sélectionnés',\n    es: 'seleccionados',\n    pt: 'selecionados',\n  },\n  noOptionsFound: {\n    it: 'Nessuna opzione trovata',\n    en: 'No options found',\n    de: 'Keine Optionen gefunden',\n    fr: 'Aucune option trouvée',\n    es: 'No se encontraron opciones',\n    pt: 'Nenhuma opção encontrada',\n  },\n  selectAll: {\n    it: 'Seleziona tutti',\n    en: 'Select all',\n    de: 'Alle auswählen',\n    fr: 'Tout sélectionner',\n    es: 'Seleccionar todo',\n    pt: 'Selecionar tudo',\n  },\n  from: {\n    it: 'Da',\n    en: 'From',\n    de: 'Von',\n    fr: 'De',\n    es: 'Desde',\n    pt: 'De',\n  },\n  to: {\n    it: 'A',\n    en: 'To',\n    de: 'Bis',\n    fr: 'À',\n    es: 'Hasta',\n    pt: 'Até',\n  },\n  // Label dei filtri comuni\n  filterDataOrdine: {\n    it: 'Data Ordine',\n    en: 'Order Date',\n    de: 'Bestelldatum',\n    fr: 'Date de Commande',\n    es: 'Fecha de Pedido',\n    pt: 'Data do Pedido',\n  },\n  filterNumeroDocumento: {\n    it: 'Numero Documento',\n    en: 'Document Number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro de Document',\n    es: 'Número de Documento',\n    pt: 'Número do Documento',\n  },\n  filterCodiceArticolo: {\n    it: 'Codice Articolo',\n    en: 'Item Code',\n    de: 'Artikelcode',\n    fr: 'Code Article',\n    es: 'Código Artículo',\n    pt: 'Código do Artigo',\n  },\n  filterAnno: {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  filterTipoDocumento: {\n    it: 'Tipo Documento',\n    en: 'Document Type',\n    de: 'Dokumenttyp',\n    fr: 'Type de Document',\n    es: 'Tipo de Documento',\n    pt: 'Tipo de Documento',\n  },\n  filterCliente: {\n    it: 'Cliente',\n    en: 'Customer',\n    de: 'Kunde',\n    fr: 'Client',\n    es: 'Cliente',\n    pt: 'Cliente',\n  },\n};\n\n// opzioni comuni da tradurre (es. \"Tutti\", \"Pagato\", ecc.)\nfunction translateFilterOption(option: string, lang: string): string {\n  const map: Record<string, Record<string, string>> = {\n    'Tutti': {\n      it: 'Tutti',\n      en: 'All',\n      de: 'Alle',\n      fr: 'Tous',\n      es: 'Todos',\n      pt: 'Todos',\n    },\n    'Pagato': {\n      it: 'Pagato',\n      en: 'Paid',\n      de: 'Bezahlt',\n      fr: 'Payé',\n      es: 'Pagado',\n      pt: 'Pago',\n    },\n    'Da Pagare': {\n      it: 'Da Pagare',\n      en: 'To pay',\n      de: 'Zu zahlen',\n      fr: 'À payer',\n      es: 'Por pagar',\n      pt: 'A pagar',\n    },\n    'Annullato': {\n      it: 'Annullato',\n      en: 'Cancelled',\n      de: 'Storniert',\n      fr: 'Annulé',\n      es: 'Anulado',\n      pt: 'Cancelado',\n    },\n  };\n  if (map[option]) {\n    return map[option][lang] || map[option].it;\n  }\n  return option;\n}\n\ninterface ReportFiltersProps {\n  filters: ReportFilter[];\n  values: Record<string, any>;\n  onChange: (values: Record<string, any>) => void;\n  onApply: () => void;\n  autoOptions?: Record<string, string[]>;\n  rawData?: any[];\n  language?: string;\n}\n\nexport default function ReportFilters({\n  filters,\n  values,\n  onChange,\n  onApply,\n  autoOptions = {},\n  rawData = [],\n  language = 'it',\n}: ReportFiltersProps) {\n  const currentLang = language || 'it';\n\n  const [showFilters, setShowFilters] = useState(false);\n  const [localValues, setLocalValues] = useState(values);\n  const [autocompleteOpen, setAutocompleteOpen] = useState<string | null>(null);\n  const autocompleteRef = useRef<HTMLDivElement>(null);\n\n  const [multiselectSearch, setMultiselectSearch] = useState<Record<string, string>>({});\n  const [multiselectOpen, setMultiselectOpen] = useState<Record<string, boolean>>({});\n\n  useEffect(() => {\n    setLocalValues(values);\n  }, [values]);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (autocompleteRef.current && !autocompleteRef.current.contains(event.target as Node)) {\n        setAutocompleteOpen(null);\n        setMultiselectOpen({});\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  const handleChange = (field: string, value: any) => {\n    setLocalValues({ ...localValues, [field]: value });\n  };\n\n  const getUniqueValues = (field: string): string[] => {\n    if (!rawData || rawData.length === 0) return [];\n\n    const uniqueValues = new Set<string>();\n    rawData.forEach((row) => {\n      const value = row[field];\n      if (value != null && value !== '') {\n        uniqueValues.add(String(value));\n      }\n    });\n\n    return Array.from(uniqueValues).sort();\n  };\n\n  const getSuggestions = (field: string, inputValue: string): string[] => {\n    if (!inputValue) return getUniqueValues(field).slice(0, 10);\n\n    const uniqueValues = getUniqueValues(field);\n    return uniqueValues\n      .filter((val) => val.toLowerCase().includes(inputValue.toLowerCase()))\n      .slice(0, 10);\n  };\n\n  const handleApply = () => {\n    onChange(localValues);\n    onApply();\n    setShowFilters(false);\n  };\n\n  const handleReset = () => {\n    const resetValues: Record<string, any> = {};\n    filters.forEach((filter) => {\n      resetValues[filter.field] = filter.default || null;\n    });\n    setLocalValues(resetValues);\n    onChange(resetValues);\n    onApply();\n  };\n\n  const getDateRangeDefault = (defaultValue: string) => {\n    const today = new Date();\n    const currentYear = today.getFullYear();\n\n    switch (defaultValue) {\n      case 'current_year':\n        return {\n          from: `${currentYear}-01-01`,\n          to: `${currentYear}-12-31`,\n        };\n      case 'last_year':\n        return {\n          from: `${currentYear - 1}-01-01`,\n          to: `${currentYear - 1}-12-31`,\n        };\n      case 'last_6_months': {\n        const sixMonthsAgo = new Date(today);\n        sixMonthsAgo.setMonth(today.getMonth() - 6);\n        return {\n          from: sixMonthsAgo.toISOString().split('T')[0],\n          to: today.toISOString().split('T')[0],\n        };\n      }\n      default:\n        return { from: '', to: '' };\n    }\n  };\n\n  const getFilterLabel = (filter: ReportFilter): string => {\n    // Mappa i field comuni a chiavi TEXTS\n    const fieldToTextKey: Record<string, string> = {\n      data_ordine: 'filterDataOrdine',\n      numero_documento: 'filterNumeroDocumento',\n      codice_articolo: 'filterCodiceArticolo',\n      anno: 'filterAnno',\n      tipo_documento: 'filterTipoDocumento',\n      cliente: 'filterCliente',\n    };\n\n    const textKey = fieldToTextKey[filter.field];\n    if (textKey && (TEXTS_FILTERS as any)[textKey]) {\n      return (TEXTS_FILTERS as any)[textKey][currentLang] || filter.field;\n    }\n\n    // ❗ NON ritorno più filter.label, perché arriva in italiano dal DB\n    return filter.field;\n  };\n\n  const renderFilter = (filter: ReportFilter) => {\n    const value = localValues[filter.field];\n    const label = getFilterLabel(filter);\n\n    switch (filter.type) {\n      case 'text': {\n        const suggestions = getSuggestions(filter.field, value || '');\n        const showAutocomplete = autocompleteOpen === filter.field && suggestions.length > 0;\n\n        return (\n          <div className=\"relative\" ref={autocompleteOpen === filter.field ? autocompleteRef : null}>\n            <input\n              type=\"text\"\n              value={value || ''}\n              onChange={(e) => handleChange(filter.field, e.target.value)}\n              onFocus={() => setAutocompleteOpen(filter.field)}\n              className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              placeholder={label}\n            />\n            {showAutocomplete && (\n              <div className=\"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                {suggestions.map((suggestion, idx) => (\n                  <button\n                    key={idx}\n                    type=\"button\"\n                    onClick={() => {\n                      handleChange(filter.field, suggestion);\n                      setAutocompleteOpen(null);\n                    }}\n                    className=\"w-full text-left px-3 py-2 hover:bg-sky-50 text-sm text-gray-700 hover:text-sky-900 border-b last:border-b-0\"\n                  >\n                    {suggestion}\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n        );\n      }\n\n      case 'select': {\n        const selectOptions =\n          filter.options === 'auto' ? autoOptions[filter.field] || [] : filter.options || [];\n\n        return (\n          <select\n            value={value || ''}\n            onChange={(e) => handleChange(filter.field, e.target.value)}\n            className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 bg-white shadow-sm\"\n          >\n            <option value=\"\">{TEXTS_FILTERS.all[currentLang]}</option>\n            {selectOptions.map((option) => (\n              <option key={option} value={option}>\n                {translateFilterOption(option, currentLang)}\n              </option>\n            ))}\n          </select>\n        );\n      }\n\n      case 'multiselect': {\n        const multiOptions =\n          filter.options === 'auto' ? autoOptions[filter.field] || [] : filter.options || [];\n\n        const selectedValues = value || [];\n        const searchTerm = multiselectSearch[filter.field] || '';\n        const isOpen = multiselectOpen[filter.field] || false;\n\n        const filteredOptions = multiOptions.filter((option) =>\n          option.toLowerCase().includes(searchTerm.toLowerCase())\n        );\n\n        return (\n          <div className=\"relative\" ref={isOpen ? autocompleteRef : null}>\n            {selectedValues.length > 0 && (\n              <div className=\"flex flex-wrap gap-1 mb-2\">\n                {selectedValues.map((val: string) => (\n                  <span\n                    key={val}\n                    className=\"inline-flex items-center gap-1 bg-sky-100 text-sky-800 text-xs px-2 py-1 rounded-full\"\n                  >\n                    {translateFilterOption(val, currentLang)}\n                    <button\n                      type=\"button\"\n                      onClick={() => {\n                        const newValues = selectedValues.filter((v: string) => v !== val);\n                        handleChange(filter.field, newValues);\n                      }}\n                      className=\"text-sky-600 hover:text-sky-800\"\n                    >\n                      ×\n                    </button>\n                  </span>\n                ))}\n              </div>\n            )}\n\n            <div className=\"relative\">\n              <input\n                type=\"text\"\n                value={searchTerm}\n                onChange={(e) =>\n                  setMultiselectSearch({\n                    ...multiselectSearch,\n                    [filter.field]: e.target.value,\n                  })\n                }\n                onFocus={() =>\n                  setMultiselectOpen({\n                    ...multiselectOpen,\n                    [filter.field]: true,\n                  })\n                }\n                placeholder={`${TEXTS_FILTERS.search[currentLang]} (${\n                  selectedValues.length\n                } ${TEXTS_FILTERS.selected[currentLang]})`}\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n\n              {isOpen && (\n                <div className=\"absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                  {filteredOptions.length === 0 ? (\n                    <div className=\"px-3 py-2 text-sm text-gray-500\">\n                      {TEXTS_FILTERS.noOptionsFound[currentLang]}\n                    </div>\n                  ) : (\n                    <>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          handleChange(filter.field, filteredOptions);\n                          setMultiselectOpen({\n                            ...multiselectOpen,\n                            [filter.field]: false,\n                          });\n                        }}\n                        className=\"w-full text-left px-3 py-2 text-xs text-sky-600 hover:bg-sky-50 border-b\"\n                      >\n                        ✓ {TEXTS_FILTERS.selectAll[currentLang]} ({filteredOptions.length})\n                      </button>\n                      {filteredOptions.map((option) => (\n                        <label\n                          key={option}\n                          className=\"flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer border-b last:border-b-0\"\n                        >\n                          <input\n                            type=\"checkbox\"\n                            checked={selectedValues.includes(option)}\n                            onChange={(e) => {\n                              const newValues = e.target.checked\n                                ? [...selectedValues, option]\n                                : selectedValues.filter((v: string) => v !== option);\n                              handleChange(filter.field, newValues);\n                            }}\n                            className=\"rounded\"\n                          />\n                          <span className=\"text-sm\">{translateFilterOption(option, currentLang)}</span>\n                        </label>\n                      ))}\n                    </>\n                  )}\n                </div>\n              )}\n            </div>\n\n            <button\n              type=\"button\"\n              onClick={() =>\n                setMultiselectOpen({\n                  ...multiselectOpen,\n                  [filter.field]: !isOpen,\n                })\n              }\n              className=\"absolute right-2 top-2 text-gray-400 hover:text-gray-600\"\n            >\n              {isOpen ? '▲' : '▼'}\n            </button>\n          </div>\n        );\n      }\n\n      case 'daterange': {\n        const dateRange = value || getDateRangeDefault(filter.default as string);\n\n        return (\n          <div className=\"flex gap-2\">\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.from[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.from || ''}\n                onChange={(e) => handleChange(filter.field, { ...dateRange, from: e.target.value })}\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.to[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.to || ''}\n                onChange={(e) => handleChange(filter.field, { ...dateRange, to: e.target.value })}\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n          </div>\n        );\n      }\n\n      default:\n        return null;\n    }\n  };\n\n  const activeFiltersCount = Object.values(localValues).filter(\n    (v) =>\n      v !== null &&\n      v !== undefined &&\n      v !== '' &&\n      !(typeof v === 'object' && Object.keys(v).length === 0)\n  ).length;\n\n  return (\n    <div className=\"bg-white/80 backdrop-blur-sm rounded-xl shadow-sm border border-gray-100 p-4 mb-4\">\n      <div className=\"flex items-center justify-between mb-3\">\n        <div className=\"flex items-center gap-2\">\n          <span className=\"inline-flex items-center justify-center w-8 h-8 rounded-full bg-sky-100 text-sky-700 shadow-sm\">\n            <Filter className=\"w-4 h-4\" />\n          </span>\n          <h3 className=\"text-base font-semibold text-gray-900\">\n            {TEXTS_FILTERS.filters[currentLang]}\n          </h3>\n          {activeFiltersCount > 0 && (\n            <span className=\"px-2 py-1 bg-sky-100 text-sky-800 text-xs font-medium rounded-full\">\n              {activeFiltersCount}\n            </span>\n          )}\n        </div>\n        <button\n          onClick={() => setShowFilters(!showFilters)}\n          className=\"text-sky-600 hover:text-sky-700 text-sm font-medium\"\n        >\n          {showFilters ? TEXTS_FILTERS.hide[currentLang] : TEXTS_FILTERS.show[currentLang]}\n        </button>\n      </div>\n\n      {showFilters && (\n        <>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4\">\n            {filters.map((filter) => {\n              const label = getFilterLabel(filter);\n              return (\n                <div key={filter.field}>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    {label}\n                  </label>\n                  {renderFilter(filter)}\n                </div>\n              );\n            })}\n          </div>\n\n          <div className=\"flex gap-2 pt-4 border-t border-dashed border-slate-200\">\n            <button\n              onClick={handleApply}\n              className=\"px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 font-medium shadow-sm transition\"\n            >\n              {TEXTS_FILTERS.applyFilters[currentLang]}\n            </button>\n            <button\n              onClick={handleReset}\n              className=\"px-4 py-2 border border-gray-200 text-gray-700 bg-white rounded-md hover:bg-gray-50 font-medium flex items-center gap-2\"\n            >\n              <X className=\"w-4 h-4\" />\n              {TEXTS_FILTERS.reset[currentLang]}\n            </button>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}\n\n// ============================================================\n// COMPONENTE: ReportExport\n// FILE: components/reports/ReportExport.tsx\n// ============================================================\n\n'use client';\n\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { FileText, Table, File } from 'lucide-react';\n\nconst TEXTS_EXPORT = {\n  exportPdfTitle: {\n    it: 'Esporta come PDF',\n    en: 'Export as PDF',\n    de: 'Als PDF exportieren',\n    fr: 'Exporter en PDF',\n    es: 'Exportar como PDF',\n    pt: 'Exportar como PDF',\n  },\n  exportExcelTitle: {\n    it: 'Esporta come Excel',\n    en: 'Export as Excel',\n    de: 'Als Excel exportieren',\n    fr: 'Exporter en Excel',\n    es: 'Exportar como Excel',\n    pt: 'Exportar como Excel',\n  },\n  exportCsvTitle: {\n    it: 'Esporta come CSV',\n    en: 'Export as CSV',\n    de: 'Als CSV exportieren',\n    fr: \"Exporter en CSV\",\n    es: 'Exportar como CSV',\n    pt: 'Exportar como CSV',\n  },\n  errorCsvExport: {\n    it: \"Errore durante l'export CSV\",\n    en: 'Error during CSV export',\n    de: 'Fehler beim CSV-Export',\n    fr: \"Erreur lors de l'export CSV\",\n    es: 'Error durante la exportación CSV',\n    pt: 'Erro durante a exportação CSV',\n  },\n  errorExcelExport: {\n    it: \"Errore durante l'export Excel\",\n    en: 'Error during Excel export',\n    de: 'Fehler beim Excel-Export',\n    fr: \"Erreur lors de l'export Excel\",\n    es: 'Error durante la exportación Excel',\n    pt: 'Erro durante a exportação Excel',\n  },\n  noExportFormats: {\n    it: 'Nessun formato di export disponibile',\n    en: 'No export formats available',\n    de: 'Keine Exportformate verfügbar',\n    fr: \"Aucun format d'export disponible\",\n    es: 'No hay formatos de exportación disponibles',\n    pt: 'Nenhum formato de exportação disponível',\n  },\n  buttonPdf: {\n    it: 'PDF',\n    en: 'PDF',\n    de: 'PDF',\n    fr: 'PDF',\n    es: 'PDF',\n    pt: 'PDF',\n  },\n  buttonExcel: {\n    it: 'Excel',\n    en: 'Excel',\n    de: 'Excel',\n    fr: 'Excel',\n    es: 'Excel',\n    pt: 'Excel',\n  },\n  buttonCsv: {\n    it: 'CSV',\n    en: 'CSV',\n    de: 'CSV',\n    fr: 'CSV',\n    es: 'CSV',\n    pt: 'CSV',\n  },\n};\n\nfunction getExportColumnLabel(field: string, language: string): string {\n  const key = `column_${field.replace(/`/g, '').replace(/\\s+/g, '_').toLowerCase()}`;\n  const colObj = (TEXTS.columns as any)[key];\n  if (colObj) {\n    return colObj[language] || colObj.it;\n  }\n  return field;\n}\n\ninterface ReportExportProps {\n  data: any[];\n  config: ReportConfig;\n  reportTitle: string;\n  language?: string;\n}\n\nexport default function ReportExport({ data, config, reportTitle, language = 'it' }: ReportExportProps) {\n  const flattenGroupedData = (items: any[]): any[] => {\n    const result: any[] = [];\n\n    items.forEach((item) => {\n      if ('groupKey' in item) {\n        result.push(...flattenGroupedData(item.children));\n      } else {\n        result.push(item);\n      }\n    });\n\n    return result;\n  };\n\n  const exportToCSV = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      const headers = visibleColumns.map((col) => getExportColumnLabel(col.field, language)).join(',');\n\n      const rows = flatData.map((row) =>\n        visibleColumns\n          .map((col) => {\n            const value = ReportEngine.formatValue(row[col.field], col, language);\n            return `\"${String(value).replace(/\"/g, '\"\"')}\"`;\n          })\n          .join(',')\n      );\n\n      const csv = [headers, ...rows].join('\\n');\n\n      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle.replace(/\\s+/g, '_').trim()}_${\n        new Date().toISOString().split('T')[0]\n      }.csv`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting CSV:', error);\n      alert(TEXTS_EXPORT.errorCsvExport[language as keyof typeof TEXTS_EXPORT.errorCsvExport]);\n    }\n  };\n\n  const exportToExcel = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      let html = '<table border=\"1\"><thead><tr>';\n\n      visibleColumns.forEach((col) => {\n        html += `<th>${getExportColumnLabel(col.field, language)}</th>`;\n      });\n      html += '</tr></thead><tbody>';\n\n      flatData.forEach((row) => {\n        html += '<tr>';\n        visibleColumns.forEach((col) => {\n          const value = ReportEngine.formatValue(row[col.field], col, language);\n          html += `<td>${value}</td>`;\n        });\n        html += '</tr>';\n      });\n\n      html += '</tbody></table>';\n\n      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle.replace(/\\s+/g, '_').trim()}_${\n        new Date().toISOString().split('T')[0]\n      }.xls`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting Excel:', error);\n      alert(TEXTS_EXPORT.errorExcelExport[language as keyof typeof TEXTS_EXPORT.errorExcelExport]);\n    }\n  };\n\n  const exportToPDF = () => {\n    window.print();\n  };\n\n  return (\n    <div className=\"flex flex-wrap gap-2 mt-4\">\n      {config.export?.pdf && (\n        <button\n          onClick={exportToPDF}\n          className=\"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={TEXTS_EXPORT.exportPdfTitle[language as keyof typeof TEXTS_EXPORT.exportPdfTitle]}\n        >\n          <FileText className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonPdf[language as keyof typeof TEXTS_EXPORT.buttonPdf]}\n        </button>\n      )}\n\n      {config.export?.excel && (\n        <button\n          onClick={exportToExcel}\n          className=\"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={TEXTS_EXPORT.exportExcelTitle[language as keyof typeof TEXTS_EXPORT.exportExcelTitle]}\n        >\n          <Table className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonExcel[language as keyof typeof TEXTS_EXPORT.buttonExcel]}\n        </button>\n      )}\n\n      {config.export?.csv && (\n        <button\n          onClick={exportToCSV}\n          className=\"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={TEXTS_EXPORT.exportCsvTitle[language as keyof typeof TEXTS_EXPORT.exportCsvTitle]}\n        >\n          <File className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonCsv[language as keyof typeof TEXTS_EXPORT.buttonCsv]}\n        </button>\n      )}\n\n      {!config.export?.pdf && !config.export?.excel && !config.export?.csv && (\n        <p className=\"text-sm text-gray-500\">\n          {TEXTS_EXPORT.noExportFormats[language as keyof typeof TEXTS_EXPORT.noExportFormats]}\n        </p>\n      )}\n    </div>\n  );\n}\n\n// ============================================================\n// COMPONENTE: ReportBuilder\n// FILE: components/reports/ReportBuilder.tsx\n// ============================================================\n\n'use client';\n\nimport { useState, useEffect } from 'react';\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { executeQuery, getDocumentTypes, getDocumentYears } from '@/lib/mysql-query';\nimport ReportTable from './ReportTable';\nimport { ReportFilters as ReportFiltersComp } from './ReportFilters';\nimport { ReportExport as ReportExportComp } from './ReportExport';\nimport { Loader2 } from 'lucide-react';\n\nconst TEXTS_BUILDER = {\n  errorTitle: {\n    it: 'Errore',\n    en: 'Error',\n    de: 'Fehler',\n    fr: 'Erreur',\n    es: 'Error',\n    pt: 'Erro',\n  },\n  loadingData: {\n    it: 'Caricamento dati...',\n    en: 'Loading data...',\n    de: 'Daten werden geladen...',\n    fr: 'Chargement des données...',\n    es: 'Cargando datos...',\n    pt: 'Carregando dados...',\n  },\n  activeFilters: {\n    it: 'Filtri attivi:',\n    en: 'Active filters:',\n    de: 'Aktive Filter:',\n    fr: 'Filtres actifs :',\n    es: 'Filtros activos:',\n    pt: 'Filtros ativos:',\n  },\n  removeAll: {\n    it: 'Rimuovi tutti',\n    en: 'Remove all',\n    de: 'Alle entfernen',\n    fr: 'Tout supprimer',\n    es: 'Eliminar todos',\n    pt: 'Remover todos',\n  },\n  noDataTitle: {\n    it: 'Nessun dato disponibile',\n    en: 'No data available',\n    de: 'Keine Daten verfügbar',\n    fr: 'Aucune donnée disponible',\n    es: 'No hay datos disponibles',\n    pt: 'Nenhum dado disponível',\n  },\n  noDataText: {\n    it: 'Non ci sono dati per il cliente selezionato con i filtri applicati.',\n    en: 'There is no data for the selected customer with the applied filters.',\n    de: 'Für den ausgewählten Kunden mit den angewendeten Filtern sind keine Daten vorhanden.',\n    fr: 'Aucune donnée pour le client sélectionné avec les filtres appliqués.',\n    es: 'No hay datos para el cliente seleccionado con los filtros aplicados.',\n    pt: 'Não há dados para o cliente selecionado com os filtros aplicados.',\n  },\n  languageLabel: {\n    it: 'Lingua',\n    en: 'Language',\n    de: 'Sprache',\n    fr: 'Langue',\n    es: 'Idioma',\n    pt: 'Idioma',\n  },\n  debugTitle: {\n    it: 'Debug: Query SQL eseguita',\n    en: 'Debug: Executed SQL query',\n    de: 'Debug: Ausgeführte SQL-Abfrage',\n    fr: 'Débogage : Requête SQL exécutée',\n    es: 'Depuración: consulta SQL ejecutada',\n    pt: 'Depuração: consulta SQL executada',\n  },\n  debugSql: {\n    it: 'Query SQL:',\n    en: 'SQL query:',\n    de: 'SQL-Abfrage:',\n    fr: 'Requête SQL :',\n    es: 'Consulta SQL:',\n    pt: 'Consulta SQL:',\n  },\n  debugParams: {\n    it: 'Parametri:',\n    en: 'Parameters:',\n    de: 'Parameter:',\n    fr: 'Paramètres :',\n    es: 'Parámetros:',\n    pt: 'Parâmetros:',\n  },\n  debugBind: {\n    it: 'Bind Types:',\n    en: 'Bind Types:',\n    de: 'Bind-Typen:',\n    fr: 'Types de bind :',\n    es: 'Tipos de bind:',\n    pt: 'Tipos de bind:',\n  },\n};\n\ninterface ReportBuilderProps {\n  reportSlug: string;\n  clientCode: string;\n  language?: string;\n}\n\nexport default function ReportBuilder({\n  reportSlug,\n  clientCode,\n  language: initialLanguage = 'it',\n}: ReportBuilderProps) {\n  const [config, setConfig] = useState<ReportConfig | null>(null);\n  const [rawData, setRawData] = useState<any[]>([]);\n  const [processedData, setProcessedData] = useState<any[]>([]);\n  const [aggregates, setAggregates] = useState<Record<string, any>>({});\n  const [filters, setFilters] = useState<Record<string, any>>({});\n  const [autoOptions, setAutoOptions] = useState<Record<string, string[]>>({});\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [debugInfo, setDebugInfo] = useState<any>(null);\n  const [currentLanguage, setCurrentLanguage] = useState(initialLanguage);\n\n  // restituisce titolo tradotto partendo dallo slug\n  const getTranslatedTitle = (slug: string, lang: string) => {\n    const obj = REPORT_TEXTS[slug];\n    if (obj) return obj.title[lang] || obj.title.it;\n    // fallback: se non c'è nel dizionario uso lo slug\n    return slug;\n  };\n\n  const getTranslatedDescription = (slug: string, lang: string) => {\n    const obj = REPORT_TEXTS[slug];\n    if (obj) return obj.description[lang] || obj.description.it;\n    return '';\n  };\n\n  const getFilterLabelFromField = (field: string, lang: string) => {\n    // stessa mappa di ReportFilters\n    const fieldToTextKey: Record<string, keyof typeof TEXTS_FILTERS> = {\n      data_ordine: 'filterDataOrdine',\n      numero_documento: 'filterNumeroDocumento',\n      codice_articolo: 'filterCodiceArticolo',\n      anno: 'filterAnno',\n      tipo_documento: 'filterTipoDocumento',\n      cliente: 'filterCliente',\n    };\n    const key = fieldToTextKey[field];\n    if (key) {\n      return TEXTS_FILTERS[key][lang] || field;\n    }\n    return field;\n  };\n\n  useEffect(() => {\n    async function loadConfig() {\n      try {\n        const response = await fetch(`/api/reports/config?slug=${reportSlug}`);\n\n        if (!response.ok) {\n          throw new Error(`Report configuration not found: ${reportSlug}`);\n        }\n\n        const data = await response.json();\n        setConfig(data.config);\n      } catch (err: any) {\n        console.error('Error loading report config:', err);\n        setError(err.message || 'Failed to load report configuration');\n      }\n    }\n\n    loadConfig();\n  }, [reportSlug]);\n\n  useEffect(() => {\n    if (!config || !clientCode) return;\n\n    async function loadData(reportConfig: ReportConfig) {\n      try {\n        setLoading(true);\n        setError(null);\n\n        const queryParams: Record<string, any> = {};\n        queryParams.clientCode = clientCode;\n\n        const result = await executeQuery(reportConfig.query, queryParams);\n\n        setRawData(result.data || []);\n\n        if (result.debug) {\n          setDebugInfo(result.debug);\n        }\n\n        const options: Record<string, string[]> = {};\n\n        for (const filter of reportConfig.filters || []) {\n          if (filter.options === 'auto') {\n            if (filter.field === 'tipo_documento') {\n              options[filter.field] = await getDocumentTypes(clientCode);\n            } else if (filter.field === 'anno') {\n              const years = await getDocumentYears(clientCode);\n              options[filter.field] = years.map(String);\n            } else {\n              const uniqueValues = new Set<string>();\n              result.data.forEach((row: any) => {\n                const value = row[filter.field];\n                if (value != null && value !== '') {\n                  uniqueValues.add(String(value));\n                }\n              });\n              options[filter.field] = Array.from(uniqueValues).sort();\n            }\n          }\n        }\n\n        setAutoOptions(options);\n      } catch (err: any) {\n        console.error('Error loading data:', err);\n        setError(err.message || 'Failed to load data');\n      } finally {\n        setLoading(false);\n      }\n    }\n\n    loadData(config);\n  }, [config, clientCode]);\n\n  useEffect(() => {\n    if (!config || rawData.length === 0) {\n      setProcessedData([]);\n      setAggregates({});\n      return;\n    }\n\n    const result = ReportEngine.processReport(rawData, config, filters);\n    setProcessedData(result.data);\n    setAggregates(result.aggregates);\n  }, [rawData, config, filters]);\n\n  const handleFiltersChange = (newFilters: Record<string, any>) => {\n    setFilters(newFilters);\n  };\n\n  const handleApplyFilters = () => {};\n\n  if (loading && !config) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-sky-600\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n        <p className=\"text-red-800 font-medium\">\n          {TEXTS_BUILDER.errorTitle[currentLanguage]}\n        </p>\n        <p className=\"text-red-600 text-sm mt-1\">{error}</p>\n      </div>\n    );\n  }\n\n  if (!config) {\n    return null;\n  }\n\n  const isGrouped = config.grouping && config.grouping.length > 0;\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-start justify-between bg-gradient-to-r from-white to-slate-50 rounded-xl p-3 md:p-4\">\n        <div className=\"flex-1\">\n          <h1 className=\"text-3xl font-bold text-gray-900 tracking-tight\">\n            {getTranslatedTitle(reportSlug, currentLanguage)}\n          </h1>\n          {getTranslatedDescription(reportSlug, currentLanguage) && (\n            <p className=\"text-gray-600 mt-2\">{getTranslatedDescription(reportSlug, currentLanguage)}</p>\n          )}\n        </div>\n\n        {/* Language selector */}\n        <div className=\"ml-4\">\n          <label className=\"block text-xs font-medium text-gray-600 mb-1\">\n            {TEXTS_BUILDER.languageLabel[currentLanguage]}\n          </label>\n          <select\n            value={currentLanguage}\n            onChange={(e) => setCurrentLanguage(e.target.value)}\n            className=\"block w-40 px-3 py-2 bg-white border border-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400 text-sm\"\n          >\n            <option value=\"it\">🇮🇹 Italiano</option>\n            <option value=\"en\">🇬🇧 English</option>\n            <option value=\"de\">🇩🇪 Deutsch</option>\n            <option value=\"fr\">🇫🇷 Français</option>\n            <option value=\"es\">🇪🇸 Español</option>\n            <option value=\"pt\">🇵🇹 Português</option>\n          </select>\n        </div>\n      </div>\n\n      {config && config.filters && config.filters.length > 0 && (\n        <ReportFiltersComp\n          filters={config.filters}\n          values={filters}\n          onChange={handleFiltersChange}\n          onApply={handleApplyFilters}\n          autoOptions={autoOptions}\n          rawData={rawData}\n          language={currentLanguage}\n        />\n      )}\n\n      {debugInfo && (\n        <details className=\"bg-gray-50 border border-gray-200 rounded-lg p-4\">\n          <summary className=\"cursor-pointer font-medium text-gray-700 hover:text-gray-900\">\n            {TEXTS_BUILDER.debugTitle[currentLanguage]}\n          </summary>\n          <div className=\"mt-4 space-y-3\">\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugSql[currentLanguage]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {debugInfo.sql}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugParams[currentLanguage]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {JSON.stringify(debugInfo.params, null, 2)}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugBind[currentLanguage]}\n              </p>\n              <code className=\"bg-white px-2 py-1 rounded border text-xs\">\n                {debugInfo.bindTypes}\n              </code>\n            </div>\n          </div>\n        </details>\n      )}\n\n      {!loading &&\n        Object.keys(filters)\n          .filter((key) => filters[key])\n          .length > 0 && (\n          <div className=\"bg-sky-50 border border-sky-100 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <h3 className=\"text-sm font-semibold text-sky-900\">\n                {TEXTS_BUILDER.activeFilters[currentLanguage]}\n              </h3>\n              <button\n                onClick={() => setFilters({})}\n                className=\"text-xs text-sky-600 hover:text-sky-800 underline\"\n              >\n                {TEXTS_BUILDER.removeAll[currentLanguage]}\n              </button>\n            </div>\n            <div className=\"flex flex-wrap gap-2\">\n              {Object.entries(filters).map(([field, value]) => {\n                if (!value) return null;\n\n                const label = getFilterLabelFromField(field, currentLanguage);\n\n                let displayValue = value;\n                if (typeof value === 'object' && value.from && value.to) {\n                  displayValue = `${value.from} - ${value.to}`;\n                } else if (Array.isArray(value)) {\n                  displayValue = value.join(', ');\n                }\n\n                return (\n                  <div\n                    key={field}\n                    className=\"inline-flex items-center gap-2 bg-white border border-sky-200 rounded-full px-3 py-1 text-sm shadow-sm\"\n                  >\n                    <span className=\"font-medium text-sky-900\">{label}:</span>\n                    <span className=\"text-sky-700\">{displayValue}</span>\n                    <button\n                      onClick={() => {\n                        const newFilters = { ...filters };\n                        delete newFilters[field];\n                        setFilters(newFilters);\n                      }}\n                      className=\"text-sky-400 hover:text-sky-600\"\n                    >\n                      ×\n                    </button>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        )}\n\n      {loading && (\n        <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"w-6 h-6 animate-spin text-sky-600 mr-2\" />\n          <span className=\"text-gray-600\">\n            {TEXTS_BUILDER.loadingData[currentLanguage]}\n          </span>\n        </div>\n      )}\n\n      {!loading && processedData.length === 0 && (\n        <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center\">\n          <p className=\"text-yellow-800 font-medium\">\n            {TEXTS_BUILDER.noDataTitle[currentLanguage]}\n          </p>\n          <p className=\"text-yellow-600 text-sm mt-1\">\n            {TEXTS_BUILDER.noDataText[currentLanguage]}\n          </p>\n        </div>\n      )}\n\n      {!loading && processedData.length > 0 && config && (\n        <ReportTable\n          data={processedData}\n          columns={config.columns}\n          aggregates={aggregates}\n          language={currentLanguage}\n          isGrouped={isGrouped}\n          groupingConfig={config.grouping}\n        />\n      )}\n\n      {!loading && processedData.length > 0 && config && (\n        <ReportExportComp\n          data={processedData}\n          config={config}\n          reportTitle={getTranslatedTitle(reportSlug, currentLanguage)}\n          language={currentLanguage}\n        />\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v30",
        "timestamp": "2025-11-10T06:29:20.538Z",
        "note": "Modifica 10/11/2025, 07:29:19",
        "code": "// ============================================================\n// COMPONENTE: ReportTable\n// FILE: components/reports/ReportTable.tsx\n// ============================================================\n\n'use client';\n\nimport { useState, useEffect, useMemo } from 'react';\nimport { ReportColumn, GroupedDataNode } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { ChevronDown, ChevronRight } from 'lucide-react';\n\nconst TEXTS_TABLE = {\n  // ----------------------------------------------------------\n  // Bottoni / messaggi di sistema\n  // ----------------------------------------------------------\n  buttonShowOnlyPending: {\n    it: 'Mostra solo da consegnare',\n    en: 'Show only pending',\n    de: 'Nur ausstehende anzeigen',\n    fr: 'Afficher uniquement en attente',\n    es: 'Mostrar solo pendientes',\n    pt: 'Mostrar apenas pendentes',\n  },\n  buttonExcel: {\n    it: 'Excel',\n    en: 'Excel',\n    de: 'Excel',\n    fr: 'Excel',\n    es: 'Excel',\n    pt: 'Excel',\n  },\n  buttonPDF: {\n    it: 'PDF',\n    en: 'PDF',\n    de: 'PDF',\n    fr: 'PDF',\n    es: 'PDF',\n    pt: 'PDF',\n  },\n  messageNoDocuments: {\n    it: 'Nessun documento trovato',\n    en: 'No documents found',\n    de: 'Keine Dokumente gefunden',\n    fr: 'Aucun document trouvé',\n    es: 'No se encontraron documentos',\n    pt: 'Nenhum documento encontrado',\n  },\n  labelTotal: {\n    it: 'TOTALE',\n    en: 'TOTAL',\n    de: 'GESAMT',\n    fr: 'TOTAL',\n    es: 'TOTAL',\n    pt: 'TOTAL',\n  },\n\n  // ----------------------------------------------------------\n  // Stato righe\n  // ----------------------------------------------------------\n  statusDelivered: {\n    it: 'CONSEGNATO',\n    en: 'DELIVERED',\n    de: 'GELIEFERT',\n    fr: 'LIVRÉ',\n    es: 'ENTREGADO',\n    pt: 'ENTREGUE',\n  },\n  statusInOrder: {\n    it: 'IN ORDINE',\n    en: 'IN ORDER',\n    de: 'IN AUFTRAG',\n    fr: 'EN COMMANDE',\n    es: 'EN PEDIDO',\n    pt: 'EM PEDIDO',\n  },\n\n  // ----------------------------------------------------------\n  // Raggruppamenti\n  // ----------------------------------------------------------\n  labelOrder: {\n    it: 'Ordine',\n    en: 'Order',\n    de: 'Bestellung',\n    fr: 'Commande',\n    es: 'Pedido',\n    pt: 'Pedido',\n  },\n  labelDelivered: {\n    it: 'consegnato',\n    en: 'delivered',\n    de: 'geliefert',\n    fr: 'livré',\n    es: 'entregado',\n    pt: 'entregue',\n  },\n  labelFulfilled: {\n    it: 'Evasi',\n    en: 'Fulfilled',\n    de: 'Erfüllt',\n    fr: 'Traités',\n    es: 'Cumplidos',\n    pt: 'Cumpridos',\n  },\n\n  // ----------------------------------------------------------\n  // COLONNE DINAMICHE\n  // ----------------------------------------------------------\n  columns: {\n    column_data: {\n      it: 'Data',\n      en: 'Date',\n      de: 'Datum',\n      fr: 'Date',\n      es: 'Fecha',\n      pt: 'Data',\n    },\n    column_tipo_documento: {\n      it: 'Tipo Documento',\n      en: 'Document type',\n      de: 'Belegart',\n      fr: 'Type de document',\n      es: 'Tipo de documento',\n      pt: 'Tipo de documento',\n    },\n    column_tipo: {\n      it: 'Tipo',\n      en: 'Type',\n      de: 'Typ',\n      fr: 'Type',\n      es: 'Tipo',\n      pt: 'Tipo',\n    },\n    column_numero: {\n      it: 'Numero',\n      en: 'Number',\n      de: 'Nummer',\n      fr: 'Numéro',\n      es: 'Número',\n      pt: 'Número',\n    },\n    column_descrizione: {\n      it: 'Descrizione',\n      en: 'Description',\n      de: 'Beschreibung',\n      fr: 'Description',\n      es: 'Descripción',\n      pt: 'Descrição',\n    },\n    column_stato: {\n      it: 'Stato',\n      en: 'Status',\n      de: 'Status',\n      fr: 'Statut',\n      es: 'Estado',\n      pt: 'Estado',\n    },\n    column_totale: {\n      it: 'Importo',\n      en: 'Amount',\n      de: 'Betrag',\n      fr: 'Montant',\n      es: 'Importe',\n      pt: 'Valor',\n    },\n    column_valuta: {\n      it: 'Valuta',\n      en: 'Currency',\n      de: 'Währung',\n      fr: 'Devise',\n      es: 'Moneda',\n      pt: 'Moeda',\n    },\n    column_anno: {\n      it: 'Anno',\n      en: 'Year',\n      de: 'Jahr',\n      fr: 'Année',\n      es: 'Año',\n      pt: 'Ano',\n    },\n    column_ngl_doc_ord: {\n      it: 'Numero Ordine',\n      en: 'Order number',\n      de: 'Bestellnummer',\n      fr: 'Numéro de commande',\n      es: 'Número de pedido',\n      pt: 'Número do pedido',\n    },\n    column_dtt_ord: {\n      it: 'Data Ordine',\n      en: 'Order date',\n      de: 'Bestelldatum',\n      fr: 'Date de commande',\n      es: 'Fecha de pedido',\n      pt: 'Data do pedido',\n    },\n    column_cds_caum: {\n      it: 'Causale',\n      en: 'Reason',\n      de: 'Grund',\n      fr: 'Motif',\n      es: 'Causal',\n      pt: 'Causa',\n    },\n    column_cky_cnt_clfr: {\n      it: 'Codice cliente',\n      en: 'Customer code',\n      de: 'Kundencode',\n      fr: 'Code client',\n      es: 'Código cliente',\n      pt: 'Código do cliente',\n    },\n    column_cds_cnt_ragsoc: {\n      it: 'Ragione Sociale',\n      en: 'Company name',\n      de: 'Firmenname',\n      fr: 'Raison sociale',\n      es: 'Razón social',\n      pt: 'Razão social',\n    },\n    column_nome_agente: {\n      it: 'Agente',\n      en: 'Agent',\n      de: 'Vertreter',\n      fr: 'Agent',\n      es: 'Agente',\n      pt: 'Agente',\n    },\n    column_cky_art: {\n      it: 'Codice Articolo',\n      en: 'Item code',\n      de: 'Artikelcode',\n      fr: \"Code de l'article\",\n      es: 'Código artículo',\n      pt: 'Código do artigo',\n    },\n    column_descrizione_art: {\n      it: 'Articolo',\n      en: 'Item',\n      de: 'Artikel',\n      fr: 'Article',\n      es: 'Artículo',\n      pt: 'Artigo',\n    },\n    column_quantita: {\n      it: 'Quantità',\n      en: 'Quantity',\n      de: 'Menge',\n      fr: 'Quantité',\n      es: 'Cantidad',\n      pt: 'Quantidade',\n    },\n    column_valore: {\n      it: 'Valore',\n      en: 'Value',\n      de: 'Wert',\n      fr: 'Valeur',\n      es: 'Valor',\n      pt: 'Valor',\n    },\n    column_sigla_trasf: {\n      it: 'Sigla Doc Magazzino',\n      en: 'Warehouse doc code',\n      de: 'Lagerbeleg-Kürzel',\n      fr: 'Code doc magasin',\n      es: 'Sigla doc almacén',\n      pt: 'Sigla doc armazém',\n    },\n    column_numero_trasf: {\n      it: 'Numero Doc Magazzino',\n      en: 'Warehouse doc number',\n      de: 'Lagerbelegnummer',\n      fr: 'Numéro doc magasin',\n      es: 'Número doc almacén',\n      pt: 'Número doc armazém',\n    },\n    column_data_trasf: {\n      it: 'Data trasf',\n      en: 'Transfer date',\n      de: 'Transferdatum',\n      fr: 'Date transfert',\n      es: 'Fecha transf',\n      pt: 'Data transf',\n    },\n    column_origne: {\n      it: 'Evaso o In Ordine',\n      en: 'Fulfilled or On order',\n      de: 'Erledigt oder in Bestellung',\n      fr: 'Livré ou en commande',\n      es: 'Servido o en pedido',\n      pt: 'Atendido ou em pedido',\n    },\n    column_sco_1: {\n      it: 'Sco 1',\n      en: 'Disc 1',\n      de: 'Rabatt 1',\n      fr: 'Rem 1',\n      es: 'Dto 1',\n      pt: 'Desc 1',\n    },\n    column_sco_2: {\n      it: 'Sco 2',\n      en: 'Disc 2',\n      de: 'Rabatt 2',\n      fr: 'Rem 2',\n      es: 'Dto 2',\n      pt: 'Desc 2',\n    },\n    column_sco_3: {\n      it: 'Sco 3',\n      en: 'Disc 3',\n      de: 'Rabatt 3',\n      fr: 'Rem 3',\n      es: 'Dto 3',\n      pt: 'Desc 3',\n    },\n    column_npz_unit: {\n      it: 'Prezzo Unitario',\n      en: 'Unit price',\n      de: 'Einzelpreis',\n      fr: 'Prix unitaire',\n      es: 'Precio unitario',\n      pt: 'Preço unitário',\n    },\n  },\n};\n\nfunction getColumnLabelFromField(field: string | undefined, language: string): string {\n  if (!field) return '';\n  const key = `column_${field.replace(/`/g, '').replace(/\\s+/g, '_').toLowerCase()}`;\n  const colObj = (TEXTS_TABLE.columns as any)[key];\n  if (colObj) {\n    return colObj[language] || colObj.it;\n  }\n  return field;\n}\n\ninterface ReportTableProps {\n  data: any[] | GroupedDataNode[];\n  columns: ReportColumn[];\n  aggregates?: Record<string, any>;\n  language?: string;\n  isGrouped?: boolean;\n  groupingConfig?: any[];\n}\n\nexport default function ReportTable({\n  data,\n  columns,\n  aggregates,\n  language = 'it',\n  isGrouped = false,\n  groupingConfig = [],\n}: ReportTableProps) {\n  const getInitialExpandedGroups = () => {\n    const shouldExpandAll = groupingConfig.length > 0 && groupingConfig[0].collapsed === false;\n\n    if (shouldExpandAll && isGrouped && data.length > 0) {\n      const all = new Set<string>();\n      const collect = (nodes: any[]) => {\n        nodes.forEach((n) => {\n          if ('groupKey' in n) {\n            all.add(n.groupKey);\n            if (n.children?.length) collect(n.children);\n          }\n        });\n      };\n      collect(data as GroupedDataNode[]);\n      return all;\n    }\n    return new Set<string>();\n  };\n\n  const [expandedGroups, setExpandedGroups] = useState<Set<string>>(getInitialExpandedGroups());\n  const [showOnlyPending, setShowOnlyPending] = useState(false);\n  const [columnWidths, setColumnWidths] = useState<Record<string, number>>({});\n\n  const visibleColumns = useMemo(() => columns.filter((c) => c.visible), [columns]);\n\n  const statusColumn = columns.find((c) => (c.field || '').toLowerCase().includes('stato'));\n\n  useEffect(() => {\n    setExpandedGroups(getInitialExpandedGroups());\n  }, [data, groupingConfig]);\n\n  useEffect(() => {\n    const widths: Record<string, number> = {};\n    const sampleRows: any[] = Array.isArray(data)\n      ? data.filter((r) => !('groupKey' in r)).slice(0, 10)\n      : [];\n\n    visibleColumns.forEach((col) => {\n      const label = getColumnLabelFromField(col.field, language);\n      let maxLen = (label || col.field || '').length;\n\n      sampleRows.forEach((row) => {\n        const val = row[col.field];\n        const str = val == null ? '' : String(val);\n        if (str.length > maxLen) maxLen = str.length;\n      });\n\n      let px = maxLen * 8 + 28;\n      const isTexty =\n        label.toLowerCase().includes('descr') || label.toLowerCase().includes('articolo');\n      const min = isTexty ? 160 : 90;\n      const max = isTexty ? 360 : 180;\n      if (px < min) px = min;\n      if (px > max) px = max;\n\n      widths[col.field] = px;\n    });\n\n    setColumnWidths(widths);\n  }, [data, columns, language, visibleColumns]);\n\n  const toggleGroup = (groupKey: string) => {\n    const next = new Set(expandedGroups);\n    if (next.has(groupKey)) next.delete(groupKey);\n    else next.add(groupKey);\n    setExpandedGroups(next);\n  };\n\n  const getGroupDeliveryInfo = (node: GroupedDataNode) => {\n    let total = 0;\n    let delivered = 0;\n\n    const scan = (items: any[]) => {\n      items.forEach((it) => {\n        if ('groupKey' in it) {\n          if (it.children?.length) scan(it.children);\n        } else {\n          total++;\n          if (statusColumn) {\n            const raw = (it[statusColumn.field] || '').toString().trim().toUpperCase();\n            if (raw === 'EVASO' || raw === 'CONSEGNATO') delivered++;\n          }\n        }\n      });\n    };\n\n    if (node.children?.length) scan(node.children);\n\n    const perc = total > 0 ? Math.round((delivered / total) * 100) : 0;\n    return { total, delivered, perc };\n  };\n\n  const filteredData = (() => {\n    if (!showOnlyPending) return data;\n    if (isGrouped && Array.isArray(data) && data.length > 0 && 'groupKey' in data[0]) {\n      return (data as GroupedDataNode[]).filter((node) => {\n        const { perc } = getGroupDeliveryInfo(node);\n        return perc < 100;\n      });\n    }\n    if (Array.isArray(data)) {\n      return data.filter((row: any) => {\n        if (!statusColumn) return true;\n        const raw = (row[statusColumn.field] || '').toString().trim().toUpperCase();\n        return !(raw === 'EVASO' || raw === 'CONSEGNATO');\n      });\n    }\n    return data;\n  })();\n\n  const renderStatusBadge = (raw: any) => {\n    const txt = (raw || '').toString().trim().toUpperCase();\n    const delivered = txt === 'EVASO' || txt === 'CONSEGNATO';\n    return (\n      <span\n        className={`inline-flex items-center px-2 py-[2px] rounded-full text-[11px] font-semibold ${\n          delivered\n            ? 'bg-emerald-100 text-emerald-700 ring-1 ring-emerald-200'\n            : 'bg-sky-100 text-sky-700 ring-1 ring-sky-200'\n        }`}\n      >\n        {delivered\n          ? TEXTS_TABLE.statusDelivered[language as keyof typeof TEXTS_TABLE.statusDelivered]\n          : TEXTS_TABLE.statusInOrder[language as keyof typeof TEXTS_TABLE.statusInOrder]}\n      </span>\n    );\n  };\n\n  const renderDataRow = (row: any, idx: number) => {\n    return (\n      <div\n        key={idx}\n        className=\"flex border-b border-slate-100 hover:bg-slate-50/80 transition-colors duration-150\"\n      >\n        {visibleColumns.map((col) => {\n          const width = columnWidths[col.field] || 120;\n          if (statusColumn && col.field === statusColumn.field) {\n            return (\n              <div key={col.field} className=\"px-3 py-2 flex items-center\" style={{ width, minWidth: width }}>\n                {renderStatusBadge(row[col.field])}\n              </div>\n            );\n          }\n          return (\n            <div\n              key={col.field}\n              className={`px-3 py-2 text-xs text-slate-800 ${\n                col.align === 'right' ? 'text-right' : 'text-left'\n              } overflow-hidden text-ellipsis whitespace-nowrap`}\n              style={{ width, minWidth: width }}\n              title={row[col.field] != null ? String(row[col.field]) : ''}\n            >\n              {ReportEngine.formatValue(row[col.field], col, language)}\n            </div>\n          );\n        })}\n      </div>\n    );\n  };\n\n  const renderGroupedRow = (node: GroupedDataNode, index: number) => {\n    const isExpanded = expandedGroups.has(node.groupKey);\n    const hasChildren = node.children.length > 0;\n    const { total, delivered, perc } = getGroupDeliveryInfo(node);\n\n    let badgeClass = 'bg-orange-100 text-orange-800';\n    let barClass = 'bg-orange-500';\n    if (perc >= 75) {\n      badgeClass = 'bg-emerald-100 text-emerald-700';\n      barClass = 'bg-emerald-500';\n    } else if (perc >= 26) {\n      badgeClass = 'bg-amber-100 text-amber-800';\n      barClass = 'bg-amber-400';\n    }\n\n    return (\n      <div key={`${node.groupKey}-${index}`} className=\"bg-white\">\n        <div\n          className=\"flex items-center justify-between border-b border-sky-200 bg-gradient-to-r from-sky-100 to-sky-50 hover:from-sky-200/80 hover:to-sky-100/80 cursor-pointer px-4 py-2.5\"\n          onClick={() => hasChildren && toggleGroup(node.groupKey)}\n        >\n          <div className=\"flex items-center gap-2\">\n            {hasChildren && (\n              <span className=\"rounded-full bg-white/90 p-1 shadow-sm\">\n                {isExpanded ? (\n                  <ChevronDown className=\"w-4 h-4 text-sky-700\" />\n                ) : (\n                  <ChevronRight className=\"w-4 h-4 text-sky-700\" />\n                )}\n              </span>\n            )}\n            <span className=\"text-sm font-bold text-sky-950\">\n              {TEXTS_TABLE.labelOrder[language as keyof typeof TEXTS_TABLE.labelOrder]}:{' '}\n              {node.groupLabel}\n            </span>\n            <span className={`text-[11px] font-semibold px-2 py-[1px] rounded-full ${badgeClass}`}>\n              {perc}% {TEXTS_TABLE.labelDelivered[language as keyof typeof TEXTS_TABLE.labelDelivered]}\n            </span>\n          </div>\n          <div className=\"flex items-center gap-3\">\n            <span className=\"text-xs font-bold text-sky-900\">\n              {TEXTS_TABLE.labelFulfilled[language as keyof typeof TEXTS_TABLE.labelFulfilled]}{' '}\n              {delivered}/{total}\n            </span>\n            <div className=\"w-28 h-2.5 bg-slate-200 rounded-full overflow-hidden shadow-inner\">\n              <div className={`h-2.5 transition-all ${barClass}`} style={{ width: `${perc}%` }} />\n            </div>\n          </div>\n        </div>\n\n        {isExpanded && hasChildren && (\n          <div className=\"border-l border-slate-100\">\n            {node.children.map((child: any, i: number) =>\n              'groupKey' in child ? renderGroupedRow(child, i) : renderDataRow(child, i)\n            )}\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  return (\n    <div className=\"bg-white/50 backdrop-blur-sm rounded-2xl shadow-md border border-slate-100 overflow-hidden flex flex-col max-h-[72vh]\">\n      {/* header tabella */}\n      <div className=\"flex items-center justify-between px-4 py-3 bg-white/80 border-b border-slate-100\">\n        <button\n          type=\"button\"\n          onClick={() => setShowOnlyPending((p) => !p)}\n          className={`inline-flex items-center gap-2 text-sm font-semibold rounded-full px-4 py-1.5 transition ${\n            showOnlyPending\n              ? 'bg-sky-600 text-white shadow-sm'\n              : 'bg-slate-200 text-slate-700 hover:bg-slate-300'\n          }`}\n        >\n          <span className=\"text-xs\">●</span>\n          {TEXTS_TABLE.buttonShowOnlyPending[language as keyof typeof TEXTS_TABLE.buttonShowOnlyPending]}\n        </button>\n\n        <div className=\"flex items-center gap-2\">\n          <button\n            type=\"button\"\n            className=\"px-3 py-1.5 rounded-md bg-slate-100 text-slate-700 text-xs hover:bg-slate-200 shadow-sm\"\n          >\n            {TEXTS_TABLE.buttonExcel[language as keyof typeof TEXTS_TABLE.buttonExcel]}\n          </button>\n          <button\n            type=\"button\"\n            className=\"px-3 py-1.5 rounded-md bg-slate-100 text-slate-700 text-xs hover:bg-slate-200 shadow-sm\"\n          >\n            {TEXTS_TABLE.buttonPDF[language as keyof typeof TEXTS_TABLE.buttonPDF]}\n          </button>\n        </div>\n      </div>\n\n      {/* intestazione colonne */}\n      <div className=\"flex border-b border-slate-200 bg-slate-100/90 sticky top-0 z-10\">\n        {visibleColumns.map((col) => {\n          const width = columnWidths[col.field] || 120;\n          return (\n            <div\n              key={col.field}\n              className={`px-3 py-2 text-[11px] font-semibold text-slate-700 uppercase tracking-wide ${\n                col.align === 'right' ? 'text-right' : 'text-left'\n              } overflow-hidden text-ellipsis whitespace-nowrap`}\n              style={{ width, minWidth: width }}\n            >\n              {getColumnLabelFromField(col.field, language)}\n            </div>\n          );\n        })}\n      </div>\n\n      {/* corpo tabella */}\n      <div className=\"flex-1 overflow-auto\">\n        {filteredData.length === 0 ? (\n          <div className=\"px-6 py-12 text-center text-slate-400 text-sm\">\n            {TEXTS_TABLE.messageNoDocuments[language as keyof typeof TEXTS_TABLE.messageNoDocuments]}\n          </div>\n        ) : isGrouped && 'groupKey' in filteredData[0] ? (\n          (filteredData as GroupedDataNode[]).map((node, idx) => renderGroupedRow(node, idx))\n        ) : (\n          (filteredData as any[]).map((row, idx) => renderDataRow(row, idx))\n        )}\n      </div>\n\n      {/* footer totali */}\n      {aggregates && Object.keys(aggregates).length > 0 && (\n        <div className=\"flex border-t border-slate-200 bg-blue-50/80\">\n          {visibleColumns.map((col, idx) => {\n            const width = columnWidths[col.field] || 120;\n            return (\n              <div\n                key={col.field}\n                className={`px-3 py-2 text-xs ${\n                  col.align === 'right' ? 'text-right' : 'text-left'\n                } overflow-hidden text-ellipsis whitespace-nowrap`}\n                style={{ width, minWidth: width }}\n              >\n                {idx === 0 ? (\n                  <span className=\"font-bold text-slate-900\">\n                    {TEXTS_TABLE.labelTotal[language as keyof typeof TEXTS_TABLE.labelTotal]}\n                  </span>\n                ) : col.aggregate && aggregates[col.field] !== undefined ? (\n                  <span className=\"font-bold text-slate-900\">\n                    {ReportEngine.formatValue(aggregates[col.field], col, language)}\n                  </span>\n                ) : null}\n              </div>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n\n// ============================================================\n// COMPONENTE: ReportFilters\n// FILE: components/reports/ReportFilters.tsx\n// ============================================================\n\n'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { ReportFilter } from '@/types/report';\nimport { Filter, X } from 'lucide-react';\n\nconst TEXTS_FILTERS = {\n  filters: {\n    it: 'Filtri',\n    en: 'Filters',\n    de: 'Filter',\n    fr: 'Filtres',\n    es: 'Filtros',\n    pt: 'Filtros',\n  },\n  show: {\n    it: 'Mostra',\n    en: 'Show',\n    de: 'Anzeigen',\n    fr: 'Afficher',\n    es: 'Mostrar',\n    pt: 'Mostrar',\n  },\n  hide: {\n    it: 'Nascondi',\n    en: 'Hide',\n    de: 'Verbergen',\n    fr: 'Masquer',\n    es: 'Ocultar',\n    pt: 'Ocultar',\n  },\n  applyFilters: {\n    it: 'Applica filtri',\n    en: 'Apply filters',\n    de: 'Filter anwenden',\n    fr: 'Appliquer les filtres',\n    es: 'Aplicar filtros',\n    pt: 'Aplicar filtros',\n  },\n  reset: {\n    it: 'Reset',\n    en: 'Reset',\n    de: 'Zurücksetzen',\n    fr: 'Réinitialiser',\n    es: 'Restablecer',\n    pt: 'Redefinir',\n  },\n  all: {\n    it: 'Tutti',\n    en: 'All',\n    de: 'Alle',\n    fr: 'Tous',\n    es: 'Todos',\n    pt: 'Todos',\n  },\n  search: {\n    it: 'Cerca...',\n    en: 'Search...',\n    de: 'Suchen...',\n    fr: 'Rechercher...',\n    es: 'Buscar...',\n    pt: 'Pesquisar...',\n  },\n  selected: {\n    it: 'selezionati',\n    en: 'selected',\n    de: 'ausgewählt',\n    fr: 'sélectionnés',\n    es: 'seleccionados',\n    pt: 'selecionados',\n  },\n  noOptionsFound: {\n    it: 'Nessuna opzione trovata',\n    en: 'No options found',\n    de: 'Keine Optionen gefunden',\n    fr: 'Aucune option trouvée',\n    es: 'No se encontraron opciones',\n    pt: 'Nenhuma opção encontrada',\n  },\n  selectAll: {\n    it: 'Seleziona tutti',\n    en: 'Select all',\n    de: 'Alle auswählen',\n    fr: 'Tout sélectionner',\n    es: 'Seleccionar todo',\n    pt: 'Selecionar tudo',\n  },\n  from: {\n    it: 'Da',\n    en: 'From',\n    de: 'Von',\n    fr: 'De',\n    es: 'Desde',\n    pt: 'De',\n  },\n  to: {\n    it: 'A',\n    en: 'To',\n    de: 'Bis',\n    fr: 'À',\n    es: 'Hasta',\n    pt: 'Até',\n  },\n  // Label dei filtri comuni\n  filterDataOrdine: {\n    it: 'Data Ordine',\n    en: 'Order Date',\n    de: 'Bestelldatum',\n    fr: 'Date de Commande',\n    es: 'Fecha de Pedido',\n    pt: 'Data do Pedido',\n  },\n  filterNumeroDocumento: {\n    it: 'Numero Documento',\n    en: 'Document Number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro de Document',\n    es: 'Número de Documento',\n    pt: 'Número do Documento',\n  },\n  filterCodiceArticolo: {\n    it: 'Codice Articolo',\n    en: 'Item Code',\n    de: 'Artikelcode',\n    fr: 'Code Article',\n    es: 'Código Artículo',\n    pt: 'Código do Artigo',\n  },\n  filterAnno: {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  filterTipoDocumento: {\n    it: 'Tipo Documento',\n    en: 'Document Type',\n    de: 'Dokumenttyp',\n    fr: 'Type de Document',\n    es: 'Tipo de Documento',\n    pt: 'Tipo de Documento',\n  },\n  filterCliente: {\n    it: 'Cliente',\n    en: 'Customer',\n    de: 'Kunde',\n    fr: 'Client',\n    es: 'Cliente',\n    pt: 'Cliente',\n  },\n};\n\n// opzioni comuni da tradurre (es. \"Tutti\", \"Pagato\", ecc.)\nfunction translateFilterOption(option: string, lang: string): string {\n  const map: Record<string, Record<string, string>> = {\n    'Tutti': {\n      it: 'Tutti',\n      en: 'All',\n      de: 'Alle',\n      fr: 'Tous',\n      es: 'Todos',\n      pt: 'Todos',\n    },\n    'Pagato': {\n      it: 'Pagato',\n      en: 'Paid',\n      de: 'Bezahlt',\n      fr: 'Payé',\n      es: 'Pagado',\n      pt: 'Pago',\n    },\n    'Da Pagare': {\n      it: 'Da Pagare',\n      en: 'To pay',\n      de: 'Zu zahlen',\n      fr: 'À payer',\n      es: 'Por pagar',\n      pt: 'A pagar',\n    },\n    'Annullato': {\n      it: 'Annullato',\n      en: 'Cancelled',\n      de: 'Storniert',\n      fr: 'Annulé',\n      es: 'Anulado',\n      pt: 'Cancelado',\n    },\n  };\n  if (map[option]) {\n    return map[option][lang] || map[option].it;\n  }\n  return option;\n}\n\ninterface ReportFiltersProps {\n  filters: ReportFilter[];\n  values: Record<string, any>;\n  onChange: (values: Record<string, any>) => void;\n  onApply: () => void;\n  autoOptions?: Record<string, string[]>;\n  rawData?: any[];\n  language?: string;\n}\n\nexport function ReportFilters({\n  filters,\n  values,\n  onChange,\n  onApply,\n  autoOptions = {},\n  rawData = [],\n  language = 'it',\n}: ReportFiltersProps) {\n  const currentLang = language || 'it';\n\n  const [showFilters, setShowFilters] = useState(false);\n  const [localValues, setLocalValues] = useState(values);\n  const [autocompleteOpen, setAutocompleteOpen] = useState<string | null>(null);\n  const autocompleteRef = useRef<HTMLDivElement>(null);\n\n  const [multiselectSearch, setMultiselectSearch] = useState<Record<string, string>>({});\n  const [multiselectOpen, setMultiselectOpen] = useState<Record<string, boolean>>({});\n\n  useEffect(() => {\n    setLocalValues(values);\n  }, [values]);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (autocompleteRef.current && !autocompleteRef.current.contains(event.target as Node)) {\n        setAutocompleteOpen(null);\n        setMultiselectOpen({});\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  const handleChange = (field: string, value: any) => {\n    setLocalValues({ ...localValues, [field]: value });\n  };\n\n  const getUniqueValues = (field: string): string[] => {\n    if (!rawData || rawData.length === 0) return [];\n\n    const uniqueValues = new Set<string>();\n    rawData.forEach((row) => {\n      const value = row[field];\n      if (value != null && value !== '') {\n        uniqueValues.add(String(value));\n      }\n    });\n\n    return Array.from(uniqueValues).sort();\n  };\n\n  const getSuggestions = (field: string, inputValue: string): string[] => {\n    if (!inputValue) return getUniqueValues(field).slice(0, 10);\n\n    const uniqueValues = getUniqueValues(field);\n    return uniqueValues\n      .filter((val) => val.toLowerCase().includes(inputValue.toLowerCase()))\n      .slice(0, 10);\n  };\n\n  const handleApply = () => {\n    onChange(localValues);\n    onApply();\n    setShowFilters(false);\n  };\n\n  const handleReset = () => {\n    const resetValues: Record<string, any> = {};\n    filters.forEach((filter) => {\n      resetValues[filter.field] = filter.default || null;\n    });\n    setLocalValues(resetValues);\n    onChange(resetValues);\n    onApply();\n  };\n\n  const getDateRangeDefault = (defaultValue: string) => {\n    const today = new Date();\n    const currentYear = today.getFullYear();\n\n    switch (defaultValue) {\n      case 'current_year':\n        return {\n          from: `${currentYear}-01-01`,\n          to: `${currentYear}-12-31`,\n        };\n      case 'last_year':\n        return {\n          from: `${currentYear - 1}-01-01`,\n          to: `${currentYear - 1}-12-31`,\n        };\n      case 'last_6_months': {\n        const sixMonthsAgo = new Date(today);\n        sixMonthsAgo.setMonth(today.getMonth() - 6);\n        return {\n          from: sixMonthsAgo.toISOString().split('T')[0],\n          to: today.toISOString().split('T')[0],\n        };\n      }\n      default:\n        return { from: '', to: '' };\n    }\n  };\n\n  const getFilterLabel = (filter: ReportFilter): string => {\n    const fieldToTextKey: Record<string, string> = {\n      data_ordine: 'filterDataOrdine',\n      numero_documento: 'filterNumeroDocumento',\n      codice_articolo: 'filterCodiceArticolo',\n      anno: 'filterAnno',\n      tipo_documento: 'filterTipoDocumento',\n      cliente: 'filterCliente',\n    };\n\n    const textKey = fieldToTextKey[filter.field];\n    if (textKey && (TEXTS_FILTERS as any)[textKey]) {\n      return (TEXTS_FILTERS as any)[textKey][currentLang] || filter.field;\n    }\n\n    return filter.field;\n  };\n\n  const renderFilter = (filter: ReportFilter) => {\n    const value = localValues[filter.field];\n    const label = getFilterLabel(filter);\n\n    switch (filter.type) {\n      case 'text': {\n        const suggestions = getSuggestions(filter.field, value || '');\n        const showAutocomplete = autocompleteOpen === filter.field && suggestions.length > 0;\n\n        return (\n          <div className=\"relative\" ref={autocompleteOpen === filter.field ? autocompleteRef : null}>\n            <input\n              type=\"text\"\n              value={value || ''}\n              onChange={(e) => handleChange(filter.field, e.target.value)}\n              onFocus={() => setAutocompleteOpen(filter.field)}\n              className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              placeholder={label}\n            />\n            {showAutocomplete && (\n              <div className=\"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                {suggestions.map((suggestion, idx) => (\n                  <button\n                    key={idx}\n                    type=\"button\"\n                    onClick={() => {\n                      handleChange(filter.field, suggestion);\n                      setAutocompleteOpen(null);\n                    }}\n                    className=\"w-full text-left px-3 py-2 hover:bg-sky-50 text-sm text-gray-700 hover:text-sky-900 border-b last:border-b-0\"\n                  >\n                    {suggestion}\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n        );\n      }\n\n      case 'select': {\n        const selectOptions =\n          filter.options === 'auto' ? autoOptions[filter.field] || [] : filter.options || [];\n\n        return (\n          <select\n            value={value || ''}\n            onChange={(e) => handleChange(filter.field, e.target.value)}\n            className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 bg-white shadow-sm\"\n          >\n            <option value=\"\">{TEXTS_FILTERS.all[currentLang]}</option>\n            {selectOptions.map((option) => (\n              <option key={option} value={option}>\n                {translateFilterOption(option, currentLang)}\n              </option>\n            ))}\n          </select>\n        );\n      }\n\n      case 'multiselect': {\n        const multiOptions =\n          filter.options === 'auto' ? autoOptions[filter.field] || [] : filter.options || [];\n\n        const selectedValues = value || [];\n        const searchTerm = multiselectSearch[filter.field] || '';\n        const isOpen = multiselectOpen[filter.field] || false;\n\n        const filteredOptions = multiOptions.filter((option) =>\n          option.toLowerCase().includes(searchTerm.toLowerCase())\n        );\n\n        return (\n          <div className=\"relative\" ref={isOpen ? autocompleteRef : null}>\n            {selectedValues.length > 0 && (\n              <div className=\"flex flex-wrap gap-1 mb-2\">\n                {selectedValues.map((val: string) => (\n                  <span\n                    key={val}\n                    className=\"inline-flex items-center gap-1 bg-sky-100 text-sky-800 text-xs px-2 py-1 rounded-full\"\n                  >\n                    {translateFilterOption(val, currentLang)}\n                    <button\n                      type=\"button\"\n                      onClick={() => {\n                        const newValues = selectedValues.filter((v: string) => v !== val);\n                        handleChange(filter.field, newValues);\n                      }}\n                      className=\"text-sky-600 hover:text-sky-800\"\n                    >\n                      ×\n                    </button>\n                  </span>\n                ))}\n              </div>\n            )}\n\n            <div className=\"relative\">\n              <input\n                type=\"text\"\n                value={searchTerm}\n                onChange={(e) =>\n                  setMultiselectSearch({\n                    ...multiselectSearch,\n                    [filter.field]: e.target.value,\n                  })\n                }\n                onFocus={() =>\n                  setMultiselectOpen({\n                    ...multiselectOpen,\n                    [filter.field]: true,\n                  })\n                }\n                placeholder={`${TEXTS_FILTERS.search[currentLang]} (${\n                  selectedValues.length\n                } ${TEXTS_FILTERS.selected[currentLang]})`}\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n\n              {isOpen && (\n                <div className=\"absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                  {filteredOptions.length === 0 ? (\n                    <div className=\"px-3 py-2 text-sm text-gray-500\">\n                      {TEXTS_FILTERS.noOptionsFound[currentLang]}\n                    </div>\n                  ) : (\n                    <>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          handleChange(filter.field, filteredOptions);\n                          setMultiselectOpen({\n                            ...multiselectOpen,\n                            [filter.field]: false,\n                          });\n                        }}\n                        className=\"w-full text-left px-3 py-2 text-xs text-sky-600 hover:bg-sky-50 border-b\"\n                      >\n                        ✓ {TEXTS_FILTERS.selectAll[currentLang]} ({filteredOptions.length})\n                      </button>\n                      {filteredOptions.map((option) => (\n                        <label\n                          key={option}\n                          className=\"flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer border-b last:border-b-0\"\n                        >\n                          <input\n                            type=\"checkbox\"\n                            checked={selectedValues.includes(option)}\n                            onChange={(e) => {\n                              const newValues = e.target.checked\n                                ? [...selectedValues, option]\n                                : selectedValues.filter((v: string) => v !== option);\n                              handleChange(filter.field, newValues);\n                            }}\n                            className=\"rounded\"\n                          />\n                          <span className=\"text-sm\">\n                            {translateFilterOption(option, currentLang)}\n                          </span>\n                        </label>\n                      ))}\n                    </>\n                  )}\n                </div>\n              )}\n            </div>\n\n            <button\n              type=\"button\"\n              onClick={() =>\n                setMultiselectOpen({\n                  ...multiselectOpen,\n                  [filter.field]: !isOpen,\n                })\n              }\n              className=\"absolute right-2 top-2 text-gray-400 hover:text-gray-600\"\n            >\n              {isOpen ? '▲' : '▼'}\n            </button>\n          </div>\n        );\n      }\n\n      case 'daterange': {\n        const dateRange = value || getDateRangeDefault(filter.default as string);\n\n        return (\n          <div className=\"flex gap-2\">\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.from[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.from || ''}\n                onChange={(e) => handleChange(filter.field, { ...dateRange, from: e.target.value })}\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.to[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.to || ''}\n                onChange={(e) => handleChange(filter.field, { ...dateRange, to: e.target.value })}\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n          </div>\n        );\n      }\n\n      default:\n        return null;\n    }\n  };\n\n  const activeFiltersCount = Object.values(localValues).filter(\n    (v) =>\n      v !== null &&\n      v !== undefined &&\n      v !== '' &&\n      !(typeof v === 'object' && Object.keys(v).length === 0)\n  ).length;\n\n  return (\n    <div className=\"bg-white/80 backdrop-blur-sm rounded-xl shadow-sm border border-gray-100 p-4 mb-4\">\n      <div className=\"flex items-center justify-between mb-3\">\n        <div className=\"flex items-center gap-2\">\n          <span className=\"inline-flex items-center justify-center w-8 h-8 rounded-full bg-sky-100 text-sky-700 shadow-sm\">\n            <Filter className=\"w-4 h-4\" />\n          </span>\n          <h3 className=\"text-base font-semibold text-gray-900\">\n            {TEXTS_FILTERS.filters[currentLang]}\n          </h3>\n          {activeFiltersCount > 0 && (\n            <span className=\"px-2 py-1 bg-sky-100 text-sky-800 text-xs font-medium rounded-full\">\n              {activeFiltersCount}\n            </span>\n          )}\n        </div>\n        <button\n          onClick={() => setShowFilters(!showFilters)}\n          className=\"text-sky-600 hover:text-sky-700 text-sm font-medium\"\n        >\n          {showFilters ? TEXTS_FILTERS.hide[currentLang] : TEXTS_FILTERS.show[currentLang]}\n        </button>\n      </div>\n\n      {showFilters && (\n        <>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4\">\n            {filters.map((filter) => {\n              const label = getFilterLabel(filter);\n              return (\n                <div key={filter.field}>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    {label}\n                  </label>\n                  {renderFilter(filter)}\n                </div>\n              );\n            })}\n          </div>\n\n          <div className=\"flex gap-2 pt-4 border-t border-dashed border-slate-200\">\n            <button\n              onClick={handleApply}\n              className=\"px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 font-medium shadow-sm transition\"\n            >\n              {TEXTS_FILTERS.applyFilters[currentLang]}\n            </button>\n            <button\n              onClick={handleReset}\n              className=\"px-4 py-2 border border-gray-200 text-gray-700 bg-white rounded-md hover:bg-gray-50 font-medium flex items-center gap-2\"\n            >\n              <X className=\"w-4 h-4\" />\n              {TEXTS_FILTERS.reset[currentLang]}\n            </button>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}\n\n// ============================================================\n// COMPONENTE: ReportExport\n// FILE: components/reports/ReportExport.tsx\n// ============================================================\n\n'use client';\n\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { FileText, Table, File } from 'lucide-react';\n\nconst TEXTS_EXPORT = {\n  exportPdfTitle: {\n    it: 'Esporta come PDF',\n    en: 'Export as PDF',\n    de: 'Als PDF exportieren',\n    fr: 'Exporter en PDF',\n    es: 'Exportar como PDF',\n    pt: 'Exportar como PDF',\n  },\n  exportExcelTitle: {\n    it: 'Esporta come Excel',\n    en: 'Export as Excel',\n    de: 'Als Excel exportieren',\n    fr: 'Exporter en Excel',\n    es: 'Exportar como Excel',\n    pt: 'Exportar como Excel',\n  },\n  exportCsvTitle: {\n    it: 'Esporta come CSV',\n    en: 'Export as CSV',\n    de: 'Als CSV exportieren',\n    fr: 'Exporter en CSV',\n    es: 'Exportar como CSV',\n    pt: 'Exportar como CSV',\n  },\n  errorCsvExport: {\n    it: \"Errore durante l'export CSV\",\n    en: 'Error during CSV export',\n    de: 'Fehler beim CSV-Export',\n    fr: \"Erreur lors de l'export CSV\",\n    es: 'Error durante la exportación CSV',\n    pt: 'Erro durante a exportação CSV',\n  },\n  errorExcelExport: {\n    it: \"Errore durante l'export Excel\",\n    en: 'Error during Excel export',\n    de: 'Fehler beim Excel-Export',\n    fr: \"Erreur lors de l'export Excel\",\n    es: 'Error durante la exportación Excel',\n    pt: 'Erro durante a exportação Excel',\n  },\n  noExportFormats: {\n    it: 'Nessun formato di export disponibile',\n    en: 'No export formats available',\n    de: 'Keine Exportformate verfügbar',\n    fr: \"Aucun format d'export disponible\",\n    es: 'No hay formatos de exportación disponibles',\n    pt: 'Nenhum formato de exportação disponível',\n  },\n  buttonPdf: {\n    it: 'PDF',\n    en: 'PDF',\n    de: 'PDF',\n    fr: 'PDF',\n    es: 'PDF',\n    pt: 'PDF',\n  },\n  buttonExcel: {\n    it: 'Excel',\n    en: 'Excel',\n    de: 'Excel',\n    fr: 'Excel',\n    es: 'Excel',\n    pt: 'Excel',\n  },\n  buttonCsv: {\n    it: 'CSV',\n    en: 'CSV',\n    de: 'CSV',\n    fr: 'CSV',\n    es: 'CSV',\n    pt: 'CSV',\n  },\n};\n\n// copia del mapping colonne usato in ReportTable, per non referenziare TEXTS_TABLE\nconst TEXTS_EXPORT_COLUMNS: Record<\n  string,\n  { it: string; en: string; de: string; fr: string; es: string; pt: string }\n> = {\n  column_data: {\n    it: 'Data',\n    en: 'Date',\n    de: 'Datum',\n    fr: 'Date',\n    es: 'Fecha',\n    pt: 'Data',\n  },\n  column_tipo_documento: {\n    it: 'Tipo Documento',\n    en: 'Document type',\n    de: 'Belegart',\n    fr: 'Type de document',\n    es: 'Tipo de documento',\n    pt: 'Tipo de documento',\n  },\n  column_tipo: {\n    it: 'Tipo',\n    en: 'Type',\n    de: 'Typ',\n    fr: 'Type',\n    es: 'Tipo',\n    pt: 'Tipo',\n  },\n  column_numero: {\n    it: 'Numero',\n    en: 'Number',\n    de: 'Nummer',\n    fr: 'Numéro',\n    es: 'Número',\n    pt: 'Número',\n  },\n  column_descrizione: {\n    it: 'Descrizione',\n    en: 'Description',\n    de: 'Beschreibung',\n    fr: 'Description',\n    es: 'Descripción',\n    pt: 'Descrição',\n  },\n  column_stato: {\n    it: 'Stato',\n    en: 'Status',\n    de: 'Status',\n    fr: 'Statut',\n    es: 'Estado',\n    pt: 'Estado',\n  },\n  column_totale: {\n    it: 'Importo',\n    en: 'Amount',\n    de: 'Betrag',\n    fr: 'Montant',\n    es: 'Importe',\n    pt: 'Valor',\n  },\n  column_valuta: {\n    it: 'Valuta',\n    en: 'Currency',\n    de: 'Währung',\n    fr: 'Devise',\n    es: 'Moneda',\n    pt: 'Moeda',\n  },\n  column_anno: {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  column_ngl_doc_ord: {\n    it: 'Numero Ordine',\n    en: 'Order number',\n    de: 'Bestellnummer',\n    fr: 'Numéro de commande',\n    es: 'Número de pedido',\n    pt: 'Número do pedido',\n  },\n  column_dtt_ord: {\n    it: 'Data Ordine',\n    en: 'Order date',\n    de: 'Bestelldatum',\n    fr: 'Date de commande',\n    es: 'Fecha de pedido',\n    pt: 'Data do pedido',\n  },\n  column_cds_caum: {\n    it: 'Causale',\n    en: 'Reason',\n    de: 'Grund',\n    fr: 'Motif',\n    es: 'Causal',\n    pt: 'Causa',\n  },\n  column_cky_cnt_clfr: {\n    it: 'Codice cliente',\n    en: 'Customer code',\n    de: 'Kundencode',\n    fr: 'Code client',\n    es: 'Código cliente',\n    pt: 'Código do cliente',\n  },\n  column_cds_cnt_ragsoc: {\n    it: 'Ragione Sociale',\n    en: 'Company name',\n    de: 'Firmenname',\n    fr: 'Raison sociale',\n    es: 'Razón social',\n    pt: 'Razão social',\n  },\n  column_nome_agente: {\n    it: 'Agente',\n    en: 'Agent',\n    de: 'Vertreter',\n    fr: 'Agent',\n    es: 'Agente',\n    pt: 'Agente',\n  },\n  column_cky_art: {\n    it: 'Codice Articolo',\n    en: 'Item code',\n    de: 'Artikelcode',\n    fr: \"Code de l'article\",\n    es: 'Código artículo',\n    pt: 'Código do artigo',\n  },\n  column_descrizione_art: {\n    it: 'Articolo',\n    en: 'Item',\n    de: 'Artikel',\n    fr: 'Article',\n    es: 'Artículo',\n    pt: 'Artigo',\n  },\n  column_quantita: {\n    it: 'Quantità',\n    en: 'Quantity',\n    de: 'Menge',\n    fr: 'Quantité',\n    es: 'Cantidad',\n    pt: 'Quantidade',\n  },\n  column_valore: {\n    it: 'Valore',\n    en: 'Value',\n    de: 'Wert',\n    fr: 'Valeur',\n    es: 'Valor',\n    pt: 'Valor',\n  },\n  column_sigla_trasf: {\n    it: 'Sigla Doc Magazzino',\n    en: 'Warehouse doc code',\n    de: 'Lagerbeleg-Kürzel',\n    fr: 'Code doc magasin',\n    es: 'Sigla doc almacén',\n    pt: 'Sigla doc armazém',\n  },\n  column_numero_trasf: {\n    it: 'Numero Doc Magazzino',\n    en: 'Warehouse doc number',\n    de: 'Lagerbelegnummer',\n    fr: 'Numéro doc magasin',\n    es: 'Número doc almacén',\n    pt: 'Número doc armazém',\n  },\n  column_data_trasf: {\n    it: 'Data trasf',\n    en: 'Transfer date',\n    de: 'Transferdatum',\n    fr: 'Date transfert',\n    es: 'Fecha transf',\n    pt: 'Data transf',\n  },\n  column_origne: {\n    it: 'Evaso o In Ordine',\n    en: 'Fulfilled or On order',\n    de: 'Erledigt oder in Bestellung',\n    fr: 'Livré ou en commande',\n    es: 'Servido o en pedido',\n    pt: 'Atendido ou em pedido',\n  },\n  column_sco_1: {\n    it: 'Sco 1',\n    en: 'Disc 1',\n    de: 'Rabatt 1',\n    fr: 'Rem 1',\n    es: 'Dto 1',\n    pt: 'Desc 1',\n  },\n  column_sco_2: {\n    it: 'Sco 2',\n    en: 'Disc 2',\n    de: 'Rabatt 2',\n    fr: 'Rem 2',\n    es: 'Dto 2',\n    pt: 'Desc 2',\n  },\n  column_sco_3: {\n    it: 'Sco 3',\n    en: 'Disc 3',\n    de: 'Rabatt 3',\n    fr: 'Rem 3',\n    es: 'Dto 3',\n    pt: 'Desc 3',\n  },\n  column_npz_unit: {\n    it: 'Prezzo Unitario',\n    en: 'Unit price',\n    de: 'Einzelpreis',\n    fr: 'Prix unitaire',\n    es: 'Precio unitario',\n    pt: 'Preço unitário',\n  },\n};\n\nfunction getExportColumnLabel(field: string, language: string): string {\n  const key = `column_${field.replace(/`/g, '').replace(/\\s+/g, '_').toLowerCase()}`;\n  const colObj = TEXTS_EXPORT_COLUMNS[key];\n  if (colObj) {\n    return colObj[language] || colObj.it;\n  }\n  return field;\n}\n\ninterface ReportExportProps {\n  data: any[];\n  config: ReportConfig;\n  reportTitle: string;\n  language?: string;\n}\n\nexport function ReportExport({ data, config, reportTitle, language = 'it' }: ReportExportProps) {\n  const flattenGroupedData = (items: any[]): any[] => {\n    const result: any[] = [];\n\n    items.forEach((item) => {\n      if ('groupKey' in item) {\n        result.push(...flattenGroupedData(item.children));\n      } else {\n        result.push(item);\n      }\n    });\n\n    return result;\n  };\n\n  const exportToCSV = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      const headers = visibleColumns.map((col) => getExportColumnLabel(col.field, language)).join(',');\n\n      const rows = flatData.map((row) =>\n        visibleColumns\n          .map((col) => {\n            const value = ReportEngine.formatValue(row[col.field], col, language);\n            return `\"${String(value).replace(/\"/g, '\"\"')}\"`;\n          })\n          .join(',')\n      );\n\n      const csv = [headers, ...rows].join('\\n');\n\n      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle.replace(/\\s+/g, '_').trim()}_${\n        new Date().toISOString().split('T')[0]\n      }.csv`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting CSV:', error);\n      alert(TEXTS_EXPORT.errorCsvExport[language as keyof typeof TEXTS_EXPORT.errorCsvExport]);\n    }\n  };\n\n  const exportToExcel = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      let html = '<table border=\"1\"><thead><tr>';\n\n      visibleColumns.forEach((col) => {\n        html += `<th>${getExportColumnLabel(col.field, language)}</th>`;\n      });\n      html += '</tr></thead><tbody>';\n\n      flatData.forEach((row) => {\n        html += '<tr>';\n        visibleColumns.forEach((col) => {\n          const value = ReportEngine.formatValue(row[col.field], col, language);\n          html += `<td>${value}</td>`;\n        });\n        html += '</tr>';\n      });\n\n      html += '</tbody></table>';\n\n      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle.replace(/\\s+/g, '_').trim()}_${\n        new Date().toISOString().split('T')[0]\n      }.xls`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting Excel:', error);\n      alert(TEXTS_EXPORT.errorExcelExport[language as keyof typeof TEXTS_EXPORT.errorExcelExport]);\n    }\n  };\n\n  const exportToPDF = () => {\n    window.print();\n  };\n\n  return (\n    <div className=\"flex flex-wrap gap-2 mt-4\">\n      {config.export?.pdf && (\n        <button\n          onClick={exportToPDF}\n          className=\"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={TEXTS_EXPORT.exportPdfTitle[language as keyof typeof TEXTS_EXPORT.exportPdfTitle]}\n        >\n          <FileText className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonPdf[language as keyof typeof TEXTS_EXPORT.buttonPdf]}\n        </button>\n      )}\n\n      {config.export?.excel && (\n        <button\n          onClick={exportToExcel}\n          className=\"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={TEXTS_EXPORT.exportExcelTitle[language as keyof typeof TEXTS_EXPORT.exportExcelTitle]}\n        >\n          <Table className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonExcel[language as keyof typeof TEXTS_EXPORT.buttonExcel]}\n        </button>\n      )}\n\n      {config.export?.csv && (\n        <button\n          onClick={exportToCSV}\n          className=\"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={TEXTS_EXPORT.exportCsvTitle[language as keyof typeof TEXTS_EXPORT.exportCsvTitle]}\n        >\n          <File className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonCsv[language as keyof typeof TEXTS_EXPORT.buttonCsv]}\n        </button>\n      )}\n\n      {!config.export?.pdf && !config.export?.excel && !config.export?.csv && (\n        <p className=\"text-sm text-gray-500\">\n          {TEXTS_EXPORT.noExportFormats[language as keyof typeof TEXTS_EXPORT.noExportFormats]}\n        </p>\n      )}\n    </div>\n  );\n}\n\n// ============================================================\n// COMPONENTE: ReportBuilder\n// FILE: components/reports/ReportBuilder.tsx\n// ============================================================\n\n'use client';\n\nimport { useState, useEffect } from 'react';\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { executeQuery, getDocumentTypes, getDocumentYears } from '@/lib/mysql-query';\nimport ReportTable from './ReportTable';\nimport { ReportFilters } from './ReportFilters';\nimport { ReportExport } from './ReportExport';\nimport { Loader2 } from 'lucide-react';\n\nconst REPORT_TEXTS = {\n  customer_documents_summary: {\n    title: {\n      it: 'Documenti Cliente',\n      en: 'Customer documents',\n      de: 'Kundendokumente',\n      fr: 'Documents client',\n      es: 'Documentos de cliente',\n      pt: 'Documentos do cliente',\n    },\n    description: {\n      it: 'Riepilogo documenti con raggruppamento per anno e tipo',\n      en: 'Document summary grouped by year and type',\n      de: 'Dokumentenübersicht gruppiert nach Jahr und Typ',\n      fr: 'Résumé des documents regroupés par année et type',\n      es: 'Resumen de documentos agrupados por año y tipo',\n      pt: 'Resumo de documentos agrupados por ano e tipo',\n    },\n  },\n  customer_documents_flat: {\n    title: {\n      it: 'Lista Documenti',\n      en: 'Documents list',\n      de: 'Dokumentenliste',\n      fr: 'Liste des documents',\n      es: 'Lista de documentos',\n      pt: 'Lista de documentos',\n    },\n    description: {\n      it: 'Lista semplice senza raggruppamento',\n      en: 'Simple list without grouping',\n      de: 'Einfache Liste ohne Gruppierung',\n      fr: 'Liste simple sans regroupement',\n      es: 'Lista simple sin agrupación',\n      pt: 'Lista simples sem agrupamento',\n    },\n  },\n  cc: {\n    title: {\n      it: 'Ordini Cliente',\n      en: 'Customer orders',\n      de: 'Kundenaufträge',\n      fr: 'Commandes client',\n      es: 'Pedidos cliente',\n      pt: 'Encomendas cliente',\n    },\n    description: {\n      it: 'Dettaglio righe ordine con stato evasione',\n      en: 'Order line details with fulfillment status',\n      de: 'Auftragspositionsdetails mit Erfüllungsstatus',\n      fr: 'Détails des lignes de commande avec statut de livraison',\n      es: 'Detalle de líneas de pedido con estado',\n      pt: 'Detalhe de linhas de encomenda com estado',\n    },\n  },\n};\n\nconst TEXTS_BUILDER = {\n  errorTitle: {\n    it: 'Errore',\n    en: 'Error',\n    de: 'Fehler',\n    fr: 'Erreur',\n    es: 'Error',\n    pt: 'Erro',\n  },\n  loadingData: {\n    it: 'Caricamento dati...',\n    en: 'Loading data...',\n    de: 'Daten werden geladen...',\n    fr: 'Chargement des données...',\n    es: 'Cargando datos...',\n    pt: 'Carregando dados...',\n  },\n  activeFilters: {\n    it: 'Filtri attivi:',\n    en: 'Active filters:',\n    de: 'Aktive Filter:',\n    fr: 'Filtres actifs :',\n    es: 'Filtros activos:',\n    pt: 'Filtros ativos:',\n  },\n  removeAll: {\n    it: 'Rimuovi tutti',\n    en: 'Remove all',\n    de: 'Alle entfernen',\n    fr: 'Tout supprimer',\n    es: 'Eliminar todos',\n    pt: 'Remover todos',\n  },\n  noDataTitle: {\n    it: 'Nessun dato disponibile',\n    en: 'No data available',\n    de: 'Keine Daten verfügbar',\n    fr: 'Aucune donnée disponible',\n    es: 'No hay datos disponibles',\n    pt: 'Nenhum dado disponível',\n  },\n  noDataText: {\n    it: 'Non ci sono dati per il cliente selezionato con i filtri applicati.',\n    en: 'There is no data for the selected customer with the applied filters.',\n    de: 'Für den ausgewählten Kunden mit den angewendeten Filtern sind keine Daten vorhanden.',\n    fr: 'Aucune donnée pour le client sélectionné avec les filtres appliqués.',\n    es: 'No hay datos para el cliente seleccionado con los filtros aplicados.',\n    pt: 'Não há dados para o cliente selecionado com os filtros aplicados.',\n  },\n  languageLabel: {\n    it: 'Lingua',\n    en: 'Language',\n    de: 'Sprache',\n    fr: 'Langue',\n    es: 'Idioma',\n    pt: 'Idioma',\n  },\n  debugTitle: {\n    it: 'Debug: Query SQL eseguita',\n    en: 'Debug: Executed SQL query',\n    de: 'Debug: Ausgeführte SQL-Abfrage',\n    fr: 'Débogage : Requête SQL exécutée',\n    es: 'Depuración: consulta SQL ejecutada',\n    pt: 'Depuração: consulta SQL executada',\n  },\n  debugSql: {\n    it: 'Query SQL:',\n    en: 'SQL query:',\n    de: 'SQL-Abfrage:',\n    fr: 'Requête SQL :',\n    es: 'Consulta SQL:',\n    pt: 'Consulta SQL:',\n  },\n  debugParams: {\n    it: 'Parametri:',\n    en: 'Parameters:',\n    de: 'Parameter:',\n    fr: 'Paramètres :',\n    es: 'Parámetros:',\n    pt: 'Parâmetros:',\n  },\n  debugBind: {\n    it: 'Bind Types:',\n    en: 'Bind Types:',\n    de: 'Bind-Typen:',\n    fr: 'Types de bind :',\n    es: 'Tipos de bind:',\n    pt: 'Tipos de bind:',\n  },\n};\n\n// mini mappa per le etichette filtri nei badge\nconst FILTER_FIELD_LABELS: Record<string, Record<string, string>> = {\n  data_ordine: {\n    it: 'Data Ordine',\n    en: 'Order Date',\n    de: 'Bestelldatum',\n    fr: 'Date de Commande',\n    es: 'Fecha de Pedido',\n    pt: 'Data do Pedido',\n  },\n  numero_documento: {\n    it: 'Numero Documento',\n    en: 'Document Number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro de Document',\n    es: 'Número de Documento',\n    pt: 'Número do Documento',\n  },\n  codice_articolo: {\n    it: 'Codice Articolo',\n    en: 'Item Code',\n    de: 'Artikelcode',\n    fr: 'Code Article',\n    es: 'Código Artículo',\n    pt: 'Código do Artigo',\n  },\n  anno: {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  tipo_documento: {\n    it: 'Tipo Documento',\n    en: 'Document Type',\n    de: 'Dokumenttyp',\n    fr: 'Type de Document',\n    es: 'Tipo de Documento',\n    pt: 'Tipo de Documento',\n  },\n  cliente: {\n    it: 'Cliente',\n    en: 'Customer',\n    de: 'Kunde',\n    fr: 'Client',\n    es: 'Cliente',\n    pt: 'Cliente',\n  },\n};\n\ninterface ReportBuilderProps {\n  reportSlug: string;\n  clientCode: string;\n  language?: string;\n}\n\nexport default function ReportBuilder({\n  reportSlug,\n  clientCode,\n  language: initialLanguage = 'it',\n}: ReportBuilderProps) {\n  const [config, setConfig] = useState<ReportConfig | null>(null);\n  const [rawData, setRawData] = useState<any[]>([]);\n  const [processedData, setProcessedData] = useState<any[]>([]);\n  const [aggregates, setAggregates] = useState<Record<string, any>>({});\n  const [filters, setFilters] = useState<Record<string, any>>({});\n  const [autoOptions, setAutoOptions] = useState<Record<string, string[]>>({});\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [debugInfo, setDebugInfo] = useState<any>(null);\n  const [currentLanguage, setCurrentLanguage] = useState(initialLanguage);\n\n  const getTranslatedTitle = (slug: string, lang: string) => {\n    const obj = REPORT_TEXTS[slug as keyof typeof REPORT_TEXTS];\n    if (obj) return obj.title[lang as keyof typeof obj.title] || obj.title.it;\n    return slug;\n  };\n\n  const getTranslatedDescription = (slug: string, lang: string) => {\n    const obj = REPORT_TEXTS[slug as keyof typeof REPORT_TEXTS];\n    if (obj) return obj.description[lang as keyof typeof obj.description] || obj.description.it;\n    return '';\n  };\n\n  const getFilterLabelFromField = (field: string, lang: string) => {\n    const obj = FILTER_FIELD_LABELS[field];\n    if (obj) return obj[lang] || obj.it;\n    return field;\n  };\n\n  useEffect(() => {\n    async function loadConfig() {\n      try {\n        const response = await fetch(`/api/reports/config?slug=${reportSlug}`);\n\n        if (!response.ok) {\n          throw new Error(`Report configuration not found: ${reportSlug}`);\n        }\n\n        const data = await response.json();\n        setConfig(data.config);\n      } catch (err: any) {\n        console.error('Error loading report config:', err);\n        setError(err.message || 'Failed to load report configuration');\n      }\n    }\n\n    loadConfig();\n  }, [reportSlug]);\n\n  useEffect(() => {\n    if (!config || !clientCode) return;\n\n    async function loadData(reportConfig: ReportConfig) {\n      try {\n        setLoading(true);\n        setError(null);\n\n        const queryParams: Record<string, any> = {};\n        queryParams.clientCode = clientCode;\n\n        const result = await executeQuery(reportConfig.query, queryParams);\n\n        setRawData(result.data || []);\n\n        if (result.debug) {\n          setDebugInfo(result.debug);\n        }\n\n        const options: Record<string, string[]> = {};\n\n        for (const filter of reportConfig.filters || []) {\n          if (filter.options === 'auto') {\n            if (filter.field === 'tipo_documento') {\n              options[filter.field] = await getDocumentTypes(clientCode);\n            } else if (filter.field === 'anno') {\n              const years = await getDocumentYears(clientCode);\n              options[filter.field] = years.map(String);\n            } else {\n              const uniqueValues = new Set<string>();\n              result.data.forEach((row: any) => {\n                const value = row[filter.field];\n                if (value != null && value !== '') {\n                  uniqueValues.add(String(value));\n                }\n              });\n              options[filter.field] = Array.from(uniqueValues).sort();\n            }\n          }\n        }\n\n        setAutoOptions(options);\n      } catch (err: any) {\n        console.error('Error loading data:', err);\n        setError(err.message || 'Failed to load data');\n      } finally {\n        setLoading(false);\n      }\n    }\n\n    loadData(config);\n  }, [config, clientCode]);\n\n  useEffect(() => {\n    if (!config || rawData.length === 0) {\n      setProcessedData([]);\n      setAggregates({});\n      return;\n    }\n\n    const result = ReportEngine.processReport(rawData, config, filters);\n    setProcessedData(result.data);\n    setAggregates(result.aggregates);\n  }, [rawData, config, filters]);\n\n  const handleFiltersChange = (newFilters: Record<string, any>) => {\n    setFilters(newFilters);\n  };\n\n  const handleApplyFilters = () => {};\n\n  if (loading && !config) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-sky-600\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n        <p className=\"text-red-800 font-medium\">\n          {TEXTS_BUILDER.errorTitle[currentLanguage]}\n        </p>\n        <p className=\"text-red-600 text-sm mt-1\">{error}</p>\n      </div>\n    );\n  }\n\n  if (!config) {\n    return null;\n  }\n\n  const isGrouped = config.grouping && config.grouping.length > 0;\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-start justify-between bg-gradient-to-r from-white to-slate-50 rounded-xl p-3 md:p-4\">\n        <div className=\"flex-1\">\n          <h1 className=\"text-3xl font-bold text-gray-900 tracking-tight\">\n            {getTranslatedTitle(reportSlug, currentLanguage)}\n          </h1>\n          {getTranslatedDescription(reportSlug, currentLanguage) && (\n            <p className=\"text-gray-600 mt-2\">\n              {getTranslatedDescription(reportSlug, currentLanguage)}\n            </p>\n          )}\n        </div>\n\n        <div className=\"ml-4\">\n          <label className=\"block text-xs font-medium text-gray-600 mb-1\">\n            {TEXTS_BUILDER.languageLabel[currentLanguage]}\n          </label>\n          <select\n            value={currentLanguage}\n            onChange={(e) => setCurrentLanguage(e.target.value)}\n            className=\"block w-40 px-3 py-2 bg-white border border-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400 text-sm\"\n          >\n            <option value=\"it\">🇮🇹 Italiano</option>\n            <option value=\"en\">🇬🇧 English</option>\n            <option value=\"de\">🇩🇪 Deutsch</option>\n            <option value=\"fr\">🇫🇷 Français</option>\n            <option value=\"es\">🇪🇸 Español</option>\n            <option value=\"pt\">🇵🇹 Português</option>\n          </select>\n        </div>\n      </div>\n\n      {config && config.filters && config.filters.length > 0 && (\n        <ReportFilters\n          filters={config.filters}\n          values={filters}\n          onChange={handleFiltersChange}\n          onApply={handleApplyFilters}\n          autoOptions={autoOptions}\n          rawData={rawData}\n          language={currentLanguage}\n        />\n      )}\n\n      {debugInfo && (\n        <details className=\"bg-gray-50 border border-gray-200 rounded-lg p-4\">\n          <summary className=\"cursor-pointer font-medium text-gray-700 hover:text-gray-900\">\n            {TEXTS_BUILDER.debugTitle[currentLanguage]}\n          </summary>\n          <div className=\"mt-4 space-y-3\">\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugSql[currentLanguage]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {debugInfo.sql}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugParams[currentLanguage]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {JSON.stringify(debugInfo.params, null, 2)}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugBind[currentLanguage]}\n              </p>\n              <code className=\"bg-white px-2 py-1 rounded border text-xs\">\n                {debugInfo.bindTypes}\n              </code>\n            </div>\n          </div>\n        </details>\n      )}\n\n      {!loading &&\n        Object.keys(filters)\n          .filter((key) => filters[key])\n          .length > 0 && (\n          <div className=\"bg-sky-50 border border-sky-100 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <h3 className=\"text-sm font-semibold text-sky-900\">\n                {TEXTS_BUILDER.activeFilters[currentLanguage]}\n              </h3>\n              <button\n                onClick={() => setFilters({})}\n                className=\"text-xs text-sky-600 hover:text-sky-800 underline\"\n              >\n                {TEXTS_BUILDER.removeAll[currentLanguage]}\n              </button>\n            </div>\n            <div className=\"flex flex-wrap gap-2\">\n              {Object.entries(filters).map(([field, value]) => {\n                if (!value) return null;\n\n                const label = getFilterLabelFromField(field, currentLanguage);\n\n                let displayValue = value;\n                if (typeof value === 'object' && value.from && value.to) {\n                  displayValue = `${value.from} - ${value.to}`;\n                } else if (Array.isArray(value)) {\n                  displayValue = value.join(', ');\n                }\n\n                return (\n                  <div\n                    key={field}\n                    className=\"inline-flex items-center gap-2 bg-white border border-sky-200 rounded-full px-3 py-1 text-sm shadow-sm\"\n                  >\n                    <span className=\"font-medium text-sky-900\">{label}:</span>\n                    <span className=\"text-sky-700\">{displayValue}</span>\n                    <button\n                      onClick={() => {\n                        const newFilters = { ...filters };\n                        delete newFilters[field];\n                        setFilters(newFilters);\n                      }}\n                      className=\"text-sky-400 hover:text-sky-600\"\n                    >\n                      ×\n                    </button>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        )}\n\n      {loading && (\n        <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"w-6 h-6 animate-spin text-sky-600 mr-2\" />\n          <span className=\"text-gray-600\">\n            {TEXTS_BUILDER.loadingData[currentLanguage]}\n          </span>\n        </div>\n      )}\n\n      {!loading && processedData.length === 0 && (\n        <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center\">\n          <p className=\"text-yellow-800 font-medium\">\n            {TEXTS_BUILDER.noDataTitle[currentLanguage]}\n          </p>\n          <p className=\"text-yellow-600 text-sm mt-1\">\n            {TEXTS_BUILDER.noDataText[currentLanguage]}\n          </p>\n        </div>\n      )}\n\n      {!loading && processedData.length > 0 && config && (\n        <ReportTable\n          data={processedData}\n          columns={config.columns}\n          aggregates={aggregates}\n          language={currentLanguage}\n          isGrouped={isGrouped}\n          groupingConfig={config.grouping}\n        />\n      )}\n\n      {!loading && processedData.length > 0 && config && (\n        <ReportExport\n          data={processedData}\n          config={config}\n          reportTitle={getTranslatedTitle(reportSlug, currentLanguage)}\n          language={currentLanguage}\n        />\n      )}\n    </div>\n  );\n}\n"
      }
    ]
  },
  "ReportFilters": {
    "active": "v12",
    "versions": [
      {
        "id": "v8",
        "timestamp": "2025-11-09T06:10:11.409Z",
        "note": "Modifica multipla 09/11/2025, 07:10:10",
        "code": "'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { ReportFilter } from '@/types/report';\nimport { Filter, X } from 'lucide-react';\n\nconst TEXTS_FILTERS = {\n  filters: {\n    it: 'Filtri',\n    en: 'Filters',\n    de: 'Filter',\n    fr: 'Filtres',\n    es: 'Filtros',\n    pt: 'Filtros',\n  },\n  show: {\n    it: 'Mostra',\n    en: 'Show',\n    de: 'Anzeigen',\n    fr: 'Afficher',\n    es: 'Mostrar',\n    pt: 'Mostrar',\n  },\n  hide: {\n    it: 'Nascondi',\n    en: 'Hide',\n    de: 'Verbergen',\n    fr: 'Masquer',\n    es: 'Ocultar',\n    pt: 'Ocultar',\n  },\n  applyFilters: {\n    it: 'Applica filtri',\n    en: 'Apply filters',\n    de: 'Filter anwenden',\n    fr: 'Appliquer les filtres',\n    es: 'Aplicar filtros',\n    pt: 'Aplicar filtros',\n  },\n  reset: {\n    it: 'Reset',\n    en: 'Reset',\n    de: 'Zurücksetzen',\n    fr: 'Réinitialiser',\n    es: 'Restablecer',\n    pt: 'Redefinir',\n  },\n  all: {\n    it: 'Tutti',\n    en: 'All',\n    de: 'Alle',\n    fr: 'Tous',\n    es: 'Todos',\n    pt: 'Todos',\n  },\n  search: {\n    it: 'Cerca...',\n    en: 'Search...',\n    de: 'Suchen...',\n    fr: 'Rechercher...',\n    es: 'Buscar...',\n    pt: 'Pesquisar...',\n  },\n  selected: {\n    it: 'selezionati',\n    en: 'selected',\n    de: 'ausgewählt',\n    fr: 'sélectionnés',\n    es: 'seleccionados',\n    pt: 'selecionados',\n  },\n  noOptionsFound: {\n    it: 'Nessuna opzione trovata',\n    en: 'No options found',\n    de: 'Keine Optionen gefunden',\n    fr: 'Aucune option trouvée',\n    es: 'No se encontraron opciones',\n    pt: 'Nenhuma opção encontrada',\n  },\n  selectAll: {\n    it: 'Seleziona tutti',\n    en: 'Select all',\n    de: 'Alle auswählen',\n    fr: 'Tout sélectionner',\n    es: 'Seleccionar todo',\n    pt: 'Selecionar tudo',\n  },\n  from: {\n    it: 'Da',\n    en: 'From',\n    de: 'Von',\n    fr: 'De',\n    es: 'Desde',\n    pt: 'De',\n  },\n  to: {\n    it: 'A',\n    en: 'To',\n    de: 'Bis',\n    fr: 'À',\n    es: 'Hasta',\n    pt: 'Até',\n  },\n};\n\nfunction translateFilterLabel(label: string | undefined, language: string) {\n  if (!label) return '';\n  return label;\n}\n\ninterface ReportFiltersProps {\n  filters: ReportFilter[];\n  values: Record<string, any>;\n  onChange: (values: Record<string, any>) => void;\n  onApply: () => void;\n  autoOptions?: Record<string, string[]>;\n  rawData?: any[];\n  language?: string;\n}\n\nexport default function ReportFilters({\n  filters,\n  values,\n  onChange,\n  onApply,\n  autoOptions = {},\n  rawData = [],\n  language = 'it',\n}: ReportFiltersProps) {\n  const currentLang = language || 'it';\n\n  const [showFilters, setShowFilters] = useState(false);\n  const [localValues, setLocalValues] = useState(values);\n  const [autocompleteOpen, setAutocompleteOpen] = useState<string | null>(null);\n  const autocompleteRef = useRef<HTMLDivElement>(null);\n\n  const [multiselectSearch, setMultiselectSearch] = useState<Record<string, string>>({});\n  const [multiselectOpen, setMultiselectOpen] = useState<Record<string, boolean>>({});\n\n  useEffect(() => {\n    setLocalValues(values);\n  }, [values]);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (\n        autocompleteRef.current &&\n        !autocompleteRef.current.contains(event.target as Node)\n      ) {\n        setAutocompleteOpen(null);\n        setMultiselectOpen({});\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  const handleChange = (field: string, value: any) => {\n    setLocalValues({ ...localValues, [field]: value });\n  };\n\n  const getUniqueValues = (field: string): string[] => {\n    if (!rawData || rawData.length === 0) return [];\n\n    const uniqueValues = new Set<string>();\n    rawData.forEach((row) => {\n      const value = row[field];\n      if (value != null && value !== '') {\n        uniqueValues.add(String(value));\n      }\n    });\n\n    return Array.from(uniqueValues).sort();\n  };\n\n  const getSuggestions = (field: string, inputValue: string): string[] => {\n    if (!inputValue) return getUniqueValues(field).slice(0, 10);\n\n    const uniqueValues = getUniqueValues(field);\n    return uniqueValues\n      .filter((val) => val.toLowerCase().includes(inputValue.toLowerCase()))\n      .slice(0, 10);\n  };\n\n  const handleApply = () => {\n    onChange(localValues);\n    onApply();\n    setShowFilters(false);\n  };\n\n  const handleReset = () => {\n    const resetValues: Record<string, any> = {};\n    filters.forEach((filter) => {\n      resetValues[filter.field] = filter.default || null;\n    });\n    setLocalValues(resetValues);\n    onChange(resetValues);\n    onApply();\n  };\n\n  const getDateRangeDefault = (defaultValue: string) => {\n    const today = new Date();\n    const currentYear = today.getFullYear();\n\n    switch (defaultValue) {\n      case 'current_year':\n        return {\n          from: `${currentYear}-01-01`,\n          to: `${currentYear}-12-31`,\n        };\n      case 'last_year':\n        return {\n          from: `${currentYear - 1}-01-01`,\n          to: `${currentYear - 1}-12-31`,\n        };\n      case 'last_6_months': {\n        const sixMonthsAgo = new Date(today);\n        sixMonthsAgo.setMonth(today.getMonth() - 6);\n        return {\n          from: sixMonthsAgo.toISOString().split('T')[0],\n          to: today.toISOString().split('T')[0],\n        };\n      }\n      default:\n        return { from: '', to: '' };\n    }\n  };\n\n  const renderFilter = (filter: ReportFilter) => {\n    const value = localValues[filter.field];\n    const label = translateFilterLabel(filter.label, currentLang);\n\n    switch (filter.type) {\n      case 'text': {\n        const suggestions = getSuggestions(filter.field, value || '');\n        const showAutocomplete =\n          autocompleteOpen === filter.field && suggestions.length > 0;\n\n        return (\n          <div\n            className=\"relative\"\n            ref={autocompleteOpen === filter.field ? autocompleteRef : null}\n          >\n            <input\n              type=\"text\"\n              value={value || ''}\n              onChange={(e) => handleChange(filter.field, e.target.value)}\n              onFocus={() => setAutocompleteOpen(filter.field)}\n              className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              placeholder={label}\n            />\n            {showAutocomplete && (\n              <div className=\"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                {suggestions.map((suggestion, idx) => (\n                  <button\n                    key={idx}\n                    type=\"button\"\n                    onClick={() => {\n                      handleChange(filter.field, suggestion);\n                      setAutocompleteOpen(null);\n                    }}\n                    className=\"w-full text-left px-3 py-2 hover:bg-sky-50 text-sm text-gray-700 hover:text-sky-900 border-b last:border-b-0\"\n                  >\n                    {suggestion}\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n        );\n      }\n\n      case 'select': {\n        const selectOptions =\n          filter.options === 'auto'\n            ? autoOptions[filter.field] || []\n            : filter.options || [];\n\n        return (\n          <select\n            value={value || ''}\n            onChange={(e) => handleChange(filter.field, e.target.value)}\n            className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 bg-white shadow-sm\"\n          >\n            <option value=\"\">{TEXTS_FILTERS.all[currentLang]}</option>\n            {selectOptions.map((option) => (\n              <option key={option} value={option}>\n                {option}\n              </option>\n            ))}\n          </select>\n        );\n      }\n\n      case 'multiselect': {\n        const multiOptions =\n          filter.options === 'auto'\n            ? autoOptions[filter.field] || []\n            : filter.options || [];\n\n        const selectedValues = value || [];\n        const searchTerm = multiselectSearch[filter.field] || '';\n        const isOpen = multiselectOpen[filter.field] || false;\n\n        const filteredOptions = multiOptions.filter((option) =>\n          option.toLowerCase().includes(searchTerm.toLowerCase())\n        );\n\n        return (\n          <div className=\"relative\" ref={isOpen ? autocompleteRef : null}>\n            {selectedValues.length > 0 && (\n              <div className=\"flex flex-wrap gap-1 mb-2\">\n                {selectedValues.map((val: string) => (\n                  <span\n                    key={val}\n                    className=\"inline-flex items-center gap-1 bg-sky-100 text-sky-800 text-xs px-2 py-1 rounded-full\"\n                  >\n                    {val}\n                    <button\n                      type=\"button\"\n                      onClick={() => {\n                        const newValues = selectedValues.filter(\n                          (v: string) => v !== val\n                        );\n                        handleChange(filter.field, newValues);\n                      }}\n                      className=\"text-sky-600 hover:text-sky-800\"\n                    >\n                      ×\n                    </button>\n                  </span>\n                ))}\n              </div>\n            )}\n\n            <div className=\"relative\">\n              <input\n                type=\"text\"\n                value={searchTerm}\n                onChange={(e) =>\n                  setMultiselectSearch({\n                    ...multiselectSearch,\n                    [filter.field]: e.target.value,\n                  })\n                }\n                onFocus={() =>\n                  setMultiselectOpen({\n                    ...multiselectOpen,\n                    [filter.field]: true,\n                  })\n                }\n                placeholder={`${TEXTS_FILTERS.search[currentLang]} (${\n                  selectedValues.length\n                } ${TEXTS_FILTERS.selected[currentLang]})`}\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n\n              {isOpen && (\n                <div className=\"absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                  {filteredOptions.length === 0 ? (\n                    <div className=\"px-3 py-2 text-sm text-gray-500\">\n                      {TEXTS_FILTERS.noOptionsFound[currentLang]}\n                    </div>\n                  ) : (\n                    <>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          handleChange(filter.field, filteredOptions);\n                          setMultiselectOpen({\n                            ...multiselectOpen,\n                            [filter.field]: false,\n                          });\n                        }}\n                        className=\"w-full text-left px-3 py-2 text-xs text-sky-600 hover:bg-sky-50 border-b\"\n                      >\n                        ✓ {TEXTS_FILTERS.selectAll[currentLang]} (\n                        {filteredOptions.length})\n                      </button>\n                      {filteredOptions.map((option) => (\n                        <label\n                          key={option}\n                          className=\"flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer border-b last:border-b-0\"\n                        >\n                          <input\n                            type=\"checkbox\"\n                            checked={selectedValues.includes(option)}\n                            onChange={(e) => {\n                              const newValues = e.target.checked\n                                ? [...selectedValues, option]\n                                : selectedValues.filter(\n                                    (v: string) => v !== option\n                                  );\n                              handleChange(filter.field, newValues);\n                            }}\n                            className=\"rounded\"\n                          />\n                          <span className=\"text-sm\">{option}</span>\n                        </label>\n                      ))}\n                    </>\n                  )}\n                </div>\n              )}\n            </div>\n\n            <button\n              type=\"button\"\n              onClick={() =>\n                setMultiselectOpen({\n                  ...multiselectOpen,\n                  [filter.field]: !isOpen,\n                })\n              }\n              className=\"absolute right-2 top-2 text-gray-400 hover:text-gray-600\"\n            >\n              {isOpen ? '▲' : '▼'}\n            </button>\n          </div>\n        );\n      }\n\n      case 'daterange': {\n        const dateRange = value || getDateRangeDefault(filter.default as string);\n\n        return (\n          <div className=\"flex gap-2\">\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.from[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.from || ''}\n                onChange={(e) =>\n                  handleChange(filter.field, { ...dateRange, from: e.target.value })\n                }\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.to[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.to || ''}\n                onChange={(e) =>\n                  handleChange(filter.field, { ...dateRange, to: e.target.value })\n                }\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n          </div>\n        );\n      }\n\n      default:\n        return null;\n    }\n  };\n\n  const activeFiltersCount = Object.values(localValues).filter(\n    (v) =>\n      v !== null &&\n      v !== undefined &&\n      v !== '' &&\n      !(typeof v === 'object' && Object.keys(v).length === 0)\n  ).length;\n\n  return (\n    <div className=\"bg-white/80 backdrop-blur-sm rounded-xl shadow-sm border border-gray-100 p-4 mb-4\">\n      <div className=\"flex items-center justify-between mb-3\">\n        <div className=\"flex items-center gap-2\">\n          <span className=\"inline-flex items-center justify-center w-8 h-8 rounded-full bg-sky-100 text-sky-700 shadow-sm\">\n            <Filter className=\"w-4 h-4\" />\n          </span>\n          <h3 className=\"text-base font-semibold text-gray-900\">\n            {TEXTS_FILTERS.filters[currentLang]}\n          </h3>\n          {activeFiltersCount > 0 && (\n            <span className=\"px-2 py-1 bg-sky-100 text-sky-800 text-xs font-medium rounded-full\">\n              {activeFiltersCount}\n            </span>\n          )}\n        </div>\n        <button\n          onClick={() => setShowFilters(!showFilters)}\n          className=\"text-sky-600 hover:text-sky-700 text-sm font-medium\"\n        >\n          {showFilters\n            ? TEXTS_FILTERS.hide[currentLang]\n            : TEXTS_FILTERS.show[currentLang]}\n        </button>\n      </div>\n\n      {showFilters && (\n        <>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4\">\n            {filters.map((filter) => {\n              const label = translateFilterLabel(filter.label, currentLang);\n              return (\n                <div key={filter.field}>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    {label}\n                  </label>\n                  {renderFilter(filter)}\n                </div>\n              );\n            })}\n          </div>\n\n          <div className=\"flex gap-2 pt-4 border-t border-dashed border-slate-200\">\n            <button\n              onClick={handleApply}\n              className=\"px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 font-medium shadow-sm transition\"\n            >\n              {TEXTS_FILTERS.applyFilters[currentLang]}\n            </button>\n            <button\n              onClick={handleReset}\n              className=\"px-4 py-2 border border-gray-200 text-gray-700 bg-white rounded-md hover:bg-gray-50 font-medium flex items-center gap-2\"\n            >\n              <X className=\"w-4 h-4\" />\n              {TEXTS_FILTERS.reset[currentLang]}\n            </button>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v9",
        "timestamp": "2025-11-09T06:14:41.688Z",
        "note": "Modifica multipla 09/11/2025, 07:14:41",
        "code": "'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { ReportFilter } from '@/types/report';\nimport { Filter, X } from 'lucide-react';\n\nconst FILTER_LABELS: Record<\n  string,\n  {\n    it: string;\n    en: string;\n    de: string;\n    fr: string;\n    es: string;\n    pt: string;\n  }\n> = {\n  'data ordine': {\n    it: 'Data Ordine',\n    en: 'Order Date',\n    de: 'Bestelldatum',\n    fr: 'Date commande',\n    es: 'Fecha pedido',\n    pt: 'Data pedido',\n  },\n  'numero documento': {\n    it: 'Numero documento',\n    en: 'Document number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro document',\n    es: 'Número documento',\n    pt: 'Número documento',\n  },\n  'codice articolo': {\n    it: 'Codice articolo',\n    en: 'Item code',\n    de: 'Artikelcode',\n    fr: 'Code article',\n    es: 'Código artículo',\n    pt: 'Código artigo',\n  },\n  'cliente': {\n    it: 'Cliente',\n    en: 'Customer',\n    de: 'Kunde',\n    fr: 'Client',\n    es: 'Cliente',\n    pt: 'Cliente',\n  },\n  'articolo': {\n    it: 'Articolo',\n    en: 'Item',\n    de: 'Artikel',\n    fr: 'Article',\n    es: 'Artículo',\n    pt: 'Artigo',\n  },\n  'agente': {\n    it: 'Agente',\n    en: 'Agent',\n    de: 'Vertreter',\n    fr: 'Agent',\n    es: 'Agente',\n    pt: 'Agente',\n  },\n  'anno': {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  'tipo documento': {\n    it: 'Tipo documento',\n    en: 'Document type',\n    de: 'Dokumentenart',\n    fr: 'Type de document',\n    es: 'Tipo de documento',\n    pt: 'Tipo de documento',\n  },\n  'stato': {\n    it: 'Stato',\n    en: 'Status',\n    de: 'Status',\n    fr: 'Statut',\n    es: 'Estado',\n    pt: 'Estado',\n  },\n  'magazzino': {\n    it: 'Magazzino',\n    en: 'Warehouse',\n    de: 'Lager',\n    fr: 'Entrepôt',\n    es: 'Almacén',\n    pt: 'Armazém',\n  },\n  'causale': {\n    it: 'Causale',\n    en: 'Reason',\n    de: 'Grund',\n    fr: 'Causal',\n    es: 'Causal',\n    pt: 'Causal',\n  },\n};\n\nconst TEXTS_FILTERS = {\n  filters: {\n    it: 'Filtri',\n    en: 'Filters',\n    de: 'Filter',\n    fr: 'Filtres',\n    es: 'Filtros',\n    pt: 'Filtros',\n  },\n  show: {\n    it: 'Mostra',\n    en: 'Show',\n    de: 'Anzeigen',\n    fr: 'Afficher',\n    es: 'Mostrar',\n    pt: 'Mostrar',\n  },\n  hide: {\n    it: 'Nascondi',\n    en: 'Hide',\n    de: 'Verbergen',\n    fr: 'Masquer',\n    es: 'Ocultar',\n    pt: 'Ocultar',\n  },\n  applyFilters: {\n    it: 'Applica filtri',\n    en: 'Apply filters',\n    de: 'Filter anwenden',\n    fr: 'Appliquer les filtres',\n    es: 'Aplicar filtros',\n    pt: 'Aplicar filtros',\n  },\n  reset: {\n    it: 'Reset',\n    en: 'Reset',\n    de: 'Zurücksetzen',\n    fr: 'Réinitialiser',\n    es: 'Restablecer',\n    pt: 'Redefinir',\n  },\n  all: {\n    it: 'Tutti',\n    en: 'All',\n    de: 'Alle',\n    fr: 'Tous',\n    es: 'Todos',\n    pt: 'Todos',\n  },\n  search: {\n    it: 'Cerca...',\n    en: 'Search...',\n    de: 'Suchen...',\n    fr: 'Rechercher...',\n    es: 'Buscar...',\n    pt: 'Pesquisar...',\n  },\n  selected: {\n    it: 'selezionati',\n    en: 'selected',\n    de: 'ausgewählt',\n    fr: 'sélectionnés',\n    es: 'seleccionados',\n    pt: 'selecionados',\n  },\n  noOptionsFound: {\n    it: 'Nessuna opzione trovata',\n    en: 'No options found',\n    de: 'Keine Optionen gefunden',\n    fr: 'Aucune option trouvée',\n    es: 'No se encontraron opciones',\n    pt: 'Nenhuma opção encontrada',\n  },\n  selectAll: {\n    it: 'Seleziona tutti',\n    en: 'Select all',\n    de: 'Alle auswählen',\n    fr: 'Tout sélectionner',\n    es: 'Seleccionar todo',\n    pt: 'Selecionar tudo',\n  },\n  from: {\n    it: 'Da',\n    en: 'From',\n    de: 'Von',\n    fr: 'De',\n    es: 'Desde',\n    pt: 'De',\n  },\n  to: {\n    it: 'A',\n    en: 'To',\n    de: 'Bis',\n    fr: 'À',\n    es: 'Hasta',\n    pt: 'Até',\n  },\n};\n\nfunction translateFilterLabel(label: string | undefined, language: string) {\n  if (!label) return '';\n  const key = label.toLowerCase().trim();\n  if (FILTER_LABELS[key]) {\n    return FILTER_LABELS[key][language as keyof (typeof FILTER_LABELS)[string]];\n  }\n  return label;\n}\n\ninterface ReportFiltersProps {\n  filters: ReportFilter[];\n  values: Record<string, any>;\n  onChange: (values: Record<string, any>) => void;\n  onApply: () => void;\n  autoOptions?: Record<string, string[]>;\n  rawData?: any[];\n  language?: string;\n}\n\nexport default function ReportFilters({\n  filters,\n  values,\n  onChange,\n  onApply,\n  autoOptions = {},\n  rawData = [],\n  language = 'it',\n}: ReportFiltersProps) {\n  const currentLang = language || 'it';\n\n  const [showFilters, setShowFilters] = useState(false);\n  const [localValues, setLocalValues] = useState(values);\n  const [autocompleteOpen, setAutocompleteOpen] = useState<string | null>(null);\n  const autocompleteRef = useRef<HTMLDivElement>(null);\n\n  const [multiselectSearch, setMultiselectSearch] = useState<Record<string, string>>({});\n  const [multiselectOpen, setMultiselectOpen] = useState<Record<string, boolean>>({});\n\n  useEffect(() => {\n    setLocalValues(values);\n  }, [values]);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (\n        autocompleteRef.current &&\n        !autocompleteRef.current.contains(event.target as Node)\n      ) {\n        setAutocompleteOpen(null);\n        setMultiselectOpen({});\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  const handleChange = (field: string, value: any) => {\n    setLocalValues({ ...localValues, [field]: value });\n  };\n\n  const getUniqueValues = (field: string): string[] => {\n    if (!rawData || rawData.length === 0) return [];\n\n    const uniqueValues = new Set<string>();\n    rawData.forEach((row) => {\n      const value = row[field];\n      if (value != null && value !== '') {\n        uniqueValues.add(String(value));\n      }\n    });\n\n    return Array.from(uniqueValues).sort();\n  };\n\n  const getSuggestions = (field: string, inputValue: string): string[] => {\n    if (!inputValue) return getUniqueValues(field).slice(0, 10);\n\n    const uniqueValues = getUniqueValues(field);\n    return uniqueValues\n      .filter((val) => val.toLowerCase().includes(inputValue.toLowerCase()))\n      .slice(0, 10);\n  };\n\n  const handleApply = () => {\n    onChange(localValues);\n    onApply();\n    setShowFilters(false);\n  };\n\n  const handleReset = () => {\n    const resetValues: Record<string, any> = {};\n    filters.forEach((filter) => {\n      resetValues[filter.field] = filter.default || null;\n    });\n    setLocalValues(resetValues);\n    onChange(resetValues);\n    onApply();\n  };\n\n  const getDateRangeDefault = (defaultValue: string) => {\n    const today = new Date();\n    const currentYear = today.getFullYear();\n\n    switch (defaultValue) {\n      case 'current_year':\n        return {\n          from: `${currentYear}-01-01`,\n          to: `${currentYear}-12-31`,\n        };\n      case 'last_year':\n        return {\n          from: `${currentYear - 1}-01-01`,\n          to: `${currentYear - 1}-12-31`,\n        };\n      case 'last_6_months': {\n        const sixMonthsAgo = new Date(today);\n        sixMonthsAgo.setMonth(today.getMonth() - 6);\n        return {\n          from: sixMonthsAgo.toISOString().split('T')[0],\n          to: today.toISOString().split('T')[0],\n        };\n      }\n      default:\n        return { from: '', to: '' };\n    }\n  };\n\n  const renderFilter = (filter: ReportFilter) => {\n    const value = localValues[filter.field];\n    const label = translateFilterLabel(filter.label, currentLang);\n\n    switch (filter.type) {\n      case 'text': {\n        const suggestions = getSuggestions(filter.field, value || '');\n        const showAutocomplete =\n          autocompleteOpen === filter.field && suggestions.length > 0;\n\n        return (\n          <div\n            className=\"relative\"\n            ref={autocompleteOpen === filter.field ? autocompleteRef : null}\n          >\n            <input\n              type=\"text\"\n              value={value || ''}\n              onChange={(e) => handleChange(filter.field, e.target.value)}\n              onFocus={() => setAutocompleteOpen(filter.field)}\n              className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              placeholder={label}\n            />\n            {showAutocomplete && (\n              <div className=\"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                {suggestions.map((suggestion, idx) => (\n                  <button\n                    key={idx}\n                    type=\"button\"\n                    onClick={() => {\n                      handleChange(filter.field, suggestion);\n                      setAutocompleteOpen(null);\n                    }}\n                    className=\"w-full text-left px-3 py-2 hover:bg-sky-50 text-sm text-gray-700 hover:text-sky-900 border-b last:border-b-0\"\n                  >\n                    {suggestion}\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n        );\n      }\n\n      case 'select': {\n        const selectOptions =\n          filter.options === 'auto'\n            ? autoOptions[filter.field] || []\n            : filter.options || [];\n\n        return (\n          <select\n            value={value || ''}\n            onChange={(e) => handleChange(filter.field, e.target.value)}\n            className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 bg-white shadow-sm\"\n          >\n            <option value=\"\">{TEXTS_FILTERS.all[currentLang]}</option>\n            {selectOptions.map((option) => (\n              <option key={option} value={option}>\n                {option}\n              </option>\n            ))}\n          </select>\n        );\n      }\n\n      case 'multiselect': {\n        const multiOptions =\n          filter.options === 'auto'\n            ? autoOptions[filter.field] || []\n            : filter.options || [];\n\n        const selectedValues = value || [];\n        const searchTerm = multiselectSearch[filter.field] || '';\n        const isOpen = multiselectOpen[filter.field] || false;\n\n        const filteredOptions = multiOptions.filter((option) =>\n            option.toLowerCase().includes(searchTerm.toLowerCase())\n        );\n\n        return (\n          <div className=\"relative\" ref={isOpen ? autocompleteRef : null}>\n            {selectedValues.length > 0 && (\n              <div className=\"flex flex-wrap gap-1 mb-2\">\n                {selectedValues.map((val: string) => (\n                  <span\n                    key={val}\n                    className=\"inline-flex items-center gap-1 bg-sky-100 text-sky-800 text-xs px-2 py-1 rounded-full\"\n                  >\n                    {val}\n                    <button\n                      type=\"button\"\n                      onClick={() => {\n                        const newValues = selectedValues.filter(\n                          (v: string) => v !== val\n                        );\n                        handleChange(filter.field, newValues);\n                      }}\n                      className=\"text-sky-600 hover:text-sky-800\"\n                    >\n                      ×\n                    </button>\n                  </span>\n                ))}\n              </div>\n            )}\n\n            <div className=\"relative\">\n              <input\n                type=\"text\"\n                value={searchTerm}\n                onChange={(e) =>\n                  setMultiselectSearch({\n                    ...multiselectSearch,\n                    [filter.field]: e.target.value,\n                  })\n                }\n                onFocus={() =>\n                  setMultiselectOpen({\n                    ...multiselectOpen,\n                    [filter.field]: true,\n                  })\n                }\n                placeholder={`${TEXTS_FILTERS.search[currentLang]} (${\n                  selectedValues.length\n                } ${TEXTS_FILTERS.selected[currentLang]})`}\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n\n              {isOpen && (\n                <div className=\"absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                  {filteredOptions.length === 0 ? (\n                    <div className=\"px-3 py-2 text-sm text-gray-500\">\n                      {TEXTS_FILTERS.noOptionsFound[currentLang]}\n                    </div>\n                  ) : (\n                    <>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          handleChange(filter.field, filteredOptions);\n                          setMultiselectOpen({\n                            ...multiselectOpen,\n                            [filter.field]: false,\n                          });\n                        }}\n                        className=\"w-full text-left px-3 py-2 text-xs text-sky-600 hover:bg-sky-50 border-b\"\n                      >\n                        ✓ {TEXTS_FILTERS.selectAll[currentLang]} (\n                        {filteredOptions.length})\n                      </button>\n                      {filteredOptions.map((option) => (\n                        <label\n                          key={option}\n                          className=\"flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer border-b last:border-b-0\"\n                        >\n                          <input\n                            type=\"checkbox\"\n                            checked={selectedValues.includes(option)}\n                            onChange={(e) => {\n                              const newValues = e.target.checked\n                                ? [...selectedValues, option]\n                                : selectedValues.filter(\n                                    (v: string) => v !== option\n                                  );\n                              handleChange(filter.field, newValues);\n                            }}\n                            className=\"rounded\"\n                          />\n                          <span className=\"text-sm\">{option}</span>\n                        </label>\n                      ))}\n                    </>\n                  )}\n                </div>\n              )}\n            </div>\n\n            <button\n              type=\"button\"\n              onClick={() =>\n                setMultiselectOpen({\n                  ...multiselectOpen,\n                  [filter.field]: !isOpen,\n                })\n              }\n              className=\"absolute right-2 top-2 text-gray-400 hover:text-gray-600\"\n            >\n              {isOpen ? '▲' : '▼'}\n            </button>\n          </div>\n        );\n      }\n\n      case 'daterange': {\n        const dateRange = value || getDateRangeDefault(filter.default as string);\n\n        return (\n          <div className=\"flex gap-2\">\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.from[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.from || ''}\n                onChange={(e) =>\n                  handleChange(filter.field, { ...dateRange, from: e.target.value })\n                }\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.to[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.to || ''}\n                onChange={(e) =>\n                  handleChange(filter.field, { ...dateRange, to: e.target.value })\n                }\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n          </div>\n        );\n      }\n\n      default:\n        return null;\n    }\n  };\n\n  const activeFiltersCount = Object.values(localValues).filter(\n    (v) =>\n      v !== null &&\n      v !== undefined &&\n      v !== '' &&\n      !(typeof v === 'object' && Object.keys(v).length === 0)\n  ).length;\n\n  return (\n    <div className=\"bg-white/80 backdrop-blur-sm rounded-xl shadow-sm border border-gray-100 p-4 mb-4\">\n      <div className=\"flex items-center justify-between mb-3\">\n        <div className=\"flex items-center gap-2\">\n          <span className=\"inline-flex items-center justify-center w-8 h-8 rounded-full bg-sky-100 text-sky-700 shadow-sm\">\n            <Filter className=\"w-4 h-4\" />\n          </span>\n          <h3 className=\"text-base font-semibold text-gray-900\">\n            {TEXTS_FILTERS.filters[currentLang]}\n          </h3>\n          {activeFiltersCount > 0 && (\n            <span className=\"px-2 py-1 bg-sky-100 text-sky-800 text-xs font-medium rounded-full\">\n              {activeFiltersCount}\n            </span>\n          )}\n        </div>\n        <button\n          onClick={() => setShowFilters(!showFilters)}\n          className=\"text-sky-600 hover:text-sky-700 text-sm font-medium\"\n        >\n          {showFilters\n            ? TEXTS_FILTERS.hide[currentLang]\n            : TEXTS_FILTERS.show[currentLang]}\n        </button>\n      </div>\n\n      {showFilters && (\n        <>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4\">\n            {filters.map((filter) => {\n              const label = translateFilterLabel(filter.label, currentLang);\n              return (\n                <div key={filter.field}>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    {label}\n                  </label>\n                  {renderFilter(filter)}\n                </div>\n              );\n            })}\n          </div>\n\n          <div className=\"flex gap-2 pt-4 border-t border-dashed border-slate-200\">\n            <button\n              onClick={handleApply}\n              className=\"px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 font-medium shadow-sm transition\"\n            >\n              {TEXTS_FILTERS.applyFilters[currentLang]}\n            </button>\n            <button\n              onClick={handleReset}\n              className=\"px-4 py-2 border border-gray-200 text-gray-700 bg-white rounded-md hover:bg-gray-50 font-medium flex items-center gap-2\"\n            >\n              <X className=\"w-4 h-4\" />\n              {TEXTS_FILTERS.reset[currentLang]}\n            </button>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v10",
        "timestamp": "2025-11-09T06:17:15.623Z",
        "note": "Modifica multipla 09/11/2025, 07:17:15",
        "code": "'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { ReportFilter } from '@/types/report';\nimport { Filter, X } from 'lucide-react';\n\nconst FILTER_LABELS: Record<\n  string,\n  {\n    it: string;\n    en: string;\n    de: string;\n    fr: string;\n    es: string;\n    pt: string;\n  }\n> = {\n  'data ordine': {\n    it: 'Data Ordine',\n    en: 'Order Date',\n    de: 'Bestelldatum',\n    fr: 'Date commande',\n    es: 'Fecha pedido',\n    pt: 'Data pedido',\n  },\n  'numero documento': {\n    it: 'Numero documento',\n    en: 'Document number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro document',\n    es: 'Número documento',\n    pt: 'Número documento',\n  },\n  'codice articolo': {\n    it: 'Codice articolo',\n    en: 'Item code',\n    de: 'Artikelcode',\n    fr: 'Code article',\n    es: 'Código artículo',\n    pt: 'Código artigo',\n  },\n  'cliente': {\n    it: 'Cliente',\n    en: 'Customer',\n    de: 'Kunde',\n    fr: 'Client',\n    es: 'Cliente',\n    pt: 'Cliente',\n  },\n  'articolo': {\n    it: 'Articolo',\n    en: 'Item',\n    de: 'Artikel',\n    fr: 'Article',\n    es: 'Artículo',\n    pt: 'Artigo',\n  },\n  'agente': {\n    it: 'Agente',\n    en: 'Agent',\n    de: 'Vertreter',\n    fr: 'Agent',\n    es: 'Agente',\n    pt: 'Agente',\n  },\n  'anno': {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  'tipo documento': {\n    it: 'Tipo documento',\n    en: 'Document type',\n    de: 'Dokumentenart',\n    fr: 'Type de document',\n    es: 'Tipo de documento',\n    pt: 'Tipo de documento',\n  },\n  'stato': {\n    it: 'Stato',\n    en: 'Status',\n    de: 'Status',\n    fr: 'Statut',\n    es: 'Estado',\n    pt: 'Estado',\n  },\n  'magazzino': {\n    it: 'Magazzino',\n    en: 'Warehouse',\n    de: 'Lager',\n    fr: 'Entrepôt',\n    es: 'Almacén',\n    pt: 'Armazém',\n  },\n  'causale': {\n    it: 'Causale',\n    en: 'Reason',\n    de: 'Grund',\n    fr: 'Causal',\n    es: 'Causal',\n    pt: 'Causal',\n  },\n};\n\nconst TEXTS_FILTERS = {\n  filters: {\n    it: 'Filtri',\n    en: 'Filters',\n    de: 'Filter',\n    fr: 'Filtres',\n    es: 'Filtros',\n    pt: 'Filtros',\n  },\n  show: {\n    it: 'Mostra',\n    en: 'Show',\n    de: 'Anzeigen',\n    fr: 'Afficher',\n    es: 'Mostrar',\n    pt: 'Mostrar',\n  },\n  hide: {\n    it: 'Nascondi',\n    en: 'Hide',\n    de: 'Verbergen',\n    fr: 'Masquer',\n    es: 'Ocultar',\n    pt: 'Ocultar',\n  },\n  applyFilters: {\n    it: 'Applica filtri',\n    en: 'Apply filters',\n    de: 'Filter anwenden',\n    fr: 'Appliquer les filtres',\n    es: 'Aplicar filtros',\n    pt: 'Aplicar filtros',\n  },\n  reset: {\n    it: 'Reset',\n    en: 'Reset',\n    de: 'Zurücksetzen',\n    fr: 'Réinitialiser',\n    es: 'Restablecer',\n    pt: 'Redefinir',\n  },\n  all: {\n    it: 'Tutti',\n    en: 'All',\n    de: 'Alle',\n    fr: 'Tous',\n    es: 'Todos',\n    pt: 'Todos',\n  },\n  search: {\n    it: 'Cerca...',\n    en: 'Search...',\n    de: 'Suchen...',\n    fr: 'Rechercher...',\n    es: 'Buscar...',\n    pt: 'Pesquisar...',\n  },\n  selected: {\n    it: 'selezionati',\n    en: 'selected',\n    de: 'ausgewählt',\n    fr: 'sélectionnés',\n    es: 'seleccionados',\n    pt: 'selecionados',\n  },\n  noOptionsFound: {\n    it: 'Nessuna opzione trovata',\n    en: 'No options found',\n    de: 'Keine Optionen gefunden',\n    fr: 'Aucune option trouvée',\n    es: 'No se encontraron opciones',\n    pt: 'Nenhuma opção encontrada',\n  },\n  selectAll: {\n    it: 'Seleziona tutti',\n    en: 'Select all',\n    de: 'Alle auswählen',\n    fr: 'Tout sélectionner',\n    es: 'Seleccionar todo',\n    pt: 'Selecionar tudo',\n  },\n  from: {\n    it: 'Da',\n    en: 'From',\n    de: 'Von',\n    fr: 'De',\n    es: 'Desde',\n    pt: 'De',\n  },\n  to: {\n    it: 'A',\n    en: 'To',\n    de: 'Bis',\n    fr: 'À',\n    es: 'Hasta',\n    pt: 'Até',\n  },\n};\n\nfunction translateFilterLabel(label: string | undefined, language: string) {\n  if (!label) return '';\n  const key = label.toLowerCase().trim();\n  if (FILTER_LABELS[key]) {\n    return FILTER_LABELS[key][language as keyof (typeof FILTER_LABELS)[string]];\n  }\n  return label;\n}\n\ninterface ReportFiltersProps {\n  filters: ReportFilter[];\n  values: Record<string, any>;\n  onChange: (values: Record<string, any>) => void;\n  onApply: () => void;\n  autoOptions?: Record<string, string[]>;\n  rawData?: any[];\n  language?: string;\n}\n\nexport default function ReportFilters({\n  filters,\n  values,\n  onChange,\n  onApply,\n  autoOptions = {},\n  rawData = [],\n  language = 'it',\n}: ReportFiltersProps) {\n  const currentLang = language || 'it';\n\n  const [showFilters, setShowFilters] = useState(false);\n  const [localValues, setLocalValues] = useState(values);\n  const [autocompleteOpen, setAutocompleteOpen] = useState<string | null>(null);\n  const autocompleteRef = useRef<HTMLDivElement>(null);\n\n  const [multiselectSearch, setMultiselectSearch] = useState<Record<string, string>>({});\n  const [multiselectOpen, setMultiselectOpen] = useState<Record<string, boolean>>({});\n\n  useEffect(() => {\n    setLocalValues(values);\n  }, [values]);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (\n        autocompleteRef.current &&\n        !autocompleteRef.current.contains(event.target as Node)\n      ) {\n        setAutocompleteOpen(null);\n        setMultiselectOpen({});\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  const handleChange = (field: string, value: any) => {\n    setLocalValues({ ...localValues, [field]: value });\n  };\n\n  const getUniqueValues = (field: string): string[] => {\n    if (!rawData || rawData.length === 0) return [];\n\n    const uniqueValues = new Set<string>();\n    rawData.forEach((row) => {\n      const value = row[field];\n      if (value != null && value !== '') {\n        uniqueValues.add(String(value));\n      }\n    });\n\n    return Array.from(uniqueValues).sort();\n  };\n\n  const getSuggestions = (field: string, inputValue: string): string[] => {\n    if (!inputValue) return getUniqueValues(field).slice(0, 10);\n\n    const uniqueValues = getUniqueValues(field);\n    return uniqueValues\n      .filter((val) => val.toLowerCase().includes(inputValue.toLowerCase()))\n      .slice(0, 10);\n  };\n\n  const handleApply = () => {\n    onChange(localValues);\n    onApply();\n    setShowFilters(false);\n  };\n\n  const handleReset = () => {\n    const resetValues: Record<string, any> = {};\n    filters.forEach((filter) => {\n      resetValues[filter.field] = filter.default || null;\n    });\n    setLocalValues(resetValues);\n    onChange(resetValues);\n    onApply();\n  };\n\n  const getDateRangeDefault = (defaultValue: string) => {\n    const today = new Date();\n    const currentYear = today.getFullYear();\n\n    switch (defaultValue) {\n      case 'current_year':\n        return {\n          from: `${currentYear}-01-01`,\n          to: `${currentYear}-12-31`,\n        };\n      case 'last_year':\n        return {\n          from: `${currentYear - 1}-01-01`,\n          to: `${currentYear - 1}-12-31`,\n        };\n      case 'last_6_months': {\n        const sixMonthsAgo = new Date(today);\n        sixMonthsAgo.setMonth(today.getMonth() - 6);\n        return {\n          from: sixMonthsAgo.toISOString().split('T')[0],\n          to: today.toISOString().split('T')[0],\n        };\n      }\n      default:\n        return { from: '', to: '' };\n    }\n  };\n\n  const renderFilter = (filter: ReportFilter) => {\n    const value = localValues[filter.field];\n    const label = translateFilterLabel(filter.label, currentLang);\n\n    switch (filter.type) {\n      case 'text': {\n        const suggestions = getSuggestions(filter.field, value || '');\n        const showAutocomplete =\n          autocompleteOpen === filter.field && suggestions.length > 0;\n\n        return (\n          <div\n            className=\"relative\"\n            ref={autocompleteOpen === filter.field ? autocompleteRef : null}\n          >\n            <input\n              type=\"text\"\n              value={value || ''}\n              onChange={(e) => handleChange(filter.field, e.target.value)}\n              onFocus={() => setAutocompleteOpen(filter.field)}\n              className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              placeholder={label}\n            />\n            {showAutocomplete && (\n              <div className=\"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                {suggestions.map((suggestion, idx) => (\n                  <button\n                    key={idx}\n                    type=\"button\"\n                    onClick={() => {\n                      handleChange(filter.field, suggestion);\n                      setAutocompleteOpen(null);\n                    }}\n                    className=\"w-full text-left px-3 py-2 hover:bg-sky-50 text-sm text-gray-700 hover:text-sky-900 border-b last:border-b-0\"\n                  >\n                    {suggestion}\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n        );\n      }\n\n      case 'select': {\n        const selectOptions =\n          filter.options === 'auto'\n            ? autoOptions[filter.field] || []\n            : filter.options || [];\n\n        return (\n          <select\n            value={value || ''}\n            onChange={(e) => handleChange(filter.field, e.target.value)}\n            className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 bg-white shadow-sm\"\n          >\n            <option value=\"\">{TEXTS_FILTERS.all[currentLang]}</option>\n            {selectOptions.map((option) => (\n              <option key={option} value={option}>\n                {option}\n              </option>\n            ))}\n          </select>\n        );\n      }\n\n      case 'multiselect': {\n        const multiOptions =\n          filter.options === 'auto'\n            ? autoOptions[filter.field] || []\n            : filter.options || [];\n\n        const selectedValues = value || [];\n        const searchTerm = multiselectSearch[filter.field] || '';\n        const isOpen = multiselectOpen[filter.field] || false;\n\n        const filteredOptions = multiOptions.filter((option) =>\n          option.toLowerCase().includes(searchTerm.toLowerCase())\n        );\n\n        return (\n          <div className=\"relative\" ref={isOpen ? autocompleteRef : null}>\n            {selectedValues.length > 0 && (\n              <div className=\"flex flex-wrap gap-1 mb-2\">\n                {selectedValues.map((val: string) => (\n                  <span\n                    key={val}\n                    className=\"inline-flex items-center gap-1 bg-sky-100 text-sky-800 text-xs px-2 py-1 rounded-full\"\n                  >\n                    {val}\n                    <button\n                      type=\"button\"\n                      onClick={() => {\n                        const newValues = selectedValues.filter(\n                          (v: string) => v !== val\n                        );\n                        handleChange(filter.field, newValues);\n                      }}\n                      className=\"text-sky-600 hover:text-sky-800\"\n                    >\n                      ×\n                    </button>\n                  </span>\n                ))}\n              </div>\n            )}\n\n            <div className=\"relative\">\n              <input\n                type=\"text\"\n                value={searchTerm}\n                onChange={(e) =>\n                  setMultiselectSearch({\n                    ...multiselectSearch,\n                    [filter.field]: e.target.value,\n                  })\n                }\n                onFocus={() =>\n                  setMultiselectOpen({\n                    ...multiselectOpen,\n                    [filter.field]: true,\n                  })\n                }\n                placeholder={`${TEXTS_FILTERS.search[currentLang]} (${\n                  selectedValues.length\n                } ${TEXTS_FILTERS.selected[currentLang]})`}\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n\n              {isOpen && (\n                <div className=\"absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                  {filteredOptions.length === 0 ? (\n                    <div className=\"px-3 py-2 text-sm text-gray-500\">\n                      {TEXTS_FILTERS.noOptionsFound[currentLang]}\n                    </div>\n                  ) : (\n                    <>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          handleChange(filter.field, filteredOptions);\n                          setMultiselectOpen({\n                            ...multiselectOpen,\n                            [filter.field]: false,\n                          });\n                        }}\n                        className=\"w-full text-left px-3 py-2 text-xs text-sky-600 hover:bg-sky-50 border-b\"\n                      >\n                        ✓ {TEXTS_FILTERS.selectAll[currentLang]} (\n                        {filteredOptions.length})\n                      </button>\n                      {filteredOptions.map((option) => (\n                        <label\n                          key={option}\n                          className=\"flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer border-b last:border-b-0\"\n                        >\n                          <input\n                            type=\"checkbox\"\n                            checked={selectedValues.includes(option)}\n                            onChange={(e) => {\n                              const newValues = e.target.checked\n                                ? [...selectedValues, option]\n                                : selectedValues.filter(\n                                    (v: string) => v !== option\n                                  );\n                              handleChange(filter.field, newValues);\n                            }}\n                            className=\"rounded\"\n                          />\n                          <span className=\"text-sm\">{option}</span>\n                        </label>\n                      ))}\n                    </>\n                  )}\n                </div>\n              )}\n            </div>\n\n            <button\n              type=\"button\"\n              onClick={() =>\n                setMultiselectOpen({\n                  ...multiselectOpen,\n                  [filter.field]: !isOpen,\n                })\n              }\n              className=\"absolute right-2 top-2 text-gray-400 hover:text-gray-600\"\n            >\n              {isOpen ? '▲' : '▼'}\n            </button>\n          </div>\n        );\n      }\n\n      case 'daterange': {\n        const dateRange = value || getDateRangeDefault(filter.default as string);\n\n        return (\n          <div className=\"flex gap-2\">\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.from[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.from || ''}\n                onChange={(e) =>\n                  handleChange(filter.field, { ...dateRange, from: e.target.value })\n                }\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.to[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.to || ''}\n                onChange={(e) =>\n                  handleChange(filter.field, { ...dateRange, to: e.target.value })\n                }\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n          </div>\n        );\n      }\n\n      default:\n        return null;\n    }\n  };\n\n  const activeFiltersCount = Object.values(localValues).filter(\n    (v) =>\n      v !== null &&\n      v !== undefined &&\n      v !== '' &&\n      !(typeof v === 'object' && Object.keys(v).length === 0)\n  ).length;\n\n  return (\n    <div className=\"bg-white/80 backdrop-blur-sm rounded-xl shadow-sm border border-gray-100 p-4 mb-4\">\n      <div className=\"flex items-center justify-between mb-3\">\n        <div className=\"flex items-center gap-2\">\n          <span className=\"inline-flex items-center justify-center w-8 h-8 rounded-full bg-sky-100 text-sky-700 shadow-sm\">\n            <Filter className=\"w-4 h-4\" />\n          </span>\n          <h3 className=\"text-base font-semibold text-gray-900\">\n            {TEXTS_FILTERS.filters[currentLang]}\n          </h3>\n          {activeFiltersCount > 0 && (\n            <span className=\"px-2 py-1 bg-sky-100 text-sky-800 text-xs font-medium rounded-full\">\n              {activeFiltersCount}\n            </span>\n          )}\n        </div>\n        <button\n          onClick={() => setShowFilters(!showFilters)}\n          className=\"text-sky-600 hover:text-sky-700 text-sm font-medium\"\n        >\n          {showFilters\n            ? TEXTS_FILTERS.hide[currentLang]\n            : TEXTS_FILTERS.show[currentLang]}\n        </button>\n      </div>\n\n      {showFilters && (\n        <>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4\">\n            {filters.map((filter) => {\n              const label = translateFilterLabel(filter.label, currentLang);\n              return (\n                <div key={filter.field}>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    {label}\n                  </label>\n                  {renderFilter(filter)}\n                </div>\n              );\n            })}\n          </div>\n\n          <div className=\"flex gap-2 pt-4 border-t border-dashed border-slate-200\">\n            <button\n              onClick={handleApply}\n              className=\"px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 font-medium shadow-sm transition\"\n            >\n              {TEXTS_FILTERS.applyFilters[currentLang]}\n            </button>\n            <button\n              onClick={handleReset}\n              className=\"px-4 py-2 border border-gray-200 text-gray-700 bg-white rounded-md hover:bg-gray-50 font-medium flex items-center gap-2\"\n            >\n              <X className=\"w-4 h-4\" />\n              {TEXTS_FILTERS.reset[currentLang]}\n            </button>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v11",
        "timestamp": "2025-11-09T06:24:36.553Z",
        "note": "Modifica multipla 09/11/2025, 07:24:36",
        "code": "'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { ReportFilter } from '@/types/report';\nimport { Filter, X } from 'lucide-react';\n\nconst FILTER_LABELS: Record<\n  string,\n  {\n    it: string;\n    en: string;\n    de: string;\n    fr: string;\n    es: string;\n    pt: string;\n  }\n> = {\n  'data ordine': {\n    it: 'Data Ordine',\n    en: 'Order Date',\n    de: 'Bestelldatum',\n    fr: 'Date commande',\n    es: 'Fecha pedido',\n    pt: 'Data pedido',\n  },\n  'numero documento': {\n    it: 'Numero documento',\n    en: 'Document number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro document',\n    es: 'Número documento',\n    pt: 'Número documento',\n  },\n  'codice articolo': {\n    it: 'Codice articolo',\n    en: 'Item code',\n    de: 'Artikelcode',\n    fr: 'Code article',\n    es: 'Código artículo',\n    pt: 'Código artigo',\n  },\n  'cliente': {\n    it: 'Cliente',\n    en: 'Customer',\n    de: 'Kunde',\n    fr: 'Client',\n    es: 'Cliente',\n    pt: 'Cliente',\n  },\n  'articolo': {\n    it: 'Articolo',\n    en: 'Item',\n    de: 'Artikel',\n    fr: 'Article',\n    es: 'Artículo',\n    pt: 'Artigo',\n  },\n  'agente': {\n    it: 'Agente',\n    en: 'Agent',\n    de: 'Vertreter',\n    fr: 'Agent',\n    es: 'Agente',\n    pt: 'Agente',\n  },\n  'anno': {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  'tipo documento': {\n    it: 'Tipo documento',\n    en: 'Document type',\n    de: 'Dokumentenart',\n    fr: 'Type de document',\n    es: 'Tipo de documento',\n    pt: 'Tipo de documento',\n  },\n  'stato': {\n    it: 'Stato',\n    en: 'Status',\n    de: 'Status',\n    fr: 'Statut',\n    es: 'Estado',\n    pt: 'Estado',\n  },\n  'magazzino': {\n    it: 'Magazzino',\n    en: 'Warehouse',\n    de: 'Lager',\n    fr: 'Entrepôt',\n    es: 'Almacén',\n    pt: 'Armazém',\n  },\n  'causale': {\n    it: 'Causale',\n    en: 'Reason',\n    de: 'Grund',\n    fr: 'Causal',\n    es: 'Causal',\n    pt: 'Causal',\n  },\n};\n\nconst TEXTS_FILTERS = {\n  filters: {\n    it: 'Filtri',\n    en: 'Filters',\n    de: 'Filter',\n    fr: 'Filtres',\n    es: 'Filtros',\n    pt: 'Filtros',\n  },\n  show: {\n    it: 'Mostra',\n    en: 'Show',\n    de: 'Anzeigen',\n    fr: 'Afficher',\n    es: 'Mostrar',\n    pt: 'Mostrar',\n  },\n  hide: {\n    it: 'Nascondi',\n    en: 'Hide',\n    de: 'Verbergen',\n    fr: 'Masquer',\n    es: 'Ocultar',\n    pt: 'Ocultar',\n  },\n  applyFilters: {\n    it: 'Applica filtri',\n    en: 'Apply filters',\n    de: 'Filter anwenden',\n    fr: 'Appliquer les filtres',\n    es: 'Aplicar filtros',\n    pt: 'Aplicar filtros',\n  },\n  reset: {\n    it: 'Reset',\n    en: 'Reset',\n    de: 'Zurücksetzen',\n    fr: 'Réinitialiser',\n    es: 'Restablecer',\n    pt: 'Redefinir',\n  },\n  all: {\n    it: 'Tutti',\n    en: 'All',\n    de: 'Alle',\n    fr: 'Tous',\n    es: 'Todos',\n    pt: 'Todos',\n  },\n  search: {\n    it: 'Cerca...',\n    en: 'Search...',\n    de: 'Suchen...',\n    fr: 'Rechercher...',\n    es: 'Buscar...',\n    pt: 'Pesquisar...',\n  },\n  selected: {\n    it: 'selezionati',\n    en: 'selected',\n    de: 'ausgewählt',\n    fr: 'sélectionnés',\n    es: 'seleccionados',\n    pt: 'selecionados',\n  },\n  noOptionsFound: {\n    it: 'Nessuna opzione trovata',\n    en: 'No options found',\n    de: 'Keine Optionen gefunden',\n    fr: 'Aucune option trouvée',\n    es: 'No se encontraron opciones',\n    pt: 'Nenhuma opção encontrada',\n  },\n  selectAll: {\n    it: 'Seleziona tutti',\n    en: 'Select all',\n    de: 'Alle auswählen',\n    fr: 'Tout sélectionner',\n    es: 'Seleccionar todo',\n    pt: 'Selecionar tudo',\n  },\n  from: {\n    it: 'Da',\n    en: 'From',\n    de: 'Von',\n    fr: 'De',\n    es: 'Desde',\n    pt: 'De',\n  },\n  to: {\n    it: 'A',\n    en: 'To',\n    de: 'Bis',\n    fr: 'À',\n    es: 'Hasta',\n    pt: 'Até',\n  },\n};\n\nfunction translateFilterLabel(label: string | undefined, language: string) {\n  if (!label) return '';\n  const key = label.toLowerCase().trim();\n  if (FILTER_LABELS[key]) {\n    return FILTER_LABELS[key][language as keyof (typeof FILTER_LABELS)[string]];\n  }\n  return label;\n}\n\ninterface ReportFiltersProps {\n  filters: ReportFilter[];\n  values: Record<string, any>;\n  onChange: (values: Record<string, any>) => void;\n  onApply: () => void;\n  autoOptions?: Record<string, string[]>;\n  rawData?: any[];\n  language?: string;\n}\n\nexport default function ReportFilters({\n  filters,\n  values,\n  onChange,\n  onApply,\n  autoOptions = {},\n  rawData = [],\n  language = 'it',\n}: ReportFiltersProps) {\n  const currentLang = language || 'it';\n\n  const [showFilters, setShowFilters] = useState(false);\n  const [localValues, setLocalValues] = useState(values);\n  const [autocompleteOpen, setAutocompleteOpen] = useState<string | null>(null);\n  const autocompleteRef = useRef<HTMLDivElement>(null);\n\n  const [multiselectSearch, setMultiselectSearch] = useState<Record<string, string>>({});\n  const [multiselectOpen, setMultiselectOpen] = useState<Record<string, boolean>>({});\n\n  useEffect(() => {\n    setLocalValues(values);\n  }, [values]);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (\n        autocompleteRef.current &&\n        !autocompleteRef.current.contains(event.target as Node)\n      ) {\n        setAutocompleteOpen(null);\n        setMultiselectOpen({});\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  const handleChange = (field: string, value: any) => {\n    setLocalValues({ ...localValues, [field]: value });\n  };\n\n  const getUniqueValues = (field: string): string[] => {\n    if (!rawData || rawData.length === 0) return [];\n\n    const uniqueValues = new Set<string>();\n    rawData.forEach((row) => {\n      const value = row[field];\n      if (value != null && value !== '') {\n        uniqueValues.add(String(value));\n      }\n    });\n\n    return Array.from(uniqueValues).sort();\n  };\n\n  const getSuggestions = (field: string, inputValue: string): string[] => {\n    if (!inputValue) return getUniqueValues(field).slice(0, 10);\n\n    const uniqueValues = getUniqueValues(field);\n    return uniqueValues\n      .filter((val) => val.toLowerCase().includes(inputValue.toLowerCase()))\n      .slice(0, 10);\n  };\n\n  const handleApply = () => {\n    onChange(localValues);\n    onApply();\n    setShowFilters(false);\n  };\n\n  const handleReset = () => {\n    const resetValues: Record<string, any> = {};\n    filters.forEach((filter) => {\n      resetValues[filter.field] = filter.default || null;\n    });\n    setLocalValues(resetValues);\n    onChange(resetValues);\n    onApply();\n  };\n\n  const getDateRangeDefault = (defaultValue: string) => {\n    const today = new Date();\n    const currentYear = today.getFullYear();\n\n    switch (defaultValue) {\n      case 'current_year':\n        return {\n          from: `${currentYear}-01-01`,\n          to: `${currentYear}-12-31`,\n        };\n      case 'last_year':\n        return {\n          from: `${currentYear - 1}-01-01`,\n          to: `${currentYear - 1}-12-31`,\n        };\n      case 'last_6_months': {\n        const sixMonthsAgo = new Date(today);\n        sixMonthsAgo.setMonth(today.getMonth() - 6);\n        return {\n          from: sixMonthsAgo.toISOString().split('T')[0],\n          to: today.toISOString().split('T')[0],\n        };\n      }\n      default:\n        return { from: '', to: '' };\n    }\n  };\n\n  const renderFilter = (filter: ReportFilter) => {\n    const value = localValues[filter.field];\n    const label = translateFilterLabel(filter.label, currentLang);\n\n    switch (filter.type) {\n      case 'text': {\n        const suggestions = getSuggestions(filter.field, value || '');\n        const showAutocomplete =\n          autocompleteOpen === filter.field && suggestions.length > 0;\n\n        return (\n          <div\n            className=\"relative\"\n            ref={autocompleteOpen === filter.field ? autocompleteRef : null}\n          >\n            <input\n              type=\"text\"\n              value={value || ''}\n              onChange={(e) => handleChange(filter.field, e.target.value)}\n              onFocus={() => setAutocompleteOpen(filter.field)}\n              className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              placeholder={label}\n            />\n            {showAutocomplete && (\n              <div className=\"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                {suggestions.map((suggestion, idx) => (\n                  <button\n                    key={idx}\n                    type=\"button\"\n                    onClick={() => {\n                      handleChange(filter.field, suggestion);\n                      setAutocompleteOpen(null);\n                    }}\n                    className=\"w-full text-left px-3 py-2 hover:bg-sky-50 text-sm text-gray-700 hover:text-sky-900 border-b last:border-b-0\"\n                  >\n                    {suggestion}\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n        );\n      }\n\n      case 'select': {\n        const selectOptions =\n          filter.options === 'auto'\n            ? autoOptions[filter.field] || []\n            : filter.options || [];\n\n        return (\n          <select\n            value={value || ''}\n            onChange={(e) => handleChange(filter.field, e.target.value)}\n            className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 bg-white shadow-sm\"\n          >\n            <option value=\"\">{TEXTS_FILTERS.all[currentLang]}</option>\n            {selectOptions.map((option) => (\n              <option key={option} value={option}>\n                {option}\n              </option>\n            ))}\n          </select>\n        );\n      }\n\n      case 'multiselect': {\n        const multiOptions =\n          filter.options === 'auto'\n            ? autoOptions[filter.field] || []\n            : filter.options || [];\n\n        const selectedValues = value || [];\n        const searchTerm = multiselectSearch[filter.field] || '';\n        const isOpen = multiselectOpen[filter.field] || false;\n\n        const filteredOptions = multiOptions.filter((option) =>\n          option.toLowerCase().includes(searchTerm.toLowerCase())\n        );\n\n        return (\n          <div className=\"relative\" ref={isOpen ? autocompleteRef : null}>\n            {selectedValues.length > 0 && (\n              <div className=\"flex flex-wrap gap-1 mb-2\">\n                {selectedValues.map((val: string) => (\n                  <span\n                    key={val}\n                    className=\"inline-flex items-center gap-1 bg-sky-100 text-sky-800 text-xs px-2 py-1 rounded-full\"\n                  >\n                    {val}\n                    <button\n                      type=\"button\"\n                      onClick={() => {\n                        const newValues = selectedValues.filter(\n                          (v: string) => v !== val\n                        );\n                        handleChange(filter.field, newValues);\n                      }}\n                      className=\"text-sky-600 hover:text-sky-800\"\n                    >\n                      ×\n                    </button>\n                  </span>\n                ))}\n              </div>\n            )}\n\n            <div className=\"relative\">\n              <input\n                type=\"text\"\n                value={searchTerm}\n                onChange={(e) =>\n                  setMultiselectSearch({\n                    ...multiselectSearch,\n                    [filter.field]: e.target.value,\n                  })\n                }\n                onFocus={() =>\n                  setMultiselectOpen({\n                    ...multiselectOpen,\n                    [filter.field]: true,\n                  })\n                }\n                placeholder={`${TEXTS_FILTERS.search[currentLang]} (${\n                  selectedValues.length\n                } ${TEXTS_FILTERS.selected[currentLang]})`}\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n\n              {isOpen && (\n                <div className=\"absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                  {filteredOptions.length === 0 ? (\n                    <div className=\"px-3 py-2 text-sm text-gray-500\">\n                      {TEXTS_FILTERS.noOptionsFound[currentLang]}\n                    </div>\n                  ) : (\n                    <>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          handleChange(filter.field, filteredOptions);\n                          setMultiselectOpen({\n                            ...multiselectOpen,\n                            [filter.field]: false,\n                          });\n                        }}\n                        className=\"w-full text-left px-3 py-2 text-xs text-sky-600 hover:bg-sky-50 border-b\"\n                      >\n                        ✓ {TEXTS_FILTERS.selectAll[currentLang]} (\n                        {filteredOptions.length})\n                      </button>\n                      {filteredOptions.map((option) => (\n                        <label\n                          key={option}\n                          className=\"flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer border-b last:border-b-0\"\n                        >\n                          <input\n                            type=\"checkbox\"\n                            checked={selectedValues.includes(option)}\n                            onChange={(e) => {\n                              const newValues = e.target.checked\n                                ? [...selectedValues, option]\n                                : selectedValues.filter(\n                                    (v: string) => v !== option\n                                  );\n                              handleChange(filter.field, newValues);\n                            }}\n                            className=\"rounded\"\n                          />\n                          <span className=\"text-sm\">{option}</span>\n                        </label>\n                      ))}\n                    </>\n                  )}\n                </div>\n              )}\n            </div>\n\n            <button\n              type=\"button\"\n              onClick={() =>\n                setMultiselectOpen({\n                  ...multiselectOpen,\n                  [filter.field]: !isOpen,\n                })\n              }\n              className=\"absolute right-2 top-2 text-gray-400 hover:text-gray-600\"\n            >\n              {isOpen ? '▲' : '▼'}\n            </button>\n          </div>\n        );\n      }\n\n      case 'daterange': {\n        const dateRange = value || getDateRangeDefault(filter.default as string);\n\n        return (\n          <div className=\"flex gap-2\">\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.from[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.from || ''}\n                onChange={(e) =>\n                  handleChange(filter.field, { ...dateRange, from: e.target.value })\n                }\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.to[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.to || ''}\n                onChange={(e) =>\n                  handleChange(filter.field, { ...dateRange, to: e.target.value })\n                }\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n          </div>\n        );\n      }\n\n      default:\n        return null;\n    }\n  };\n\n  const activeFiltersCount = Object.values(localValues).filter(\n    (v) =>\n      v !== null &&\n      v !== undefined &&\n      v !== '' &&\n      !(typeof v === 'object' && Object.keys(v).length === 0)\n  ).length;\n\n  return (\n    <div className=\"bg-white/80 backdrop-blur-sm rounded-xl shadow-sm border border-gray-100 p-4 mb-4\">\n      <div className=\"flex items-center justify-between mb-3\">\n        <div className=\"flex items-center gap-2\">\n          <span className=\"inline-flex items-center justify-center w-8 h-8 rounded-full bg-sky-100 text-sky-700 shadow-sm\">\n            <Filter className=\"w-4 h-4\" />\n          </span>\n          <h3 className=\"text-base font-semibold text-gray-900\">\n            {TEXTS_FILTERS.filters[currentLang]}\n          </h3>\n          {activeFiltersCount > 0 && (\n            <span className=\"px-2 py-1 bg-sky-100 text-sky-800 text-xs font-medium rounded-full\">\n              {activeFiltersCount}\n            </span>\n          )}\n        </div>\n        <button\n          onClick={() => setShowFilters(!showFilters)}\n          className=\"text-sky-600 hover:text-sky-700 text-sm font-medium\"\n        >\n          {showFilters\n            ? TEXTS_FILTERS.hide[currentLang]\n            : TEXTS_FILTERS.show[currentLang]}\n        </button>\n      </div>\n\n      {showFilters && (\n        <>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4\">\n            {filters.map((filter) => {\n              const label = translateFilterLabel(filter.label, currentLang);\n              return (\n                <div key={filter.field}>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    {label}\n                  </label>\n                  {renderFilter(filter)}\n                </div>\n              );\n            })}\n          </div>\n\n          <div className=\"flex gap-2 pt-4 border-t border-dashed border-slate-200\">\n            <button\n              onClick={handleApply}\n              className=\"px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 font-medium shadow-sm transition\"\n            >\n              {TEXTS_FILTERS.applyFilters[currentLang]}\n            </button>\n            <button\n              onClick={handleReset}\n              className=\"px-4 py-2 border border-gray-200 text-gray-700 bg-white rounded-md hover:bg-gray-50 font-medium flex items-center gap-2\"\n            >\n              <X className=\"w-4 h-4\" />\n              {TEXTS_FILTERS.reset[currentLang]}\n            </button>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v12",
        "timestamp": "2025-11-09T06:29:32.035Z",
        "note": "Modifica multipla 09/11/2025, 07:29:31",
        "code": "'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { ReportFilter } from '@/types/report';\nimport { Filter, X } from 'lucide-react';\n\nconst FILTER_LABELS: Record<\n  string,\n  {\n    it: string;\n    en: string;\n    de: string;\n    fr: string;\n    es: string;\n    pt: string;\n  }\n> = {\n  'data ordine': {\n    it: 'Data Ordine',\n    en: 'Order Date',\n    de: 'Bestelldatum',\n    fr: 'Date commande',\n    es: 'Fecha pedido',\n    pt: 'Data pedido',\n  },\n  'numero documento': {\n    it: 'Numero documento',\n    en: 'Document number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro document',\n    es: 'Número documento',\n    pt: 'Número documento',\n  },\n  'codice articolo': {\n    it: 'Codice articolo',\n    en: 'Item code',\n    de: 'Artikelcode',\n    fr: 'Code article',\n    es: 'Código artículo',\n    pt: 'Código artigo',\n  },\n  cliente: {\n    it: 'Cliente',\n    en: 'Customer',\n    de: 'Kunde',\n    fr: 'Client',\n    es: 'Cliente',\n    pt: 'Cliente',\n  },\n  articolo: {\n    it: 'Articolo',\n    en: 'Item',\n    de: 'Artikel',\n    fr: 'Article',\n    es: 'Artículo',\n    pt: 'Artigo',\n  },\n  agente: {\n    it: 'Agente',\n    en: 'Agent',\n    de: 'Vertreter',\n    fr: 'Agent',\n    es: 'Agente',\n    pt: 'Agente',\n  },\n  anno: {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  'tipo documento': {\n    it: 'Tipo documento',\n    en: 'Document type',\n    de: 'Dokumentenart',\n    fr: 'Type de document',\n    es: 'Tipo de documento',\n    pt: 'Tipo de documento',\n  },\n  stato: {\n    it: 'Stato',\n    en: 'Status',\n    de: 'Status',\n    fr: 'Statut',\n    es: 'Estado',\n    pt: 'Estado',\n  },\n  magazzino: {\n    it: 'Magazzino',\n    en: 'Warehouse',\n    de: 'Lager',\n    fr: 'Entrepôt',\n    es: 'Almacén',\n    pt: 'Armazém',\n  },\n  causale: {\n    it: 'Causale',\n    en: 'Reason',\n    de: 'Grund',\n    fr: 'Causal',\n    es: 'Causal',\n    pt: 'Causal',\n  },\n};\n\nconst TEXTS_FILTERS = {\n  filters: {\n    it: 'Filtri',\n    en: 'Filters',\n    de: 'Filter',\n    fr: 'Filtres',\n    es: 'Filtros',\n    pt: 'Filtros',\n  },\n  show: {\n    it: 'Mostra',\n    en: 'Show',\n    de: 'Anzeigen',\n    fr: 'Afficher',\n    es: 'Mostrar',\n    pt: 'Mostrar',\n  },\n  hide: {\n    it: 'Nascondi',\n    en: 'Hide',\n    de: 'Verbergen',\n    fr: 'Masquer',\n    es: 'Ocultar',\n    pt: 'Ocultar',\n  },\n  applyFilters: {\n    it: 'Applica filtri',\n    en: 'Apply filters',\n    de: 'Filter anwenden',\n    fr: 'Appliquer les filtres',\n    es: 'Aplicar filtros',\n    pt: 'Aplicar filtros',\n  },\n  reset: {\n    it: 'Reset',\n    en: 'Reset',\n    de: 'Zurücksetzen',\n    fr: 'Réinitialiser',\n    es: 'Restablecer',\n    pt: 'Redefinir',\n  },\n  all: {\n    it: 'Tutti',\n    en: 'All',\n    de: 'Alle',\n    fr: 'Tous',\n    es: 'Todos',\n    pt: 'Todos',\n  },\n  search: {\n    it: 'Cerca...',\n    en: 'Search...',\n    de: 'Suchen...',\n    fr: 'Rechercher...',\n    es: 'Buscar...',\n    pt: 'Pesquisar...',\n  },\n  selected: {\n    it: 'selezionati',\n    en: 'selected',\n    de: 'ausgewählt',\n    fr: 'sélectionnés',\n    es: 'seleccionados',\n    pt: 'selecionados',\n  },\n  noOptionsFound: {\n    it: 'Nessuna opzione trovata',\n    en: 'No options found',\n    de: 'Keine Optionen gefunden',\n    fr: 'Aucune option trouvée',\n    es: 'No se encontraron opciones',\n    pt: 'Nenhuma opção encontrada',\n  },\n  selectAll: {\n    it: 'Seleziona tutti',\n    en: 'Select all',\n    de: 'Alle auswählen',\n    fr: 'Tout sélectionner',\n    es: 'Seleccionar todo',\n    pt: 'Selecionar tudo',\n  },\n  from: {\n    it: 'Da',\n    en: 'From',\n    de: 'Von',\n    fr: 'De',\n    es: 'Desde',\n    pt: 'De',\n  },\n  to: {\n    it: 'A',\n    en: 'To',\n    de: 'Bis',\n    fr: 'À',\n    es: 'Hasta',\n    pt: 'Até',\n  },\n};\n\nfunction translateFilterLabel(label: string | undefined, language: string) {\n  if (!label) return '';\n  const key = label.toLowerCase().trim();\n  if (FILTER_LABELS[key]) {\n    return FILTER_LABELS[key][language as keyof (typeof FILTER_LABELS)[string]];\n  }\n  return label;\n}\n\ninterface ReportFiltersProps {\n  filters: ReportFilter[];\n  values: Record<string, any>;\n  onChange: (values: Record<string, any>) => void;\n  onApply: () => void;\n  autoOptions?: Record<string, string[]>;\n  rawData?: any[];\n  language?: string;\n}\n\nexport default function ReportFilters({\n  filters,\n  values,\n  onChange,\n  onApply,\n  autoOptions = {},\n  rawData = [],\n  language = 'it',\n}: ReportFiltersProps) {\n  const currentLang = language || 'it';\n\n  const [showFilters, setShowFilters] = useState(false);\n  const [localValues, setLocalValues] = useState(values);\n  const [autocompleteOpen, setAutocompleteOpen] = useState<string | null>(null);\n  const autocompleteRef = useRef<HTMLDivElement>(null);\n\n  const [multiselectSearch, setMultiselectSearch] = useState<Record<string, string>>({});\n  const [multiselectOpen, setMultiselectOpen] = useState<Record<string, boolean>>({});\n\n  useEffect(() => {\n    setLocalValues(values);\n  }, [values]);\n\n  useEffect(() => {\n    const handleClickOutside = (event: MouseEvent) => {\n      if (\n        autocompleteRef.current &&\n        !autocompleteRef.current.contains(event.target as Node)\n      ) {\n        setAutocompleteOpen(null);\n        setMultiselectOpen({});\n      }\n    };\n\n    document.addEventListener('mousedown', handleClickOutside);\n    return () => document.removeEventListener('mousedown', handleClickOutside);\n  }, []);\n\n  const handleChange = (field: string, value: any) => {\n    setLocalValues({ ...localValues, [field]: value });\n  };\n\n  const getUniqueValues = (field: string): string[] => {\n    if (!rawData || rawData.length === 0) return [];\n\n    const uniqueValues = new Set<string>();\n    rawData.forEach((row) => {\n      const value = row[field];\n      if (value != null && value !== '') {\n        uniqueValues.add(String(value));\n      }\n    });\n\n    return Array.from(uniqueValues).sort();\n  };\n\n  const getSuggestions = (field: string, inputValue: string): string[] => {\n    if (!inputValue) return getUniqueValues(field).slice(0, 10);\n\n    const uniqueValues = getUniqueValues(field);\n    return uniqueValues\n      .filter((val) => val.toLowerCase().includes(inputValue.toLowerCase()))\n      .slice(0, 10);\n  };\n\n  const handleApply = () => {\n    onChange(localValues);\n    onApply();\n    setShowFilters(false);\n  };\n\n  const handleReset = () => {\n    const resetValues: Record<string, any> = {};\n    filters.forEach((filter) => {\n      resetValues[filter.field] = filter.default || null;\n    });\n    setLocalValues(resetValues);\n    onChange(resetValues);\n    onApply();\n  };\n\n  const getDateRangeDefault = (defaultValue: string) => {\n    const today = new Date();\n    const currentYear = today.getFullYear();\n\n    switch (defaultValue) {\n      case 'current_year':\n        return {\n          from: `${currentYear}-01-01`,\n          to: `${currentYear}-12-31`,\n        };\n      case 'last_year':\n        return {\n          from: `${currentYear - 1}-01-01`,\n          to: `${currentYear - 1}-12-31`,\n        };\n      case 'last_6_months': {\n        const sixMonthsAgo = new Date(today);\n        sixMonthsAgo.setMonth(today.getMonth() - 6);\n        return {\n          from: sixMonthsAgo.toISOString().split('T')[0],\n          to: today.toISOString().split('T')[0],\n        };\n      }\n      default:\n        return { from: '', to: '' };\n    }\n  };\n\n  const renderFilter = (filter: ReportFilter) => {\n    const value = localValues[filter.field];\n    const label = translateFilterLabel(filter.label, currentLang);\n\n    switch (filter.type) {\n      case 'text': {\n        const suggestions = getSuggestions(filter.field, value || '');\n        const showAutocomplete =\n          autocompleteOpen === filter.field && suggestions.length > 0;\n\n        return (\n          <div\n            className=\"relative\"\n            ref={autocompleteOpen === filter.field ? autocompleteRef : null}\n          >\n            <input\n              type=\"text\"\n              value={value || ''}\n              onChange={(e) => handleChange(filter.field, e.target.value)}\n              onFocus={() => setAutocompleteOpen(filter.field)}\n              className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              placeholder={label}\n            />\n            {showAutocomplete && (\n              <div className=\"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                {suggestions.map((suggestion, idx) => (\n                  <button\n                    key={idx}\n                    type=\"button\"\n                    onClick={() => {\n                      handleChange(filter.field, suggestion);\n                      setAutocompleteOpen(null);\n                    }}\n                    className=\"w-full text-left px-3 py-2 hover:bg-sky-50 text-sm text-gray-700 hover:text-sky-900 border-b last:border-b-0\"\n                  >\n                    {suggestion}\n                  </button>\n                ))}\n              </div>\n            )}\n          </div>\n        );\n      }\n\n      case 'select': {\n        const selectOptions =\n          filter.options === 'auto'\n            ? autoOptions[filter.field] || []\n            : filter.options || [];\n\n        return (\n          <select\n            value={value || ''}\n            onChange={(e) => handleChange(filter.field, e.target.value)}\n            className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 bg-white shadow-sm\"\n          >\n            <option value=\"\">{TEXTS_FILTERS.all[currentLang]}</option>\n            {selectOptions.map((option) => (\n              <option key={option} value={option}>\n                {option}\n              </option>\n            ))}\n          </select>\n        );\n      }\n\n      case 'multiselect': {\n        const multiOptions =\n          filter.options === 'auto'\n            ? autoOptions[filter.field] || []\n            : filter.options || [];\n\n        const selectedValues = value || [];\n        const searchTerm = multiselectSearch[filter.field] || '';\n        const isOpen = multiselectOpen[filter.field] || false;\n\n        const filteredOptions = multiOptions.filter((option) =>\n          option.toLowerCase().includes(searchTerm.toLowerCase())\n        );\n\n        return (\n          <div className=\"relative\" ref={isOpen ? autocompleteRef : null}>\n            {selectedValues.length > 0 && (\n              <div className=\"flex flex-wrap gap-1 mb-2\">\n                {selectedValues.map((val: string) => (\n                  <span\n                    key={val}\n                    className=\"inline-flex items-center gap-1 bg-sky-100 text-sky-800 text-xs px-2 py-1 rounded-full\"\n                  >\n                    {val}\n                    <button\n                      type=\"button\"\n                      onClick={() => {\n                        const newValues = selectedValues.filter(\n                          (v: string) => v !== val\n                        );\n                        handleChange(filter.field, newValues);\n                      }}\n                      className=\"text-sky-600 hover:text-sky-800\"\n                    >\n                      ×\n                    </button>\n                  </span>\n                ))}\n              </div>\n            )}\n\n            <div className=\"relative\">\n              <input\n                type=\"text\"\n                value={searchTerm}\n                onChange={(e) =>\n                  setMultiselectSearch({\n                    ...multiselectSearch,\n                    [filter.field]: e.target.value,\n                  })\n                }\n                onFocus={() =>\n                  setMultiselectOpen({\n                    ...multiselectOpen,\n                    [filter.field]: true,\n                  })\n                }\n                placeholder={`${TEXTS_FILTERS.search[currentLang]} (${\n                  selectedValues.length\n                } ${TEXTS_FILTERS.selected[currentLang]})`}\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n\n              {isOpen && (\n                <div className=\"absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto\">\n                  {filteredOptions.length === 0 ? (\n                    <div className=\"px-3 py-2 text-sm text-gray-500\">\n                      {TEXTS_FILTERS.noOptionsFound[currentLang]}\n                    </div>\n                  ) : (\n                    <>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          handleChange(filter.field, filteredOptions);\n                          setMultiselectOpen({\n                            ...multiselectOpen,\n                            [filter.field]: false,\n                          });\n                        }}\n                        className=\"w-full text-left px-3 py-2 text-xs text-sky-600 hover:bg-sky-50 border-b\"\n                      >\n                        ✓ {TEXTS_FILTERS.selectAll[currentLang]} (\n                        {filteredOptions.length})\n                      </button>\n                      {filteredOptions.map((option) => (\n                        <label\n                          key={option}\n                          className=\"flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer border-b last:border-b-0\"\n                        >\n                          <input\n                            type=\"checkbox\"\n                            checked={selectedValues.includes(option)}\n                            onChange={(e) => {\n                              const newValues = e.target.checked\n                                ? [...selectedValues, option]\n                                : selectedValues.filter(\n                                    (v: string) => v !== option\n                                  );\n                              handleChange(filter.field, newValues);\n                            }}\n                            className=\"rounded\"\n                          />\n                          <span className=\"text-sm\">{option}</span>\n                        </label>\n                      ))}\n                    </>\n                  )}\n                </div>\n              )}\n            </div>\n\n            <button\n              type=\"button\"\n              onClick={() =>\n                setMultiselectOpen({\n                  ...multiselectOpen,\n                  [filter.field]: !isOpen,\n                })\n              }\n              className=\"absolute right-2 top-2 text-gray-400 hover:text-gray-600\"\n            >\n              {isOpen ? '▲' : '▼'}\n            </button>\n          </div>\n        );\n      }\n\n      case 'daterange': {\n        const dateRange = value || getDateRangeDefault(filter.default as string);\n\n        return (\n          <div className=\"flex gap-2\">\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.from[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.from || ''}\n                onChange={(e) =>\n                  handleChange(filter.field, { ...dateRange, from: e.target.value })\n                }\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n            <div className=\"flex-1\">\n              <label className=\"block text-xs text-gray-600 mb-1\">\n                {TEXTS_FILTERS.to[currentLang]}\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.to || ''}\n                onChange={(e) =>\n                  handleChange(filter.field, { ...dateRange, to: e.target.value })\n                }\n                className=\"w-full px-3 py-2 border border-gray-200 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-400 shadow-sm\"\n              />\n            </div>\n          </div>\n        );\n      }\n\n      default:\n        return null;\n    }\n  };\n\n  const activeFiltersCount = Object.values(localValues).filter(\n    (v) =>\n      v !== null &&\n      v !== undefined &&\n      v !== '' &&\n      !(typeof v === 'object' && Object.keys(v).length === 0)\n  ).length;\n\n  return (\n    <div className=\"bg-white/80 backdrop-blur-sm rounded-xl shadow-sm border border-gray-100 p-4 mb-4\">\n      <div className=\"flex items-center justify-between mb-3\">\n        <div className=\"flex items-center gap-2\">\n          <span className=\"inline-flex items-center justify-center w-8 h-8 rounded-full bg-sky-100 text-sky-700 shadow-sm\">\n            <Filter className=\"w-4 h-4\" />\n          </span>\n          <h3 className=\"text-base font-semibold text-gray-900\">\n            {TEXTS_FILTERS.filters[currentLang]}\n          </h3>\n          {activeFiltersCount > 0 && (\n            <span className=\"px-2 py-1 bg-sky-100 text-sky-800 text-xs font-medium rounded-full\">\n              {activeFiltersCount}\n            </span>\n          )}\n        </div>\n        <button\n          onClick={() => setShowFilters(!showFilters)}\n          className=\"text-sky-600 hover:text-sky-700 text-sm font-medium\"\n        >\n          {showFilters\n            ? TEXTS_FILTERS.hide[currentLang]\n            : TEXTS_FILTERS.show[currentLang]}\n        </button>\n      </div>\n\n      {showFilters && (\n        <>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4\">\n            {filters.map((filter) => {\n              const label = translateFilterLabel(filter.label, currentLang);\n              return (\n                <div key={filter.field}>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    {label}\n                  </label>\n                  {renderFilter(filter)}\n                </div>\n              );\n            })}\n          </div>\n\n          <div className=\"flex gap-2 pt-4 border-t border-dashed border-slate-200\">\n            <button\n              onClick={handleApply}\n              className=\"px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700 font-medium shadow-sm transition\"\n            >\n              {TEXTS_FILTERS.applyFilters[currentLang]}\n            </button>\n            <button\n              onClick={handleReset}\n              className=\"px-4 py-2 border border-gray-200 text-gray-700 bg-white rounded-md hover:bg-gray-50 font-medium flex items-center gap-2\"\n            >\n              <X className=\"w-4 h-4\" />\n              {TEXTS_FILTERS.reset[currentLang]}\n            </button>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}"
      }
    ]
  },
  "ReportExport": {
    "active": "v8",
    "versions": [
      {
        "id": "v4",
        "timestamp": "2025-11-09T06:14:42.520Z",
        "note": "Modifica multipla 09/11/2025, 07:14:42",
        "code": "'use client';\n\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { FileText, Table, File } from 'lucide-react';\n\nconst TEXTS_EXPORT = {\n  exportPdfTitle: {\n    it: 'Esporta come PDF',\n    en: 'Export as PDF',\n    de: 'Als PDF exportieren',\n    fr: 'Exporter en PDF',\n    es: 'Exportar como PDF',\n    pt: 'Exportar como PDF',\n  },\n  exportExcelTitle: {\n    it: 'Esporta come Excel',\n    en: 'Export as Excel',\n    de: 'Als Excel exportieren',\n    fr: 'Exporter en Excel',\n    es: 'Exportar como Excel',\n    pt: 'Exportar como Excel',\n  },\n  exportCsvTitle: {\n    it: 'Esporta come CSV',\n    en: 'Export as CSV',\n    de: 'Als CSV exportieren',\n    fr: 'Exporter en CSV',\n    es: 'Exportar como CSV',\n    pt: 'Exportar como CSV',\n  },\n  errorCsvExport: {\n    it: \"Errore durante l'export CSV\",\n    en: 'Error during CSV export',\n    de: 'Fehler beim CSV-Export',\n    fr: \"Erreur lors de l'export CSV\",\n    es: 'Error durante la exportación CSV',\n    pt: 'Erro durante a exportação CSV',\n  },\n  errorExcelExport: {\n    it: \"Errore durante l'export Excel\",\n    en: 'Error during Excel export',\n    de: 'Fehler beim Excel-Export',\n    fr: \"Erreur lors de l'export Excel\",\n    es: 'Error durante la exportación Excel',\n    pt: 'Erro durante a exportação Excel',\n  },\n  noExportFormats: {\n    it: 'Nessun formato di export disponibile',\n    en: 'No export formats available',\n    de: 'Keine Exportformate verfügbar',\n    fr: \"Aucun format d'export disponible\",\n    es: 'No hay formatos de exportación disponibles',\n    pt: 'Nenhum formato de exportação disponível',\n  },\n};\n\ninterface ReportExportProps {\n  data: any[];\n  config: ReportConfig;\n  reportTitle: string;\n  language?: string;\n}\n\nexport default function ReportExport({\n  data,\n  config,\n  reportTitle,\n  language = 'it',\n}: ReportExportProps) {\n  const flattenGroupedData = (items: any[]): any[] => {\n    const result: any[] = [];\n\n    items.forEach((item) => {\n      if ('groupKey' in item) {\n        result.push(...flattenGroupedData(item.children));\n      } else {\n        result.push(item);\n      }\n    });\n\n    return result;\n  };\n\n  const exportToCSV = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      const headers = visibleColumns.map((col) => col.label).join(',');\n\n      const rows = flatData.map((row) =>\n        visibleColumns\n          .map((col) => {\n            const value = ReportEngine.formatValue(row[col.field], col, language);\n            return `\"${String(value).replace(/\"/g, '\"\"')}\"`;\n          })\n          .join(',')\n      );\n\n      const csv = [headers, ...rows].join('\\n');\n\n      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle\n        .replace(/\\s+/g, '_')\n        .trim()}_${new Date().toISOString().split('T')[0]}.csv`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting CSV:', error);\n      alert(\n        TEXTS_EXPORT.errorCsvExport[\n          language as keyof typeof TEXTS_EXPORT.errorCsvExport\n        ]\n      );\n    }\n  };\n\n  const exportToExcel = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      let html = '<table border=\"1\"><thead><tr>';\n\n      visibleColumns.forEach((col) => {\n        html += `<th>${col.label}</th>`;\n      });\n      html += '</tr></thead><tbody>';\n\n      flatData.forEach((row) => {\n        html += '<tr>';\n        visibleColumns.forEach((col) => {\n          const value = ReportEngine.formatValue(row[col.field], col, language);\n          html += `<td>${value}</td>`;\n        });\n        html += '</tr>';\n      });\n\n      html += '</tbody></table>';\n\n      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle\n        .replace(/\\s+/g, '_')\n        .trim()}_${new Date().toISOString().split('T')[0]}.xls`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting Excel:', error);\n      alert(\n        TEXTS_EXPORT.errorExcelExport[\n          language as keyof typeof TEXTS_EXPORT.errorExcelExport\n        ]\n      );\n    }\n  };\n\n  const exportToPDF = () => {\n    window.print();\n  };\n\n  return (\n    <div className=\"flex flex-wrap gap-2 mt-4\">\n      {config.export?.pdf && (\n        <button\n          onClick={exportToPDF}\n          className=\"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportPdfTitle[\n              language as keyof typeof TEXTS_EXPORT.exportPdfTitle\n            ]\n          }\n        >\n          <FileText className=\"w-4 h-4\" />\n          PDF\n        </button>\n      )}\n\n      {config.export?.excel && (\n        <button\n          onClick={exportToExcel}\n          className=\"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportExcelTitle[\n              language as keyof typeof TEXTS_EXPORT.exportExcelTitle\n            ]\n          }\n        >\n          <Table className=\"w-4 h-4\" />\n          Excel\n        </button>\n      )}\n\n      {config.export?.csv && (\n        <button\n          onClick={exportToCSV}\n          className=\"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportCsvTitle[\n              language as keyof typeof TEXTS_EXPORT.exportCsvTitle\n            ]\n          }\n        >\n          <File className=\"w-4 h-4\" />\n          CSV\n        </button>\n      )}\n\n      {!config.export?.pdf && !config.export?.excel && !config.export?.csv && (\n        <p className=\"text-sm text-gray-500\">\n          {\n            TEXTS_EXPORT.noExportFormats[\n              language as keyof typeof TEXTS_EXPORT.noExportFormats\n            ]\n          }\n        </p>\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v5",
        "timestamp": "2025-11-09T06:17:16.478Z",
        "note": "Modifica multipla 09/11/2025, 07:17:16",
        "code": "'use client';\n\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { FileText, Table, File } from 'lucide-react';\n\nconst TEXTS_EXPORT = {\n  exportPdfTitle: {\n    it: 'Esporta come PDF',\n    en: 'Export as PDF',\n    de: 'Als PDF exportieren',\n    fr: 'Exporter en PDF',\n    es: 'Exportar como PDF',\n    pt: 'Exportar como PDF',\n  },\n  exportExcelTitle: {\n    it: 'Esporta come Excel',\n    en: 'Export as Excel',\n    de: 'Als Excel exportieren',\n    fr: 'Exporter en Excel',\n    es: 'Exportar como Excel',\n    pt: 'Exportar como Excel',\n  },\n  exportCsvTitle: {\n    it: 'Esporta come CSV',\n    en: 'Export as CSV',\n    de: 'Als CSV exportieren',\n    fr: 'Exporter en CSV',\n    es: 'Exportar como CSV',\n    pt: 'Exportar como CSV',\n  },\n  errorCsvExport: {\n    it: \"Errore durante l'export CSV\",\n    en: 'Error during CSV export',\n    de: 'Fehler beim CSV-Export',\n    fr: \"Erreur lors de l'export CSV\",\n    es: 'Error durante la exportación CSV',\n    pt: 'Erro durante a exportação CSV',\n  },\n  errorExcelExport: {\n    it: \"Errore durante l'export Excel\",\n    en: 'Error during Excel export',\n    de: 'Fehler beim Excel-Export',\n    fr: \"Erreur lors de l'export Excel\",\n    es: 'Error durante la exportación Excel',\n    pt: 'Erro durante a exportação Excel',\n  },\n  noExportFormats: {\n    it: 'Nessun formato di export disponibile',\n    en: 'No export formats available',\n    de: 'Keine Exportformate verfügbar',\n    fr: \"Aucun format d'export disponible\",\n    es: 'No hay formatos de exportación disponibles',\n    pt: 'Nenhum formato de exportação disponível',\n  },\n};\n\ninterface ReportExportProps {\n  data: any[];\n  config: ReportConfig;\n  reportTitle: string;\n  language?: string;\n}\n\nexport default function ReportExport({\n  data,\n  config,\n  reportTitle,\n  language = 'it',\n}: ReportExportProps) {\n  const flattenGroupedData = (items: any[]): any[] => {\n    const result: any[] = [];\n\n    items.forEach((item) => {\n      if ('groupKey' in item) {\n        result.push(...flattenGroupedData(item.children));\n      } else {\n        result.push(item);\n      }\n    });\n\n    return result;\n  };\n\n  const exportToCSV = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      const headers = visibleColumns.map((col) => col.label).join(',');\n\n      const rows = flatData.map((row) =>\n        visibleColumns\n          .map((col) => {\n            const value = ReportEngine.formatValue(row[col.field], col, language);\n            return `\"${String(value).replace(/\"/g, '\"\"')}\"`;\n          })\n          .join(',')\n      );\n\n      const csv = [headers, ...rows].join('\\n');\n\n      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle\n        .replace(/\\s+/g, '_')\n        .trim()}_${new Date().toISOString().split('T')[0]}.csv`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting CSV:', error);\n      alert(\n        TEXTS_EXPORT.errorCsvExport[\n          language as keyof typeof TEXTS_EXPORT.errorCsvExport\n        ]\n      );\n    }\n  };\n\n  const exportToExcel = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      let html = '<table border=\"1\"><thead><tr>';\n\n      visibleColumns.forEach((col) => {\n        html += `<th>${col.label}</th>`;\n      });\n      html += '</tr></thead><tbody>';\n\n      flatData.forEach((row) => {\n        html += '<tr>';\n        visibleColumns.forEach((col) => {\n          const value = ReportEngine.formatValue(row[col.field], col, language);\n          html += `<td>${value}</td>`;\n        });\n        html += '</tr>';\n      });\n\n      html += '</tbody></table>';\n\n      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle\n        .replace(/\\s+/g, '_')\n        .trim()}_${new Date().toISOString().split('T')[0]}.xls`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting Excel:', error);\n      alert(\n        TEXTS_EXPORT.errorExcelExport[\n          language as keyof typeof TEXTS_EXPORT.errorExcelExport\n        ]\n      );\n    }\n  };\n\n  const exportToPDF = () => {\n    window.print();\n  };\n\n  return (\n    <div className=\"flex flex-wrap gap-2 mt-4\">\n      {config.export?.pdf && (\n        <button\n          onClick={exportToPDF}\n          className=\"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportPdfTitle[\n              language as keyof typeof TEXTS_EXPORT.exportPdfTitle\n            ]\n          }\n        >\n          <FileText className=\"w-4 h-4\" />\n          PDF\n        </button>\n      )}\n\n      {config.export?.excel && (\n        <button\n          onClick={exportToExcel}\n          className=\"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportExcelTitle[\n              language as keyof typeof TEXTS_EXPORT.exportExcelTitle\n            ]\n          }\n        >\n          <Table className=\"w-4 h-4\" />\n          Excel\n        </button>\n      )}\n\n      {config.export?.csv && (\n        <button\n          onClick={exportToCSV}\n          className=\"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportCsvTitle[\n              language as keyof typeof TEXTS_EXPORT.exportCsvTitle\n            ]\n          }\n        >\n          <File className=\"w-4 h-4\" />\n          CSV\n        </button>\n      )}\n\n      {!config.export?.pdf && !config.export?.excel && !config.export?.csv && (\n        <p className=\"text-sm text-gray-500\">\n          {\n            TEXTS_EXPORT.noExportFormats[\n              language as keyof typeof TEXTS_EXPORT.noExportFormats\n            ]\n          }\n        </p>\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v6",
        "timestamp": "2025-11-09T06:24:37.383Z",
        "note": "Modifica multipla 09/11/2025, 07:24:36",
        "code": "'use client';\n\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { FileText, Table, File } from 'lucide-react';\n\nconst TEXTS_EXPORT = {\n  exportPdfTitle: {\n    it: 'Esporta come PDF',\n    en: 'Export as PDF',\n    de: 'Als PDF exportieren',\n    fr: 'Exporter en PDF',\n    es: 'Exportar como PDF',\n    pt: 'Exportar como PDF',\n  },\n  exportExcelTitle: {\n    it: 'Esporta come Excel',\n    en: 'Export as Excel',\n    de: 'Als Excel exportieren',\n    fr: 'Exporter en Excel',\n    es: 'Exportar como Excel',\n    pt: 'Exportar como Excel',\n  },\n  exportCsvTitle: {\n    it: 'Esporta come CSV',\n    en: 'Export as CSV',\n    de: 'Als CSV exportieren',\n    fr: 'Exporter en CSV',\n    es: 'Exportar como CSV',\n    pt: 'Exportar como CSV',\n  },\n  errorCsvExport: {\n    it: \"Errore durante l'export CSV\",\n    en: 'Error during CSV export',\n    de: 'Fehler beim CSV-Export',\n    fr: \"Erreur lors de l'export CSV\",\n    es: 'Error durante la exportación CSV',\n    pt: 'Erro durante a exportação CSV',\n  },\n  errorExcelExport: {\n    it: \"Errore durante l'export Excel\",\n    en: 'Error during Excel export',\n    de: 'Fehler beim Excel-Export',\n    fr: \"Erreur lors de l'export Excel\",\n    es: 'Error durante la exportación Excel',\n    pt: 'Erro durante a exportação Excel',\n  },\n  noExportFormats: {\n    it: 'Nessun formato di export disponibile',\n    en: 'No export formats available',\n    de: 'Keine Exportformate verfügbar',\n    fr: \"Aucun format d'export disponible\",\n    es: 'No hay formatos de exportación disponibles',\n    pt: 'Nenhum formato de exportação disponível',\n  },\n  buttonPdf: {\n    it: 'PDF',\n    en: 'PDF',\n    de: 'PDF',\n    fr: 'PDF',\n    es: 'PDF',\n    pt: 'PDF',\n  },\n  buttonExcel: {\n    it: 'Excel',\n    en: 'Excel',\n    de: 'Excel',\n    fr: 'Excel',\n    es: 'Excel',\n    pt: 'Excel',\n  },\n  buttonCsv: {\n    it: 'CSV',\n    en: 'CSV',\n    de: 'CSV',\n    fr: 'CSV',\n    es: 'CSV',\n    pt: 'CSV',\n  },\n};\n\ninterface ReportExportProps {\n  data: any[];\n  config: ReportConfig;\n  reportTitle: string;\n  language?: string;\n}\n\nexport default function ReportExport({\n  data,\n  config,\n  reportTitle,\n  language = 'it',\n}: ReportExportProps) {\n  const flattenGroupedData = (items: any[]): any[] => {\n    const result: any[] = [];\n\n    items.forEach((item) => {\n      if ('groupKey' in item) {\n        result.push(...flattenGroupedData(item.children));\n      } else {\n        result.push(item);\n      }\n    });\n\n    return result;\n  };\n\n  const exportToCSV = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      const headers = visibleColumns.map((col) => col.label).join(',');\n\n      const rows = flatData.map((row) =>\n        visibleColumns\n          .map((col) => {\n            const value = ReportEngine.formatValue(row[col.field], col, language);\n            return `\"${String(value).replace(/\"/g, '\"\"')}\"`;\n          })\n          .join(',')\n      );\n\n      const csv = [headers, ...rows].join('\\n');\n\n      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle\n        .replace(/\\s+/g, '_')\n        .trim()}_${new Date().toISOString().split('T')[0]}.csv`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting CSV:', error);\n      alert(\n        TEXTS_EXPORT.errorCsvExport[\n          language as keyof typeof TEXTS_EXPORT.errorCsvExport\n        ]\n      );\n    }\n  };\n\n  const exportToExcel = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      let html = '<table border=\"1\"><thead><tr>';\n\n      visibleColumns.forEach((col) => {\n        html += `<th>${col.label}</th>`;\n      });\n      html += '</tr></thead><tbody>';\n\n      flatData.forEach((row) => {\n        html += '<tr>';\n        visibleColumns.forEach((col) => {\n          const value = ReportEngine.formatValue(row[col.field], col, language);\n          html += `<td>${value}</td>`;\n        });\n        html += '</tr>';\n      });\n\n      html += '</tbody></table>';\n\n      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle\n        .replace(/\\s+/g, '_')\n        .trim()}_${new Date().toISOString().split('T')[0]}.xls`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting Excel:', error);\n      alert(\n        TEXTS_EXPORT.errorExcelExport[\n          language as keyof typeof TEXTS_EXPORT.errorExcelExport\n        ]\n      );\n    }\n  };\n\n  const exportToPDF = () => {\n    window.print();\n  };\n\n  return (\n    <div className=\"flex flex-wrap gap-2 mt-4\">\n      {config.export?.pdf && (\n        <button\n          onClick={exportToPDF}\n          className=\"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportPdfTitle[\n              language as keyof typeof TEXTS_EXPORT.exportPdfTitle\n            ]\n          }\n        >\n          <FileText className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonPdf[language as keyof typeof TEXTS_EXPORT.buttonPdf]}\n        </button>\n      )}\n\n      {config.export?.excel && (\n        <button\n          onClick={exportToExcel}\n          className=\"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportExcelTitle[\n              language as keyof typeof TEXTS_EXPORT.exportExcelTitle\n            ]\n          }\n        >\n          <Table className=\"w-4 h-4\" />\n          {\n            TEXTS_EXPORT.buttonExcel[\n              language as keyof typeof TEXTS_EXPORT.buttonExcel\n            ]\n          }\n        </button>\n      )}\n\n      {config.export?.csv && (\n        <button\n          onClick={exportToCSV}\n          className=\"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportCsvTitle[\n              language as keyof typeof TEXTS_EXPORT.exportCsvTitle\n            ]\n          }\n        >\n          <File className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonCsv[language as keyof typeof TEXTS_EXPORT.buttonCsv]}\n        </button>\n      )}\n\n      {!config.export?.pdf && !config.export?.excel && !config.export?.csv && (\n        <p className=\"text-sm text-gray-500\">\n          {\n            TEXTS_EXPORT.noExportFormats[\n              language as keyof typeof TEXTS_EXPORT.noExportFormats\n            ]\n          }\n        </p>\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v7",
        "timestamp": "2025-11-09T06:29:32.920Z",
        "note": "Modifica multipla 09/11/2025, 07:29:32",
        "code": "'use client';\n\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { FileText, Table, File } from 'lucide-react';\n\nconst TEXTS_EXPORT = {\n  exportPdfTitle: {\n    it: 'Esporta come PDF',\n    en: 'Export as PDF',\n    de: 'Als PDF exportieren',\n    fr: 'Exporter en PDF',\n    es: 'Exportar como PDF',\n    pt: 'Exportar como PDF',\n  },\n  exportExcelTitle: {\n    it: 'Esporta come Excel',\n    en: 'Export as Excel',\n    de: 'Als Excel exportieren',\n    fr: 'Exporter en Excel',\n    es: 'Exportar como Excel',\n    pt: 'Exportar como Excel',\n  },\n  exportCsvTitle: {\n    it: 'Esporta come CSV',\n    en: 'Export as CSV',\n    de: 'Als CSV exportieren',\n    fr: 'Exporter en CSV',\n    es: 'Exportar como CSV',\n    pt: 'Exportar como CSV',\n  },\n  errorCsvExport: {\n    it: \"Errore durante l'export CSV\",\n    en: 'Error during CSV export',\n    de: 'Fehler beim CSV-Export',\n    fr: \"Erreur lors de l'export CSV\",\n    es: 'Error durante la exportación CSV',\n    pt: 'Erro durante a exportação CSV',\n  },\n  errorExcelExport: {\n    it: \"Errore durante l'export Excel\",\n    en: 'Error during Excel export',\n    de: 'Fehler beim Excel-Export',\n    fr: \"Erreur lors de l'export Excel\",\n    es: 'Error durante la exportación Excel',\n    pt: 'Erro durante a exportação Excel',\n  },\n  noExportFormats: {\n    it: 'Nessun formato di export disponibile',\n    en: 'No export formats available',\n    de: 'Keine Exportformate verfügbar',\n    fr: \"Aucun format d'export disponible\",\n    es: 'No hay formatos de exportación disponibles',\n    pt: 'Nenhum formato de exportação disponível',\n  },\n  buttonPdf: {\n    it: 'PDF',\n    en: 'PDF',\n    de: 'PDF',\n    fr: 'PDF',\n    es: 'PDF',\n    pt: 'PDF',\n  },\n  buttonExcel: {\n    it: 'Excel',\n    en: 'Excel',\n    de: 'Excel',\n    fr: 'Excel',\n    es: 'Excel',\n    pt: 'Excel',\n  },\n  buttonCsv: {\n    it: 'CSV',\n    en: 'CSV',\n    de: 'CSV',\n    fr: 'CSV',\n    es: 'CSV',\n    pt: 'CSV',\n  },\n};\n\ninterface ReportExportProps {\n  data: any[];\n  config: ReportConfig;\n  reportTitle: string;\n  language?: string;\n}\n\nexport default function ReportExport({\n  data,\n  config,\n  reportTitle,\n  language = 'it',\n}: ReportExportProps) {\n  const flattenGroupedData = (items: any[]): any[] => {\n    const result: any[] = [];\n\n    items.forEach((item) => {\n      if ('groupKey' in item) {\n        result.push(...flattenGroupedData(item.children));\n      } else {\n        result.push(item);\n      }\n    });\n\n    return result;\n  };\n\n  const exportToCSV = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      const headers = visibleColumns.map((col) => col.label).join(',');\n\n      const rows = flatData.map((row) =>\n        visibleColumns\n          .map((col) => {\n            const value = ReportEngine.formatValue(row[col.field], col, language);\n            return `\"${String(value).replace(/\"/g, '\"\"')}\"`;\n          })\n          .join(',')\n      );\n\n      const csv = [headers, ...rows].join('\\n');\n\n      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle\n        .replace(/\\s+/g, '_')\n        .trim()}_${new Date().toISOString().split('T')[0]}.csv`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting CSV:', error);\n      alert(\n        TEXTS_EXPORT.errorCsvExport[\n          language as keyof typeof TEXTS_EXPORT.errorCsvExport\n        ]\n      );\n    }\n  };\n\n  const exportToExcel = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      let html = '<table border=\"1\"><thead><tr>';\n\n      visibleColumns.forEach((col) => {\n        html += `<th>${col.label}</th>`;\n      });\n      html += '</tr></thead><tbody>';\n\n      flatData.forEach((row) => {\n        html += '<tr>';\n        visibleColumns.forEach((col) => {\n          const value = ReportEngine.formatValue(row[col.field], col, language);\n          html += `<td>${value}</td>`;\n        });\n        html += '</tr>';\n      });\n\n      html += '</tbody></table>';\n\n      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle\n        .replace(/\\s+/g, '_')\n        .trim()}_${new Date().toISOString().split('T')[0]}.xls`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting Excel:', error);\n      alert(\n        TEXTS_EXPORT.errorExcelExport[\n          language as keyof typeof TEXTS_EXPORT.errorExcelExport\n        ]\n      );\n    }\n  };\n\n  const exportToPDF = () => {\n    window.print();\n  };\n\n  return (\n    <div className=\"flex flex-wrap gap-2 mt-4\">\n      {config.export?.pdf && (\n        <button\n          onClick={exportToPDF}\n          className=\"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportPdfTitle[\n              language as keyof typeof TEXTS_EXPORT.exportPdfTitle\n            ]\n          }\n        >\n          <FileText className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonPdf[language as keyof typeof TEXTS_EXPORT.buttonPdf]}\n        </button>\n      )}\n\n      {config.export?.excel && (\n        <button\n          onClick={exportToExcel}\n          className=\"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportExcelTitle[\n              language as keyof typeof TEXTS_EXPORT.exportExcelTitle\n            ]\n          }\n        >\n          <Table className=\"w-4 h-4\" />\n          {\n            TEXTS_EXPORT.buttonExcel[\n              language as keyof typeof TEXTS_EXPORT.buttonExcel\n            ]\n          }\n        </button>\n      )}\n\n      {config.export?.csv && (\n        <button\n          onClick={exportToCSV}\n          className=\"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportCsvTitle[\n              language as keyof typeof TEXTS_EXPORT.exportCsvTitle\n            ]\n          }\n        >\n          <File className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonCsv[language as keyof typeof TEXTS_EXPORT.buttonCsv]}\n        </button>\n      )}\n\n      {!config.export?.pdf && !config.export?.excel && !config.export?.csv && (\n        <p className=\"text-sm text-gray-500\">\n          {\n            TEXTS_EXPORT.noExportFormats[\n              language as keyof typeof TEXTS_EXPORT.noExportFormats\n            ]\n          }\n        </p>\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v8",
        "timestamp": "2025-11-09T07:28:03.605Z",
        "note": "Modifica multipla 09/11/2025, 08:28:03",
        "code": "'use client';\n\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport { FileText, Table, File } from 'lucide-react';\n\nconst TEXTS_EXPORT = {\n  exportPdfTitle: {\n    it: 'Esporta come PDF',\n    en: 'Export as PDF',\n    de: 'Als PDF exportieren',\n    fr: 'Exporter en PDF',\n    es: 'Exportar como PDF',\n    pt: 'Exportar como PDF',\n  },\n  exportExcelTitle: {\n    it: 'Esporta come Excel',\n    en: 'Export as Excel',\n    de: 'Als Excel exportieren',\n    fr: 'Exporter en Excel',\n    es: 'Exportar como Excel',\n    pt: 'Exportar como Excel',\n  },\n  exportCsvTitle: {\n    it: 'Esporta come CSV',\n    en: 'Export as CSV',\n    de: 'Als CSV exportieren',\n    fr: 'Exporter en CSV',\n    es: 'Exportar como CSV',\n    pt: 'Exportar como CSV',\n  },\n  errorCsvExport: {\n    it: \"Errore durante l'export CSV\",\n    en: 'Error during CSV export',\n    de: 'Fehler beim CSV-Export',\n    fr: \"Erreur lors de l'export CSV\",\n    es: 'Error durante la exportación CSV',\n    pt: 'Erro durante a exportação CSV',\n  },\n  errorExcelExport: {\n    it: \"Errore durante l'export Excel\",\n    en: 'Error during Excel export',\n    de: 'Fehler beim Excel-Export',\n    fr: \"Erreur lors de l'export Excel\",\n    es: 'Error durante la exportación Excel',\n    pt: 'Erro durante a exportação Excel',\n  },\n  noExportFormats: {\n    it: 'Nessun formato di export disponibile',\n    en: 'No export formats available',\n    de: 'Keine Exportformate verfügbar',\n    fr: \"Aucun format d'export disponible\",\n    es: 'No hay formatos de exportación disponibles',\n    pt: 'Nenhum formato de exportação disponível',\n  },\n  buttonPdf: {\n    it: 'PDF',\n    en: 'PDF',\n    de: 'PDF',\n    fr: 'PDF',\n    es: 'PDF',\n    pt: 'PDF',\n  },\n  buttonExcel: {\n    it: 'Excel',\n    en: 'Excel',\n    de: 'Excel',\n    fr: 'Excel',\n    es: 'Excel',\n    pt: 'Excel',\n  },\n  buttonCsv: {\n    it: 'CSV',\n    en: 'CSV',\n    de: 'CSV',\n    fr: 'CSV',\n    es: 'CSV',\n    pt: 'CSV',\n  },\n};\n\nfunction getExportColumnLabel(field: string, language: string): string {\n  const key = `column_${field.replace(/`/g, '').replace(/\\s+/g, '_').toLowerCase()}`;\n  const colObj = (TEXTS.columns as any)[key];\n  if (colObj) {\n    return colObj[language] || colObj.it;\n  }\n  return field;\n}\n\ninterface ReportExportProps {\n  data: any[];\n  config: ReportConfig;\n  reportTitle: string;\n  language?: string;\n}\n\nexport function ReportExport({ data, config, reportTitle, language = 'it' }: ReportExportProps) {\n  const flattenGroupedData = (items: any[]): any[] => {\n    const result: any[] = [];\n\n    items.forEach((item) => {\n      if ('groupKey' in item) {\n        result.push(...flattenGroupedData(item.children));\n      } else {\n        result.push(item);\n      }\n    });\n\n    return result;\n  };\n\n  const exportToCSV = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      const headers = visibleColumns\n        .map((col) => getExportColumnLabel(col.field, language))\n        .join(',');\n\n      const rows = flatData.map((row) =>\n        visibleColumns\n          .map((col) => {\n            const value = ReportEngine.formatValue(row[col.field], col, language);\n            return `\"${String(value).replace(/\"/g, '\"\"')}\"`;\n          })\n          .join(',')\n      );\n\n      const csv = [headers, ...rows].join('\\n');\n\n      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle.replace(/\\s+/g, '_').trim()}_${\n        new Date().toISOString().split('T')[0]\n      }.csv`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting CSV:', error);\n      alert(TEXTS_EXPORT.errorCsvExport[language as keyof typeof TEXTS_EXPORT.errorCsvExport]);\n    }\n  };\n\n  const exportToExcel = () => {\n    try {\n      const flatData = flattenGroupedData(data);\n      const visibleColumns = config.columns.filter((col) => col.visible);\n\n      let html = '<table border=\"1\"><thead><tr>';\n\n      visibleColumns.forEach((col) => {\n        html += `<th>${getExportColumnLabel(col.field, language)}</th>`;\n      });\n      html += '</tr></thead><tbody>';\n\n      flatData.forEach((row) => {\n        html += '<tr>';\n        visibleColumns.forEach((col) => {\n          const value = ReportEngine.formatValue(row[col.field], col, language);\n          html += `<td>${value}</td>`;\n        });\n        html += '</tr>';\n      });\n\n      html += '</tbody></table>';\n\n      const blob = new Blob([html], { type: 'application/vnd.ms-excel' });\n      const link = document.createElement('a');\n      link.href = URL.createObjectURL(blob);\n      link.download = `${reportTitle.replace(/\\s+/g, '_').trim()}_${\n        new Date().toISOString().split('T')[0]\n      }.xls`;\n      link.click();\n    } catch (error) {\n      console.error('Error exporting Excel:', error);\n      alert(TEXTS_EXPORT.errorExcelExport[language as keyof typeof TEXTS_EXPORT.errorExcelExport]);\n    }\n  };\n\n  const exportToPDF = () => {\n    window.print();\n  };\n\n  return (\n    <div className=\"flex flex-wrap gap-2 mt-4\">\n      {config.export?.pdf && (\n        <button\n          onClick={exportToPDF}\n          className=\"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={TEXTS_EXPORT.exportPdfTitle[language as keyof typeof TEXTS_EXPORT.exportPdfTitle]}\n        >\n          <FileText className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonPdf[language as keyof typeof TEXTS_EXPORT.buttonPdf]}\n        </button>\n      )}\n\n      {config.export?.excel && (\n        <button\n          onClick={exportToExcel}\n          className=\"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={\n            TEXTS_EXPORT.exportExcelTitle[language as keyof typeof TEXTS_EXPORT.exportExcelTitle]\n          }\n        >\n          <Table className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonExcel[language as keyof typeof TEXTS_EXPORT.buttonExcel]}\n        </button>\n      )}\n\n      {config.export?.csv && (\n        <button\n          onClick={exportToCSV}\n          className=\"px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 flex items-center gap-2 text-sm font-medium shadow-sm\"\n          title={TEXTS_EXPORT.exportCsvTitle[language as keyof typeof TEXTS_EXPORT.exportCsvTitle]}\n        >\n          <File className=\"w-4 h-4\" />\n          {TEXTS_EXPORT.buttonCsv[language as keyof typeof TEXTS_EXPORT.buttonCsv]}\n        </button>\n      )}\n\n      {!config.export?.pdf && !config.export?.excel && !config.export?.csv && (\n        <p className=\"text-sm text-gray-500\">\n          {TEXTS_EXPORT.noExportFormats[language as keyof typeof TEXTS_EXPORT.noExportFormats]}\n        </p>\n      )}\n    </div>\n  );\n}"
      }
    ]
  },
  "ReportBuilder": {
    "active": "v7",
    "versions": [
      {
        "id": "v3",
        "timestamp": "2025-11-09T06:14:43.359Z",
        "note": "Modifica multipla 09/11/2025, 07:14:42",
        "code": "'use client';\n\nimport { useState, useEffect } from 'react';\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport {\n  executeQuery,\n  getDocumentTypes,\n  getDocumentYears,\n} from '@/lib/mysql-query';\nimport ReportTable from './ReportTable';\nimport ReportFilters from './ReportFilters';\nimport ReportExport from './ReportExport';\nimport { Loader2 } from 'lucide-react';\n\nconst TEXTS_BUILDER = {\n  errorTitle: {\n    it: 'Errore',\n    en: 'Error',\n    de: 'Fehler',\n    fr: 'Erreur',\n    es: 'Error',\n    pt: 'Erro',\n  },\n  loadingData: {\n    it: 'Caricamento dati...',\n    en: 'Loading data...',\n    de: 'Daten werden geladen...',\n    fr: 'Chargement des données...',\n    es: 'Cargando datos...',\n    pt: 'Carregando dados...',\n  },\n  noData: {\n    it: 'Nessun dato disponibile',\n    en: 'No data available',\n    de: 'Keine Daten verfügbar',\n    fr: 'Aucune donnée disponible',\n    es: 'No hay datos disponibles',\n    pt: 'Nenhum dado disponível',\n  },\n  noDataDescription: {\n    it: 'Non ci sono dati per il cliente selezionato con i filtri applicati.',\n    en: 'There is no data for the selected customer with the applied filters.',\n    de: 'Es sind keine Daten für den ausgewählten Kunden mit den angewendeten Filtern vorhanden.',\n    fr: 'Aucune donnée pour le client sélectionné avec les filtres appliqués.',\n    es: 'No hay datos para el cliente seleccionado con los filtros aplicados.',\n    pt: 'Não há dados para o cliente selecionado com os filtros aplicados.',\n  },\n  activeFilters: {\n    it: 'Filtri attivi:',\n    en: 'Active filters:',\n    de: 'Aktive Filter:',\n    fr: 'Filtres actifs :',\n    es: 'Filtros activos:',\n    pt: 'Filtros ativos:',\n  },\n  removeAll: {\n    it: 'Rimuovi tutti',\n    en: 'Remove all',\n    de: 'Alle entfernen',\n    fr: 'Tout supprimer',\n    es: 'Eliminar todos',\n    pt: 'Remover todos',\n  },\n  debugTitle: {\n    it: 'Debug: Query SQL eseguita',\n    en: 'Debug: Executed SQL query',\n    de: 'Debug: Ausgeführte SQL-Abfrage',\n    fr: 'Debug : Requête SQL exécutée',\n    es: 'Debug: Consulta SQL ejecutada',\n    pt: 'Debug: Consulta SQL executada',\n  },\n  debugSql: {\n    it: 'Query SQL:',\n    en: 'SQL query:',\n    de: 'SQL-Abfrage:',\n    fr: 'Requête SQL :',\n    es: 'Consulta SQL:',\n    pt: 'Consulta SQL:',\n  },\n  debugParams: {\n    it: 'Parametri:',\n    en: 'Parameters:',\n    de: 'Parameter:',\n    fr: 'Paramètres :',\n    es: 'Parámetros:',\n    pt: 'Parâmetros:',\n  },\n  debugBind: {\n    it: 'Bind Types:',\n    en: 'Bind Types:',\n    de: 'Bindetypen:',\n    fr: 'Types de liaison :',\n    es: 'Tipos de enlace:',\n    pt: 'Tipos de ligação:',\n  },\n  languageLabel: {\n    it: 'Lingua',\n    en: 'Language',\n    de: 'Sprache',\n    fr: 'Langue',\n    es: 'Idioma',\n    pt: 'Idioma',\n  },\n};\n\nconst LANGUAGES = [\n  { code: 'it', label: 'Italiano', flag: '🇮🇹' },\n  { code: 'en', label: 'English', flag: '🇬🇧' },\n  { code: 'de', label: 'Deutsch', flag: '🇩🇪' },\n  { code: 'fr', label: 'Français', flag: '🇫🇷' },\n  { code: 'es', label: 'Español', flag: '🇪🇸' },\n  { code: 'pt', label: 'Português', flag: '🇵🇹' },\n];\n\nfunction translateDynamic(label: string | undefined, language: string) {\n  if (!label) return '';\n  const key = label.toLowerCase().trim();\n  if (FILTER_LABELS[key as keyof typeof FILTER_LABELS]) {\n    return FILTER_LABELS[key as keyof typeof FILTER_LABELS][\n      language as keyof (typeof FILTER_LABELS)[string]\n    ];\n  }\n  if (COLUMN_LABELS[key as keyof typeof COLUMN_LABELS]) {\n    return COLUMN_LABELS[key as keyof typeof COLUMN_LABELS][\n      language as keyof (typeof COLUMN_LABELS)[string]\n    ];\n  }\n  return label;\n}\n\ninterface ReportBuilderProps {\n  reportSlug: string;\n  clientCode: string;\n  language?: string;\n}\n\nexport default function ReportBuilder({\n  reportSlug,\n  clientCode,\n  language: initialLanguage = 'it',\n}: ReportBuilderProps) {\n  const [config, setConfig] = useState<ReportConfig | null>(null);\n  const [rawData, setRawData] = useState<any[]>([]);\n  const [processedData, setProcessedData] = useState<any[]>([]);\n  const [aggregates, setAggregates] = useState<Record<string, any>>({});\n  const [filters, setFilters] = useState<Record<string, any>>({});\n  const [autoOptions, setAutoOptions] = useState<Record<string, string[]>>({});\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [debugInfo, setDebugInfo] = useState<any>(null);\n  const [currentLanguage, setCurrentLanguage] = useState(initialLanguage);\n\n  useEffect(() => {\n    async function loadConfig() {\n      try {\n        const response = await fetch(`/api/reports/config?slug=${reportSlug}`);\n\n        if (!response.ok) {\n          throw new Error(`Report configuration not found: ${reportSlug}`);\n        }\n\n        const data = await response.json();\n        setConfig(data.config);\n      } catch (err: any) {\n        console.error('Error loading report config:', err);\n        setError(err.message || 'Failed to load report configuration');\n      }\n    }\n\n    loadConfig();\n  }, [reportSlug]);\n\n  useEffect(() => {\n    if (!config || !clientCode) return;\n\n    async function loadData(reportConfig: ReportConfig) {\n      try {\n        setLoading(true);\n        setError(null);\n\n        const queryParams: Record<string, any> = {};\n        queryParams.clientCode = clientCode;\n\n        const result = await executeQuery(reportConfig.query, queryParams);\n\n        setRawData(result.data || []);\n\n        if (result.debug) {\n          setDebugInfo(result.debug);\n        }\n\n        const options: Record<string, string[]> = {};\n\n        for (const filter of reportConfig.filters || []) {\n          if (filter.options === 'auto') {\n            if (filter.field === 'tipo_documento') {\n              options[filter.field] = await getDocumentTypes(clientCode);\n            } else if (filter.field === 'anno') {\n              const years = await getDocumentYears(clientCode);\n              options[filter.field] = years.map(String);\n            } else {\n              const uniqueValues = new Set<string>();\n              result.data.forEach((row: any) => {\n                const value = row[filter.field];\n                if (value != null && value !== '') {\n                  uniqueValues.add(String(value));\n                }\n              });\n              options[filter.field] = Array.from(uniqueValues).sort();\n            }\n          }\n        }\n\n        setAutoOptions(options);\n      } catch (err: any) {\n        console.error('Error loading data:', err);\n        setError(err.message || 'Failed to load data');\n      } finally {\n        setLoading(false);\n      }\n    }\n\n    loadData(config);\n  }, [config, clientCode]);\n\n  useEffect(() => {\n    if (!config || rawData.length === 0) {\n      setProcessedData([]);\n      setAggregates({});\n      return;\n    }\n\n    const result = ReportEngine.processReport(rawData, config, filters);\n    setProcessedData(result.data);\n    setAggregates(result.aggregates);\n  }, [rawData, config, filters]);\n\n  const handleFiltersChange = (newFilters: Record<string, any>) => {\n    setFilters(newFilters);\n  };\n\n  const handleApplyFilters = () => {};\n\n  if (loading && !config) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-sky-600\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n        <p className=\"text-red-800 font-medium\">\n          {TEXTS_BUILDER.errorTitle[currentLanguage]}\n        </p>\n        <p className=\"text-red-600 text-sm mt-1\">{error}</p>\n      </div>\n    );\n  }\n\n  if (!config) {\n    return null;\n  }\n\n  const isGrouped = config.grouping && config.grouping.length > 0;\n\n  const translatedConfig: ReportConfig = {\n    ...config,\n    title: translateDynamic(config.title, currentLanguage),\n    description: config.description\n      ? translateDynamic(config.description, currentLanguage)\n      : undefined,\n    columns: config.columns.map((col) => ({\n      ...col,\n      label: translateDynamic(col.label, currentLanguage),\n    })),\n    filters: (config.filters || []).map((filter) => ({\n      ...filter,\n      label: translateDynamic(filter.label, currentLanguage),\n    })),\n    grouping: (config.grouping || []).map((group) => ({\n      ...group,\n      label: translateDynamic(group.label, currentLanguage),\n    })),\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-start justify-between bg-gradient-to-r from-white to-slate-50 rounded-xl p-3 md:p-4\">\n        <div className=\"flex-1\">\n          <h1 className=\"text-3xl font-bold text-gray-900 tracking-tight\">\n            {translatedConfig?.title || config?.title}\n          </h1>\n          {translatedConfig?.description && (\n            <p className=\"text-gray-600 mt-2\">{translatedConfig.description}</p>\n          )}\n        </div>\n\n        <div className=\"ml-4\">\n          <label className=\"block text-xs font-medium text-gray-600 mb-1\">\n            {TEXTS_BUILDER.languageLabel[currentLanguage]}\n          </label>\n          <select\n            value={currentLanguage}\n            onChange={(e) => setCurrentLanguage(e.target.value)}\n            className=\"block w-40 px-3 py-2 bg-white border border-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400 text-sm\"\n          >\n            {LANGUAGES.map((lang) => (\n              <option key={lang.code} value={lang.code}>\n                {lang.flag} {lang.label}\n              </option>\n            ))}\n          </select>\n        </div>\n      </div>\n\n      {translatedConfig && translatedConfig.filters && translatedConfig.filters.length > 0 && (\n        <ReportFilters\n          filters={translatedConfig.filters}\n          values={filters}\n          onChange={handleFiltersChange}\n          onApply={handleApplyFilters}\n          autoOptions={autoOptions}\n          rawData={rawData}\n          language={currentLanguage}\n        />\n      )}\n\n      {debugInfo && (\n        <details className=\"bg-gray-50 border border-gray-200 rounded-lg p-4\">\n          <summary className=\"cursor-pointer font-medium text-gray-700 hover:text-gray-900\">\n            {TEXTS_BUILDER.debugTitle[currentLanguage]}\n          </summary>\n          <div className=\"mt-4 space-y-3\">\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugSql[currentLanguage]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {debugInfo.sql}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugParams[currentLanguage]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {JSON.stringify(debugInfo.params, null, 2)}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugBind[currentLanguage]}\n              </p>\n              <code className=\"bg-white px-2 py-1 rounded border text-xs\">\n                {debugInfo.bindTypes}\n              </code>\n            </div>\n          </div>\n        </details>\n      )}\n\n      {!loading &&\n        Object.keys(filters)\n          .filter((key) => filters[key])\n          .length > 0 && (\n          <div className=\"bg-sky-50 border border-sky-100 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <h3 className=\"text-sm font-semibold text-sky-900\">\n                {TEXTS_BUILDER.activeFilters[currentLanguage]}\n              </h3>\n              <button\n                onClick={() => setFilters({})}\n                className=\"text-xs text-sky-600 hover:text-sky-800 underline\"\n              >\n                {TEXTS_BUILDER.removeAll[currentLanguage]}\n              </button>\n            </div>\n            <div className=\"flex flex-wrap gap-2\">\n              {Object.entries(filters).map(([field, value]) => {\n                if (!value) return null;\n\n                const filterConfig = translatedConfig?.filters?.find(\n                  (f) => f.field === field\n                );\n                const label = filterConfig?.label || field;\n\n                let displayValue = value;\n                if (typeof value === 'object' && value.from && value.to) {\n                  displayValue = `${value.from} - ${value.to}`;\n                } else if (Array.isArray(value)) {\n                  displayValue = value.join(', ');\n                }\n\n                return (\n                  <div\n                    key={field}\n                    className=\"inline-flex items-center gap-2 bg-white border border-sky-200 rounded-full px-3 py-1 text-sm shadow-sm\"\n                  >\n                    <span className=\"font-medium text-sky-900\">{label}:</span>\n                    <span className=\"text-sky-700\">{displayValue}</span>\n                    <button\n                      onClick={() => {\n                        const newFilters = { ...filters };\n                        delete newFilters[field];\n                        setFilters(newFilters);\n                      }}\n                      className=\"text-sky-400 hover:text-sky-600\"\n                    >\n                      ×\n                    </button>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        )}\n\n      {loading && (\n        <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"w-6 h-6 animate-spin text-sky-600 mr-2\" />\n          <span className=\"text-gray-600\">\n            {TEXTS_BUILDER.loadingData[currentLanguage]}\n          </span>\n        </div>\n      )}\n\n      {!loading && processedData.length === 0 && (\n        <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center\">\n          <p className=\"text-yellow-800 font-medium\">\n            {TEXTS_BUILDER.noData[currentLanguage]}\n          </p>\n          <p className=\"text-yellow-600 text-sm mt-1\">\n            {TEXTS_BUILDER.noDataDescription[currentLanguage]}\n          </p>\n        </div>\n      )}\n\n      {!loading && processedData.length > 0 && translatedConfig && (\n        <ReportTable\n          data={processedData}\n          columns={translatedConfig.columns}\n          aggregates={aggregates}\n          language={currentLanguage}\n          isGrouped={isGrouped}\n          groupingConfig={translatedConfig.grouping}\n        />\n      )}\n\n      {!loading && processedData.length > 0 && translatedConfig && (\n        <ReportExport\n          data={processedData}\n          config={translatedConfig}\n          reportTitle={translatedConfig.title}\n          language={currentLanguage}\n        />\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v4",
        "timestamp": "2025-11-09T06:17:17.323Z",
        "note": "Modifica multipla 09/11/2025, 07:17:16",
        "code": "'use client';\n\nimport { useState, useEffect } from 'react';\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport {\n  executeQuery,\n  getDocumentTypes,\n  getDocumentYears,\n} from '@/lib/mysql-query';\nimport ReportTable from './ReportTable';\nimport ReportFilters from './ReportFilters';\nimport ReportExport from './ReportExport';\nimport { Loader2 } from 'lucide-react';\n\nconst TEXTS_BUILDER = {\n  errorTitle: {\n    it: 'Errore',\n    en: 'Error',\n    de: 'Fehler',\n    fr: 'Erreur',\n    es: 'Error',\n    pt: 'Erro',\n  },\n  loadingData: {\n    it: 'Caricamento dati...',\n    en: 'Loading data...',\n    de: 'Daten werden geladen...',\n    fr: 'Chargement des données...',\n    es: 'Cargando datos...',\n    pt: 'Carregando dados...',\n  },\n  noData: {\n    it: 'Nessun dato disponibile',\n    en: 'No data available',\n    de: 'Keine Daten verfügbar',\n    fr: 'Aucune donnée disponibile',\n    es: 'No hay datos disponibles',\n    pt: 'Nenhum dado disponível',\n  },\n  noDataDescription: {\n    it: 'Non ci sono dati per il cliente selezionato con i filtri applicati.',\n    en: 'There is no data for the selected customer with the applied filters.',\n    de: 'Es sind keine Daten für den ausgewählten Kunden mit den angewendeten Filtern vorhanden.',\n    fr: 'Aucune donnée pour le client sélectionné avec les filtres appliqués.',\n    es: 'No hay datos para el cliente seleccionado con los filtros aplicados.',\n    pt: 'Não há dados para o cliente selecionado com os filtros aplicados.',\n  },\n  activeFilters: {\n    it: 'Filtri attivi:',\n    en: 'Active filters:',\n    de: 'Aktive Filter:',\n    fr: 'Filtres actifs :',\n    es: 'Filtros activos:',\n    pt: 'Filtros ativos:',\n  },\n  removeAll: {\n    it: 'Rimuovi tutti',\n    en: 'Remove all',\n    de: 'Alle entfernen',\n    fr: 'Tout supprimer',\n    es: 'Eliminar todos',\n    pt: 'Remover todos',\n  },\n  debugTitle: {\n    it: 'Debug: Query SQL eseguita',\n    en: 'Debug: Executed SQL query',\n    de: 'Debug: Ausgeführte SQL-Abfrage',\n    fr: 'Debug : Requête SQL exécutée',\n    es: 'Debug: Consulta SQL ejecutada',\n    pt: 'Debug: Consulta SQL executada',\n  },\n  debugSql: {\n    it: 'Query SQL:',\n    en: 'SQL query:',\n    de: 'SQL-Abfrage:',\n    fr: 'Requête SQL :',\n    es: 'Consulta SQL:',\n    pt: 'Consulta SQL:',\n  },\n  debugParams: {\n    it: 'Parametri:',\n    en: 'Parameters:',\n    de: 'Parameter:',\n    fr: 'Paramètres :',\n    es: 'Parámetros:',\n    pt: 'Parâmetros:',\n  },\n  debugBind: {\n    it: 'Bind Types:',\n    en: 'Bind Types:',\n    de: 'Bindetypen:',\n    fr: 'Types de liaison :',\n    es: 'Tipos de enlace:',\n    pt: 'Tipos de ligação:',\n  },\n  languageLabel: {\n    it: 'Lingua',\n    en: 'Language',\n    de: 'Sprache',\n    fr: 'Langue',\n    es: 'Idioma',\n    pt: 'Idioma',\n  },\n};\n\nconst LANGUAGES = [\n  { code: 'it', label: 'Italiano', flag: '🇮🇹' },\n  { code: 'en', label: 'English', flag: '🇬🇧' },\n  { code: 'de', label: 'Deutsch', flag: '🇩🇪' },\n  { code: 'fr', label: 'Français', flag: '🇫🇷' },\n  { code: 'es', label: 'Español', flag: '🇪🇸' },\n  { code: 'pt', label: 'Português', flag: '🇵🇹' },\n];\n\nconst BUILDER_FILTER_LABELS: Record<\n  string,\n  {\n    it: string;\n    en: string;\n    de: string;\n    fr: string;\n    es: string;\n    pt: string;\n  }\n> = {\n  'data ordine': {\n    it: 'Data Ordine',\n    en: 'Order Date',\n    de: 'Bestelldatum',\n    fr: 'Date commande',\n    es: 'Fecha pedido',\n    pt: 'Data pedido',\n  },\n  'numero documento': {\n    it: 'Numero documento',\n    en: 'Document number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro document',\n    es: 'Número documento',\n    pt: 'Número documento',\n  },\n  'codice articolo': {\n    it: 'Codice articolo',\n    en: 'Item code',\n    de: 'Artikelcode',\n    fr: 'Code article',\n    es: 'Código artículo',\n    pt: 'Código artigo',\n  },\n  'cliente': {\n    it: 'Cliente',\n    en: 'Customer',\n    de: 'Kunde',\n    fr: 'Client',\n    es: 'Cliente',\n    pt: 'Cliente',\n  },\n  'articolo': {\n    it: 'Articolo',\n    en: 'Item',\n    de: 'Artikel',\n    fr: 'Article',\n    es: 'Artículo',\n    pt: 'Artigo',\n  },\n  'agente': {\n    it: 'Agente',\n    en: 'Agent',\n    de: 'Vertreter',\n    fr: 'Agent',\n    es: 'Agente',\n    pt: 'Agente',\n  },\n  'anno': {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  'tipo documento': {\n    it: 'Tipo documento',\n    en: 'Document type',\n    de: 'Dokumentenart',\n    fr: 'Type de document',\n    es: 'Tipo de documento',\n    pt: 'Tipo de documento',\n  },\n  'stato': {\n    it: 'Stato',\n    en: 'Status',\n    de: 'Status',\n    fr: 'Statut',\n    es: 'Estado',\n    pt: 'Estado',\n  },\n  'magazzino': {\n    it: 'Magazzino',\n    en: 'Warehouse',\n    de: 'Lager',\n    fr: 'Entrepôt',\n    es: 'Almacén',\n    pt: 'Armazém',\n  },\n  'causale': {\n    it: 'Causale',\n    en: 'Reason',\n    de: 'Grund',\n    fr: 'Causal',\n    es: 'Causal',\n    pt: 'Causal',\n  },\n};\n\nconst BUILDER_COLUMN_LABELS: Record<\n  string,\n  {\n    it: string;\n    en: string;\n    de: string;\n    fr: string;\n    es: string;\n    pt: string;\n  }\n> = {\n  'data ordine': {\n    it: 'Data Ordine',\n    en: 'Order Date',\n    de: 'Bestelldatum',\n    fr: 'Date commande',\n    es: 'Fecha pedido',\n    pt: 'Data pedido',\n  },\n  'numero documento': {\n    it: 'Numero documento',\n    en: 'Document number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro document',\n    es: 'Número documento',\n    pt: 'Número documento',\n  },\n  'numero doc': {\n    it: 'Numero doc',\n    en: 'Document number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro document',\n    es: 'Número documento',\n    pt: 'Número documento',\n  },\n  'sigla doc': {\n    it: 'Sigla doc',\n    en: 'Doc code',\n    de: 'Dok-Kürzel',\n    fr: 'Code doc',\n    es: 'Código doc',\n    pt: 'Código doc',\n  },\n  'codice articolo': {\n    it: 'Codice articolo',\n    en: 'Item code',\n    de: 'Artikelcode',\n    fr: 'Code article',\n    es: 'Código artículo',\n    pt: 'Código artigo',\n  },\n  'articolo': {\n    it: 'Articolo',\n    en: 'Item',\n    de: 'Artikel',\n    fr: 'Article',\n    es: 'Artículo',\n    pt: 'Artigo',\n  },\n  'descrizione': {\n    it: 'Descrizione',\n    en: 'Description',\n    de: 'Beschreibung',\n    fr: 'Description',\n    es: 'Descripción',\n    pt: 'Descrição',\n  },\n  'quantità': {\n    it: 'Quantità',\n    en: 'Quantity',\n    de: 'Menge',\n    fr: 'Quantité',\n    es: 'Cantidad',\n    pt: 'Quantidade',\n  },\n  'qta': {\n    it: 'Quantità',\n    en: 'Quantity',\n    de: 'Menge',\n    fr: 'Quantité',\n    es: 'Cantidad',\n    pt: 'Quantidade',\n  },\n  'valore': {\n    it: 'Valore',\n    en: 'Value',\n    de: 'Wert',\n    fr: 'Valeur',\n    es: 'Valor',\n    pt: 'Valor',\n  },\n  'prezzo': {\n    it: 'Prezzo',\n    en: 'Price',\n    de: 'Preis',\n    fr: 'Prix',\n    es: 'Precio',\n    pt: 'Preço',\n  },\n  'totale': {\n    it: 'Totale',\n    en: 'Total',\n    de: 'Gesamt',\n    fr: 'Total',\n    es: 'Total',\n    pt: 'Total',\n  },\n  'cliente': {\n    it: 'Cliente',\n    en: 'Customer',\n    de: 'Kunde',\n    fr: 'Client',\n    es: 'Cliente',\n    pt: 'Cliente',\n  },\n  'agente': {\n    it: 'Agente',\n    en: 'Agent',\n    de: 'Vertreter',\n    fr: 'Agent',\n    es: 'Agente',\n    pt: 'Agente',\n  },\n  'stato': {\n    it: 'Stato',\n    en: 'Status',\n    de: 'Status',\n    fr: 'Statut',\n    es: 'Estado',\n    pt: 'Estado',\n  },\n  'evaso': {\n    it: 'Evaso',\n    en: 'Fulfilled',\n    de: 'Erfüllt',\n    fr: 'Traité',\n    es: 'Completado',\n    pt: 'Concluído',\n  },\n  'consegnato': {\n    it: 'Consegnato',\n    en: 'Delivered',\n    de: 'Geliefert',\n    fr: 'Livré',\n    es: 'Entregado',\n    pt: 'Entregue',\n  },\n  'causale': {\n    it: 'Causale',\n    en: 'Reason',\n    de: 'Grund',\n    fr: 'Causal',\n    es: 'Causal',\n    pt: 'Causal',\n  },\n  'anno': {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  'tipo documento': {\n    it: 'Tipo documento',\n    en: 'Document type',\n    de: 'Dokumentenart',\n    fr: 'Type de document',\n    es: 'Tipo de documento',\n    pt: 'Tipo de documento',\n  },\n  'magazzino': {\n    it: 'Magazzino',\n    en: 'Warehouse',\n    de: 'Lager',\n    fr: 'Entrepôt',\n    es: 'Almacén',\n    pt: 'Armazém',\n  },\n};\n\nfunction translateDynamic(label: string | undefined, language: string) {\n  if (!label) return '';\n  const key = label.toLowerCase().trim();\n  if (BUILDER_FILTER_LABELS[key]) {\n    return BUILDER_FILTER_LABELS[key][language as keyof (typeof BUILDER_FILTER_LABELS)[string]];\n  }\n  if (BUILDER_COLUMN_LABELS[key]) {\n    return BUILDER_COLUMN_LABELS[key][language as keyof (typeof BUILDER_COLUMN_LABELS)[string]];\n  }\n  return label;\n}\n\ninterface ReportBuilderProps {\n  reportSlug: string;\n  clientCode: string;\n  language?: string;\n}\n\nexport default function ReportBuilder({\n  reportSlug,\n  clientCode,\n  language: initialLanguage = 'it',\n}: ReportBuilderProps) {\n  const [config, setConfig] = useState<ReportConfig | null>(null);\n  const [rawData, setRawData] = useState<any[]>([]);\n  const [processedData, setProcessedData] = useState<any[]>([]);\n  const [aggregates, setAggregates] = useState<Record<string, any>>({});\n  const [filters, setFilters] = useState<Record<string, any>>({});\n  const [autoOptions, setAutoOptions] = useState<Record<string, string[]>>({});\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [debugInfo, setDebugInfo] = useState<any>(null);\n  const [currentLanguage, setCurrentLanguage] = useState(initialLanguage);\n\n  useEffect(() => {\n    async function loadConfig() {\n      try {\n        const response = await fetch(`/api/reports/config?slug=${reportSlug}`);\n\n        if (!response.ok) {\n          throw new Error(`Report configuration not found: ${reportSlug}`);\n        }\n\n        const data = await response.json();\n        setConfig(data.config);\n      } catch (err: any) {\n        console.error('Error loading report config:', err);\n        setError(err.message || 'Failed to load report configuration');\n      }\n    }\n\n    loadConfig();\n  }, [reportSlug]);\n\n  useEffect(() => {\n    if (!config || !clientCode) return;\n\n    async function loadData(reportConfig: ReportConfig) {\n      try {\n        setLoading(true);\n        setError(null);\n\n        const queryParams: Record<string, any> = {};\n        queryParams.clientCode = clientCode;\n\n        const result = await executeQuery(reportConfig.query, queryParams);\n\n        setRawData(result.data || []);\n\n        if (result.debug) {\n          setDebugInfo(result.debug);\n        }\n\n        const options: Record<string, string[]> = {};\n\n        for (const filter of reportConfig.filters || []) {\n          if (filter.options === 'auto') {\n            if (filter.field === 'tipo_documento') {\n              options[filter.field] = await getDocumentTypes(clientCode);\n            } else if (filter.field === 'anno') {\n              const years = await getDocumentYears(clientCode);\n              options[filter.field] = years.map(String);\n            } else {\n              const uniqueValues = new Set<string>();\n              result.data.forEach((row: any) => {\n                const value = row[filter.field];\n                if (value != null && value !== '') {\n                  uniqueValues.add(String(value));\n                }\n              });\n              options[filter.field] = Array.from(uniqueValues).sort();\n            }\n          }\n        }\n\n        setAutoOptions(options);\n      } catch (err: any) {\n        console.error('Error loading data:', err);\n        setError(err.message || 'Failed to load data');\n      } finally {\n        setLoading(false);\n      }\n    }\n\n    loadData(config);\n  }, [config, clientCode]);\n\n  useEffect(() => {\n    if (!config || rawData.length === 0) {\n      setProcessedData([]);\n      setAggregates({});\n      return;\n    }\n\n    const result = ReportEngine.processReport(rawData, config, filters);\n    setProcessedData(result.data);\n    setAggregates(result.aggregates);\n  }, [rawData, config, filters]);\n\n  const handleFiltersChange = (newFilters: Record<string, any>) => {\n    setFilters(newFilters);\n  };\n\n  const handleApplyFilters = () => {};\n\n  if (loading && !config) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-sky-600\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n        <p className=\"text-red-800 font-medium\">\n          {TEXTS_BUILDER.errorTitle[currentLanguage]}\n        </p>\n        <p className=\"text-red-600 text-sm mt-1\">{error}</p>\n      </div>\n    );\n  }\n\n  if (!config) {\n    return null;\n  }\n\n  const isGrouped = config.grouping && config.grouping.length > 0;\n\n  const translatedConfig: ReportConfig = {\n    ...config,\n    title: translateDynamic(config.title, currentLanguage),\n    description: config.description\n      ? translateDynamic(config.description, currentLanguage)\n      : undefined,\n    columns: config.columns.map((col) => ({\n      ...col,\n      label: translateDynamic(col.label, currentLanguage),\n    })),\n    filters: (config.filters || []).map((filter) => ({\n      ...filter,\n      label: translateDynamic(filter.label, currentLanguage),\n    })),\n    grouping: (config.grouping || []).map((group) => ({\n      ...group,\n      label: translateDynamic(group.label, currentLanguage),\n    })),\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-start justify-between bg-gradient-to-r from-white to-slate-50 rounded-xl p-3 md:p-4\">\n        <div className=\"flex-1\">\n          <h1 className=\"text-3xl font-bold text-gray-900 tracking-tight\">\n            {translatedConfig?.title || config?.title}\n          </h1>\n          {translatedConfig?.description && (\n            <p className=\"text-gray-600 mt-2\">{translatedConfig.description}</p>\n          )}\n        </div>\n\n        <div className=\"ml-4\">\n          <label className=\"block text-xs font-medium text-gray-600 mb-1\">\n            {TEXTS_BUILDER.languageLabel[currentLanguage]}\n          </label>\n          <select\n            value={currentLanguage}\n            onChange={(e) => setCurrentLanguage(e.target.value)}\n            className=\"block w-40 px-3 py-2 bg-white border border-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400 text-sm\"\n          >\n            {LANGUAGES.map((lang) => (\n              <option key={lang.code} value={lang.code}>\n                {lang.flag} {lang.label}\n              </option>\n            ))}\n          </select>\n        </div>\n      </div>\n\n      {translatedConfig && translatedConfig.filters && translatedConfig.filters.length > 0 && (\n        <ReportFilters\n          filters={translatedConfig.filters}\n          values={filters}\n          onChange={handleFiltersChange}\n          onApply={handleApplyFilters}\n          autoOptions={autoOptions}\n          rawData={rawData}\n          language={currentLanguage}\n        />\n      )}\n\n      {debugInfo && (\n        <details className=\"bg-gray-50 border border-gray-200 rounded-lg p-4\">\n          <summary className=\"cursor-pointer font-medium text-gray-700 hover:text-gray-900\">\n            {TEXTS_BUILDER.debugTitle[currentLanguage]}\n          </summary>\n          <div className=\"mt-4 space-y-3\">\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugSql[currentLanguage]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {debugInfo.sql}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugParams[currentLanguage]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {JSON.stringify(debugInfo.params, null, 2)}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugBind[currentLanguage]}\n              </p>\n              <code className=\"bg-white px-2 py-1 rounded border text-xs\">\n                {debugInfo.bindTypes}\n              </code>\n            </div>\n          </div>\n        </details>\n      )}\n\n      {!loading &&\n        Object.keys(filters)\n          .filter((key) => filters[key])\n          .length > 0 && (\n          <div className=\"bg-sky-50 border border-sky-100 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <h3 className=\"text-sm font-semibold text-sky-900\">\n                {TEXTS_BUILDER.activeFilters[currentLanguage]}\n              </h3>\n              <button\n                onClick={() => setFilters({})}\n                className=\"text-xs text-sky-600 hover:text-sky-800 underline\"\n              >\n                {TEXTS_BUILDER.removeAll[currentLanguage]}\n              </button>\n            </div>\n            <div className=\"flex flex-wrap gap-2\">\n              {Object.entries(filters).map(([field, value]) => {\n                if (!value) return null;\n\n                const filterConfig = translatedConfig?.filters?.find(\n                  (f) => f.field === field\n                );\n                const label = filterConfig?.label || field;\n\n                let displayValue = value;\n                if (typeof value === 'object' && value.from && value.to) {\n                  displayValue = `${value.from} - ${value.to}`;\n                } else if (Array.isArray(value)) {\n                  displayValue = value.join(', ');\n                }\n\n                return (\n                  <div\n                    key={field}\n                    className=\"inline-flex items-center gap-2 bg-white border border-sky-200 rounded-full px-3 py-1 text-sm shadow-sm\"\n                  >\n                    <span className=\"font-medium text-sky-900\">{label}:</span>\n                    <span className=\"text-sky-700\">{displayValue}</span>\n                    <button\n                      onClick={() => {\n                        const newFilters = { ...filters };\n                        delete newFilters[field];\n                        setFilters(newFilters);\n                      }}\n                      className=\"text-sky-400 hover:text-sky-600\"\n                    >\n                      ×\n                    </button>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        )}\n\n      {loading && (\n        <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"w-6 h-6 animate-spin text-sky-600 mr-2\" />\n          <span className=\"text-gray-600\">\n            {TEXTS_BUILDER.loadingData[currentLanguage]}\n          </span>\n        </div>\n      )}\n\n      {!loading && processedData.length === 0 && (\n        <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center\">\n          <p className=\"text-yellow-800 font-medium\">\n            {TEXTS_BUILDER.noData[currentLanguage]}\n          </p>\n          <p className=\"text-yellow-600 text-sm mt-1\">\n            {TEXTS_BUILDER.noDataDescription[currentLanguage]}\n          </p>\n        </div>\n      )}\n\n      {!loading && processedData.length > 0 && translatedConfig && (\n        <ReportTable\n          data={processedData}\n          columns={translatedConfig.columns}\n          aggregates={aggregates}\n          language={currentLanguage}\n          isGrouped={isGrouped}\n          groupingConfig={translatedConfig.grouping}\n        />\n      )}\n\n      {!loading && processedData.length > 0 && translatedConfig && (\n        <ReportExport\n          data={processedData}\n          config={translatedConfig}\n          reportTitle={translatedConfig.title}\n          language={currentLanguage}\n        />\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v5",
        "timestamp": "2025-11-09T06:24:38.276Z",
        "note": "Modifica multipla 09/11/2025, 07:24:37",
        "code": "'use client';\n\nimport { useState, useEffect } from 'react';\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport {\n  executeQuery,\n  getDocumentTypes,\n  getDocumentYears,\n} from '@/lib/mysql-query';\nimport ReportTable from './ReportTable';\nimport ReportFilters from './ReportFilters';\nimport ReportExport from './ReportExport';\nimport { Loader2 } from 'lucide-react';\n\nconst TEXTS_BUILDER = {\n  errorTitle: {\n    it: 'Errore',\n    en: 'Error',\n    de: 'Fehler',\n    fr: 'Erreur',\n    es: 'Error',\n    pt: 'Erro',\n  },\n  loadingData: {\n    it: 'Caricamento dati...',\n    en: 'Loading data...',\n    de: 'Daten werden geladen...',\n    fr: 'Chargement des données...',\n    es: 'Cargando datos...',\n    pt: 'Carregando dados...',\n  },\n  noData: {\n    it: 'Nessun dato disponibile',\n    en: 'No data available',\n    de: 'Keine Daten verfügbar',\n    fr: 'Aucune donnée disponibile',\n    es: 'No hay datos disponibles',\n    pt: 'Nenhum dado disponível',\n  },\n  noDataDescription: {\n    it: 'Non ci sono dati per il cliente selezionato con i filtri applicati.',\n    en: 'There is no data for the selected customer with the applied filters.',\n    de: 'Es sind keine Daten für den ausgewählten Kunden mit den angewendeten Filtern vorhanden.',\n    fr: 'Aucune donnée pour le client sélectionné avec les filtres appliqués.',\n    es: 'No hay datos para el cliente seleccionado con los filtros aplicados.',\n    pt: 'Não há dados para o cliente selecionado com os filtros aplicados.',\n  },\n  activeFilters: {\n    it: 'Filtri attivi:',\n    en: 'Active filters:',\n    de: 'Aktive Filter:',\n    fr: 'Filtres actifs :',\n    es: 'Filtros activos:',\n    pt: 'Filtros ativos:',\n  },\n  removeAll: {\n    it: 'Rimuovi tutti',\n    en: 'Remove all',\n    de: 'Alle entfernen',\n    fr: 'Tout supprimer',\n    es: 'Eliminar todos',\n    pt: 'Remover todos',\n  },\n  debugTitle: {\n    it: 'Debug: Query SQL eseguita',\n    en: 'Debug: Executed SQL query',\n    de: 'Debug: Ausgeführte SQL-Abfrage',\n    fr: 'Debug : Requête SQL exécutée',\n    es: 'Debug: Consulta SQL ejecutada',\n    pt: 'Debug: Consulta SQL executada',\n  },\n  debugSql: {\n    it: 'Query SQL:',\n    en: 'SQL query:',\n    de: 'SQL-Abfrage:',\n    fr: 'Requête SQL :',\n    es: 'Consulta SQL:',\n    pt: 'Consulta SQL:',\n  },\n  debugParams: {\n    it: 'Parametri:',\n    en: 'Parameters:',\n    de: 'Parameter:',\n    fr: 'Paramètres :',\n    es: 'Parámetros:',\n    pt: 'Parâmetros:',\n  },\n  debugBind: {\n    it: 'Bind Types:',\n    en: 'Bind Types:',\n    de: 'Bindetypen:',\n    fr: 'Types de liaison :',\n    es: 'Tipos de enlace:',\n    pt: 'Tipos de ligação:',\n  },\n  languageLabel: {\n    it: 'Lingua',\n    en: 'Language',\n    de: 'Sprache',\n    fr: 'Langue',\n    es: 'Idioma',\n    pt: 'Idioma',\n  },\n};\n\nconst LANGUAGES = [\n  { code: 'it', label: 'Italiano', flag: '🇮🇹' },\n  { code: 'en', label: 'English', flag: '🇬🇧' },\n  { code: 'de', label: 'Deutsch', flag: '🇩🇪' },\n  { code: 'fr', label: 'Français', flag: '🇫🇷' },\n  { code: 'es', label: 'Español', flag: '🇪🇸' },\n  { code: 'pt', label: 'Português', flag: '🇵🇹' },\n];\n\nconst BUILDER_FILTER_LABELS: Record<\n  string,\n  {\n    it: string;\n    en: string;\n    de: string;\n    fr: string;\n    es: string;\n    pt: string;\n  }\n> = {\n  'data ordine': {\n    it: 'Data Ordine',\n    en: 'Order Date',\n    de: 'Bestelldatum',\n    fr: 'Date commande',\n    es: 'Fecha pedido',\n    pt: 'Data pedido',\n  },\n  'numero documento': {\n    it: 'Numero documento',\n    en: 'Document number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro document',\n    es: 'Número documento',\n    pt: 'Número documento',\n  },\n  'codice articolo': {\n    it: 'Codice articolo',\n    en: 'Item code',\n    de: 'Artikelcode',\n    fr: 'Code article',\n    es: 'Código artículo',\n    pt: 'Código artigo',\n  },\n  'cliente': {\n    it: 'Cliente',\n    en: 'Customer',\n    de: 'Kunde',\n    fr: 'Client',\n    es: 'Cliente',\n    pt: 'Cliente',\n  },\n  'articolo': {\n    it: 'Articolo',\n    en: 'Item',\n    de: 'Artikel',\n    fr: 'Article',\n    es: 'Artículo',\n    pt: 'Artigo',\n  },\n  'agente': {\n    it: 'Agente',\n    en: 'Agent',\n    de: 'Vertreter',\n    fr: 'Agent',\n    es: 'Agente',\n    pt: 'Agente',\n  },\n  'anno': {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  'tipo documento': {\n    it: 'Tipo documento',\n    en: 'Document type',\n    de: 'Dokumentenart',\n    fr: 'Type de document',\n    es: 'Tipo de documento',\n    pt: 'Tipo de documento',\n  },\n  'stato': {\n    it: 'Stato',\n    en: 'Status',\n    de: 'Status',\n    fr: 'Statut',\n    es: 'Estado',\n    pt: 'Estado',\n  },\n  'magazzino': {\n    it: 'Magazzino',\n    en: 'Warehouse',\n    de: 'Lager',\n    fr: 'Entrepôt',\n    es: 'Almacén',\n    pt: 'Armazém',\n  },\n  'causale': {\n    it: 'Causale',\n    en: 'Reason',\n    de: 'Grund',\n    fr: 'Causal',\n    es: 'Causal',\n    pt: 'Causal',\n  },\n};\n\nconst BUILDER_COLUMN_LABELS: Record<\n  string,\n  {\n    it: string;\n    en: string;\n    de: string;\n    fr: string;\n    es: string;\n    pt: string;\n  }\n> = {\n  'data ordine': {\n    it: 'Data Ordine',\n    en: 'Order Date',\n    de: 'Bestelldatum',\n    fr: 'Date commande',\n    es: 'Fecha pedido',\n    pt: 'Data pedido',\n  },\n  'numero documento': {\n    it: 'Numero documento',\n    en: 'Document number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro document',\n    es: 'Número documento',\n    pt: 'Número documento',\n  },\n  'numero doc': {\n    it: 'Numero doc',\n    en: 'Document number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro document',\n    es: 'Número documento',\n    pt: 'Número documento',\n  },\n  'sigla doc': {\n    it: 'Sigla doc',\n    en: 'Doc code',\n    de: 'Dok-Kürzel',\n    fr: 'Code doc',\n    es: 'Código doc',\n    pt: 'Código doc',\n  },\n  'codice articolo': {\n    it: 'Codice articolo',\n    en: 'Item code',\n    de: 'Artikelcode',\n    fr: 'Code article',\n    es: 'Código artículo',\n    pt: 'Código artigo',\n  },\n  'articolo': {\n    it: 'Articolo',\n    en: 'Item',\n    de: 'Artikel',\n    fr: 'Article',\n    es: 'Artículo',\n    pt: 'Artigo',\n  },\n  'descrizione': {\n    it: 'Descrizione',\n    en: 'Description',\n    de: 'Beschreibung',\n    fr: 'Description',\n    es: 'Descripción',\n    pt: 'Descrição',\n  },\n  'quantità': {\n    it: 'Quantità',\n    en: 'Quantity',\n    de: 'Menge',\n    fr: 'Quantité',\n    es: 'Cantidad',\n    pt: 'Quantidade',\n  },\n  'qta': {\n    it: 'Quantità',\n    en: 'Quantity',\n    de: 'Menge',\n    fr: 'Quantité',\n    es: 'Cantidad',\n    pt: 'Quantidade',\n  },\n  'valore': {\n    it: 'Valore',\n    en: 'Value',\n    de: 'Wert',\n    fr: 'Valeur',\n    es: 'Valor',\n    pt: 'Valor',\n  },\n  'prezzo': {\n    it: 'Prezzo',\n    en: 'Price',\n    de: 'Preis',\n    fr: 'Prix',\n    es: 'Precio',\n    pt: 'Preço',\n  },\n  'totale': {\n    it: 'Totale',\n    en: 'Total',\n    de: 'Gesamt',\n    fr: 'Total',\n    es: 'Total',\n    pt: 'Total',\n  },\n  'cliente': {\n    it: 'Cliente',\n    en: 'Customer',\n    de: 'Kunde',\n    fr: 'Client',\n    es: 'Cliente',\n    pt: 'Cliente',\n  },\n  'agente': {\n    it: 'Agente',\n    en: 'Agent',\n    de: 'Vertreter',\n    fr: 'Agent',\n    es: 'Agente',\n    pt: 'Agente',\n  },\n  'stato': {\n    it: 'Stato',\n    en: 'Status',\n    de: 'Status',\n    fr: 'Statut',\n    es: 'Estado',\n    pt: 'Estado',\n  },\n  'evaso': {\n    it: 'Evaso',\n    en: 'Fulfilled',\n    de: 'Erfüllt',\n    fr: 'Traité',\n    es: 'Completado',\n    pt: 'Concluído',\n  },\n  'consegnato': {\n    it: 'Consegnato',\n    en: 'Delivered',\n    de: 'Geliefert',\n    fr: 'Livré',\n    es: 'Entregado',\n    pt: 'Entregue',\n  },\n  'causale': {\n    it: 'Causale',\n    en: 'Reason',\n    de: 'Grund',\n    fr: 'Causal',\n    es: 'Causal',\n    pt: 'Causal',\n  },\n  'anno': {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  'tipo documento': {\n    it: 'Tipo documento',\n    en: 'Document type',\n    de: 'Dokumentenart',\n    fr: 'Type de document',\n    es: 'Tipo de documento',\n    pt: 'Tipo de documento',\n  },\n  'magazzino': {\n    it: 'Magazzino',\n    en: 'Warehouse',\n    de: 'Lager',\n    fr: 'Entrepôt',\n    es: 'Almacén',\n    pt: 'Armazém',\n  },\n};\n\nfunction translateDynamic(label: string | undefined, language: string) {\n  if (!label) return '';\n  const key = label.toLowerCase().trim();\n  if (BUILDER_FILTER_LABELS[key]) {\n    return BUILDER_FILTER_LABELS[key][language as keyof (typeof BUILDER_FILTER_LABELS)[string]];\n  }\n  if (BUILDER_COLUMN_LABELS[key]) {\n    return BUILDER_COLUMN_LABELS[key][language as keyof (typeof BUILDER_COLUMN_LABELS)[string]];\n  }\n  return label;\n}\n\ninterface ReportBuilderProps {\n  reportSlug: string;\n  clientCode: string;\n  language?: string;\n}\n\nexport default function ReportBuilder({\n  reportSlug,\n  clientCode,\n  language: initialLanguage = 'it',\n}: ReportBuilderProps) {\n  const [config, setConfig] = useState<ReportConfig | null>(null);\n  const [rawData, setRawData] = useState<any[]>([]);\n  const [processedData, setProcessedData] = useState<any[]>([]);\n  const [aggregates, setAggregates] = useState<Record<string, any>>({});\n  const [filters, setFilters] = useState<Record<string, any>>({});\n  const [autoOptions, setAutoOptions] = useState<Record<string, string[]>>({});\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [debugInfo, setDebugInfo] = useState<any>(null);\n  const [currentLanguage, setCurrentLanguage] = useState(initialLanguage);\n\n  useEffect(() => {\n    async function loadConfig() {\n      try {\n        const response = await fetch(`/api/reports/config?slug=${reportSlug}`);\n\n        if (!response.ok) {\n          throw new Error(`Report configuration not found: ${reportSlug}`);\n        }\n\n        const data = await response.json();\n        setConfig(data.config);\n      } catch (err: any) {\n        console.error('Error loading report config:', err);\n        setError(err.message || 'Failed to load report configuration');\n      }\n    }\n\n    loadConfig();\n  }, [reportSlug]);\n\n  useEffect(() => {\n    if (!config || !clientCode) return;\n\n    async function loadData(reportConfig: ReportConfig) {\n      try {\n        setLoading(true);\n        setError(null);\n\n        const queryParams: Record<string, any> = {};\n        queryParams.clientCode = clientCode;\n\n        const result = await executeQuery(reportConfig.query, queryParams);\n\n        setRawData(result.data || []);\n\n        if (result.debug) {\n          setDebugInfo(result.debug);\n        }\n\n        const options: Record<string, string[]> = {};\n\n        for (const filter of reportConfig.filters || []) {\n          if (filter.options === 'auto') {\n            if (filter.field === 'tipo_documento') {\n              options[filter.field] = await getDocumentTypes(clientCode);\n            } else if (filter.field === 'anno') {\n              const years = await getDocumentYears(clientCode);\n              options[filter.field] = years.map(String);\n            } else {\n              const uniqueValues = new Set<string>();\n              result.data.forEach((row: any) => {\n                const value = row[filter.field];\n                if (value != null && value !== '') {\n                  uniqueValues.add(String(value));\n                }\n              });\n              options[filter.field] = Array.from(uniqueValues).sort();\n            }\n          }\n        }\n\n        setAutoOptions(options);\n      } catch (err: any) {\n        console.error('Error loading data:', err);\n        setError(err.message || 'Failed to load data');\n      } finally {\n        setLoading(false);\n      }\n    }\n\n    loadData(config);\n  }, [config, clientCode]);\n\n  useEffect(() => {\n    if (!config || rawData.length === 0) {\n      setProcessedData([]);\n      setAggregates({});\n      return;\n    }\n\n    const result = ReportEngine.processReport(rawData, config, filters);\n    setProcessedData(result.data);\n    setAggregates(result.aggregates);\n  }, [rawData, config, filters]);\n\n  const handleFiltersChange = (newFilters: Record<string, any>) => {\n    setFilters(newFilters);\n  };\n\n  const handleApplyFilters = () => {};\n\n  if (loading && !config) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-sky-600\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n        <p className=\"text-red-800 font-medium\">\n          {TEXTS_BUILDER.errorTitle[currentLanguage]}\n        </p>\n        <p className=\"text-red-600 text-sm mt-1\">{error}</p>\n      </div>\n    );\n  }\n\n  if (!config) {\n    return null;\n  }\n\n  const isGrouped = config.grouping && config.grouping.length > 0;\n\n  const translatedConfig: ReportConfig = {\n    ...config,\n    title: translateDynamic(config.title, currentLanguage),\n    description: config.description\n      ? translateDynamic(config.description, currentLanguage)\n      : undefined,\n    columns: config.columns.map((col) => ({\n      ...col,\n      label: translateDynamic(col.label, currentLanguage),\n    })),\n    filters: (config.filters || []).map((filter) => ({\n      ...filter,\n      label: translateDynamic(filter.label, currentLanguage),\n    })),\n    grouping: (config.grouping || []).map((group) => ({\n      ...group,\n      label: translateDynamic(group.label, currentLanguage),\n    })),\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-start justify-between bg-gradient-to-r from-white to-slate-50 rounded-xl p-3 md:p-4\">\n        <div className=\"flex-1\">\n          <h1 className=\"text-3xl font-bold text-gray-900 tracking-tight\">\n            {translatedConfig?.title || config?.title}\n          </h1>\n          {translatedConfig?.description && (\n            <p className=\"text-gray-600 mt-2\">{translatedConfig.description}</p>\n          )}\n        </div>\n\n        <div className=\"ml-4\">\n          <label className=\"block text-xs font-medium text-gray-600 mb-1\">\n            {TEXTS_BUILDER.languageLabel[currentLanguage]}\n          </label>\n          <select\n            value={currentLanguage}\n            onChange={(e) => setCurrentLanguage(e.target.value)}\n            className=\"block w-40 px-3 py-2 bg-white border border-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400 text-sm\"\n          >\n            {LANGUAGES.map((lang) => (\n              <option key={lang.code} value={lang.code}>\n                {lang.flag} {lang.label}\n              </option>\n            ))}\n          </select>\n        </div>\n      </div>\n\n      {translatedConfig && translatedConfig.filters && translatedConfig.filters.length > 0 && (\n        <ReportFilters\n          filters={translatedConfig.filters}\n          values={filters}\n          onChange={handleFiltersChange}\n          onApply={handleApplyFilters}\n          autoOptions={autoOptions}\n          rawData={rawData}\n          language={currentLanguage}\n        />\n      )}\n\n      {debugInfo && (\n        <details className=\"bg-gray-50 border border-gray-200 rounded-lg p-4\">\n          <summary className=\"cursor-pointer font-medium text-gray-700 hover:text-gray-900\">\n            {TEXTS_BUILDER.debugTitle[currentLanguage]}\n          </summary>\n          <div className=\"mt-4 space-y-3\">\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugSql[currentLanguage]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {debugInfo.sql}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugParams[currentLanguage]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {JSON.stringify(debugInfo.params, null, 2)}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugBind[currentLanguage]}\n              </p>\n              <code className=\"bg-white px-2 py-1 rounded border text-xs\">\n                {debugInfo.bindTypes}\n              </code>\n            </div>\n          </div>\n        </details>\n      )}\n\n      {!loading &&\n        Object.keys(filters)\n          .filter((key) => filters[key])\n          .length > 0 && (\n          <div className=\"bg-sky-50 border border-sky-100 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <h3 className=\"text-sm font-semibold text-sky-900\">\n                {TEXTS_BUILDER.activeFilters[currentLanguage]}\n              </h3>\n              <button\n                onClick={() => setFilters({})}\n                className=\"text-xs text-sky-600 hover:text-sky-800 underline\"\n              >\n                {TEXTS_BUILDER.removeAll[currentLanguage]}\n              </button>\n            </div>\n            <div className=\"flex flex-wrap gap-2\">\n              {Object.entries(filters).map(([field, value]) => {\n                if (!value) return null;\n\n                const filterConfig = translatedConfig?.filters?.find(\n                  (f) => f.field === field\n                );\n                const label = filterConfig?.label || field;\n\n                let displayValue = value;\n                if (typeof value === 'object' && value.from && value.to) {\n                  displayValue = `${value.from} - ${value.to}`;\n                } else if (Array.isArray(value)) {\n                  displayValue = value.join(', ');\n                }\n\n                return (\n                  <div\n                    key={field}\n                    className=\"inline-flex items-center gap-2 bg-white border border-sky-200 rounded-full px-3 py-1 text-sm shadow-sm\"\n                  >\n                    <span className=\"font-medium text-sky-900\">{label}:</span>\n                    <span className=\"text-sky-700\">{displayValue}</span>\n                    <button\n                      onClick={() => {\n                        const newFilters = { ...filters };\n                        delete newFilters[field];\n                        setFilters(newFilters);\n                      }}\n                      className=\"text-sky-400 hover:text-sky-600\"\n                    >\n                      ×\n                    </button>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        )}\n\n      {loading && (\n        <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"w-6 h-6 animate-spin text-sky-600 mr-2\" />\n          <span className=\"text-gray-600\">\n            {TEXTS_BUILDER.loadingData[currentLanguage]}\n          </span>\n        </div>\n      )}\n\n      {!loading && processedData.length === 0 && (\n        <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center\">\n          <p className=\"text-yellow-800 font-medium\">\n            {TEXTS_BUILDER.noData[currentLanguage]}\n          </p>\n          <p className=\"text-yellow-600 text-sm mt-1\">\n            {TEXTS_BUILDER.noDataDescription[currentLanguage]}\n          </p>\n        </div>\n      )}\n\n      {!loading && processedData.length > 0 && translatedConfig && (\n        <ReportTable\n          data={processedData}\n          columns={translatedConfig.columns}\n          aggregates={aggregates}\n          language={currentLanguage}\n          isGrouped={isGrouped}\n          groupingConfig={translatedConfig.grouping}\n        />\n      )}\n\n      {!loading && processedData.length > 0 && translatedConfig && (\n        <ReportExport\n          data={processedData}\n          config={translatedConfig}\n          reportTitle={translatedConfig.title}\n          language={currentLanguage}\n        />\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v6",
        "timestamp": "2025-11-09T06:29:33.764Z",
        "note": "Modifica multipla 09/11/2025, 07:29:33",
        "code": "'use client';\n\nimport { useState, useEffect } from 'react';\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport {\n  executeQuery,\n  getDocumentTypes,\n  getDocumentYears,\n} from '@/lib/mysql-query';\nimport ReportTable from './ReportTable';\nimport ReportFilters from './ReportFilters';\nimport ReportExport from './ReportExport';\nimport { Loader2 } from 'lucide-react';\n\nconst TEXTS_BUILDER = {\n  errorTitle: {\n    it: 'Errore',\n    en: 'Error',\n    de: 'Fehler',\n    fr: 'Erreur',\n    es: 'Error',\n    pt: 'Erro',\n  },\n  loadingData: {\n    it: 'Caricamento dati...',\n    en: 'Loading data...',\n    de: 'Daten werden geladen...',\n    fr: 'Chargement des données...',\n    es: 'Cargando datos...',\n    pt: 'Carregando dados...',\n  },\n  noData: {\n    it: 'Nessun dato disponibile',\n    en: 'No data available',\n    de: 'Keine Daten verfügbar',\n    fr: 'Aucune donnée disponibile',\n    es: 'No hay datos disponibles',\n    pt: 'Nenhum dado disponível',\n  },\n  noDataDescription: {\n    it: 'Non ci sono dati per il cliente selezionato con i filtri applicati.',\n    en: 'There is no data for the selected customer with the applied filters.',\n    de: 'Es sind keine Daten für den ausgewählten Kunden mit den angewendeten Filtern vorhanden.',\n    fr: 'Aucune donnée pour le client sélectionné con i filtri applicati.',\n    es: 'No hay datos para el cliente seleccionado con los filtros aplicados.',\n    pt: 'Não há dados para o cliente selecionado com os filtros aplicados.',\n  },\n  activeFilters: {\n    it: 'Filtri attivi:',\n    en: 'Active filters:',\n    de: 'Aktive Filter:',\n    fr: 'Filtres actifs :',\n    es: 'Filtros activos:',\n    pt: 'Filtros ativos:',\n  },\n  removeAll: {\n    it: 'Rimuovi tutti',\n    en: 'Remove all',\n    de: 'Alle entfernen',\n    fr: 'Tout supprimer',\n    es: 'Eliminar todos',\n    pt: 'Remover todos',\n  },\n  debugTitle: {\n    it: 'Debug: Query SQL eseguita',\n    en: 'Debug: Executed SQL query',\n    de: 'Debug: Ausgeführte SQL-Abfrage',\n    fr: 'Debug : Requête SQL exécutée',\n    es: 'Debug: Consulta SQL ejecutada',\n    pt: 'Debug: Consulta SQL executada',\n  },\n  debugSql: {\n    it: 'Query SQL:',\n    en: 'SQL query:',\n    de: 'SQL-Abfrage:',\n    fr: 'Requête SQL :',\n    es: 'Consulta SQL:',\n    pt: 'Consulta SQL:',\n  },\n  debugParams: {\n    it: 'Parametri:',\n    en: 'Parameters:',\n    de: 'Parameter:',\n    fr: 'Paramètres :',\n    es: 'Parámetros:',\n    pt: 'Parâmetros:',\n  },\n  debugBind: {\n    it: 'Bind Types:',\n    en: 'Bind Types:',\n    de: 'Bindetypen:',\n    fr: 'Types de liaison :',\n    es: 'Tipos de enlace:',\n    pt: 'Tipos de ligação:',\n  },\n  languageLabel: {\n    it: 'Lingua',\n    en: 'Language',\n    de: 'Sprache',\n    fr: 'Langue',\n    es: 'Idioma',\n    pt: 'Idioma',\n  },\n};\n\nconst LANGUAGES = [\n  { code: 'it', label: 'Italiano', flag: '🇮🇹' },\n  { code: 'en', label: 'English', flag: '🇬🇧' },\n  { code: 'de', label: 'Deutsch', flag: '🇩🇪' },\n  { code: 'fr', label: 'Français', flag: '🇫🇷' },\n  { code: 'es', label: 'Español', flag: '🇪🇸' },\n  { code: 'pt', label: 'Português', flag: '🇵🇹' },\n];\n\nconst BUILDER_FILTER_LABELS: Record<\n  string,\n  {\n    it: string;\n    en: string;\n    de: string;\n    fr: string;\n    es: string;\n    pt: string;\n  }\n> = {\n  'data ordine': {\n    it: 'Data Ordine',\n    en: 'Order Date',\n    de: 'Bestelldatum',\n    fr: 'Date commande',\n    es: 'Fecha pedido',\n    pt: 'Data pedido',\n  },\n  'numero documento': {\n    it: 'Numero documento',\n    en: 'Document number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro document',\n    es: 'Número documento',\n    pt: 'Número documento',\n  },\n  'codice articolo': {\n    it: 'Codice articolo',\n    en: 'Item code',\n    de: 'Artikelcode',\n    fr: 'Code article',\n    es: 'Código artículo',\n    pt: 'Código artigo',\n  },\n  cliente: {\n    it: 'Cliente',\n    en: 'Customer',\n    de: 'Kunde',\n    fr: 'Client',\n    es: 'Cliente',\n    pt: 'Cliente',\n  },\n  articolo: {\n    it: 'Articolo',\n    en: 'Item',\n    de: 'Artikel',\n    fr: 'Article',\n    es: 'Artículo',\n    pt: 'Artigo',\n  },\n  agente: {\n    it: 'Agente',\n    en: 'Agent',\n    de: 'Vertreter',\n    fr: 'Agent',\n    es: 'Agente',\n    pt: 'Agente',\n  },\n  anno: {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  'tipo documento': {\n    it: 'Tipo documento',\n    en: 'Document type',\n    de: 'Dokumentenart',\n    fr: 'Type de document',\n    es: 'Tipo de documento',\n    pt: 'Tipo de documento',\n  },\n  stato: {\n    it: 'Stato',\n    en: 'Status',\n    de: 'Status',\n    fr: 'Statut',\n    es: 'Estado',\n    pt: 'Estado',\n  },\n  magazzino: {\n    it: 'Magazzino',\n    en: 'Warehouse',\n    de: 'Lager',\n    fr: 'Entrepôt',\n    es: 'Almacén',\n    pt: 'Armazém',\n  },\n  causale: {\n    it: 'Causale',\n    en: 'Reason',\n    de: 'Grund',\n    fr: 'Causal',\n    es: 'Causal',\n    pt: 'Causal',\n  },\n};\n\nconst BUILDER_COLUMN_LABELS: Record<\n  string,\n  {\n    it: string;\n    en: string;\n    de: string;\n    fr: string;\n    es: string;\n    pt: string;\n  }\n> = {\n  'data ordine': {\n    it: 'Data Ordine',\n    en: 'Order Date',\n    de: 'Bestelldatum',\n    fr: 'Date commande',\n    es: 'Fecha pedido',\n    pt: 'Data pedido',\n  },\n  'numero documento': {\n    it: 'Numero documento',\n    en: 'Document number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro document',\n    es: 'Número documento',\n    pt: 'Número documento',\n  },\n  'numero doc': {\n    it: 'Numero doc',\n    en: 'Document number',\n    de: 'Dokumentnummer',\n    fr: 'Numéro document',\n    es: 'Número documento',\n    pt: 'Número documento',\n  },\n  'sigla doc': {\n    it: 'Sigla doc',\n    en: 'Doc code',\n    de: 'Dok-Kürzel',\n    fr: 'Code doc',\n    es: 'Código doc',\n    pt: 'Código doc',\n  },\n  'codice articolo': {\n    it: 'Codice articolo',\n    en: 'Item code',\n    de: 'Artikelcode',\n    fr: 'Code article',\n    es: 'Código artículo',\n    pt: 'Código artigo',\n  },\n  articolo: {\n    it: 'Articolo',\n    en: 'Item',\n    de: 'Artikel',\n    fr: 'Article',\n    es: 'Artículo',\n    pt: 'Artigo',\n  },\n  descrizione: {\n    it: 'Descrizione',\n    en: 'Description',\n    de: 'Beschreibung',\n    fr: 'Description',\n    es: 'Descripción',\n    pt: 'Descrição',\n  },\n  'quantità': {\n    it: 'Quantità',\n    en: 'Quantity',\n    de: 'Menge',\n    fr: 'Quantité',\n    es: 'Cantidad',\n    pt: 'Quantidade',\n  },\n  qta: {\n    it: 'Quantità',\n    en: 'Quantity',\n    de: 'Menge',\n    fr: 'Quantité',\n    es: 'Cantidad',\n    pt: 'Quantidade',\n  },\n  valore: {\n    it: 'Valore',\n    en: 'Value',\n    de: 'Wert',\n    fr: 'Valeur',\n    es: 'Valor',\n    pt: 'Valor',\n  },\n  prezzo: {\n    it: 'Prezzo',\n    en: 'Price',\n    de: 'Preis',\n    fr: 'Prix',\n    es: 'Precio',\n    pt: 'Preço',\n  },\n  totale: {\n    it: 'Totale',\n    en: 'Total',\n    de: 'Gesamt',\n    fr: 'Total',\n    es: 'Total',\n    pt: 'Total',\n  },\n  cliente: {\n    it: 'Cliente',\n    en: 'Customer',\n    de: 'Kunde',\n    fr: 'Client',\n    es: 'Cliente',\n    pt: 'Cliente',\n  },\n  agente: {\n    it: 'Agente',\n    en: 'Agent',\n    de: 'Vertreter',\n    fr: 'Agent',\n    es: 'Agente',\n    pt: 'Agente',\n  },\n  stato: {\n    it: 'Stato',\n    en: 'Status',\n    de: 'Status',\n    fr: 'Statut',\n    es: 'Estado',\n    pt: 'Estado',\n  },\n  evaso: {\n    it: 'Evaso',\n    en: 'Fulfilled',\n    de: 'Erfüllt',\n    fr: 'Traité',\n    es: 'Completado',\n    pt: 'Concluído',\n  },\n  consegnato: {\n    it: 'Consegnato',\n    en: 'Delivered',\n    de: 'Geliefert',\n    fr: 'Livré',\n    es: 'Entregado',\n    pt: 'Entregue',\n  },\n  causale: {\n    it: 'Causale',\n    en: 'Reason',\n    de: 'Grund',\n    fr: 'Causal',\n    es: 'Causal',\n    pt: 'Causal',\n  },\n  anno: {\n    it: 'Anno',\n    en: 'Year',\n    de: 'Jahr',\n    fr: 'Année',\n    es: 'Año',\n    pt: 'Ano',\n  },\n  'tipo documento': {\n    it: 'Tipo documento',\n    en: 'Document type',\n    de: 'Dokumentenart',\n    fr: 'Type de document',\n    es: 'Tipo de documento',\n    pt: 'Tipo de documento',\n  },\n  magazzino: {\n    it: 'Magazzino',\n    en: 'Warehouse',\n    de: 'Lager',\n    fr: 'Entrepôt',\n    es: 'Almacén',\n    pt: 'Armazém',\n  },\n};\n\nfunction translateDynamic(label: string | undefined, language: string) {\n  if (!label) return '';\n  const key = label.toLowerCase().trim();\n  if (BUILDER_FILTER_LABELS[key]) {\n    return BUILDER_FILTER_LABELS[key][language as keyof (typeof BUILDER_FILTER_LABELS)[string]];\n  }\n  if (BUILDER_COLUMN_LABELS[key]) {\n    return BUILDER_COLUMN_LABELS[key][language as keyof (typeof BUILDER_COLUMN_LABELS)[string]];\n  }\n  return label;\n}\n\ninterface ReportBuilderProps {\n  reportSlug: string;\n  clientCode: string;\n  language?: string;\n}\n\nexport default function ReportBuilder({\n  reportSlug,\n  clientCode,\n  language: initialLanguage = 'it',\n}: ReportBuilderProps) {\n  const [config, setConfig] = useState<ReportConfig | null>(null);\n  const [rawData, setRawData] = useState<any[]>([]);\n  const [processedData, setProcessedData] = useState<any[]>([]);\n  const [aggregates, setAggregates] = useState<Record<string, any>>({});\n  const [filters, setFilters] = useState<Record<string, any>>({});\n  const [autoOptions, setAutoOptions] = useState<Record<string, string[]>>({});\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [debugInfo, setDebugInfo] = useState<any>(null);\n  const [currentLanguage, setCurrentLanguage] = useState(initialLanguage);\n\n  useEffect(() => {\n    async function loadConfig() {\n      try {\n        const response = await fetch(`/api/reports/config?slug=${reportSlug}`);\n\n        if (!response.ok) {\n          throw new Error(`Report configuration not found: ${reportSlug}`);\n        }\n\n        const data = await response.json();\n        setConfig(data.config);\n      } catch (err: any) {\n        console.error('Error loading report config:', err);\n        setError(err.message || 'Failed to load report configuration');\n      }\n    }\n\n    loadConfig();\n  }, [reportSlug]);\n\n  useEffect(() => {\n    if (!config || !clientCode) return;\n\n    async function loadData(reportConfig: ReportConfig) {\n      try {\n        setLoading(true);\n        setError(null);\n\n        const queryParams: Record<string, any> = {};\n        queryParams.clientCode = clientCode;\n\n        const result = await executeQuery(reportConfig.query, queryParams);\n\n        setRawData(result.data || []);\n\n        if (result.debug) {\n          setDebugInfo(result.debug);\n        }\n\n        const options: Record<string, string[]> = {};\n\n        for (const filter of reportConfig.filters || []) {\n          if (filter.options === 'auto') {\n            if (filter.field === 'tipo_documento') {\n              options[filter.field] = await getDocumentTypes(clientCode);\n            } else if (filter.field === 'anno') {\n              const years = await getDocumentYears(clientCode);\n              options[filter.field] = years.map(String);\n            } else {\n              const uniqueValues = new Set<string>();\n              result.data.forEach((row: any) => {\n                const value = row[filter.field];\n                if (value != null && value !== '') {\n                  uniqueValues.add(String(value));\n                }\n              });\n              options[filter.field] = Array.from(uniqueValues).sort();\n            }\n          }\n        }\n\n        setAutoOptions(options);\n      } catch (err: any) {\n        console.error('Error loading data:', err);\n        setError(err.message || 'Failed to load data');\n      } finally {\n        setLoading(false);\n      }\n    }\n\n    loadData(config);\n  }, [config, clientCode]);\n\n  useEffect(() => {\n    if (!config || rawData.length === 0) {\n      setProcessedData([]);\n      setAggregates({});\n      return;\n    }\n\n    const result = ReportEngine.processReport(rawData, config, filters);\n    setProcessedData(result.data);\n    setAggregates(result.aggregates);\n  }, [rawData, config, filters]);\n\n  const handleFiltersChange = (newFilters: Record<string, any>) => {\n    setFilters(newFilters);\n  };\n\n  const handleApplyFilters = () => {};\n\n  if (loading && !config) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-sky-600\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n        <p className=\"text-red-800 font-medium\">\n          {TEXTS_BUILDER.errorTitle[currentLanguage]}\n        </p>\n        <p className=\"text-red-600 text-sm mt-1\">{error}</p>\n      </div>\n    );\n  }\n\n  if (!config) {\n    return null;\n  }\n\n  const isGrouped = config.grouping && config.grouping.length > 0;\n\n  const translatedConfig: ReportConfig = {\n    ...config,\n    title: translateDynamic(config.title, currentLanguage),\n    description: config.description\n      ? translateDynamic(config.description, currentLanguage)\n      : undefined,\n    columns: config.columns.map((col) => ({\n      ...col,\n      label: translateDynamic(col.label, currentLanguage),\n    })),\n    filters: (config.filters || []).map((filter) => ({\n      ...filter,\n      label: translateDynamic(filter.label, currentLanguage),\n    })),\n    grouping: (config.grouping || []).map((group) => ({\n      ...group,\n      label: translateDynamic(group.label, currentLanguage),\n    })),\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-start justify-between bg-gradient-to-r from-white to-slate-50 rounded-xl p-3 md:p-4\">\n        <div className=\"flex-1\">\n          <h1 className=\"text-3xl font-bold text-gray-900 tracking-tight\">\n            {translatedConfig?.title || config?.title}\n          </h1>\n          {translatedConfig?.description && (\n            <p className=\"text-gray-600 mt-2\">{translatedConfig.description}</p>\n          )}\n        </div>\n\n        <div className=\"ml-4\">\n          <label className=\"block text-xs font-medium text-gray-600 mb-1\">\n            {TEXTS_BUILDER.languageLabel[currentLanguage]}\n          </label>\n          <select\n            value={currentLanguage}\n            onChange={(e) => setCurrentLanguage(e.target.value)}\n            className=\"block w-40 px-3 py-2 bg-white border border-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400 text-sm\"\n          >\n            {LANGUAGES.map((lang) => (\n              <option key={lang.code} value={lang.code}>\n                {lang.flag} {lang.label}\n              </option>\n            ))}\n          </select>\n        </div>\n      </div>\n\n      {translatedConfig && translatedConfig.filters && translatedConfig.filters.length > 0 && (\n        <ReportFilters\n          filters={translatedConfig.filters}\n          values={filters}\n          onChange={handleFiltersChange}\n          onApply={handleApplyFilters}\n          autoOptions={autoOptions}\n          rawData={rawData}\n          language={currentLanguage}\n        />\n      )}\n\n      {debugInfo && (\n        <details className=\"bg-gray-50 border border-gray-200 rounded-lg p-4\">\n          <summary className=\"cursor-pointer font-medium text-gray-700 hover:text-gray-900\">\n            {TEXTS_BUILDER.debugTitle[currentLanguage]}\n          </summary>\n          <div className=\"mt-4 space-y-3\">\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugSql[currentLanguage]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {debugInfo.sql}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugParams[currentLanguage]}\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {JSON.stringify(debugInfo.params, null, 2)}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                {TEXTS_BUILDER.debugBind[currentLanguage]}\n              </p>\n              <code className=\"bg-white px-2 py-1 rounded border text-xs\">\n                {debugInfo.bindTypes}\n              </code>\n            </div>\n          </div>\n        </details>\n      )}\n\n      {!loading &&\n        Object.keys(filters)\n          .filter((key) => filters[key])\n          .length > 0 && (\n          <div className=\"bg-sky-50 border border-sky-100 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <h3 className=\"text-sm font-semibold text-sky-900\">\n                {TEXTS_BUILDER.activeFilters[currentLanguage]}\n              </h3>\n              <button\n                onClick={() => setFilters({})}\n                className=\"text-xs text-sky-600 hover:text-sky-800 underline\"\n              >\n                {TEXTS_BUILDER.removeAll[currentLanguage]}\n              </button>\n            </div>\n            <div className=\"flex flex-wrap gap-2\">\n              {Object.entries(filters).map(([field, value]) => {\n                if (!value) return null;\n\n                const filterConfig = translatedConfig?.filters?.find(\n                  (f) => f.field === field\n                );\n                const label = filterConfig?.label || field;\n\n                let displayValue = value;\n                if (typeof value === 'object' && value.from && value.to) {\n                  displayValue = `${value.from} - ${value.to}`;\n                } else if (Array.isArray(value)) {\n                  displayValue = value.join(', ');\n                }\n\n                return (\n                  <div\n                    key={field}\n                    className=\"inline-flex items-center gap-2 bg-white border border-sky-200 rounded-full px-3 py-1 text-sm shadow-sm\"\n                  >\n                    <span className=\"font-medium text-sky-900\">{label}:</span>\n                    <span className=\"text-sky-700\">{displayValue}</span>\n                    <button\n                      onClick={() => {\n                        const newFilters = { ...filters };\n                        delete newFilters[field];\n                        setFilters(newFilters);\n                      }}\n                      className=\"text-sky-400 hover:text-sky-600\"\n                    >\n                      ×\n                    </button>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        )}\n\n      {loading && (\n        <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"w-6 h-6 animate-spin text-sky-600 mr-2\" />\n          <span className=\"text-gray-600\">\n            {TEXTS_BUILDER.loadingData[currentLanguage]}\n          </span>\n        </div>\n      )}\n\n      {!loading && processedData.length === 0 && (\n        <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center\">\n          <p className=\"text-yellow-800 font-medium\">\n            {TEXTS_BUILDER.noData[currentLanguage]}\n          </p>\n          <p className=\"text-yellow-600 text-sm mt-1\">\n            {TEXTS_BUILDER.noDataDescription[currentLanguage]}\n          </p>\n        </div>\n      )}\n\n      {!loading && processedData.length > 0 && translatedConfig && (\n        <ReportTable\n          data={processedData}\n          columns={translatedConfig.columns}\n          aggregates={aggregates}\n          language={currentLanguage}\n          isGrouped={isGrouped}\n          groupingConfig={translatedConfig.grouping}\n        />\n      )}\n\n      {!loading && processedData.length > 0 && translatedConfig && (\n        <ReportExport\n          data={processedData}\n          config={translatedConfig}\n          reportTitle={translatedConfig.title}\n          language={currentLanguage}\n        />\n      )}\n    </div>\n  );\n}"
      },
      {
        "id": "v7",
        "timestamp": "2025-11-10T06:46:12.033Z",
        "note": "Modifica multipla 10/11/2025, 07:46:11",
        "code": "'use client';\n\nimport { useState, useEffect } from 'react';\nimport { ReportConfig } from '@/types/report';\nimport { ReportEngine } from '@/lib/report-engine';\nimport {\n  executeQuery,\n  getDocumentTypes,\n  getDocumentYears,\n} from '@/lib/mysql-query';\nimport ReportTable from './ReportTable';\nimport ReportFilters from './ReportFilters';\nimport ReportExport from './ReportExport';\nimport { Loader2 } from 'lucide-react';\n\nconst TEXTS_REPORTS: Record<\n  string,\n  {\n    title: Record<string, string>;\n    description: Record<string, string>;\n  }\n> = {\n  customer_documents_summary: {\n    title: {\n      it: 'Documenti Cliente',\n      en: 'Customer documents',\n      de: 'Kundendokumente',\n      fr: 'Documents client',\n      es: 'Documentos del cliente',\n      pt: 'Documentos do cliente',\n    },\n    description: {\n      it: 'Riepilogo documenti con raggruppamento per anno e tipo',\n      en: 'Document summary grouped by year and type',\n      de: 'Dokumentenübersicht nach Jahr und Art gruppiert',\n      fr: 'Récapitulatif des documents regroupés par année et type',\n      es: 'Resumen de documentos agrupados por año y tipo',\n      pt: 'Resumo de documentos agrupados por ano e tipo',\n    },\n  },\n  customer_documents_flat: {\n    title: {\n      it: 'Lista Documenti',\n      en: 'Documents list',\n      de: 'Dokumentenliste',\n      fr: 'Liste de documents',\n      es: 'Listado de documentos',\n      pt: 'Lista de documentos',\n    },\n    description: {\n      it: 'Lista semplice senza raggruppamento',\n      en: 'Simple list without grouping',\n      de: 'Einfache Liste ohne Gruppierung',\n      fr: 'Liste simple sans regroupement',\n      es: 'Lista simple sin agrupación',\n      pt: 'Lista simples sem agrupamento',\n    },\n  },\n  cc: {\n    // nel tuo JSON c’era \"cc\" con titoli vuoti → lo rendiamo comunque traducibile\n    title: {\n      it: 'Ordini e movimentazioni',\n      en: 'Orders and movements',\n      de: 'Bestellungen und Bewegungen',\n      fr: 'Commandes et mouvements',\n      es: 'Pedidos y movimientos',\n      pt: 'Pedidos e movimentos',\n    },\n    description: {\n      it: '',\n      en: '',\n      de: '',\n      fr: '',\n      es: '',\n      pt: '',\n    },\n  },\n};\n\nfunction getReportTitle(slug: string, lang: string, fallback: string) {\n  const r = TEXTS_REPORTS[slug];\n  if (r && r.title[lang]) return r.title[lang];\n  if (r && r.title.it) return r.title.it;\n  return fallback;\n}\n\nfunction getReportDescription(slug: string, lang: string, fallback: string | undefined) {\n  const r = TEXTS_REPORTS[slug];\n  if (r && r.description[lang]) return r.description[lang];\n  if (r && r.description.it) return r.description.it;\n  return fallback || '';\n}\n\ninterface ReportBuilderProps {\n  reportSlug: string;\n  clientCode: string;\n  language?: string;\n}\n\nexport default function ReportBuilder({\n  reportSlug,\n  clientCode,\n  language: initialLanguage = 'it',\n}: ReportBuilderProps) {\n  const [config, setConfig] = useState<ReportConfig | null>(null);\n  const [rawData, setRawData] = useState<any[]>([]);\n  const [processedData, setProcessedData] = useState<any[]>([]);\n  const [aggregates, setAggregates] = useState<Record<string, any>>({});\n  const [filters, setFilters] = useState<Record<string, any>>({});\n  const [autoOptions, setAutoOptions] = useState<Record<string, string[]>>({});\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [debugInfo, setDebugInfo] = useState<any>(null);\n  const [currentLanguage, setCurrentLanguage] = useState(initialLanguage);\n\n  useEffect(() => {\n    async function loadConfig() {\n      try {\n        const response = await fetch(`/api/reports/config?slug=${reportSlug}`);\n\n        if (!response.ok) {\n          throw new Error(`Report configuration not found: ${reportSlug}`);\n        }\n\n        const data = await response.json();\n        setConfig(data.config);\n      } catch (err: any) {\n        console.error('Error loading report config:', err);\n        setError(err.message || 'Failed to load report configuration');\n      }\n    }\n\n    loadConfig();\n  }, [reportSlug]);\n\n  useEffect(() => {\n    if (!config || !clientCode) return;\n\n    async function loadData(reportConfig: ReportConfig) {\n      try {\n        setLoading(true);\n        setError(null);\n\n        const queryParams: Record<string, any> = {};\n        queryParams.clientCode = clientCode;\n\n        const result = await executeQuery(reportConfig.query, queryParams);\n\n        setRawData(result.data || []);\n\n        if (result.debug) {\n          setDebugInfo(result.debug);\n        }\n\n        const options: Record<string, string[]> = {};\n\n        for (const filter of reportConfig.filters || []) {\n          if (filter.options === 'auto') {\n            if (filter.field === 'tipo_documento') {\n              options[filter.field] = await getDocumentTypes(clientCode);\n            } else if (filter.field === 'anno') {\n              const years = await getDocumentYears(clientCode);\n              options[filter.field] = years.map(String);\n            } else {\n              const uniqueValues = new Set<string>();\n              result.data.forEach((row: any) => {\n                const value = row[filter.field];\n                if (value != null && value !== '') {\n                  uniqueValues.add(String(value));\n                }\n              });\n              options[filter.field] = Array.from(uniqueValues).sort();\n            }\n          }\n        }\n\n        setAutoOptions(options);\n      } catch (err: any) {\n        console.error('Error loading data:', err);\n        setError(err.message || 'Failed to load data');\n      } finally {\n        setLoading(false);\n      }\n    }\n\n    loadData(config);\n  }, [config, clientCode]);\n\n  useEffect(() => {\n    if (!config || rawData.length === 0) {\n      setProcessedData([]);\n      setAggregates({});\n      return;\n    }\n\n    const result = ReportEngine.processReport(rawData, config, filters);\n    setProcessedData(result.data);\n    setAggregates(result.aggregates);\n  }, [rawData, config, filters]);\n\n  const handleFiltersChange = (newFilters: Record<string, any>) => {\n    setFilters(newFilters);\n  };\n\n  const handleApplyFilters = () => {};\n\n  if (loading && !config) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <Loader2 className=\"w-8 h-8 animate-spin text-sky-600\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n        <p className=\"text-red-800 font-medium\">\n          Errore\n        </p>\n        <p className=\"text-red-600 text-sm mt-1\">{error}</p>\n      </div>\n    );\n  }\n\n  if (!config) {\n    return null;\n  }\n\n  const isGrouped = config.grouping && config.grouping.length > 0;\n\n  const translatedTitle = getReportTitle(reportSlug, currentLanguage, config.title);\n  const translatedDescription = getReportDescription(\n    reportSlug,\n    currentLanguage,\n    config.description\n  );\n\n  const getFilterLabelByField = (field: string): string => {\n    // stesso mapping usato in ReportFilters\n    const m: Record<string, Record<string, string>> = {\n      data_ordine: {\n        it: 'Data Ordine',\n        en: 'Order Date',\n        de: 'Bestelldatum',\n        fr: 'Date de Commande',\n        es: 'Fecha de Pedido',\n        pt: 'Data do Pedido',\n      },\n      numero_documento: {\n        it: 'Numero Documento',\n        en: 'Document Number',\n        de: 'Dokumentnummer',\n        fr: 'Numéro de Document',\n        es: 'Número de Documento',\n        pt: 'Número do Documento',\n      },\n      codice_articolo: {\n        it: 'Codice Articolo',\n        en: 'Item Code',\n        de: 'Artikelcode',\n        fr: 'Code Article',\n        es: 'Código Artículo',\n        pt: 'Código do Artigo',\n      },\n      anno: {\n        it: 'Anno',\n        en: 'Year',\n        de: 'Jahr',\n        fr: 'Année',\n        es: 'Año',\n        pt: 'Ano',\n      },\n      tipo_documento: {\n        it: 'Tipo Documento',\n        en: 'Document Type',\n        de: 'Dokumenttyp',\n        fr: 'Type de Document',\n        es: 'Tipo de Documento',\n        pt: 'Tipo de Documento',\n      },\n      cliente: {\n        it: 'Cliente',\n        en: 'Customer',\n        de: 'Kunde',\n        fr: 'Client',\n        es: 'Cliente',\n        pt: 'Cliente',\n      },\n      dateRange: {\n        it: 'Periodo',\n        en: 'Period',\n        de: 'Zeitraum',\n        fr: 'Période',\n        es: 'Período',\n        pt: 'Período',\n      },\n      stato: {\n        it: 'Stato',\n        en: 'Status',\n        de: 'Status',\n        fr: 'Statut',\n        es: 'Estado',\n        pt: 'Estado',\n      },\n    };\n    const t = m[field];\n    if (t) return t[currentLanguage] || t.it;\n    return field;\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-start justify-between bg-gradient-to-r from-white to-slate-50 rounded-xl p-3 md:p-4\">\n        <div className=\"flex-1\">\n          <h1 className=\"text-3xl font-bold text-gray-900 tracking-tight\">\n            {translatedTitle}\n          </h1>\n          {translatedDescription && (\n            <p className=\"text-gray-600 mt-2\">{translatedDescription}</p>\n          )}\n        </div>\n\n        {/* Language selector */}\n        <div className=\"ml-4\">\n          <label className=\"block text-xs font-medium text-gray-600 mb-1\">\n            Lingua\n          </label>\n          <select\n            value={currentLanguage}\n            onChange={(e) => setCurrentLanguage(e.target.value)}\n            className=\"block w-40 px-3 py-2 bg-white border border-gray-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400 text-sm\"\n          >\n            <option value=\"it\">🇮🇹 Italiano</option>\n            <option value=\"en\">🇬🇧 English</option>\n            <option value=\"de\">🇩🇪 Deutsch</option>\n            <option value=\"fr\">🇫🇷 Français</option>\n            <option value=\"es\">🇪🇸 Español</option>\n            <option value=\"pt\">🇵🇹 Português</option>\n          </select>\n        </div>\n      </div>\n\n      {config && config.filters && config.filters.length > 0 && (\n        <ReportFilters\n          filters={config.filters}\n          values={filters}\n          onChange={handleFiltersChange}\n          onApply={handleApplyFilters}\n          autoOptions={autoOptions}\n          rawData={rawData}\n          language={currentLanguage}\n        />\n      )}\n\n      {debugInfo && (\n        <details className=\"bg-gray-50 border border-gray-200 rounded-lg p-4\">\n          <summary className=\"cursor-pointer font-medium text-gray-700 hover:text-gray-900\">\n            Debug: Query SQL eseguita\n          </summary>\n          <div className=\"mt-4 space-y-3\">\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                Query SQL:\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {debugInfo.sql}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                Parametri:\n              </p>\n              <pre className=\"bg-white p-3 rounded border text-xs overflow-x-auto\">\n                {JSON.stringify(debugInfo.params, null, 2)}\n              </pre>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-gray-700 mb-1\">\n                Bind Types:\n              </p>\n              <code className=\"bg-white px-2 py-1 rounded border text-xs\">\n                {debugInfo.bindTypes}\n              </code>\n            </div>\n          </div>\n        </details>\n      )}\n\n      {!loading &&\n        Object.keys(filters)\n          .filter((key) => filters[key])\n          .length > 0 && (\n          <div className=\"bg-sky-50 border border-sky-100 rounded-lg p-4\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <h3 className=\"text-sm font-semibold text-sky-900\">\n                Filtri attivi:\n              </h3>\n              <button\n                onClick={() => setFilters({})}\n                className=\"text-xs text-sky-600 hover:text-sky-800 underline\"\n              >\n                Rimuovi tutti\n              </button>\n            </div>\n            <div className=\"flex flex-wrap gap-2\">\n              {Object.entries(filters).map(([field, value]) => {\n                if (!value) return null;\n\n                const label = getFilterLabelByField(field);\n\n                let displayValue = value;\n                if (typeof value === 'object' && value.from && value.to) {\n                  displayValue = `${value.from} - ${value.to}`;\n                } else if (Array.isArray(value)) {\n                  displayValue = value.join(', ');\n                }\n\n                return (\n                  <div\n                    key={field}\n                    className=\"inline-flex items-center gap-2 bg-white border border-sky-200 rounded-full px-3 py-1 text-sm shadow-sm\"\n                  >\n                    <span className=\"font-medium text-sky-900\">{label}:</span>\n                    <span className=\"text-sky-700\">{displayValue}</span>\n                    <button\n                      onClick={() => {\n                        const newFilters = { ...filters };\n                        delete newFilters[field];\n                        setFilters(newFilters);\n                      }}\n                      className=\"text-sky-400 hover:text-sky-600\"\n                    >\n                      ×\n                    </button>\n                  </div>\n                );\n              })}\n            </div>\n          </div>\n        )}\n\n      {loading && (\n        <div className=\"flex items-center justify-center py-8\">\n          <Loader2 className=\"w-6 h-6 animate-spin text-sky-600 mr-2\" />\n          <span className=\"text-gray-600\">\n            Caricamento dati...\n          </span>\n        </div>\n      )}\n\n      {!loading && processedData.length === 0 && (\n        <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center\">\n          <p className=\"text-yellow-800 font-medium\">\n            Nessun dato disponibile\n          </p>\n          <p className=\"text-yellow-600 text-sm mt-1\">\n            Non ci sono dati per il cliente selezionato con i filtri applicati.\n          </p>\n        </div>\n      )}\n\n      {!loading && processedData.length > 0 && config && (\n        <ReportTable\n          data={processedData}\n          columns={config.columns}\n          aggregates={aggregates}\n          language={currentLanguage}\n          isGrouped={isGrouped}\n          groupingConfig={config.grouping}\n        />\n      )}\n\n      {!loading && processedData.length > 0 && config && (\n        <ReportExport\n          data={processedData}\n          config={config}\n          reportTitle={translatedTitle}\n          language={currentLanguage}\n        />\n      )}\n    </div>\n  );\n}"
      }
    ]
  }
}